---
phase: 24-navigation-selection
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - src/types/elements/controls.ts
  - src/components/elements/renderers/controls/TreeViewRenderer.tsx
  - src/components/elements/renderers/controls/index.ts
  - src/components/elements/renderers/index.ts
autonomous: true

must_haves:
  truths:
    - "react-arborist package is installed"
    - "Tree View renders hierarchical list with expand/collapse"
    - "Click arrow expands/collapses (single click on row selects)"
    - "Tree structure is designer-defined but JUCE can modify at runtime"
    - "Tree View supports custom row height and indentation"
  artifacts:
    - path: "package.json"
      provides: "react-arborist dependency"
      contains: "react-arborist"
    - path: "src/types/elements/controls.ts"
      provides: "TreeViewElementConfig type"
      contains: "TreeViewElementConfig"
    - path: "src/components/elements/renderers/controls/TreeViewRenderer.tsx"
      provides: "Tree view using react-arborist"
      exports: ["TreeViewRenderer"]
  key_links:
    - from: "TreeViewRenderer.tsx"
      to: "react-arborist"
      via: "import"
      pattern: "import.*from.*react-arborist"
    - from: "TreeViewRenderer.tsx"
      to: "controls.ts"
      via: "type import"
      pattern: "import.*TreeViewElementConfig"
---

<objective>
Install react-arborist and create Tree View element type and renderer.

Purpose: Tree View is used for preset browsers and hierarchical navigation in plugin UIs. The library handles virtualization, keyboard navigation, and accessibility. Structure is designer-defined but JUCE can modify at runtime.

Output: Tree View element type with react-arborist integration following CONTEXT.md decisions (click arrow to expand/collapse, single click on row selects).
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/24-navigation-selection/24-CONTEXT.md
@.planning/phases/24-navigation-selection/24-RESEARCH.md
@src/types/elements/controls.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install react-arborist</name>
  <files>package.json</files>
  <action>
Install react-arborist package for tree view functionality.

```bash
npm install react-arborist
```

This will add react-arborist to package.json dependencies. The library provides:
- Virtualized tree rendering (handles 30k+ nodes)
- Built-in keyboard navigation
- ARIA accessibility attributes
- Selection and expansion state management
- Custom row rendering

Note: Do not pin to a specific version - use latest.
  </action>
  <verify>grep "react-arborist" package.json shows the dependency</verify>
  <done>react-arborist installed and added to package.json dependencies</done>
</task>

<task type="auto">
  <name>Task 2: Add TreeView type definition</name>
  <files>src/types/elements/controls.ts</files>
  <action>
Add TreeViewElementConfig interface to controls.ts.

**TreeNode type:**
```typescript
export interface TreeNode {
  id: string
  name: string
  children?: TreeNode[]
}
```

**TreeViewElementConfig:**
```typescript
export interface TreeViewElementConfig extends BaseElementConfig {
  type: 'treeview'

  // Tree structure (designer defines, JUCE can modify at runtime)
  data: TreeNode[]

  // Selection state
  selectedId?: string
  expandedIds: string[]

  // Layout
  rowHeight: number
  indent: number // Pixels to indent per level

  // Visual style
  backgroundColor: string
  selectedBackgroundColor: string
  hoverBackgroundColor: string
  textColor: string
  selectedTextColor: string
  arrowColor: string

  // Behavior
  disableEdit: boolean // Always true in designer mode
  disableDrag: boolean // Always true in designer mode
}
```

Add to ControlElement union type.

Add type guard:
```typescript
export function isTreeView(element: { type: string }): element is TreeViewElementConfig {
  return element.type === 'treeview'
}
```

Add factory function:
```typescript
export function createTreeView(overrides?: Partial<TreeViewElementConfig>): TreeViewElementConfig {
  return {
    id: crypto.randomUUID(),
    type: 'treeview',
    name: 'Tree View',
    x: 0,
    y: 0,
    width: 200,
    height: 250,
    rotation: 0,
    zIndex: 0,
    locked: false,
    visible: true,
    data: [
      {
        id: '1',
        name: 'Presets',
        children: [
          {
            id: '1-1',
            name: 'Factory',
            children: [
              { id: '1-1-1', name: 'Bass' },
              { id: '1-1-2', name: 'Lead' },
              { id: '1-1-3', name: 'Pad' },
            ],
          },
          {
            id: '1-2',
            name: 'User',
            children: [
              { id: '1-2-1', name: 'My Preset 1' },
              { id: '1-2-2', name: 'My Preset 2' },
            ],
          },
        ],
      },
    ],
    selectedId: undefined,
    expandedIds: ['1', '1-1'],
    rowHeight: 28,
    indent: 16,
    backgroundColor: '#1f2937',
    selectedBackgroundColor: '#374151',
    hoverBackgroundColor: '#2d3748',
    textColor: '#d1d5db',
    selectedTextColor: '#ffffff',
    arrowColor: '#9ca3af',
    disableEdit: true,
    disableDrag: true,
    ...overrides,
  }
}
```
  </action>
  <verify>grep -c "TreeViewElementConfig\|TreeNode" src/types/elements/controls.ts shows 2+ matches</verify>
  <done>TreeViewElementConfig and TreeNode types added with type guard and factory function</done>
</task>

<task type="auto">
  <name>Task 3: Create TreeView renderer</name>
  <files>
    src/components/elements/renderers/controls/TreeViewRenderer.tsx
    src/components/elements/renderers/controls/index.ts
    src/components/elements/renderers/index.ts
  </files>
  <action>
**TreeViewRenderer.tsx:**
Use react-arborist Tree component with custom styling. Per CONTEXT.md: click arrow only to expand/collapse, single click on row selects.

```typescript
import React, { useState, useCallback } from 'react'
import { Tree, NodeRendererProps } from 'react-arborist'
import { TreeViewElementConfig, TreeNode } from '../../../../types/elements/controls'

interface TreeViewRendererProps {
  config: TreeViewElementConfig
}

export function TreeViewRenderer({ config }: TreeViewRendererProps) {
  const [selectedId, setSelectedId] = useState<string | undefined>(config.selectedId)
  const [expandedIds, setExpandedIds] = useState<Set<string>>(new Set(config.expandedIds))

  // Custom node renderer
  const Node = useCallback(({ node, style, dragHandle }: NodeRendererProps<TreeNode>) => {
    const isSelected = node.id === selectedId
    const hasChildren = node.children && node.children.length > 0

    const handleArrowClick = (e: React.MouseEvent) => {
      e.stopPropagation()
      if (hasChildren) {
        node.toggle()
        setExpandedIds(prev => {
          const next = new Set(prev)
          if (node.isOpen) {
            next.delete(node.id)
          } else {
            next.add(node.id)
          }
          return next
        })
      }
    }

    const handleRowClick = () => {
      setSelectedId(node.id)
    }

    return (
      <div
        ref={dragHandle}
        style={{
          ...style,
          display: 'flex',
          alignItems: 'center',
          backgroundColor: isSelected
            ? config.selectedBackgroundColor
            : 'transparent',
          color: isSelected ? config.selectedTextColor : config.textColor,
          cursor: 'pointer',
          height: config.rowHeight,
          paddingRight: 8,
          transition: 'none',
        }}
        onClick={handleRowClick}
        data-node-id={node.id}
      >
        {/* Expand/collapse arrow */}
        <span
          onClick={handleArrowClick}
          style={{
            width: 20,
            height: 20,
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            color: config.arrowColor,
            cursor: hasChildren ? 'pointer' : 'default',
            userSelect: 'none',
          }}
        >
          {hasChildren && (
            <span
              style={{
                transform: node.isOpen ? 'rotate(90deg)' : 'rotate(0deg)',
                transition: 'transform 100ms ease',
                fontSize: 10,
              }}
            >
              &#9654;
            </span>
          )}
        </span>

        {/* Node name */}
        <span
          style={{
            flex: 1,
            overflow: 'hidden',
            textOverflow: 'ellipsis',
            whiteSpace: 'nowrap',
            fontSize: 13,
          }}
        >
          {node.data.name}
        </span>
      </div>
    )
  }, [selectedId, config])

  return (
    <div
      style={{
        width: config.width,
        height: config.height,
        backgroundColor: config.backgroundColor,
        overflow: 'hidden',
        borderRadius: 4,
      }}
      data-selected-id={selectedId}
    >
      <Tree
        data={config.data}
        openByDefault={false}
        initialOpenState={Object.fromEntries(
          config.expandedIds.map(id => [id, true])
        )}
        width={config.width}
        height={config.height}
        rowHeight={config.rowHeight}
        indent={config.indent}
        disableEdit={true}
        disableDrag={true}
        disableDrop={true}
      >
        {Node}
      </Tree>
    </div>
  )
}
```

**Update controls/index.ts:**
Add export for TreeViewRenderer:
```typescript
export { TreeViewRenderer } from './TreeViewRenderer'
```

**Update renderers/index.ts:**
1. Add import:
```typescript
import {
  // ... existing imports ...
  TreeViewRenderer,
} from './controls'
```

2. Add to rendererRegistry Map:
```typescript
['treeview', TreeViewRenderer as RendererComponent],
```

3. Add to re-exports:
```typescript
export {
  // ... existing exports ...
  TreeViewRenderer,
  // ...
}
```
  </action>
  <verify>ls src/components/elements/renderers/controls/TreeViewRenderer.tsx exists and grep "react-arborist" shows import</verify>
  <done>TreeViewRenderer created using react-arborist with custom node rendering and proper interaction patterns</done>
</task>

</tasks>

<verification>
1. `grep "react-arborist" package.json` - Dependency installed
2. `grep "TreeViewElementConfig" src/types/elements/controls.ts` - Type exists
3. `grep "TreeNode" src/types/elements/controls.ts` - Type exists
4. `ls src/components/elements/renderers/controls/TreeViewRenderer.tsx` - File exists
5. `grep "from 'react-arborist'" src/components/elements/renderers/controls/TreeViewRenderer.tsx` - Import present
6. `grep "treeview" src/components/elements/renderers/index.ts` - Registry entry exists
7. TypeScript compilation: `npx tsc --noEmit`
</verification>

<success_criteria>
- react-arborist installed via npm install
- TreeViewElementConfig has data array with TreeNode structure (id, name, children)
- TreeViewElementConfig has expandedIds array for tracking open nodes
- TreeViewRenderer uses react-arborist Tree component
- Arrow click expands/collapses (does NOT select) per CONTEXT.md
- Row click selects (does NOT toggle expand/collapse) per CONTEXT.md
- Renderer outputs data-selected-id and data-node-id attributes for JUCE
- disableEdit and disableDrag are always true in designer mode
- Renderer registered in rendererRegistry
</success_criteria>

<output>
After completion, create `.planning/phases/24-navigation-selection/24-04-SUMMARY.md`
</output>
