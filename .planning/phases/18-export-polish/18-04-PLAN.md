---
phase: 18-export-polish
plan: 04
type: execute
wave: 2
depends_on: ["18-02"]
files_modified:
  - src/components/export/ExportPanel.tsx
  - src/services/export/previewExport.ts
autonomous: true

must_haves:
  truths:
    - "User can preview exported HTML in browser before downloading"
    - "Preview opens in new browser tab"
    - "Preview includes mock JUCE for interactivity testing"
  artifacts:
    - path: "src/services/export/previewExport.ts"
      provides: "Browser preview function using blob URL"
      exports: ["previewHTMLExport"]
    - path: "src/components/export/ExportPanel.tsx"
      provides: "Preview button in export panel"
      contains: "Preview"
  key_links:
    - from: "src/components/export/ExportPanel.tsx"
      to: "src/services/export/previewExport.ts"
      via: "previewHTMLExport function call"
      pattern: "previewHTMLExport"
---

<objective>
Implement browser preview for exported HTML

Purpose: Allow users to verify export appearance before committing to download, catching issues early
Output: Preview button that opens exported HTML in a new browser tab with mock JUCE backend
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-export-polish/18-RESEARCH.md

# Relevant source files
@src/components/export/ExportPanel.tsx
@src/services/export/codeGenerator.ts
@src/services/export/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create browser preview function</name>
  <files>src/services/export/previewExport.ts</files>
  <action>
Create `src/services/export/previewExport.ts`:

```typescript
/**
 * Browser preview for exported HTML
 * Opens a new tab with the exported HTML using blob URL
 */

import type { ElementConfig } from '../../types/elements';
import { generateHTML } from './htmlGenerator';
import { generateCSS } from './cssGenerator';
import { generateBindingsJS, generateComponentsJS, generateMockJUCE, generateResponsiveScaleJS } from './jsGenerator';

export interface PreviewOptions {
  elements: ElementConfig[];
  canvasWidth: number;
  canvasHeight: number;
  backgroundColor: string;
  enableResponsiveScaling?: boolean;
}

/**
 * Generate and open preview HTML in new browser tab
 * Uses blob URL for instant preview without download
 * Includes mock JUCE backend for interactivity testing
 */
export async function previewHTMLExport(options: PreviewOptions): Promise<{ success: boolean; error?: string }> {
  try {
    const { elements, canvasWidth, canvasHeight, backgroundColor, enableResponsiveScaling = true } = options;

    // Generate HTML structure
    const html = generateHTML(elements, {
      canvasWidth,
      canvasHeight,
      backgroundColor,
      isPreviewMode: true,
    });

    // Generate CSS
    const css = generateCSS(elements, {
      canvasWidth,
      canvasHeight,
      backgroundColor,
    });

    // Generate JavaScript
    const bindingsJS = generateBindingsJS(elements, { isPreviewMode: true });
    const componentsJS = generateComponentsJS(elements);
    const mockJUCE = generateMockJUCE();
    const responsiveJS = enableResponsiveScaling
      ? generateResponsiveScaleJS(canvasWidth, canvasHeight)
      : '';

    // Build standalone HTML with all assets inline
    const standaloneHTML = buildStandaloneHTML({
      html,
      css,
      bindingsJS,
      componentsJS,
      mockJUCE,
      responsiveJS,
    });

    // Create blob and open in new tab
    const blob = new Blob([standaloneHTML], { type: 'text/html' });
    const url = URL.createObjectURL(blob);

    const previewWindow = window.open(url, '_blank');

    if (!previewWindow) {
      return {
        success: false,
        error: 'Popup blocked. Please allow popups for preview.',
      };
    }

    // Clean up blob URL after window loads (give it time)
    setTimeout(() => {
      URL.revokeObjectURL(url);
    }, 5000);

    return { success: true };
  } catch (error) {
    return {
      success: false,
      error: error instanceof Error ? error.message : 'Preview failed',
    };
  }
}

/**
 * Build standalone HTML with all CSS/JS inline
 */
function buildStandaloneHTML(parts: {
  html: string;
  css: string;
  bindingsJS: string;
  componentsJS: string;
  mockJUCE: string;
  responsiveJS: string;
}): string {
  const { html, css, bindingsJS, componentsJS, mockJUCE, responsiveJS } = parts;

  // Replace external CSS/JS references with inline content
  // Original HTML has: <link rel="stylesheet" href="style.css">
  // and <script src="...">

  let standaloneHTML = html;

  // Replace CSS link with inline style
  standaloneHTML = standaloneHTML.replace(
    '<link rel="stylesheet" href="style.css">',
    `<style>\n${css}\n</style>`
  );

  // Replace script tags with inline scripts
  // Add mock JUCE first (must initialize before bindings)
  standaloneHTML = standaloneHTML.replace(
    '<script src="components.js"></script>',
    `<script>\n${mockJUCE}\n</script>\n<script>\n${componentsJS}\n</script>`
  );

  standaloneHTML = standaloneHTML.replace(
    '<script src="bindings.js"></script>',
    `<script>\n${bindingsJS}\n</script>${responsiveJS ? `\n<script>\n${responsiveJS}\n</script>` : ''}`
  );

  return standaloneHTML;
}
```

Per RESEARCH.md Pattern 3: Browser Preview (Web App) - use blob URL + window.open()
  </action>
  <verify>
- `npx tsc --noEmit` passes
- File exports previewHTMLExport function
- Function creates blob URL and opens window
  </verify>
  <done>Browser preview function created using blob URL + window.open pattern</done>
</task>

<task type="auto">
  <name>Task 2: Add preview button to ExportPanel</name>
  <files>src/components/export/ExportPanel.tsx</files>
  <action>
Update `src/components/export/ExportPanel.tsx`:

1. **Import preview function:**
```typescript
import { previewHTMLExport } from '../../services/export/previewExport';
```

2. **Add preview handler:**
```typescript
const handlePreview = async () => {
  setIsExporting(true);
  setError(null);

  const result = await previewHTMLExport({
    elements,
    canvasWidth,
    canvasHeight,
    backgroundColor,
    enableResponsiveScaling,
  });

  setIsExporting(false);

  if (!result.success) {
    setError(result.error || 'Preview failed');
  }
};
```

3. **Add preview button** after the Export HTML Preview button:
```tsx
<button
  onClick={handlePreview}
  disabled={isExporting}
  className="w-full px-3 py-2 bg-purple-600 hover:bg-purple-700 disabled:bg-gray-600 text-white text-sm font-medium rounded transition-colors"
>
  {isExporting ? 'Loading...' : 'Preview in Browser'}
</button>
```

4. **Update export service index** to export the new function:
In `src/services/export/index.ts`, add:
```typescript
export { previewHTMLExport } from './previewExport';
```

Per CONTEXT.md: Browser preview option - open exported HTML in browser to verify appearance
  </action>
  <verify>
- `npx tsc --noEmit` passes
- ExportPanel shows "Preview in Browser" button
- Clicking button opens new tab with preview
  </verify>
  <done>Preview button added to ExportPanel that opens HTML preview in new browser tab</done>
</task>

</tasks>

<verification>
1. Run `npx tsc --noEmit` to verify TypeScript compilation
2. Run `npm run dev` and click "Preview in Browser" button
3. Verify new tab opens with rendered UI
4. Verify interactive elements work with mock JUCE
</verification>

<success_criteria>
- ExportPanel has "Preview in Browser" button
- Clicking preview opens new browser tab
- Preview shows rendered UI with all elements
- Interactive elements (knobs, sliders) work in preview
- Error shows if popup is blocked
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/18-export-polish/18-04-SUMMARY.md`
</output>
