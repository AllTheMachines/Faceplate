---
phase: 18-export-polish
plan: 03
type: execute
wave: 2
depends_on: ["18-01", "18-02"]
files_modified:
  - src/services/export/codeGenerator.ts
  - src/components/export/ExportPanel.tsx
autonomous: true

must_haves:
  truths:
    - "Export dialog has toggle for SVG optimization (enabled by default)"
    - "Export includes responsive scaling script when enabled"
    - "Size savings displayed after export completion"
  artifacts:
    - path: "src/services/export/codeGenerator.ts"
      provides: "Export functions that use SVGO and responsive scaling"
      contains: "optimizeSVG"
    - path: "src/components/export/ExportPanel.tsx"
      provides: "Export dialog with optimization toggle and size savings display"
      contains: "optimizeSVG"
  key_links:
    - from: "src/components/export/ExportPanel.tsx"
      to: "src/services/export/codeGenerator.ts"
      via: "exportJUCEBundle with options"
      pattern: "exportJUCEBundle.*optimizeSVG"
---

<objective>
Integrate SVGO optimization and responsive scaling into export workflow

Purpose: Connect the SVGO wrapper and responsive scaling to the actual export process with UI controls
Output: Export panel with optimization toggle, export functions that apply SVGO and include responsive scaling
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-export-polish/18-RESEARCH.md

# Relevant source files
@src/services/export/codeGenerator.ts
@src/components/export/ExportPanel.tsx
@src/services/export/svgOptimizer.ts (created in 18-01)
@src/services/export/jsGenerator.ts (updated in 18-02)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update export options and codeGenerator</name>
  <files>src/services/export/codeGenerator.ts</files>
  <action>
Update `src/services/export/codeGenerator.ts`:

1. **Update ExportOptions interface:**
```typescript
export interface ExportOptions {
  elements: ElementConfig[];
  canvasWidth: number;
  canvasHeight: number;
  backgroundColor: string;
  optimizeSVG?: boolean;        // New: default true
  enableResponsiveScaling?: boolean;  // New: default true
}
```

2. **Update ExportResult interface:**
```typescript
export interface ExportResult {
  success: boolean;
  error?: string;
  sizeSavings?: {              // New: for displaying savings
    original: number;
    optimized: number;
    percent: number;
  };
}
```

3. **Import SVGO optimizer and responsive JS generator:**
```typescript
import { optimizeSVG } from './svgOptimizer';
import { generateResponsiveScaleJS } from './jsGenerator';
```

4. **In exportJUCEBundle function:**
- Apply SVGO to SVG content before generating HTML (if optimizeSVG !== false)
- This requires getting all assets with SVG content and optimizing them
- Track total size savings
- Add responsive scaling script to the JS output (if enableResponsiveScaling !== false)
- Return sizeSavings in result

5. **Also update exportHTMLPreview** with same optimization and responsive scaling logic

Note: The optimization should happen at export time, not modify store data. Apply to:
- Asset SVG content used in SvgGraphic elements
- KnobStyle SVG content used in styled knobs

The htmlGenerator already re-sanitizes SVG. Optimization should happen AFTER sanitization (sanitize first for security, then optimize for size).
  </action>
  <verify>
- `npx tsc --noEmit` passes
- ExportOptions includes optimizeSVG and enableResponsiveScaling
- ExportResult includes sizeSavings
- codeGenerator imports optimizeSVG and generateResponsiveScaleJS
  </verify>
  <done>Export functions updated to apply SVGO optimization and include responsive scaling script</done>
</task>

<task type="auto">
  <name>Task 2: Add optimization toggle to ExportPanel</name>
  <files>src/components/export/ExportPanel.tsx</files>
  <action>
Update `src/components/export/ExportPanel.tsx`:

1. **Add state for export options:**
```typescript
const [optimizeSVG, setOptimizeSVG] = useState(true);
const [enableResponsiveScaling, setEnableResponsiveScaling] = useState(true);
```

2. **Update export handlers** to pass options:
```typescript
const result = await exportJUCEBundle({
  elements,
  canvasWidth,
  canvasHeight,
  backgroundColor,
  optimizeSVG,
  enableResponsiveScaling,
});
```

3. **Add UI controls** before the export buttons:

```tsx
{/* Export Options */}
<div className="mb-3 space-y-2">
  <label className="flex items-center gap-2 text-xs text-gray-300 cursor-pointer">
    <input
      type="checkbox"
      checked={optimizeSVG}
      onChange={(e) => setOptimizeSVG(e.target.checked)}
      className="rounded border-gray-600 bg-gray-700 text-blue-500"
    />
    Optimize SVG assets
  </label>
  <label className="flex items-center gap-2 text-xs text-gray-300 cursor-pointer">
    <input
      type="checkbox"
      checked={enableResponsiveScaling}
      onChange={(e) => setEnableResponsiveScaling(e.target.checked)}
      className="rounded border-gray-600 bg-gray-700 text-blue-500"
    />
    Enable responsive scaling
  </label>
</div>
```

4. **Update success message** to show size savings if available:
```typescript
if (result.success) {
  let message = 'JUCE bundle exported successfully';
  if (result.sizeSavings && result.sizeSavings.percent > 0) {
    message += ` (SVG optimized: ${result.sizeSavings.percent.toFixed(1)}% smaller)`;
  }
  setLastExport(message);
}
```

Per CONTEXT.md: Toggle appears in export dialog as checkbox, display file size savings after export
  </action>
  <verify>
- `npx tsc --noEmit` passes
- Export panel renders optimization toggle checkbox
- Export panel renders responsive scaling toggle checkbox
- Success message includes size savings percentage when available
  </verify>
  <done>ExportPanel updated with optimization toggle and size savings display</done>
</task>

</tasks>

<verification>
1. Run `npx tsc --noEmit` to verify TypeScript compilation
2. Run `npm run dev` and verify export panel shows toggles
3. Test export with optimization enabled and check success message shows savings
</verification>

<success_criteria>
- ExportPanel has "Optimize SVG assets" checkbox (default checked)
- ExportPanel has "Enable responsive scaling" checkbox (default checked)
- Export functions pass options through and apply optimization
- Success message shows size savings percentage when optimization applied
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/18-export-polish/18-03-SUMMARY.md`
</output>
