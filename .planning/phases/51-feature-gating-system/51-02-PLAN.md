---
phase: 51-feature-gating-system
plan: 02
type: execute
wave: 2
depends_on: ["51-01"]
files_modified:
  - src/components/Palette/PaletteItem.tsx
  - src/components/Palette/Palette.tsx
  - src/components/elements/Element.tsx
autonomous: false

must_haves:
  truths:
    - "Pro elements in palette show violet PRO badge in top-right corner"
    - "Pro elements cannot be dragged to canvas when unlicensed"
    - "Pro elements on canvas show PRO badge when user is unlicensed"
    - "Hide Pro elements toggle filters Pro items from palette"
    - "Pro elements are grouped at bottom of each category"
  artifacts:
    - path: "src/components/Palette/PaletteItem.tsx"
      provides: "Palette item with Pro badge and drag blocking"
      contains: "isProElement"
    - path: "src/components/Palette/Palette.tsx"
      provides: "Palette with Hide Pro toggle and Pro element sorting"
      contains: "hideProElements"
    - path: "src/components/elements/Element.tsx"
      provides: "Canvas element with Pro badge overlay"
      contains: "PRO"
  key_links:
    - from: "src/components/Palette/PaletteItem.tsx"
      to: "src/services/proElements.ts"
      via: "import"
      pattern: "isProElement"
    - from: "src/components/Palette/PaletteItem.tsx"
      to: "src/hooks/useLicense.ts"
      via: "import"
      pattern: "useLicense"
    - from: "src/components/elements/Element.tsx"
      to: "src/hooks/useLicense.ts"
      via: "import"
      pattern: "useLicense"
---

<objective>
Add Pro element UI indicators: badges in palette and on canvas, drag blocking for unlicensed users, and "Hide Pro elements" toggle.

Purpose: Users can visually identify which elements require Pro license and understand they cannot use them without upgrading.
Output: Modified PaletteItem with badge/blocking, modified Palette with toggle, modified Element with canvas badge
</objective>

<execution_context>
@C:\Users\User\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\User\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/51-feature-gating-system/51-CONTEXT.md
@.planning/phases/51-feature-gating-system/51-RESEARCH.md
@.planning/phases/51-feature-gating-system/51-01-SUMMARY.md

# Key files to modify
@src/components/Palette/PaletteItem.tsx
@src/components/Palette/Palette.tsx
@src/components/elements/Element.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Pro badge and drag blocking to PaletteItem</name>
  <files>src/components/Palette/PaletteItem.tsx</files>
  <action>
Modify `src/components/Palette/PaletteItem.tsx`:

**Step 1: Add imports at top of file:**
```typescript
import { useLicense } from '../../hooks/useLicense'
import { isProElement } from '../../services/proElements'
```

**Step 2: Inside PaletteItem function, add license check:**
After the existing `const editingContainerId = useStore(...)` line:
```typescript
const { isPro: userIsPro } = useLicense()
const elementIsPro = isProElement(elementType)
const canDrag = !elementIsPro || userIsPro
```

**Step 3: Update useDraggable to disable for Pro elements:**
Change:
```typescript
const { attributes, listeners, setNodeRef, isDragging } = useDraggable({
  id: `palette-${id}`,
  data: { elementType, variant },
})
```
To:
```typescript
const { attributes, listeners, setNodeRef, isDragging } = useDraggable({
  id: `palette-${id}`,
  data: { elementType, variant },
  disabled: !canDrag,  // Disable drag for Pro elements when unlicensed
})
```

**Step 4: Update handleClick to block adding Pro elements in container edit mode:**
At the start of handleClick function, add:
```typescript
if (!canDrag) return  // Block adding Pro elements when unlicensed
```

**Step 5: Update the return JSX:**
Change the outer div to:
```typescript
return (
  <div
    ref={setNodeRef}
    {...(canDrag ? listeners : {})}  // Only attach listeners if can drag
    {...attributes}
    onClick={handleClick}
    className={`
      relative flex flex-col items-center gap-1 p-2
      border border-gray-700 rounded
      ${editingContainerId ? 'cursor-pointer' : canDrag ? 'cursor-grab active:cursor-grabbing' : 'cursor-not-allowed'}
      hover:bg-gray-700 hover:border-gray-600
      transition-colors
      ${isDragging ? 'opacity-50' : 'opacity-100'}
    `}
    title={!canDrag ? 'Pro feature - upgrade to use' : undefined}
  >
    <div className="flex items-center justify-center min-h-16">
      {renderPreview()}
    </div>

    {/* Pro badge overlay */}
    {elementIsPro && !userIsPro && (
      <div
        className="absolute top-1 right-1 bg-violet-500 text-white font-bold px-1.5 py-0.5 rounded pointer-events-none select-none"
        style={{ fontSize: '8px', lineHeight: '10px' }}
      >
        PRO
      </div>
    )}

    <span className="text-xs text-gray-300 text-center">{name}</span>
  </div>
)
```

Key changes:
- Added `relative` class to outer div (for absolute badge positioning)
- Conditional listeners attachment: `{...(canDrag ? listeners : {})}`
- Conditional cursor: `cursor-not-allowed` when can't drag
- Added `title` attribute for tooltip on hover
- Added PRO badge div with violet-500 background, absolute positioning top-1 right-1
  </action>
  <verify>
Run `npm run dev` and verify:
1. Palette items render without errors
2. Pro elements (e.g., Scrolling Waveform in Visualizations) show violet "PRO" badge
3. Pro elements cannot be dragged (cursor shows not-allowed)
4. Free elements (e.g., Knob) still drag normally
5. Hover tooltip shows "Pro feature - upgrade to use" on Pro elements
  </verify>
  <done>
PaletteItem shows PRO badge for Pro elements, disables drag for unlicensed users, shows appropriate cursor.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Hide Pro toggle and Pro element sorting to Palette</name>
  <files>src/components/Palette/Palette.tsx</files>
  <action>
Modify `src/components/Palette/Palette.tsx`:

**Step 1: Add imports:**
```typescript
import { isProElement } from '../../services/proElements'
```

**Step 2: Add hideProElements state:**
After the existing state declarations (around line 211):
```typescript
const [hideProElements, setHideProElements] = useState(() => {
  // Initialize from localStorage
  return localStorage.getItem('palette-hide-pro') === 'true'
})
```

**Step 3: Add toggle handler:**
After handleClear function:
```typescript
const handleToggleHidePro = () => {
  setHideProElements(prev => {
    const newValue = !prev
    localStorage.setItem('palette-hide-pro', String(newValue))
    return newValue
  })
}
```

**Step 4: Update filteredCategories to sort Pro elements to bottom and optionally hide:**
Replace the existing filteredCategories useMemo with:
```typescript
const filteredCategories = useMemo(() => {
  let categories = paletteCategories

  // Sort items within each category: Free first, Pro last
  categories = categories.map((category) => ({
    ...category,
    items: [...category.items].sort((a, b) => {
      const aIsPro = isProElement(a.type)
      const bIsPro = isProElement(b.type)
      if (aIsPro === bIsPro) return 0
      return aIsPro ? 1 : -1  // Pro items go to end
    }),
  }))

  // Filter by search term
  if (searchTerm) {
    categories = categories
      .map((category) => ({
        ...category,
        items: category.items.filter(
          (item) =>
            item.name.toLowerCase().includes(searchTerm) ||
            item.type.toLowerCase().includes(searchTerm)
        ),
      }))
      .filter((category) => category.items.length > 0)
  }

  // Filter out Pro elements if toggle is on
  if (hideProElements) {
    categories = categories
      .map((category) => ({
        ...category,
        items: category.items.filter((item) => !isProElement(item.type)),
      }))
      .filter((category) => category.items.length > 0)
  }

  return categories
}, [searchTerm, hideProElements])
```

**Step 5: Add toggle UI after search bar (before categories):**
After the search bar div (after the closing `</div>` of the search container around line 342), add:
```typescript
{/* Hide Pro elements toggle */}
<div className="px-2 py-1.5 border-b border-gray-700 flex items-center justify-between">
  <span className="text-xs text-gray-400">Hide Pro elements</span>
  <button
    onClick={handleToggleHidePro}
    className={`
      relative w-8 h-4 rounded-full transition-colors
      ${hideProElements ? 'bg-violet-500' : 'bg-gray-600'}
    `}
  >
    <div
      className={`
        absolute top-0.5 w-3 h-3 rounded-full bg-white transition-transform
        ${hideProElements ? 'left-4' : 'left-0.5'}
      `}
    />
  </button>
</div>
```

This creates a mini toggle switch styled consistently with the app.
  </action>
  <verify>
Run `npm run dev` and verify:
1. Toggle appears below search bar
2. Toggle state persists across page refresh (check localStorage)
3. When toggle is ON: Pro elements are hidden from all categories
4. When toggle is OFF: Pro elements appear at bottom of each category
5. Search still works with toggle in either state
  </verify>
  <done>
Palette has "Hide Pro elements" toggle that persists to localStorage, Pro elements sorted to bottom of categories.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add Pro badge overlay to canvas elements</name>
  <files>src/components/elements/Element.tsx</files>
  <action>
Modify `src/components/elements/Element.tsx`:

**Step 1: Add imports at top:**
```typescript
import { useLicense } from '../../hooks/useLicense'
```

**Step 2: Inside ElementComponent function, add license check:**
After the existing `const lockAllMode = useStore(...)` line:
```typescript
const { isPro: userIsPro } = useLicense()
const showProBadge = element.isPro && !userIsPro
```

**Step 3: Add Pro badge overlay in the return JSX:**
Inside the `<BaseElement>` component, after the Suspense block but before the children rendering block, add:
```typescript
{/* Pro badge overlay for unlicensed users */}
{showProBadge && (
  <div
    className="absolute bg-violet-500 text-white font-bold px-2 py-1 rounded pointer-events-none select-none z-50"
    style={{
      fontSize: '10px',
      lineHeight: '12px',
      top: '-4px',
      right: '-4px',
    }}
  >
    PRO
  </div>
)}
```

Note: Using inline style for top/right to position slightly outside the element bounds for visibility. z-50 ensures badge is above element content.
  </action>
  <verify>
Run `npm run dev` and verify:
1. Load a project that contains Pro elements (or manually add via browser console)
2. Pro elements on canvas show violet "PRO" badge in top-right corner
3. Badge is positioned slightly outside element bounds
4. Badge doesn't interfere with element selection or manipulation
5. Free elements have no badge
  </verify>
  <done>
Canvas elements show PRO badge overlay when element.isPro is true and user is unlicensed.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Pro element feature gating UI:
1. Palette shows PRO badges on 43 element types
2. Pro elements cannot be dragged when unlicensed
3. Hide Pro toggle in palette (persists to localStorage)
4. Pro elements sorted to bottom of each category
5. Canvas elements show PRO badge when unlicensed
  </what-built>
  <how-to-verify>
1. Open http://localhost:5173 in browser
2. In palette, check "Visualizations" category - all 5 items should show "PRO" badge
3. Check "Specialized Audio" category - all 12 items should show "PRO" badge
4. Check "Linear Controls" category - "ASCII Slider" should show "PRO" badge, others should not
5. Try to drag "Scrolling Waveform" to canvas - should show cursor-not-allowed and not drag
6. Try to drag "Knob" to canvas - should work normally
7. Toggle "Hide Pro elements" - Pro elements should disappear from palette
8. Refresh page - toggle state should persist
9. (Optional) To test canvas badge: temporarily modify useLicense hook to return isPro: false, then load a project with Pro elements

Verify counts:
- Linear Controls: 1 Pro (ASCII Slider)
- Buttons: 1 Pro (ASCII Button)
- Meters: 23 Pro (all except basic Meter)
- Visualizations: 5 Pro (all)
- Specialized Audio: 12 Pro (all)
- Images & Decorative: 1 Pro (ASCII Art)
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors: `npx tsc --noEmit`
2. Dev server runs without console errors
3. All 43 Pro elements show badges in palette
4. Pro element drag is blocked for unlicensed users
5. Hide Pro toggle works and persists
6. Canvas badge appears on Pro elements when unlicensed
</verification>

<success_criteria>
- PRO badge visible on all 43 Pro element types in palette
- Pro elements cannot be dragged to canvas (cursor shows not-allowed, no drag initiation)
- Hovering Pro element shows tooltip "Pro feature - upgrade to use"
- "Hide Pro elements" toggle filters palette and persists across sessions
- Pro elements sorted to bottom of each category
- Canvas elements with isPro=true show PRO badge when user is unlicensed
- Badge styling: violet-500 background (#8B5CF6), white text, 8-10px font, rounded corners
</success_criteria>

<output>
After completion, create `.planning/phases/51-feature-gating-system/51-02-SUMMARY.md`
</output>
