---
phase: 51-feature-gating-system
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/services/proElements.ts
  - src/types/elements/base.ts
  - src/store/licenseSlice.ts
  - src/hooks/useLicense.ts
  - src/store/index.ts
autonomous: true

must_haves:
  truths:
    - "PRO_ELEMENTS registry contains 43 element type strings"
    - "BaseElementConfig interface includes isPro optional boolean"
    - "LicenseSlice exists in Zustand store with isPro, license, validationState"
    - "useLicense hook returns isPro boolean"
    - "License state persists to localStorage"
  artifacts:
    - path: "src/services/proElements.ts"
      provides: "Pro element type registry"
      exports: ["PRO_ELEMENTS", "isProElement", "ProElementType"]
    - path: "src/types/elements/base.ts"
      provides: "BaseElementConfig with isPro field"
      contains: "isPro?: boolean"
    - path: "src/store/licenseSlice.ts"
      provides: "License state management"
      exports: ["createLicenseSlice", "LicenseSlice"]
    - path: "src/hooks/useLicense.ts"
      provides: "License hook for components"
      exports: ["useLicense"]
  key_links:
    - from: "src/store/index.ts"
      to: "src/store/licenseSlice.ts"
      via: "store composition"
      pattern: "createLicenseSlice"
    - from: "src/hooks/useLicense.ts"
      to: "src/store/index.ts"
      via: "useStore selector"
      pattern: "useStore.*isPro"
---

<objective>
Create the data layer for Pro element feature gating: registry of 43 Pro element types, license state in Zustand with localStorage persistence, and useLicense hook for component access.

Purpose: Establishes the foundation for Pro/Free element classification without UI changes yet. Plan 02 will consume these APIs for visual indicators.
Output: proElements.ts registry, licenseSlice.ts store, useLicense.ts hook, updated BaseElementConfig type
</objective>

<execution_context>
@C:\Users\User\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\User\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/51-feature-gating-system/51-CONTEXT.md
@.planning/phases/51-feature-gating-system/51-RESEARCH.md

# Key files to understand patterns
@src/store/index.ts
@src/store/viewportSlice.ts
@src/types/elements/base.ts
@src/hooks/useDirtyState.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Pro elements registry</name>
  <files>src/services/proElements.ts</files>
  <action>
Create `src/services/proElements.ts` with:

1. `PRO_ELEMENTS` const object mapping element type strings to `true`:
   - ASCII (3): asciislider, asciibutton, asciiart
   - Advanced Meters (23): rmsmetermo, rmsmeterstereo, vumetermono, vumeterstereo, ppmtype1mono, ppmtype1stereo, ppmtype2mono, ppmtype2stereo, truepeakmetermono, truepeakmeterstereo, lufsmomomo, lufsmomostereo, lufsshortmono, lufsshortstereo, lufsintmono, lufsintstereo, k12metermono, k12meterstereo, k14metermono, k14meterstereo, k20metermono, k20meterstereo, correlationmeter, stereowidthmeter
   - Visualizations (5): scrollingwaveform, spectrumanalyzer, spectrogram, goniometer, vectorscope
   - Specialized Audio (12): pianokeyboard, drumpad, padgrid, stepsequencer, xypad, wavetabledisplay, harmoniceditor, looppoints, envelopeeditor, sampledisplay, patchbay, signalflow

2. Export `ProElementType` type from `keyof typeof PRO_ELEMENTS`

3. Export `isProElement(elementType: string): boolean` function that returns `elementType in PRO_ELEMENTS`

Use `as const` for type safety on PRO_ELEMENTS object.

Note: Total count is 43 elements (3+23+5+12), slightly more than roadmap's 42 due to mono/stereo variants being counted. This is correct.
  </action>
  <verify>
Run `npx tsc --noEmit` to verify no type errors.
Grep for "PRO_ELEMENTS" in the new file to confirm export.
  </verify>
  <done>
proElements.ts exports PRO_ELEMENTS (43 entries), ProElementType, and isProElement function.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add isPro to BaseElementConfig and create license slice</name>
  <files>src/types/elements/base.ts, src/store/licenseSlice.ts, src/hooks/useLicense.ts, src/store/index.ts</files>
  <action>
**Step 1: Update BaseElementConfig (src/types/elements/base.ts)**

Add `isPro?: boolean` field to BaseElementConfig interface after the `layerId` field:
```typescript
// Pro feature gating (optional)
isPro?: boolean  // true = Pro element, undefined/false = Free element
```

**Step 2: Create licenseSlice.ts (src/store/licenseSlice.ts)**

Create new slice with:

```typescript
import { StateCreator } from 'zustand'

export interface LicenseData {
  key: string
  email: string
  validUntil: number  // Unix timestamp ms
}

export interface LicenseSlice {
  // License state
  isPro: boolean
  license: LicenseData | null
  validationState: 'unchecked' | 'validating' | 'valid' | 'invalid' | 'expired'
  lastValidation: number | null

  // Actions
  setLicense: (license: LicenseData | null) => void
  setValidationState: (state: LicenseSlice['validationState']) => void
  clearLicense: () => void
}

export const createLicenseSlice: StateCreator<LicenseSlice, [], [], LicenseSlice> = (set) => ({
  isPro: false,
  license: null,
  validationState: 'unchecked',
  lastValidation: null,

  setLicense: (license) => {
    // Persist to localStorage
    if (license) {
      localStorage.setItem('faceplate-license', JSON.stringify({
        license,
        lastValidation: Date.now(),
      }))
    } else {
      localStorage.removeItem('faceplate-license')
    }

    set({
      license,
      isPro: !!license,
      validationState: license ? 'valid' : 'invalid',
      lastValidation: license ? Date.now() : null,
    })
  },

  setValidationState: (validationState) => set({ validationState }),

  clearLicense: () => {
    localStorage.removeItem('faceplate-license')
    set({
      license: null,
      isPro: false,
      validationState: 'unchecked',
      lastValidation: null,
    })
  },
})

// Initialize from localStorage on app load
export function initializeLicenseFromStorage(): Partial<LicenseSlice> {
  try {
    const stored = localStorage.getItem('faceplate-license')
    if (!stored) return {}

    const { license, lastValidation } = JSON.parse(stored)
    const SEVEN_DAYS = 7 * 24 * 60 * 60 * 1000
    const isExpired = !lastValidation || (Date.now() - lastValidation) > SEVEN_DAYS

    return {
      license: isExpired ? null : license,
      isPro: !isExpired && !!license,
      validationState: isExpired ? 'expired' : (license ? 'valid' : 'unchecked'),
      lastValidation: isExpired ? null : lastValidation,
    }
  } catch {
    return {}
  }
}
```

**Step 3: Create useLicense hook (src/hooks/useLicense.ts)**

```typescript
import { useStore } from '../store'

export function useLicense() {
  const isPro = useStore((state) => state.isPro)
  const validationState = useStore((state) => state.validationState)
  const license = useStore((state) => state.license)
  const setLicense = useStore((state) => state.setLicense)
  const clearLicense = useStore((state) => state.clearLicense)

  return {
    isPro,
    isValidating: validationState === 'validating',
    isExpired: validationState === 'expired',
    license,
    setLicense,
    clearLicense,
  }
}
```

**Step 4: Integrate into store (src/store/index.ts)**

1. Add imports at top:
```typescript
import { createLicenseSlice, LicenseSlice, initializeLicenseFromStorage } from './licenseSlice'
```

2. Add `LicenseSlice` to Store type union

3. Add `...createLicenseSlice(...a),` to the store creator (after other slices)

4. Add license state fields to the `partialize` destructuring (to exclude from undo history):
```typescript
isPro, license, validationState, lastValidation,
```

5. After store creation, initialize from localStorage:
```typescript
// Initialize license from localStorage
const licenseInit = initializeLicenseFromStorage()
if (Object.keys(licenseInit).length > 0) {
  useStore.setState(licenseInit)
}
```
  </action>
  <verify>
Run `npx tsc --noEmit` to verify no type errors.
Run `npm run dev` and check browser console for errors.
Check browser DevTools > Application > Local Storage for `faceplate-license` key structure.
  </verify>
  <done>
- BaseElementConfig has `isPro?: boolean` field
- licenseSlice.ts exports createLicenseSlice, LicenseSlice, initializeLicenseFromStorage
- useLicense.ts hook exports useLicense function
- Store type includes LicenseSlice, license state excluded from undo history
- License state initializes from localStorage on app load
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors: `npx tsc --noEmit`
2. Dev server starts without errors: `npm run dev`
3. In browser console, verify:
   - `import('./src/services/proElements').then(m => console.log(Object.keys(m.PRO_ELEMENTS).length))` returns 43
   - Store has license-related state accessible
4. localStorage has correct structure when license is set (test in Phase 52)
</verification>

<success_criteria>
- PRO_ELEMENTS contains exactly 43 element types
- isProElement('scrollingwaveform') returns true
- isProElement('button') returns false
- useLicense hook returns { isPro: false, ... } by default
- License state excluded from undo/redo history
- No TypeScript errors
- Dev server runs without console errors
</success_criteria>

<output>
After completion, create `.planning/phases/51-feature-gating-system/51-01-SUMMARY.md`
</output>
