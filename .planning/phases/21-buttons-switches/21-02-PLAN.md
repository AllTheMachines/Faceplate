---
phase: 21-buttons-switches
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/types/elements/controls.ts
  - src/components/elements/renderers/controls/RockerSwitchRenderer.tsx
  - src/components/elements/renderers/controls/RotarySwitchRenderer.tsx
  - src/components/elements/renderers/controls/SegmentButtonRenderer.tsx
  - src/components/elements/renderers/controls/index.ts
  - src/components/elements/renderers/index.ts
autonomous: true

must_haves:
  truths:
    - "User can add Rocker Switch with 3-position up/center/down states"
    - "Rocker Switch supports both spring-to-center and latch-all modes"
    - "User can add Rotary Switch with configurable 2-12 positions"
    - "Rotary Switch displays position labels appropriately for position count"
    - "User can add Segment Button with 2-8 segments in single or multi-select mode"
    - "Segment Button segments can show icon, text, or icon+text"
  artifacts:
    - path: "src/types/elements/controls.ts"
      provides: "RockerSwitchElementConfig, RotarySwitchElementConfig, SegmentButtonElementConfig"
      contains: "type: 'rockerswitch'"
    - path: "src/components/elements/renderers/controls/RockerSwitchRenderer.tsx"
      provides: "Rocker Switch rendering with 3 positions"
      exports: ["RockerSwitchRenderer"]
    - path: "src/components/elements/renderers/controls/RotarySwitchRenderer.tsx"
      provides: "Rotary Switch rendering with labels"
      exports: ["RotarySwitchRenderer"]
    - path: "src/components/elements/renderers/controls/SegmentButtonRenderer.tsx"
      provides: "Segment Button rendering with icon/text segments"
      exports: ["SegmentButtonRenderer"]
  key_links:
    - from: "src/components/elements/renderers/index.ts"
      to: "rendererRegistry"
      via: "Map.set for rockerswitch, rotaryswitch, segmentbutton"
      pattern: "\\['rockerswitch'"
---

<objective>
Implement three multi-position switch element types: Rocker Switch, Rotary Switch, and Segment Button.

Purpose: Provide audio plugin designers with multi-state selection controls - 3-position switches for pitch bend/mode selection, vintage-style rotary selectors, and iOS-style segmented controls.

Output: Three new switch types with element configs, renderers, and registry entries supporting various position counts and selection modes.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21-buttons-switches/21-CONTEXT.md
@.planning/phases/21-buttons-switches/21-RESEARCH.md

# Existing patterns to extend
@src/types/elements/controls.ts
@src/components/elements/renderers/controls/ButtonRenderer.tsx
@src/components/elements/renderers/controls/index.ts
@src/components/elements/renderers/index.ts
@src/utils/builtInIcons.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create switch element types</name>
  <files>
    src/types/elements/controls.ts
  </files>
  <action>
    Add three new element configurations to controls.ts:

    1. **RockerSwitchElementConfig:**
       - type: 'rockerswitch'
       - position: 0 | 1 | 2 (0=down, 1=center, 2=up)
       - mode: 'spring-to-center' | 'latch-all-positions'
       - showLabels: boolean
       - upLabel, downLabel: string (default 'UP', 'DN')
       - backgroundColor, switchColor, borderColor, labelColor

    2. **RotarySwitchElementConfig:**
       - type: 'rotaryswitch'
       - positionCount: number (2-12)
       - currentPosition: number (0 to positionCount-1)
       - positionLabels: string[] | null (if null, show numbers 1-N)
       - rotationAngle: number (total rotation range, default 270)
       - labelLayout: 'radial' | 'legend' (radial for 2-6 positions, legend for 7-12)
       - backgroundColor, pointerColor, labelColor, labelFontSize, borderColor

    3. **SegmentButtonElementConfig:**
       - type: 'segmentbutton'
       - segmentCount: number (2-8)
       - segments: SegmentConfig[] (array of segment definitions)
       - selectionMode: 'single' | 'multi'
       - selectedIndices: number[] (which segments are selected)
       - orientation: 'horizontal' | 'vertical'
       - backgroundColor, selectedColor, textColor, selectedTextColor, borderColor

    Also add **SegmentConfig** interface:
    - displayMode: 'icon' | 'text' | 'icon-text'
    - iconSource?: 'builtin' | 'asset'
    - builtInIcon?: BuiltInIcon
    - assetId?: string
    - text?: string

    Add type guards: isRockerSwitch, isRotarySwitch, isSegmentButton
    Add factory functions: createRockerSwitch, createRotarySwitch, createSegmentButton
    Add to ControlElement union type.

    **Factory function defaults:**
    - createRockerSwitch: position 1 (center), latch-all-positions mode
    - createRotarySwitch: 4 positions, position 0, null labels (shows 1-4)
    - createSegmentButton: 3 segments with text-only ['A', 'B', 'C'], single select, selectedIndices [0]
  </action>
  <verify>
    npm run build succeeds.
    grep "rockerswitch" src/types/elements/controls.ts returns interface definition.
    grep "SegmentConfig" src/types/elements/controls.ts returns interface.
  </verify>
  <done>
    Three switch element types defined with proper configs.
    SegmentConfig interface defined for segment content.
    Type guards and factory functions created.
    ControlElement union includes all three types.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create switch renderers</name>
  <files>
    src/components/elements/renderers/controls/RockerSwitchRenderer.tsx
    src/components/elements/renderers/controls/RotarySwitchRenderer.tsx
    src/components/elements/renderers/controls/SegmentButtonRenderer.tsx
    src/components/elements/renderers/controls/index.ts
    src/components/elements/renderers/index.ts
  </files>
  <action>
    **RockerSwitchRenderer.tsx:**
    - Vertical track with 3 positions (top, center, bottom)
    - Switch paddle that moves to current position
    - Calculate paddle offset based on position:
      - position 2 (up): offset = 0
      - position 1 (center): offset = (height - paddleHeight) / 2
      - position 0 (down): offset = height - paddleHeight
    - Show position indicator on paddle (↑, ─, ↓)
    - Optional labels on right side (UP at top, DN at bottom)
    - transition: none for instant position change
    - Hover: brightness(1.05) on paddle

    **RotarySwitchRenderer.tsx:**
    - Circular switch body with rotating pointer/indicator
    - Calculate angle per position: rotationAngle / (positionCount - 1)
    - Current angle: -rotationAngle/2 + currentPosition * anglePerPosition
    - Pointer rotates to show current position
    - Labels rendered based on labelLayout:
      - 'radial': Labels around the switch edge (use trig for positions)
      - 'legend': Vertical list beside the switch
    - Highlight current position label (bold/brighter)
    - transition: none for instant rotation
    - Hover: brightness(1.05) on switch body

    **SegmentButtonRenderer.tsx:**
    - Flexbox container (row for horizontal, column for vertical)
    - Each segment: flex: 1, centered content
    - Segment content based on displayMode:
      - 'icon': Render icon from builtInIconSVG or asset library (use SafeSVG pattern)
      - 'text': Render text span with ellipsis overflow
      - 'icon-text': Icon + text side by side with gap
    - Selected segments: backgroundColor = selectedColor, color = selectedTextColor
    - Unselected: transparent background, regular textColor
    - Dividers between segments using borders
    - transition: none for instant selection change
    - Hover on segments: brightness(1.05)

    **Register all three:**
    - Export from controls/index.ts
    - Add to rendererRegistry in main index.ts

    **Note on icon usage in SegmentButtonRenderer:**
    Import builtInIconSVG from utils/builtInIcons.ts (created in Plan 01, but can fall back to empty icon if not available during parallel execution - registry will work regardless)
  </action>
  <verify>
    npm run build succeeds.
    grep "RockerSwitchRenderer" src/components/elements/renderers/controls/index.ts returns export.
    grep "rockerswitch" src/components/elements/renderers/index.ts returns registry entry.
  </verify>
  <done>
    Three switch renderers created with proper multi-position rendering.
    RockerSwitch shows 3 positions with paddle.
    RotarySwitch rotates pointer and displays labels.
    SegmentButton renders segments with icon/text support.
    All use transition: none for instant state changes.
    All registered in rendererRegistry.
  </done>
</task>

</tasks>

<verification>
1. TypeScript build: `npm run build` completes with no errors
2. Type verification:
   - grep "RockerSwitchElementConfig" src/types/elements/controls.ts returns interface
   - grep "RotarySwitchElementConfig" src/types/elements/controls.ts returns interface
   - grep "SegmentButtonElementConfig" src/types/elements/controls.ts returns interface
3. Registry verification:
   - `grep "rockerswitch" src/components/elements/renderers/index.ts` returns 1 entry
   - `grep "rotaryswitch" src/components/elements/renderers/index.ts` returns 1 entry
   - `grep "segmentbutton" src/components/elements/renderers/index.ts` returns 1 entry
4. Factory verification:
   - grep "createRockerSwitch" src/types/elements/controls.ts returns function
   - grep "createRotarySwitch" src/types/elements/controls.ts returns function
   - grep "createSegmentButton" src/types/elements/controls.ts returns function
</verification>

<success_criteria>
- All three switch types compile without errors
- Renderers display correct visual appearance:
  - Rocker Switch: vertical track with movable paddle in 3 positions
  - Rotary Switch: circular with rotating pointer and position labels
  - Segment Button: horizontal/vertical segments with selection highlighting
- Position counts are configurable (3 for Rocker, 2-12 for Rotary, 2-8 for Segment)
- All state transitions are instant (transition: none)
- Segment Button supports icon, text, and icon+text content modes
- Renderers registered in rendererRegistry
</success_criteria>

<output>
After completion, create `.planning/phases/21-buttons-switches/21-02-SUMMARY.md`
</output>
