---
phase: 42-layers-panel
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/types/layer.ts
  - src/store/layersSlice.ts
  - src/store/index.ts
  - src/types/elements/base.ts
autonomous: true

must_haves:
  truths:
    - "Layer types exist with id, name, color, visible, locked, order fields"
    - "Default layer auto-created with id='default', cannot be deleted"
    - "layersSlice provides CRUD actions for layers"
    - "Elements have optional layerId field defaulting to 'default'"
  artifacts:
    - path: "src/types/layer.ts"
      provides: "Layer interface and LayerColor type"
      exports: ["Layer", "LayerColor", "LAYER_COLOR_MAP", "LAYER_COLORS"]
    - path: "src/store/layersSlice.ts"
      provides: "Layer state management"
      exports: ["LayersSlice", "createLayersSlice"]
    - path: "src/store/index.ts"
      provides: "Store composition with layers"
      contains: "createLayersSlice"
    - path: "src/types/elements/base.ts"
      provides: "Element-layer association"
      contains: "layerId"
  key_links:
    - from: "src/store/index.ts"
      to: "src/store/layersSlice.ts"
      via: "import and slice composition"
      pattern: "createLayersSlice"
    - from: "src/store/layersSlice.ts"
      to: "src/types/layer.ts"
      via: "type imports"
      pattern: "import.*Layer.*from"
---

<objective>
Create the foundational layer state management system.

Purpose: Establish types, constants, and Zustand slice for layer CRUD operations. This enables all subsequent plans to work with layer data.
Output: Layer types, layersSlice integrated into store, layerId field on elements
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/42-layers-panel/42-CONTEXT.md
@.planning/phases/42-layers-panel/42-RESEARCH.md

@src/store/windowsSlice.ts (pattern reference for slice structure)
@src/store/index.ts (store composition pattern)
@src/types/elements/base.ts (BaseElementConfig to extend)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create layer types and constants</name>
  <files>src/types/layer.ts</files>
  <action>
Create `src/types/layer.ts` with:

1. LayerColor type - 7 Photoshop-style colors: 'red', 'orange', 'yellow', 'green', 'blue', 'purple', 'gray'

2. LAYER_COLOR_MAP constant - maps LayerColor to Tailwind hex values:
   - red: '#ef4444'
   - orange: '#f97316'
   - yellow: '#eab308'
   - green: '#22c55e'
   - blue: '#3b82f6'
   - purple: '#a855f7'
   - gray: '#6b7280'

3. LAYER_COLORS array - ordered list of LayerColor values for dropdowns

4. Layer interface:
   - id: string (UUID, 'default' for default layer)
   - name: string
   - color: LayerColor
   - visible: boolean
   - locked: boolean
   - order: number (explicit z-order field, 0 = bottom)
   - createdAt: number

5. DEFAULT_LAYER constant - pre-configured default layer object with id='default', name='Default', color='gray', order=0

Export all types and constants.
  </action>
  <verify>TypeScript compiles without errors: `npx tsc --noEmit`</verify>
  <done>Layer types and constants exported, DEFAULT_LAYER constant available</done>
</task>

<task type="auto">
  <name>Task 2: Create layersSlice with CRUD actions</name>
  <files>src/store/layersSlice.ts</files>
  <action>
Create `src/store/layersSlice.ts` following windowsSlice.ts pattern:

1. Import StateCreator from 'zustand' and Layer types from '../types/layer'

2. Define LayersSlice interface:
   State:
   - layers: Layer[]
   - selectedLayerId: string | null

   Actions:
   - addLayer(name: string, color: LayerColor) => string (returns new layer ID)
   - removeLayer(id: string) => void (NO-OP if id === 'default')
   - updateLayer(id: string, updates: Partial<Layer>) => void
   - reorderLayers(startIndex: number, endIndex: number) => void
   - toggleVisibility(id: string) => void
   - toggleLock(id: string) => void
   - selectLayer(id: string | null) => void
   - setLayers(layers: Layer[]) => void

   Selectors:
   - getLayerById(id: string) => Layer | undefined
   - getLayersInOrder() => Layer[] (sorted by order field)
   - getDefaultLayer() => Layer

3. Create createLayersSlice StateCreator:
   - Initialize with DEFAULT_LAYER in layers array
   - selectedLayerId defaults to null

   addLayer implementation:
   - Create new layer with crypto.randomUUID(), given name/color
   - Set order = layers.length (add at top)
   - Append to layers array
   - Return new ID

   removeLayer implementation:
   - Return early if id === 'default' (cannot delete default layer)
   - Filter out layer from array
   - Recalculate order fields for remaining layers (keep default at 0)
   - If selectedLayerId was deleted, set to null

   reorderLayers implementation:
   - Return early if trying to move default layer (startIndex is default)
   - Return early if trying to drop below default layer (endIndex is 0)
   - Splice layers array to reorder
   - Recalculate order fields (default always stays at order=0)

   toggleVisibility/toggleLock:
   - Map over layers, toggle visible/locked for matching id

   getLayersInOrder:
   - Return [...layers].sort((a, b) => a.order - b.order)

Export LayersSlice interface and createLayersSlice.
  </action>
  <verify>`npx tsc --noEmit` passes, layersSlice exports are correct</verify>
  <done>layersSlice provides full CRUD, default layer protected from deletion</done>
</task>

<task type="auto">
  <name>Task 3: Integrate layersSlice into store and add layerId to elements</name>
  <files>src/store/index.ts, src/types/elements/base.ts</files>
  <action>
1. Update `src/store/index.ts`:
   - Import createLayersSlice, LayersSlice from './layersSlice'
   - Add LayersSlice to Store type union
   - Add createLayersSlice(...a) to store composition
   - Add selectedLayerId to partialize exclusion list (layer selection is UI state, not undoable)

2. Update `src/types/elements/base.ts`:
   - Add optional layerId field to BaseElementConfig:
     ```
     layerId?: string // Layer assignment (defaults to 'default' if not set)
     ```
   - Add comment explaining the field's purpose

This enables elements to be associated with layers while maintaining backward compatibility (layerId is optional, defaults to 'default').
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - `npm run dev` starts without errors
    - In browser console: `useStore.getState().layers` returns array with default layer
  </verify>
  <done>LayersSlice integrated into store, elements can have layerId, app runs without errors</done>
</task>

</tasks>

<verification>
1. TypeScript compilation: `npx tsc --noEmit`
2. Dev server starts: `npm run dev`
3. Console check: `useStore.getState().layers` returns `[{id: 'default', name: 'Default', ...}]`
4. Console check: `useStore.getState().addLayer('Test', 'blue')` returns UUID
5. Console check: `useStore.getState().layers.length` is now 2
6. Console check: `useStore.getState().removeLayer('default')` does nothing (default protected)
</verification>

<success_criteria>
- Layer types exported from src/types/layer.ts
- layersSlice integrated into Zustand store
- Default layer auto-created and protected from deletion
- Elements have optional layerId field
- All existing functionality unaffected
</success_criteria>

<output>
After completion, create `.planning/phases/42-layers-panel/42-01-SUMMARY.md`
</output>
