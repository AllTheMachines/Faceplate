---
phase: 42-layers-panel
plan: 05
type: execute
wave: 4
depends_on: ["42-03", "42-04"]
files_modified:
  - src/components/Layers/LayersPanel.tsx
  - src/components/Layers/LayerRow.tsx
  - src/components/Layers/DeleteLayerDialog.tsx
  - src/components/Canvas/CanvasStage.tsx
  - src/components/Canvas/TransformerComponent.tsx
autonomous: true

must_haves:
  truths:
    - "Clicking layer in panel selects first element in that layer on canvas"
    - "Selecting element on canvas highlights its layer in the panel"
    - "User can right-click canvas element to see 'Move to Layer' submenu"
    - "User can delete a layer via trash icon (with confirmation showing element count)"
    - "Deleting default layer is not allowed"
    - "Selected elements show layer color on selection handles"
  artifacts:
    - path: "src/components/Layers/DeleteLayerDialog.tsx"
      provides: "Confirmation dialog for layer deletion"
      min_lines: 40
    - path: "src/components/Canvas/CanvasStage.tsx"
      provides: "Context menu with Move to Layer option"
      contains: "Move to Layer"
    - path: "src/components/Canvas/TransformerComponent.tsx"
      provides: "Transformer with layer color styling"
      contains: "LAYER_COLOR_MAP"
  key_links:
    - from: "src/components/Layers/LayersPanel.tsx"
      to: "src/store/elementsSlice.ts"
      via: "selectElement when clicking layer"
      pattern: "selectElement"
    - from: "src/components/Canvas/CanvasStage.tsx"
      to: "src/store/elementsSlice.ts"
      via: "updateElement to change layerId"
      pattern: "updateElement.*layerId"
---

<objective>
Implement selection sync between canvas and layers panel, context menu layer assignment, and delete layer functionality.

Purpose: Complete the bidirectional interaction between layers panel and canvas. Users can navigate from either direction and manage layer assignments.
Output: Full layer-canvas integration with selection sync, context menu, delete confirmation, and layer color on selection handles
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/42-layers-panel/42-CONTEXT.md
@.planning/phases/42-layers-panel/42-RESEARCH.md
@.planning/phases/42-layers-panel/42-03-SUMMARY.md
@.planning/phases/42-layers-panel/42-04-SUMMARY.md

@src/components/Layers/LayersPanel.tsx (selection sync)
@src/components/Canvas/CanvasStage.tsx (context menu)
@src/components/Canvas/TransformerComponent.tsx (layer color styling)
@src/components/Layout/WindowTabs.tsx (context menu pattern reference)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement bidirectional selection sync</name>
  <files>src/components/Layers/LayersPanel.tsx, src/components/Layers/LayerRow.tsx</files>
  <action>
Update selection sync between layers panel and canvas:

**In LayersPanel.tsx:**

1. Get elements and selectElement from store:
   ```typescript
   const elements = useStore((state) => state.elements)
   const selectedIds = useStore((state) => state.selectedIds)
   const selectElement = useStore((state) => state.selectElement)
   const clearSelection = useStore((state) => state.clearSelection)
   ```

2. Compute which layers contain selected elements (canvas -> layers):
   ```typescript
   const layersWithSelectedElements = useMemo(() => {
     const layerIds = new Set<string>()
     selectedIds.forEach(id => {
       const element = elements.find(el => el.id === id)
       if (element) {
         layerIds.add(element.layerId || 'default')
       }
     })
     return layerIds
   }, [selectedIds, elements])
   ```

3. Pass highlight state to LayerRow:
   ```typescript
   <LayerRow
     layer={layer}
     isSelected={selectedLayerId === layer.id}
     hasSelectedElements={layersWithSelectedElements.has(layer.id)}
     onSelect={handleLayerClick}
     ...
   />
   ```

4. Handle layer click (layers -> canvas):
   ```typescript
   const handleLayerClick = (layerId: string) => {
     selectLayer(layerId)

     // Find first visible element in this layer and select it
     const layerElements = elements.filter(el =>
       (el.layerId || 'default') === layerId
     )
     if (layerElements.length > 0) {
       selectElement(layerElements[0].id)
     } else {
       clearSelection()
     }
   }
   ```

**In LayerRow.tsx:**

5. Add hasSelectedElements prop:
   ```typescript
   interface LayerRowProps {
     layer: Layer
     isSelected: boolean
     hasSelectedElements: boolean
     onSelect: (id: string) => void
     dragHandle?: React.RefObject<HTMLDivElement>
   }
   ```

6. Show visual indicator when layer contains selected canvas elements:
   ```jsx
   <div className={`flex items-center gap-2 px-3 py-2 cursor-pointer hover:bg-gray-700
     ${isSelected ? 'bg-gray-700' : ''}
     ${hasSelectedElements && !isSelected ? 'border-l-2 border-blue-400' : ''}
     ${!layer.visible ? 'opacity-50' : ''}`}
   >
   ```

This provides visual feedback: blue left border when layer contains selected elements.
  </action>
  <verify>
    - Click layer in panel - first element in that layer gets selected on canvas
    - Select element on canvas - its layer shows blue border in panel
    - Multi-select elements from multiple layers - multiple layers show blue border
  </verify>
  <done>Bidirectional selection sync between layers panel and canvas</done>
</task>

<task type="auto">
  <name>Task 2: Create DeleteLayerDialog with element count</name>
  <files>src/components/Layers/DeleteLayerDialog.tsx</files>
  <action>
Create `src/components/Layers/DeleteLayerDialog.tsx`:

1. Import dependencies:
   ```typescript
   import { useStore } from '../../store'
   import type { Layer } from '../../types/layer'
   ```

2. Props interface:
   ```typescript
   interface DeleteLayerDialogProps {
     layer: Layer
     isOpen: boolean
     onClose: () => void
   }
   ```

3. Get required data and actions:
   ```typescript
   const elements = useStore((state) => state.elements)
   const removeLayer = useStore((state) => state.removeLayer)
   const removeElement = useStore((state) => state.removeElement)

   // Count elements in this layer
   const elementsInLayer = elements.filter(el =>
     (el.layerId || 'default') === layer.id
   )
   const elementCount = elementsInLayer.length
   ```

4. Handle delete:
   ```typescript
   const handleDelete = () => {
     // Delete all elements in this layer first
     elementsInLayer.forEach(el => removeElement(el.id))
     // Then delete the layer
     removeLayer(layer.id)
     onClose()
   }
   ```

5. Render modal dialog:
   ```jsx
   if (!isOpen) return null

   return (
     <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
       <div className="bg-gray-800 rounded-lg p-6 max-w-md w-full mx-4 shadow-xl">
         <h2 className="text-lg font-semibold text-white mb-4">Delete Layer?</h2>

         <p className="text-gray-300 mb-6">
           {elementCount > 0 ? (
             <>
               Delete layer <span className="font-semibold">"{layer.name}"</span> and
               all <span className="font-semibold text-red-400">{elementCount}</span> element{elementCount !== 1 ? 's' : ''} inside it?
               <br /><br />
               <span className="text-gray-400 text-sm">This action cannot be undone.</span>
             </>
           ) : (
             <>
               Delete empty layer <span className="font-semibold">"{layer.name}"</span>?
             </>
           )}
         </p>

         <div className="flex gap-3 justify-end">
           <button
             onClick={onClose}
             className="px-4 py-2 bg-gray-700 text-gray-300 rounded hover:bg-gray-600"
             autoFocus
           >
             Cancel
           </button>
           <button
             onClick={handleDelete}
             className="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-500"
           >
             Delete
           </button>
         </div>
       </div>
     </div>
   )
   ```

6. Export component.
  </action>
  <verify>Dialog renders with layer name and element count, cancel closes, delete removes layer and elements</verify>
  <done>DeleteLayerDialog shows confirmation with element count, deletes layer and its elements</done>
</task>

<task type="auto">
  <name>Task 3: Add delete button to LayerRow and wire to dialog</name>
  <files>src/components/Layers/LayerRow.tsx, src/components/Layers/LayersPanel.tsx</files>
  <action>
**In LayerRow.tsx:**

1. Add onDelete prop:
   ```typescript
   interface LayerRowProps {
     layer: Layer
     isSelected: boolean
     hasSelectedElements: boolean
     onSelect: (id: string) => void
     onDelete: (layer: Layer) => void
     dragHandle?: React.RefObject<HTMLDivElement>
   }
   ```

2. Add delete button after lock toggle (only for non-default layers):
   ```jsx
   {/* Delete button */}
   {layer.id !== 'default' && (
     <button
       onClick={(e) => {
         e.stopPropagation()
         onDelete(layer)
       }}
       className="p-1 rounded hover:bg-gray-600 text-gray-600 hover:text-red-400"
       title="Delete layer"
     >
       <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
         <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2}
           d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
       </svg>
     </button>
   )}
   ```

**In LayersPanel.tsx:**

3. Add state for delete dialog:
   ```typescript
   const [layerToDelete, setLayerToDelete] = useState<Layer | null>(null)
   ```

4. Import DeleteLayerDialog:
   ```typescript
   import { DeleteLayerDialog } from './DeleteLayerDialog'
   ```

5. Pass onDelete to LayerRow:
   ```typescript
   <LayerRow
     layer={layer}
     isSelected={selectedLayerId === layer.id}
     hasSelectedElements={layersWithSelectedElements.has(layer.id)}
     onSelect={handleLayerClick}
     onDelete={(layer) => setLayerToDelete(layer)}
     dragHandle={dragHandle}
   />
   ```

6. Add DeleteLayerDialog at end of component:
   ```jsx
   {layerToDelete && (
     <DeleteLayerDialog
       layer={layerToDelete}
       isOpen={!!layerToDelete}
       onClose={() => setLayerToDelete(null)}
     />
   )}
   ```

7. Update index.ts to export DeleteLayerDialog if needed.
  </action>
  <verify>
    - Trash icon appears on non-default layers
    - Clicking trash opens confirmation dialog
    - Dialog shows element count
    - Cancel closes dialog
    - Delete removes layer and all its elements
    - Default layer has no trash icon
  </verify>
  <done>Delete button on non-default layers opens confirmation dialog before deleting</done>
</task>

<task type="auto">
  <name>Task 4: Add "Move to Layer" context menu on canvas</name>
  <files>src/components/Canvas/CanvasStage.tsx</files>
  <action>
Update `src/components/Canvas/CanvasStage.tsx` to add "Move to Layer" option in context menu:

1. Import layer-related items:
   ```typescript
   import { LAYER_COLOR_MAP } from '../../types/layer'
   ```

2. Get layer state from store:
   ```typescript
   const layers = useStore((state) => state.getLayersInOrder())
   const updateElement = useStore((state) => state.updateElement)
   ```

3. Add context menu state (if not already present):
   ```typescript
   const [contextMenu, setContextMenu] = useState<{
     visible: boolean
     x: number
     y: number
     elementId: string | null
   }>({ visible: false, x: 0, y: 0, elementId: null })
   ```

4. Handle right-click on elements:
   ```typescript
   const handleContextMenu = (e: KonvaEventObject<MouseEvent>, elementId: string) => {
     e.evt.preventDefault()
     setContextMenu({
       visible: true,
       x: e.evt.clientX,
       y: e.evt.clientY,
       elementId,
     })
   }
   ```

5. Add onContextMenu handler to element shapes.

6. Create context menu component/JSX with "Move to Layer" submenu:
   ```jsx
   {contextMenu.visible && contextMenu.elementId && (
     <div
       className="fixed bg-gray-800 rounded shadow-lg py-1 z-50 min-w-48"
       style={{ left: contextMenu.x, top: contextMenu.y }}
     >
       {/* Existing menu items... */}

       {/* Move to Layer submenu */}
       <div className="relative group">
         <div className="px-4 py-2 text-sm text-gray-300 hover:bg-gray-700 cursor-pointer flex items-center justify-between">
           <span>Move to Layer</span>
           <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
             <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" />
           </svg>
         </div>

         {/* Submenu */}
         <div className="absolute left-full top-0 bg-gray-800 rounded shadow-lg py-1 min-w-40 hidden group-hover:block">
           {layers.map((layer) => {
             const element = elements.find(el => el.id === contextMenu.elementId)
             const currentLayerId = element?.layerId || 'default'
             const isCurrentLayer = currentLayerId === layer.id

             return (
               <button
                 key={layer.id}
                 onClick={() => {
                   updateElement(contextMenu.elementId!, { layerId: layer.id })
                   setContextMenu(prev => ({ ...prev, visible: false }))
                 }}
                 className={`w-full px-4 py-2 text-sm text-left flex items-center gap-2 hover:bg-gray-700 ${
                   isCurrentLayer ? 'text-blue-400' : 'text-gray-300'
                 }`}
               >
                 <span
                   className="w-3 h-3 rounded-full flex-shrink-0"
                   style={{ backgroundColor: LAYER_COLOR_MAP[layer.color] }}
                 />
                 {layer.name}
                 {isCurrentLayer && <span className="ml-auto">âœ“</span>}
               </button>
             )
           })}
         </div>
       </div>
     </div>
   )}
   ```

7. Close context menu when clicking outside:
   ```typescript
   useEffect(() => {
     const handleClickOutside = () => setContextMenu(prev => ({ ...prev, visible: false }))
     if (contextMenu.visible) {
       document.addEventListener('click', handleClickOutside)
       return () => document.removeEventListener('click', handleClickOutside)
     }
   }, [contextMenu.visible])
   ```

Note: If context menu already exists, integrate "Move to Layer" as new menu item. If not, create the full context menu infrastructure.
  </action>
  <verify>
    - Right-click element on canvas
    - Context menu appears with "Move to Layer" option
    - Hovering shows submenu with all layers
    - Current layer has checkmark
    - Clicking layer moves element
    - Menu closes after selection
  </verify>
  <done>Right-click context menu on canvas elements has "Move to Layer" submenu</done>
</task>

<task type="auto">
  <name>Task 5: Add layer color to selection handles (Transformer)</name>
  <files>src/components/Canvas/TransformerComponent.tsx</files>
  <action>
Update `src/components/Canvas/TransformerComponent.tsx` (or equivalent) to show layer color on selection handles:

1. Import layer color map:
   ```typescript
   import { LAYER_COLOR_MAP } from '../../types/layer'
   ```

2. Get layer data for selected element:
   ```typescript
   const getLayerById = useStore((state) => state.getLayerById)

   // Get the first selected element's layer color
   const selectedElement = useStore((state) => {
     const firstId = state.selectedIds[0]
     return firstId ? state.getElement(firstId) : null
   })

   const layerId = selectedElement?.layerId || 'default'
   const layer = getLayerById(layerId)
   const layerColor = layer ? LAYER_COLOR_MAP[layer.color] : '#6b7280'
   ```

3. Apply layer color to Transformer styling (Konva Transformer props):
   ```jsx
   <Transformer
     ref={transformerRef}
     nodes={selectedNodes}
     borderStroke={layerColor}
     borderStrokeWidth={2}
     anchorFill="#ffffff"
     anchorStroke={layerColor}
     anchorStrokeWidth={2}
     anchorSize={8}
     anchorCornerRadius={2}
     // ... other props
   />
   ```

4. If multiple elements selected from different layers, use the first selected element's layer color (or a neutral color like gray).

This provides visual feedback about which layer the selected element belongs to.
  </action>
  <verify>
    - Select element on canvas
    - Selection handles (border and anchors) show layer color
    - Create layer with different color, move element to it
    - Selection handles update to new layer color
  </verify>
  <done>Selection handles show layer color for visual layer identification</done>
</task>

</tasks>

<verification>
1. TypeScript compilation: `npx tsc --noEmit`
2. Dev server: `npm run dev`
3. Functional tests:
   - Click layer - first element in layer gets selected on canvas
   - Select element on canvas - layer shows highlight in panel
   - Multi-select from different layers - multiple layers highlight
   - Right-click element - context menu with "Move to Layer" appears
   - Select layer from submenu - element moves to that layer
   - Click delete on layer - confirmation shows element count
   - Confirm delete - layer and elements removed
   - Default layer has no delete option
   - Select element - handles show layer color
</verification>

<success_criteria>
- Clicking layer selects its first element on canvas
- Canvas selection highlights corresponding layer in panel
- Right-click context menu on canvas includes "Move to Layer" submenu
- Layer submenu shows all layers with colors, current layer marked
- Delete layer shows confirmation with element count
- Delete confirmation removes layer and all its elements
- Default layer cannot be deleted
- Selection handles display layer color
</success_criteria>

<output>
After completion, create `.planning/phases/42-layers-panel/42-05-SUMMARY.md`
</output>
