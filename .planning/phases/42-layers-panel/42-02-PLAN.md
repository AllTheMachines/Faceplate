---
phase: 42-layers-panel
plan: 02
type: execute
wave: 2
depends_on: ["42-01"]
files_modified:
  - src/components/Layers/LayersPanel.tsx
  - src/components/Layers/LayerRow.tsx
  - src/components/Layers/index.ts
  - src/components/Layout/LeftPanel.tsx
autonomous: true

must_haves:
  truths:
    - "User can see Layers tab in LeftPanel next to Elements and Assets"
    - "User can see all layers in the layers panel"
    - "User can create new layer via + button"
    - "User can double-click layer name to rename inline"
    - "Default layer always appears at bottom of list"
  artifacts:
    - path: "src/components/Layers/LayersPanel.tsx"
      provides: "Main layers panel with layer list and add button"
      min_lines: 80
    - path: "src/components/Layers/LayerRow.tsx"
      provides: "Individual layer row with name, color dot, inline edit"
      min_lines: 60
    - path: "src/components/Layers/index.ts"
      provides: "Barrel export for Layers components"
      exports: ["LayersPanel"]
    - path: "src/components/Layout/LeftPanel.tsx"
      provides: "LeftPanel with Layers tab"
      contains: "layers"
  key_links:
    - from: "src/components/Layout/LeftPanel.tsx"
      to: "src/components/Layers/LayersPanel.tsx"
      via: "import and tab rendering"
      pattern: "import.*LayersPanel"
    - from: "src/components/Layers/LayersPanel.tsx"
      to: "src/store/index.ts"
      via: "useStore hook"
      pattern: "useStore.*layers"
---

<objective>
Create the LayersPanel UI component with layer list and basic interactions.

Purpose: Provide visual interface for viewing and managing layers. Users can see all layers, create new ones, and rename via double-click.
Output: Functional LayersPanel component integrated as tab in LeftPanel
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/42-layers-panel/42-CONTEXT.md
@.planning/phases/42-layers-panel/42-RESEARCH.md
@.planning/phases/42-layers-panel/42-01-SUMMARY.md

@src/components/Layout/LeftPanel.tsx (tab integration target)
@src/components/AssetLibrary/AssetLibraryPanel.tsx (panel pattern reference)
@src/types/layer.ts (layer types)
@src/store/layersSlice.ts (layer state)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create LayerRow component with inline editing</name>
  <files>src/components/Layers/LayerRow.tsx</files>
  <action>
Create `src/components/Layers/LayerRow.tsx`:

1. Import dependencies:
   - React (useState, useRef, useEffect)
   - useStore from '../../store'
   - Layer, LAYER_COLOR_MAP from '../../types/layer'

2. Props interface:
   - layer: Layer
   - isSelected: boolean
   - onSelect: (id: string) => void
   - dragHandle?: React.RefObject<HTMLDivElement> (for react-arborist integration later)

3. State:
   - isEditing: boolean (default false)
   - editValue: string (default layer.name)
   - inputRef: useRef<HTMLInputElement>

4. Auto-focus effect:
   - When isEditing becomes true, focus input and select all text

5. handleSave function:
   - Trim editValue
   - If empty, revert to original name
   - If different from current name, call updateLayer(layer.id, { name: trimmed })
   - Set isEditing = false

6. handleKeyDown function:
   - Enter: prevent default, call handleSave
   - Escape: prevent default, revert editValue to layer.name, set isEditing = false

7. Render:
   ```jsx
   <div
     className={`flex items-center gap-2 px-3 py-2 cursor-pointer hover:bg-gray-700 ${
       isSelected ? 'bg-gray-700' : ''
     }`}
     onClick={() => onSelect(layer.id)}
     ref={dragHandle}
   >
     {/* Color dot */}
     <div
       className="w-3 h-3 rounded-full flex-shrink-0"
       style={{ backgroundColor: LAYER_COLOR_MAP[layer.color] }}
     />

     {/* Name or input */}
     {isEditing ? (
       <input
         ref={inputRef}
         value={editValue}
         onChange={(e) => setEditValue(e.target.value)}
         onKeyDown={handleKeyDown}
         onBlur={handleSave}
         className="flex-1 bg-gray-900 text-white text-sm px-1 py-0.5 rounded outline-none border border-blue-500"
       />
     ) : (
       <span
         className="flex-1 text-sm text-gray-200 truncate"
         onDoubleClick={() => setIsEditing(true)}
       >
         {layer.name}
       </span>
     )}

     {/* Default badge */}
     {layer.id === 'default' && (
       <span className="text-xs text-gray-500 italic">Default</span>
     )}
   </div>
   ```

Export LayerRow component.
  </action>
  <verify>File exists with proper TypeScript types, no compilation errors</verify>
  <done>LayerRow renders layer with color dot, name, double-click to edit</done>
</task>

<task type="auto">
  <name>Task 2: Create LayersPanel component with add button</name>
  <files>src/components/Layers/LayersPanel.tsx, src/components/Layers/index.ts</files>
  <action>
Create `src/components/Layers/LayersPanel.tsx`:

1. Import dependencies:
   - React (useState)
   - useStore from '../../store'
   - LayerRow from './LayerRow'
   - LAYER_COLORS from '../../types/layer'

2. State:
   - isCreating: boolean (for new layer name input)
   - newLayerName: string
   - newLayerColor: LayerColor (default 'blue')

3. Get from store:
   - layers (getLayersInOrder selector)
   - selectedLayerId
   - selectLayer
   - addLayer

4. handleCreateLayer function:
   - If newLayerName is empty, return
   - Call addLayer(newLayerName.trim(), newLayerColor)
   - Reset newLayerName to '', isCreating to false

5. Render:
   ```jsx
   <div className="flex flex-col h-full">
     {/* Header */}
     <div className="px-4 py-2 border-b border-gray-700 flex items-center justify-between">
       <span className="text-sm font-medium text-gray-300">Layers</span>
       <span className="text-xs text-gray-500">{layers.length} layer{layers.length !== 1 ? 's' : ''}</span>
     </div>

     {/* Layer list (reversed so top layer appears at top) */}
     <div className="flex-1 overflow-y-auto">
       {[...layers].reverse().map((layer) => (
         <LayerRow
           key={layer.id}
           layer={layer}
           isSelected={selectedLayerId === layer.id}
           onSelect={selectLayer}
         />
       ))}
     </div>

     {/* Create new layer area */}
     {isCreating ? (
       <div className="p-3 border-t border-gray-700 space-y-2">
         <input
           type="text"
           value={newLayerName}
           onChange={(e) => setNewLayerName(e.target.value)}
           placeholder="Layer name"
           className="w-full bg-gray-900 text-white text-sm px-2 py-1.5 rounded border border-gray-600 focus:border-blue-500 outline-none"
           autoFocus
           onKeyDown={(e) => {
             if (e.key === 'Enter') handleCreateLayer()
             if (e.key === 'Escape') setIsCreating(false)
           }}
         />
         <div className="flex gap-1">
           {LAYER_COLORS.map((color) => (
             <button
               key={color}
               onClick={() => setNewLayerColor(color)}
               className={`w-6 h-6 rounded ${newLayerColor === color ? 'ring-2 ring-white ring-offset-1 ring-offset-gray-800' : ''}`}
               style={{ backgroundColor: LAYER_COLOR_MAP[color] }}
             />
           ))}
         </div>
         <div className="flex gap-2">
           <button
             onClick={handleCreateLayer}
             className="flex-1 py-1.5 bg-blue-600 text-white text-sm rounded hover:bg-blue-500"
           >
             Create
           </button>
           <button
             onClick={() => setIsCreating(false)}
             className="flex-1 py-1.5 bg-gray-700 text-gray-300 text-sm rounded hover:bg-gray-600"
           >
             Cancel
           </button>
         </div>
       </div>
     ) : (
       <div className="p-3 border-t border-gray-700">
         <button
           onClick={() => setIsCreating(true)}
           className="w-full py-2 bg-gray-700 text-gray-300 text-sm rounded hover:bg-gray-600 flex items-center justify-center gap-1"
         >
           <span className="text-lg leading-none">+</span>
           <span>New Layer</span>
         </button>
       </div>
     )}
   </div>
   ```

Create `src/components/Layers/index.ts`:
```typescript
export { LayersPanel } from './LayersPanel'
export { LayerRow } from './LayerRow'
```
  </action>
  <verify>`npx tsc --noEmit` passes, LayersPanel exports correctly</verify>
  <done>LayersPanel shows layer list, allows creating new layers with name and color</done>
</task>

<task type="auto">
  <name>Task 3: Add Layers tab to LeftPanel</name>
  <files>src/components/Layout/LeftPanel.tsx</files>
  <action>
Update `src/components/Layout/LeftPanel.tsx`:

1. Import LayersPanel:
   ```typescript
   import { LayersPanel } from '../Layers'
   ```

2. Update activeTab state type:
   ```typescript
   const [activeTab, setActiveTab] = useState<'elements' | 'assets' | 'layers'>('elements')
   ```

3. Add Layers tab button after Assets button in the tab row:
   ```jsx
   <button
     onClick={() => setActiveTab('layers')}
     className={`flex-1 px-4 py-2 text-sm ${
       activeTab === 'layers'
         ? 'text-blue-400 border-b-2 border-blue-400'
         : 'text-gray-400 hover:text-gray-200'
     }`}
   >
     Layers
   </button>
   ```

4. Update conditional render for tab content:
   ```jsx
   <div className="flex-1 overflow-y-auto">
     {activeTab === 'elements' && <Palette />}
     {activeTab === 'assets' && <AssetLibraryPanel />}
     {activeTab === 'layers' && <LayersPanel />}
   </div>
   ```

The Import Template button at bottom remains visible on all tabs.
  </action>
  <verify>
    - `npm run dev` starts without errors
    - Layers tab visible in LeftPanel
    - Clicking Layers tab shows LayersPanel
    - Default layer visible in list
    - Can create new layer
    - Can double-click to rename layer
  </verify>
  <done>Layers tab integrated into LeftPanel, shows layer list with create and rename functionality</done>
</task>

</tasks>

<verification>
1. TypeScript compilation: `npx tsc --noEmit`
2. Dev server: `npm run dev`
3. UI verification:
   - Open app, see Elements/Assets/Layers tabs in LeftPanel
   - Click Layers tab, see "Default" layer with gray dot
   - Click "+ New Layer" button, enter name, select color, click Create
   - New layer appears above Default in list
   - Double-click layer name, edit text, press Enter to save
   - Press Escape to cancel edit
</verification>

<success_criteria>
- LayersPanel component renders in LeftPanel as tab
- Layer list shows all layers sorted by order (top layer at top of visual list)
- Default layer always at bottom of visual list
- Users can create new layers with name and color selection
- Users can double-click layer names to rename inline
- Enter saves, Escape cancels rename
</success_criteria>

<output>
After completion, create `.planning/phases/42-layers-panel/42-02-SUMMARY.md`
</output>
