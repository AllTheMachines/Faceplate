---
phase: 42-layers-panel
plan: 03
type: execute
wave: 3
depends_on: ["42-02"]
files_modified:
  - src/components/Layers/LayerRow.tsx
  - src/components/Layers/LayersPanel.tsx
  - src/components/Canvas/Canvas.tsx
  - src/components/elements/Element.tsx
autonomous: true

must_haves:
  truths:
    - "User can toggle layer visibility via eye icon"
    - "Hidden layer elements do not render on canvas"
    - "User can toggle layer lock via lock icon"
    - "Locked layer elements cannot be moved or resized"
    - "User can press H key to toggle visibility of selected layer"
  artifacts:
    - path: "src/components/Layers/LayerRow.tsx"
      provides: "Layer row with visibility and lock toggle buttons"
      contains: "toggleVisibility"
    - path: "src/components/Canvas/Canvas.tsx"
      provides: "Canvas filtering hidden layer elements"
      contains: "getLayerById"
    - path: "src/components/elements/Element.tsx"
      provides: "Element respecting layer lock state"
      contains: "layer.locked"
  key_links:
    - from: "src/components/Canvas/Canvas.tsx"
      to: "src/store/layersSlice.ts"
      via: "useStore for layer visibility check"
      pattern: "getLayerById.*visible"
    - from: "src/components/elements/Element.tsx"
      to: "src/store/layersSlice.ts"
      via: "useStore for layer lock check"
      pattern: "layer.*locked"
---

<objective>
Implement visibility and lock toggles for layers.

Purpose: Users can control which layers are visible on canvas and which are locked from editing. This enables non-destructive layer management.
Output: Eye and lock icons in LayerRow, canvas respects layer visibility, elements respect layer lock
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/42-layers-panel/42-CONTEXT.md
@.planning/phases/42-layers-panel/42-RESEARCH.md
@.planning/phases/42-layers-panel/42-02-SUMMARY.md

@src/components/Layers/LayerRow.tsx (add toggle buttons)
@src/components/Layers/LayersPanel.tsx (add H key shortcut)
@src/components/Canvas/Canvas.tsx (filter hidden elements)
@src/components/elements/Element.tsx (check lock state)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add visibility and lock toggle buttons to LayerRow</name>
  <files>src/components/Layers/LayerRow.tsx</files>
  <action>
Update `src/components/Layers/LayerRow.tsx`:

1. Get toggleVisibility and toggleLock from store:
   ```typescript
   const toggleVisibility = useStore((state) => state.toggleVisibility)
   const toggleLock = useStore((state) => state.toggleLock)
   ```

2. Add toggle buttons to the right side of the layer row (after name, before default badge):

   ```jsx
   {/* Toggle buttons - right side */}
   <div className="flex items-center gap-1 ml-auto">
     {/* Visibility toggle */}
     <button
       onClick={(e) => {
         e.stopPropagation() // Don't select layer
         toggleVisibility(layer.id)
       }}
       className={`p-1 rounded hover:bg-gray-600 ${
         layer.visible ? 'text-gray-400' : 'text-gray-600'
       }`}
       title={layer.visible ? 'Hide layer (H)' : 'Show layer (H)'}
     >
       {layer.visible ? (
         // Eye open icon
         <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
           <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2}
             d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
           <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2}
             d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
         </svg>
       ) : (
         // Eye closed icon
         <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
           <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2}
             d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21" />
         </svg>
       )}
     </button>

     {/* Lock toggle */}
     <button
       onClick={(e) => {
         e.stopPropagation() // Don't select layer
         toggleLock(layer.id)
       }}
       className={`p-1 rounded hover:bg-gray-600 ${
         layer.locked ? 'text-yellow-500' : 'text-gray-600'
       }`}
       title={layer.locked ? 'Unlock layer' : 'Lock layer'}
     >
       {layer.locked ? (
         // Locked icon
         <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
           <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2}
             d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
         </svg>
       ) : (
         // Unlocked icon
         <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
           <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2}
             d="M8 11V7a4 4 0 118 0m-4 8v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2z" />
         </svg>
       )}
     </button>
   </div>
   ```

3. Update the row layout to accommodate toggle buttons:
   - Name should truncate to make room
   - Toggle buttons on right, before default badge

4. When layer is hidden, dim the entire row:
   ```jsx
   className={`flex items-center gap-2 px-3 py-2 cursor-pointer hover:bg-gray-700 ${
     isSelected ? 'bg-gray-700' : ''
   } ${!layer.visible ? 'opacity-50' : ''}`}
   ```
  </action>
  <verify>Visibility and lock icons appear on layer rows, clicking toggles state</verify>
  <done>LayerRow has functional visibility (eye) and lock (padlock) toggle buttons</done>
</task>

<task type="auto">
  <name>Task 2: Add H key shortcut for visibility toggle</name>
  <files>src/components/Layers/LayersPanel.tsx</files>
  <action>
Update `src/components/Layers/LayersPanel.tsx`:

1. Import useHotkeys:
   ```typescript
   import { useHotkeys } from 'react-hotkeys-hook'
   ```

2. Get toggleVisibility from store:
   ```typescript
   const toggleVisibility = useStore((state) => state.toggleVisibility)
   ```

3. Add H key shortcut that toggles visibility of selected layer:
   ```typescript
   useHotkeys('h', () => {
     if (selectedLayerId) {
       toggleVisibility(selectedLayerId)
     }
   }, { enabled: !!selectedLayerId })
   ```

This allows users to quickly toggle layer visibility with keyboard when a layer is selected.
  </action>
  <verify>Select a layer in panel, press H, layer visibility toggles</verify>
  <done>H key toggles visibility of selected layer</done>
</task>

<task type="auto">
  <name>Task 3: Filter hidden layer elements from canvas rendering</name>
  <files>src/components/Canvas/Canvas.tsx</files>
  <action>
Update `src/components/Canvas/Canvas.tsx` to filter out elements from hidden layers:

1. Get getLayerById from store:
   ```typescript
   const getLayerById = useStore((state) => state.getLayerById)
   ```

2. Find where elements are mapped for rendering (likely iterating over elements array).

3. Filter elements to exclude those in hidden layers:
   ```typescript
   // Filter out elements from hidden layers
   const visibleElements = elements.filter((element) => {
     const layerId = element.layerId || 'default'
     const layer = getLayerById(layerId)
     return layer?.visible !== false // Show if layer visible or layer not found
   })
   ```

4. Use visibleElements instead of elements for rendering.

5. Also filter hidden elements from selection - hidden elements should not be selectable:
   - In click handlers that select elements, check if element's layer is visible
   - If layer is hidden, don't allow selection

Note: This filtering should happen at render time, not in state. Elements still exist in state but don't render when their layer is hidden.
  </action>
  <verify>
    - Add element to canvas
    - Hide its layer (default layer)
    - Element disappears from canvas
    - Show layer again
    - Element reappears
  </verify>
  <done>Elements in hidden layers do not render on canvas</done>
</task>

<task type="auto">
  <name>Task 4: Prevent move/resize of locked layer elements</name>
  <files>src/components/elements/Element.tsx</files>
  <action>
Update `src/components/elements/Element.tsx` to check layer lock state:

1. Get getLayerById from store:
   ```typescript
   const getLayerById = useStore((state) => state.getLayerById)
   ```

2. Determine if element is locked due to layer:
   ```typescript
   const layerId = element.layerId || 'default'
   const layer = getLayerById(layerId)
   const isLayerLocked = layer?.locked || false
   const isLocked = element.locked || isLayerLocked
   ```

3. Use `isLocked` instead of just `element.locked` for:
   - Drag prevention (draggable prop or drag handler)
   - Resize prevention (transformer enabled state)
   - Any other editing operations

4. Visual indication - when layer is locked, element should behave as locked:
   - If using Konva, disable the element's draggable prop
   - If using a Transformer, disable it when locked

5. Important: Properties panel should still be editable even when layer is locked.
   Lock only prevents move and resize, not property edits.

The existing element.locked property works with layer lock - either makes the element non-movable.
  </action>
  <verify>
    - Add element to canvas
    - Lock its layer
    - Try to drag element - should not move
    - Try to resize element - handles should not work
    - Edit property in panel - should still work
    - Unlock layer
    - Element can move and resize again
  </verify>
  <done>Elements in locked layers cannot be moved or resized, but properties can still be edited</done>
</task>

</tasks>

<verification>
1. TypeScript compilation: `npx tsc --noEmit`
2. Dev server: `npm run dev`
3. Functional tests:
   - Eye icon visible on each layer row
   - Click eye icon toggles visibility
   - Lock icon visible on each layer row
   - Click lock icon toggles lock state
   - Hidden layer's elements disappear from canvas
   - Locked layer's elements cannot be dragged
   - Locked layer's elements cannot be resized
   - Locked layer's elements CAN have properties edited
   - Select layer, press H, visibility toggles
   - Hidden elements cannot be selected on canvas
</verification>

<success_criteria>
- Visibility toggle (eye icon) works on all layers
- Lock toggle (lock icon) works on all layers
- Hidden layers' elements do not render on canvas
- Hidden layers' elements cannot be selected
- Locked layers' elements cannot be moved or resized
- Properties panel still editable for locked layer elements
- H keyboard shortcut toggles selected layer visibility
</success_criteria>

<output>
After completion, create `.planning/phases/42-layers-panel/42-03-SUMMARY.md`
</output>
