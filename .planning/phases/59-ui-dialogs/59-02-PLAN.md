---
phase: 59-ui-dialogs
plan: 02
type: execute
wave: 2
depends_on: [59-01]
files_modified:
  - src/components/dialogs/ElementLayerMappingDialog.tsx
  - src/components/dialogs/index.ts
  - src/components/dialogs/ManageElementStylesDialog.tsx
autonomous: true

must_haves:
  truths:
    - "User can import SVG and dialog shows category-appropriate layer roles"
    - "Auto-detection fills initial mappings from naming conventions"
    - "Required roles are marked and save is blocked until all are mapped"
    - "Hovering a table row highlights that layer in SVG preview"
  artifacts:
    - path: "src/components/dialogs/ElementLayerMappingDialog.tsx"
      provides: "Category-aware SVG layer mapping dialog"
      min_lines: 200
      exports: ["ElementLayerMappingDialog"]
  key_links:
    - from: "ElementLayerMappingDialog.tsx"
      to: "addElementStyle"
      via: "store action"
      pattern: "addElementStyle\\("
    - from: "ManageElementStylesDialog.tsx"
      to: "ElementLayerMappingDialog"
      via: "import button opens"
      pattern: "ElementLayerMappingDialog"
---

<objective>
Create ElementLayerMappingDialog that generalizes LayerMappingDialog for all element categories with layer hover highlighting.

Purpose: Unified SVG import and layer assignment workflow for all element types
Output: ElementLayerMappingDialog.tsx with auto-detection, validation, and hover highlighting
</objective>

<execution_context>
@C:\Users\User\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\User\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/59-ui-dialogs/59-CONTEXT.md
@.planning/phases/59-ui-dialogs/59-RESEARCH.md
@.planning/phases/59-ui-dialogs/59-01-PLAN.md
@src/components/dialogs/LayerMappingDialog.tsx
@src/services/svgLayerDetection.ts
@src/types/elementStyle.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ElementLayerMappingDialog with category support</name>
  <files>src/components/dialogs/ElementLayerMappingDialog.tsx</files>
  <action>
Create ElementLayerMappingDialog based on LayerMappingDialog pattern:

1. Accept props: `{ isOpen, onClose, category: ElementCategory, existingStyle?: ElementStyle }`
   - existingStyle is for re-mapping an existing style (pre-populate data)

2. Define layer roles per category (use getLayerRoles helper):
   - rotary: ['indicator', 'track', 'arc', 'glow', 'shadow']
   - linear: ['thumb', 'track', 'fill']
   - arc: ['thumb', 'track', 'fill', 'arc']
   - button: ['normal', 'pressed', 'icon', 'label', 'on', 'off', 'indicator', 'led', 'position-0', 'position-1', 'position-2', 'base', 'selector', 'highlight']
   - meter: ['body', 'fill', 'fill-green', 'fill-yellow', 'fill-red', 'scale', 'peak']

3. Define required roles per category (getRequiredRoles helper):
   - rotary: ['indicator']
   - linear: ['thumb']
   - arc: ['thumb']
   - button: ['normal']
   - meter: ['body']

4. Three-step wizard like LayerMappingDialog:
   - Step 1: Upload (drag-drop SVG)
   - Step 2: Mapping (table of roles -> layer assignments)
   - Step 3: Config (name, angles for rotary/arc)

5. On file drop:
   - Validate with validateSVGContent
   - Sanitize with sanitizeSVG
   - Use detectLayersForType(sanitized, category) for auto-detection
   - Initialize mappings from detected layers

6. Layer mapping table:
   - Left column: Role name (required roles marked with red asterisk)
   - Right column: Dropdown with available layer identifiers
   - Show "(none)" option for optional roles

7. Validation:
   - hasAllRequired = requiredRoles.every(role => assigned)
   - Disable "Next" button if !hasAllRequired

8. On create:
   - Build layers object from mappings
   - Call addElementStyle with category-specific data
   - For rotary/arc: include minAngle, maxAngle fields
   - Toast success and close

Use z-60 for this dialog (nested inside ManageElementStylesDialog which is z-50).
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit 2>&1 | head -50`
Component exists with category prop: grep "category: ElementCategory" src/components/dialogs/ElementLayerMappingDialog.tsx
  </verify>
  <done>
ElementLayerMappingDialog accepts category prop, shows category-appropriate layer roles, validates required roles before save
  </done>
</task>

<task type="auto">
  <name>Task 2: Add layer hover highlighting</name>
  <files>src/components/dialogs/ElementLayerMappingDialog.tsx</files>
  <action>
Add hover highlighting to the layer mapping table:

1. Add state: `const [hoveredLayer, setHoveredLayer] = useState<string | null>(null)`

2. On each table row:
   - onMouseEnter={() => setHoveredLayer(assignedLayerId)}
   - onMouseLeave={() => setHoveredLayer(null)}

3. In SVG preview, implement "dim others" approach (highest contrast per research):
   - Wrap SafeSVG in a div with ref
   - Use useEffect to manipulate SVG DOM when hoveredLayer changes:

```typescript
useEffect(() => {
  if (!svgContainerRef.current) return

  const svg = svgContainerRef.current.querySelector('svg')
  if (!svg) return

  // Get all elements with id or class
  const allLayers = Array.from(svg.querySelectorAll('[id], [class]'))

  if (!hoveredLayer) {
    // Reset all to full opacity
    allLayers.forEach((el) => {
      (el as HTMLElement).style.opacity = '1'
    })
    return
  }

  // Dim all except hovered
  allLayers.forEach((el) => {
    const isHovered = el.id === hoveredLayer || el.classList.contains(hoveredLayer)
    ;(el as HTMLElement).style.opacity = isHovered ? '1' : '0.3'
  })

  return () => {
    // Cleanup on unmount
    allLayers.forEach((el) => {
      (el as HTMLElement).style.opacity = '1'
    })
  }
}, [hoveredLayer])
```

4. Add visual hint in table: "Hover a row to highlight the layer in preview"
  </action>
  <verify>
Hover state exists: grep "hoveredLayer" src/components/dialogs/ElementLayerMappingDialog.tsx
Effect exists: grep "useEffect" src/components/dialogs/ElementLayerMappingDialog.tsx
  </verify>
  <done>
Hovering a role row in the mapping table dims all other layers in the SVG preview, highlighting the assigned layer
  </done>
</task>

<task type="auto">
  <name>Task 3: Wire ElementLayerMappingDialog to ManageElementStylesDialog</name>
  <files>
src/components/dialogs/ManageElementStylesDialog.tsx
src/components/dialogs/index.ts
  </files>
  <action>
1. Update ManageElementStylesDialog to import and use ElementLayerMappingDialog:

```typescript
import { ElementLayerMappingDialog } from './ElementLayerMappingDialog'
```

2. Add state for import dialog and re-map mode:
```typescript
const [showImport, setShowImport] = useState(false)
const [remapStyleId, setRemapStyleId] = useState<string | null>(null)
```

3. Wire "Import New [Category] Style" button:
```typescript
<button onClick={() => setShowImport(true)} ...>
  Import New {category} Style
</button>
```

4. Wire "Re-map" button per style:
```typescript
<button onClick={() => setRemapStyleId(style.id)} ...>
  Re-map
</button>
```

5. Add ElementLayerMappingDialog at end of component:
```typescript
<ElementLayerMappingDialog
  isOpen={showImport || remapStyleId !== null}
  onClose={() => { setShowImport(false); setRemapStyleId(null) }}
  category={category}
  existingStyle={remapStyleId ? getElementStyle(remapStyleId) : undefined}
/>
```

6. Export ElementLayerMappingDialog from dialogs/index.ts:
```typescript
export { ElementLayerMappingDialog } from './ElementLayerMappingDialog'
```
  </action>
  <verify>
Import button works: grep "setShowImport" src/components/dialogs/ManageElementStylesDialog.tsx
Re-map button exists: grep "Re-map" src/components/dialogs/ManageElementStylesDialog.tsx
Export exists: grep "ElementLayerMappingDialog" src/components/dialogs/index.ts
  </verify>
  <done>
Import button opens ElementLayerMappingDialog for new imports, Re-map button opens it with existing style data pre-populated
  </done>
</task>

</tasks>

<verification>
1. ElementLayerMappingDialog.tsx exists with ~200+ lines
2. Component shows different layer roles based on category parameter
3. Required roles marked with asterisk, save blocked if unmapped
4. Hovering table row highlights layer in preview (others dimmed)
5. ManageElementStylesDialog's Import button opens ElementLayerMappingDialog
6. Re-map action opens ElementLayerMappingDialog with existing style data
7. Both components exported from dialogs/index.ts
</verification>

<success_criteria>
- User can upload SVG and see auto-detected layer assignments
- Required roles are clearly marked and validated before save
- Hover highlighting provides visual feedback during layer mapping
- Import flow works end-to-end: Manage dialog -> Import button -> Layer mapping -> Save -> Style appears in list
- Re-map flow works: Manage dialog -> Re-map button -> Pre-filled mappings -> Update -> Style updated
</success_criteria>

<output>
After completion, create `.planning/phases/59-ui-dialogs/59-02-SUMMARY.md`
</output>
