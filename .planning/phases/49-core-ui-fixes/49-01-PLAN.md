---
phase: 49-core-ui-fixes
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/Properties/ColorInput.tsx
  - src/services/helpService.ts
  - src/content/help/styles.ts
autonomous: true

must_haves:
  truths:
    - "Color picker popup stays open during drag interactions"
    - "Related Topics links scroll to correct section within help window"
    - "Back button appears after navigating and returns to previous position"
    - "Navigated section briefly highlights to show target"
  artifacts:
    - path: "src/components/Properties/ColorInput.tsx"
      provides: "Color picker with stopPropagation on drag"
      contains: "onMouseDown.*stopPropagation"
    - path: "src/services/helpService.ts"
      provides: "In-window help navigation with history"
      contains: "navigateToSection"
    - path: "src/content/help/styles.ts"
      provides: "Highlight animation CSS"
      contains: "highlight-flash"
  key_links:
    - from: "ColorInput.tsx picker popup div"
      to: "mousedown event listener"
      via: "stopPropagation prevents bubbling"
      pattern: "onMouseDown.*stopPropagation"
    - from: "Help window Related Topics links"
      to: "Section elements by ID"
      via: "navigateToSection function"
      pattern: "getElementById.*scrollIntoView"
---

<objective>
Fix color picker and help system interaction bugs

Purpose: Eliminate two frustrating UI issues - color picker closing during drag and Related Topics links not working
Output: Polished UI interactions that work as users expect
</objective>

<execution_context>
@C:\Users\User\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\User\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/49-core-ui-fixes/49-CONTEXT.md
@.planning/phases/49-core-ui-fixes/49-RESEARCH.md
@src/components/Properties/ColorInput.tsx
@src/services/helpService.ts
@src/content/help/styles.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix color picker drag closure bug</name>
  <files>src/components/Properties/ColorInput.tsx</files>
  <action>
Add `onMouseDown={(e) => e.stopPropagation()}` to the picker popup container div (the one with `ref={pickerRef}`).

This prevents mousedown events inside the color picker from bubbling up to the document listener that closes the popup. The existing click-outside detection already uses `mousedown` (line 31), so this fix ensures drag operations within the picker don't trigger the outside-click handler.

Change line 63 from:
```tsx
<div ref={pickerRef} className="absolute z-50 mt-2 left-0">
```

To:
```tsx
<div
  ref={pickerRef}
  className="absolute z-50 mt-2 left-0"
  onMouseDown={(e) => e.stopPropagation()}
>
```

No other changes needed - the existing useEffect and handleClickOutside logic is correct.
  </action>
  <verify>
1. Run dev server: `npm run dev`
2. Add any element with color properties (e.g., Button)
3. Open the color picker by clicking a color swatch
4. Drag within the color gradient area
5. Verify the picker stays open during the entire drag operation
6. Click outside the picker to verify it still closes properly
  </verify>
  <done>Color picker remains open while dragging to select colors, closes on click outside</done>
</task>

<task type="auto">
  <name>Task 2: Implement in-window help navigation with history</name>
  <files>src/services/helpService.ts, src/content/help/styles.ts</files>
  <action>
Refactor the help system to navigate within the same window instead of opening new windows for Related Topics.

**Part A: Add highlight CSS to styles.ts**

Add these styles to HELP_WINDOW_STYLES:

```css
/* Navigation highlight animation */
.highlight-flash {
  background-color: rgba(59, 130, 246, 0.2);
  transition: background-color 1s ease-out;
}

/* Back button styling */
.back-btn {
  position: sticky;
  top: 0;
  background: #262626;
  color: #d4d4d4;
  border: 1px solid #404040;
  padding: 8px 16px;
  border-radius: 4px;
  cursor: pointer;
  font-size: 14px;
  margin-bottom: 16px;
  display: none;
}

.back-btn:hover {
  background: #333333;
  color: #ffffff;
}

/* Section anchor offset for sticky back button */
.help-section {
  scroll-margin-top: 60px;
}
```

**Part B: Refactor helpService.ts generateHelpHTML**

The current approach opens a new window via postMessage for each Related Topics link. Instead, include all potentially-needed help topics as hidden sections in the same HTML document, then use JavaScript to:

1. Show/hide sections on navigation
2. Scroll to the section with smooth animation
3. Apply highlight class temporarily
4. Track navigation history
5. Show/hide back button

Replace the current `openRelatedTopic` JavaScript in generateHelpHTML with:

```javascript
let navigationHistory = [];
let currentSectionId = null;

function initializeHelp(initialSectionId) {
  currentSectionId = initialSectionId;
  // Show only the initial section
  document.querySelectorAll('.help-section').forEach(el => {
    el.style.display = el.id === initialSectionId ? 'block' : 'none';
  });
  updateBackButton();
}

function navigateToSection(sectionId) {
  const element = document.getElementById(sectionId);
  if (!element) {
    console.warn('Help section not found:', sectionId);
    return;
  }

  // Save current position to history
  if (currentSectionId) {
    navigationHistory.push({
      sectionId: currentSectionId,
      scrollY: window.scrollY
    });
  }

  // Hide current section, show new section
  document.querySelectorAll('.help-section').forEach(el => {
    el.style.display = 'none';
  });
  element.style.display = 'block';
  currentSectionId = sectionId;

  // Scroll to top of new section
  window.scrollTo({ top: 0, behavior: 'smooth' });

  // Brief highlight
  element.classList.add('highlight-flash');
  setTimeout(() => {
    element.classList.remove('highlight-flash');
  }, 1000);

  updateBackButton();
}

function navigateBack() {
  if (navigationHistory.length === 0) return;

  const prev = navigationHistory.pop();

  // Hide current section, show previous section
  document.querySelectorAll('.help-section').forEach(el => {
    el.style.display = 'none';
  });

  const element = document.getElementById(prev.sectionId);
  if (element) {
    element.style.display = 'block';
    currentSectionId = prev.sectionId;
    window.scrollTo({ top: prev.scrollY, behavior: 'smooth' });
  }

  updateBackButton();
}

function updateBackButton() {
  const btn = document.getElementById('back-btn');
  if (btn) {
    btn.style.display = navigationHistory.length > 0 ? 'block' : 'none';
  }
}
```

**Part C: Generate all sections in HTML**

Modify generateHelpHTML to:
1. Add a back button at the top of body
2. Generate the main content as a section with ID
3. Generate hidden sections for each topic found in relatedTopics
4. Call initializeHelp on load with the main section ID

The section ID should be derived from the topic key (e.g., "knob" -> "help-knob").

For renderRelatedTopic, change the onclick from `openRelatedTopic('${contentBase64}')` to `navigateToSection('help-${elementKey}')`.

**Implementation notes:**
- Only include sections for topics actually referenced in relatedTopics (not all 100+ topics)
- Generate recursive related topics up to 1 level deep (topics referenced by referenced topics)
- Use a Set to avoid duplicate section generation
- The elementKey is already found by findElementKeyInTopic
  </action>
  <verify>
1. Run dev server: `npm run dev`
2. Add any element (e.g., Knob) and open help via F1 or help button
3. Click a Related Topics link (e.g., "Panel" if available)
4. Verify:
   - The content changes to the related topic within the same window
   - A back button appears at the top
   - The transition is smooth (no page flash)
   - The new section briefly highlights blue
5. Click the back button
6. Verify it returns to the original help content at the same scroll position
7. Navigate multiple levels and verify back button works through the entire history
8. Verify clicking outside the help window (in main app) doesn't break navigation
  </verify>
  <done>Related Topics links navigate within the help window, back button allows returning through navigation history</done>
</task>

</tasks>

<verification>
1. **Color Picker Test:**
   - Open color picker, drag across entire gradient area
   - Picker must remain open throughout drag
   - Click outside must still close picker

2. **Help Navigation Test:**
   - Open help for any element with Related Topics
   - Navigate via links - must scroll/transition smoothly
   - Back button must appear and work
   - Multi-level navigation must maintain correct history

3. **Edge Cases:**
   - Invalid/missing topic links should not crash (console warning only)
   - Rapid navigation clicks should not break history
   - Opening new help window (different element) should work independently
</verification>

<success_criteria>
- Color picker drag does not close the popup
- Related Topics links navigate within the same help window
- Back button appears after navigation and returns to previous section
- Section highlight briefly appears on navigation (~1 second)
- No console errors during normal usage
</success_criteria>

<output>
After completion, create `.planning/phases/49-core-ui-fixes/49-01-SUMMARY.md`
</output>
