---
phase: 49-core-ui-fixes
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/Properties/ColorInput.tsx
  - src/services/helpService.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Color picker stays open during drag interactions"
    - "Related Topics links navigate to the correct linked section"
  artifacts:
    - path: "src/components/Properties/ColorInput.tsx"
      provides: "Color picker with picking-aware value change handling"
      contains: "isPickingRef"
    - path: "src/services/helpService.ts"
      provides: "Element key matching with longest-first priority"
      contains: "sort.*length"
  key_links:
    - from: "ColorInput.tsx HexColorPicker onChange"
      to: "isPickingRef tracking"
      via: "ref set true during picking, prevents useEffect close"
      pattern: "isPickingRef\\.current.*true"
    - from: "helpService.ts findElementKeyInTopic"
      to: "sorted knownElementTypes"
      via: "longer keys checked first"
      pattern: "sort.*b\\.length.*a\\.length"
---

<objective>
Fix two UAT failures: color picker closing during drag and Related Topics links pointing to wrong sections

Purpose: Close gaps identified in 49-UAT.md where users reported these issues persist after Plan 01
Output: Working color picker drag behavior and correct help navigation links
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/49-core-ui-fixes/49-01-SUMMARY.md
@src/components/Properties/ColorInput.tsx
@src/services/helpService.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix color picker closing during drag with picking-aware ref</name>
  <files>src/components/Properties/ColorInput.tsx</files>
  <action>
The root cause: useEffect on [value] (lines 15-19) closes the picker whenever `value` changes. During dragging, each mouse movement triggers onChange -> updates value prop -> triggers useEffect -> closes picker.

The stopPropagation fix only prevents mousedown bubbling but doesn't prevent the useEffect from firing when value changes.

**Fix:** Track whether the picker is the source of value changes using a ref:

1. Add a ref to track if the picker is active:
```tsx
const isPickingRef = useRef(false)
```

2. Modify the useEffect to only close if NOT actively picking:
```tsx
useEffect(() => {
  // Close picker when value changes from outside (element selection changed)
  // But NOT when change comes from picker itself (during drag)
  if (!isPickingRef.current) {
    setShowPicker(false)
  }
}, [value])
```

3. Wrap the HexColorPicker onChange to track picking state:
```tsx
<HexColorPicker
  color={value}
  onChange={(newColor) => {
    isPickingRef.current = true
    onChange(newColor)
    // Reset after a brief delay to catch rapid value changes
    setTimeout(() => {
      isPickingRef.current = false
    }, 100)
  }}
/>
```

4. Reset picking state when picker closes (in case user clicks outside during drag):
In the toggle button onClick, when closing (showPicker is true becoming false):
```tsx
onClick={() => {
  if (showPicker) {
    isPickingRef.current = false
  }
  setShowPicker(!showPicker)
}}
```

5. Also reset in the click-outside handler:
```tsx
const handleClickOutside = (e: MouseEvent) => {
  if (pickerRef.current && !pickerRef.current.contains(e.target as Node)) {
    isPickingRef.current = false
    setShowPicker(false)
  }
}
```

This ensures:
- Dragging in picker keeps picker open (isPickingRef prevents useEffect close)
- Selecting a different element closes picker (external value change, isPickingRef is false)
- Clicking outside closes picker (click handler resets ref and closes)
  </action>
  <verify>
1. `npm run dev`
2. Add a Button element (has background color)
3. Click the color swatch to open picker
4. Drag across the gradient area - picker MUST stay open
5. Release mouse - picker stays open
6. Click outside picker - picker closes
7. Select a different element - verify no stale picker appears
8. Repeat with different color properties
  </verify>
  <done>Color picker remains open during entire drag interaction, closes correctly on click-outside or element change</done>
</task>

<task type="auto">
  <name>Task 2: Fix Related Topics matching to prioritize longer keys</name>
  <files>src/services/helpService.ts</files>
  <action>
The root cause: `findElementKeyInTopic` iterates through `knownElementTypes` (Object.keys) which has undefined order. When topic says "Use SteppedKnob for discrete values", the substring "steppedknob" contains "knob", so if "knob" is checked first, it matches incorrectly.

**Fix:** Sort knownElementTypes by length descending so longer/more specific keys are checked first:

1. At line 18, change:
```typescript
const knownElementTypes = Object.keys(allHelpTopics)
```

To:
```typescript
// Sort by length descending so longer/more specific keys match first
// This prevents "knob" from matching before "steppedknob" in topics like "Use SteppedKnob..."
const knownElementTypes = Object.keys(allHelpTopics).sort((a, b) => b.length - a.length)
```

This ensures:
- "steppedknob" (11 chars) is checked before "knob" (4 chars)
- "centerdetentknob" (16 chars) is checked before "knob" (4 chars)
- "bipolarslider" (13 chars) is checked before "slider" (6 chars)
- etc.

The more specific element type will always match first, preventing substring collisions.

**No other changes needed** - the matching logic itself is correct, it just needs proper key ordering.
  </action>
  <verify>
1. `npm run dev`
2. Add a Knob element and open help (F1)
3. Check Related Topics - should include "Use SteppedKnob..." and "Use CenterDetentKnob..."
4. Click on "Use SteppedKnob for discrete values with detents"
5. Verify navigation shows "Stepped Knob Element" section (NOT regular Knob section)
6. Click back button - returns to Knob help
7. Click "Use CenterDetentKnob for bipolar parameters"
8. Verify navigation shows "Center Detent Knob Element" section
9. Test with Slider element - click "Use BipolarSlider for -1 to +1 range"
10. Verify navigation shows "Bipolar Slider Element" section
  </verify>
  <done>Related Topics links correctly navigate to specific variant sections (SteppedKnob, CenterDetentKnob, BipolarSlider, etc.)</done>
</task>

</tasks>

<verification>
1. **Color Picker Drag Test:**
   - Open picker, drag across gradient - must stay open entire time
   - Click outside - closes
   - Select different element - picker does not reappear with stale state

2. **Help Navigation Test:**
   - Knob help -> click "SteppedKnob" link -> shows Stepped Knob section
   - Slider help -> click "BipolarSlider" link -> shows Bipolar Slider section
   - All variant-specific links go to correct sections

3. **Regression Test:**
   - Regular help links (Panel, Frame, etc.) still work
   - Back button still works through navigation history
   - Text input for hex color still works
</verification>

<success_criteria>
- Color picker drag does not close the popup (ref tracking prevents useEffect close)
- Related Topics "SteppedKnob" links navigate to Stepped Knob section, not Knob
- Related Topics "CenterDetentKnob" links navigate to Center Detent Knob section
- Related Topics "BipolarSlider" links navigate to Bipolar Slider section, not Slider
- No regressions in other help or color picker functionality
</success_criteria>

<output>
After completion, create `.planning/phases/49-core-ui-fixes/49-02-SUMMARY.md`
</output>
