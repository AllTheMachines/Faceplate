---
phase: 56-button-switch-styling
plan: 04
type: execute
wave: 2
depends_on: ["56-01"]
files_modified:
  - src/components/elements/renderers/controls/RockerSwitchRenderer.tsx
  - src/components/elements/renderers/controls/RotarySwitchRenderer.tsx
  - src/components/Properties/RockerSwitchProperties.tsx
  - src/components/Properties/RotarySwitchProperties.tsx
autonomous: true

must_haves:
  truths:
    - "Rocker Switch renders with 3-position SVG states (position-0, position-1, position-2)"
    - "Rotary Switch renders with static base and rotating selector layer"
    - "Position labels remain programmatic (existing behavior preserved)"
  artifacts:
    - path: "src/components/elements/renderers/controls/RockerSwitchRenderer.tsx"
      provides: "StyledRockerSwitchRenderer with position state layers"
      contains: "StyledRockerSwitchRenderer"
    - path: "src/components/elements/renderers/controls/RotarySwitchRenderer.tsx"
      provides: "StyledRotarySwitchRenderer with rotating selector"
      contains: "StyledRotarySwitchRenderer"
  key_links:
    - from: "RockerSwitchRenderer.tsx"
      to: "extractElementLayer"
      via: "import"
      pattern: "import.*extractElementLayer"
    - from: "RotarySwitchRenderer.tsx"
      to: "applyAllColorOverrides"
      via: "import"
      pattern: "import.*applyAllColorOverrides"
---

<objective>
Add SVG styling support to Rocker Switch and Rotary Switch with multi-position layers.

Purpose: Enable user-customizable switch artwork with position-based state visuals.
Output: StyledRockerSwitchRenderer (3-position layers), StyledRotarySwitchRenderer (rotating selector).
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/56-button-switch-styling/56-CONTEXT.md
@.planning/phases/56-button-switch-styling/56-RESEARCH.md
@.planning/phases/56-button-switch-styling/56-01-SUMMARY.md
@src/components/elements/renderers/controls/RockerSwitchRenderer.tsx
@src/components/elements/renderers/controls/RotarySwitchRenderer.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add StyledRockerSwitchRenderer with 3-position state layers</name>
  <files>src/components/elements/renderers/controls/RockerSwitchRenderer.tsx</files>
  <action>
Follow the delegation pattern:

1. Add imports at top:
```typescript
import { useMemo } from 'react'
import { useStore } from '../../../../store'
import { SafeSVG } from '../../../SafeSVG'
import { extractElementLayer } from '../../../../services/elementLayers'
import { applyAllColorOverrides } from '../../../../services/knobLayers'
```

2. Rename current RockerSwitchRenderer to DefaultRockerSwitchRenderer (keep ALL existing code)

3. Create StyledRockerSwitchRenderer:
```typescript
function StyledRockerSwitchRenderer({ config }: RockerSwitchRendererProps) {
  const getElementStyle = useStore((state) => state.getElementStyle)
  const style = config.styleId ? getElementStyle(config.styleId) : undefined

  if (style && style.category !== 'button') {
    console.warn('RockerSwitch requires button category style')
    return null
  }

  const svgContent = useMemo(() => {
    if (!style) return ''
    return applyAllColorOverrides(style.svgContent, style.layers, config.colorOverrides)
  }, [style, config.colorOverrides])

  const layers = useMemo(() => {
    if (!style || !svgContent) return null
    return {
      base: style.layers.base ? extractElementLayer(svgContent, style.layers.base) : null,
      position0: style.layers['position-0'] ? extractElementLayer(svgContent, style.layers['position-0']) : null,
      position1: style.layers['position-1'] ? extractElementLayer(svgContent, style.layers['position-1']) : null,
      position2: style.layers['position-2'] ? extractElementLayer(svgContent, style.layers['position-2']) : null,
    }
  }, [style, svgContent])

  if (!style) {
    return (
      <div style={{
        width: '100%', height: '100%',
        display: 'flex', alignItems: 'center', justifyContent: 'center',
        background: '#374151', borderRadius: '4px',
        color: '#9CA3AF', fontSize: '12px', textAlign: 'center', padding: '8px',
      }}>
        Style not found
      </div>
    )
  }

  return (
    <div style={{ position: 'relative', width: '100%', height: '100%' }}>
      {/* Static base - always visible */}
      {layers?.base && (
        <div style={{ position: 'absolute', inset: 0 }}>
          <SafeSVG content={layers.base} style={{ width: '100%', height: '100%' }} />
        </div>
      )}

      {/* Position 0 (down) - visible when position === 0 */}
      {layers?.position0 && (
        <div style={{
          position: 'absolute', inset: 0,
          opacity: config.position === 0 ? 1 : 0,
          transition: 'none', // Direct jump per CONTEXT.md
        }}>
          <SafeSVG content={layers.position0} style={{ width: '100%', height: '100%' }} />
        </div>
      )}

      {/* Position 1 (center) - visible when position === 1 */}
      {layers?.position1 && (
        <div style={{
          position: 'absolute', inset: 0,
          opacity: config.position === 1 ? 1 : 0,
          transition: 'none',
        }}>
          <SafeSVG content={layers.position1} style={{ width: '100%', height: '100%' }} />
        </div>
      )}

      {/* Position 2 (up) - visible when position === 2 */}
      {layers?.position2 && (
        <div style={{
          position: 'absolute', inset: 0,
          opacity: config.position === 2 ? 1 : 0,
          transition: 'none',
        }}>
          <SafeSVG content={layers.position2} style={{ width: '100%', height: '100%' }} />
        </div>
      )}

      {/* Labels - preserved from existing implementation */}
      {config.showLabels && (
        <div style={{
          position: 'absolute', inset: 0,
          display: 'flex', flexDirection: 'column',
          justifyContent: 'space-between', alignItems: 'flex-end',
          paddingRight: '8px', paddingTop: '8px', paddingBottom: '8px',
          fontSize: `${config.labelFontSize}px`,
          fontFamily: config.labelFontFamily,
          fontWeight: config.labelFontWeight,
          color: config.labelColor,
          pointerEvents: 'none',
        }}>
          <span style={{ opacity: config.position === 2 ? 1 : 0.5 }}>
            {config.upLabel}
          </span>
          <span style={{ opacity: config.position === 0 ? 1 : 0.5 }}>
            {config.downLabel}
          </span>
        </div>
      )}
    </div>
  )
}
```

4. Create delegating RockerSwitchRenderer:
```typescript
export function RockerSwitchRenderer({ config }: RockerSwitchRendererProps) {
  if (!config.styleId) {
    return <DefaultRockerSwitchRenderer config={config} />
  }
  return <StyledRockerSwitchRenderer config={config} />
}
```
  </action>
  <verify>
- TypeScript compiles: `npx tsc --noEmit`
- Dev server runs: `npm run dev`
- Rocker Switch renders on canvas
  </verify>
  <done>Rocker Switch supports SVG styling with 3-position state layers</done>
</task>

<task type="auto">
  <name>Task 2: Add StyledRotarySwitchRenderer + update both property panels</name>
  <files>
    src/components/elements/renderers/controls/RotarySwitchRenderer.tsx
    src/components/Properties/RockerSwitchProperties.tsx
    src/components/Properties/RotarySwitchProperties.tsx
  </files>
  <action>
**RotarySwitchRenderer.tsx:**

1. Add imports at top:
```typescript
import { useMemo } from 'react'
import { useStore } from '../../../../store'
import { SafeSVG } from '../../../SafeSVG'
import { extractElementLayer } from '../../../../services/elementLayers'
import { applyAllColorOverrides } from '../../../../services/knobLayers'
```

2. Rename current RotarySwitchRenderer to DefaultRotarySwitchRenderer (keep ALL existing code)

3. Create StyledRotarySwitchRenderer:
```typescript
function StyledRotarySwitchRenderer({ config }: RotarySwitchRendererProps) {
  const getElementStyle = useStore((state) => state.getElementStyle)
  const style = config.styleId ? getElementStyle(config.styleId) : undefined

  if (style && style.category !== 'button') {
    console.warn('RotarySwitch requires button category style')
    return null
  }

  const svgContent = useMemo(() => {
    if (!style) return ''
    return applyAllColorOverrides(style.svgContent, style.layers, config.colorOverrides)
  }, [style, config.colorOverrides])

  const layers = useMemo(() => {
    if (!style || !svgContent) return null
    return {
      base: style.layers.base ? extractElementLayer(svgContent, style.layers.base) : null,
      selector: style.layers.selector ? extractElementLayer(svgContent, style.layers.selector) : null,
    }
  }, [style, svgContent])

  // Calculate rotation angle - same logic as existing RotarySwitchRenderer
  const { positionCount, currentPosition, rotationAngle } = config
  const anglePerPosition = positionCount > 1 ? rotationAngle / (positionCount - 1) : 0
  const startAngle = -rotationAngle / 2
  const currentAngle = startAngle + currentPosition * anglePerPosition

  // Generate label positions for radial layout (preserve existing behavior)
  const size = Math.min(config.width, config.height)
  const centerX = size / 2
  const centerY = size / 2
  const labelRadius = size * 0.35 + 20
  const degToRad = (deg: number) => (deg * Math.PI) / 180

  const labels = config.positionLabels || Array.from({ length: positionCount }, (_, i) => String(i + 1))

  const radialLabels = config.labelLayout === 'radial'
    ? labels.slice(0, positionCount).map((label, i) => {
        const angle = startAngle + i * anglePerPosition
        const x = centerX + labelRadius * Math.sin(degToRad(angle))
        const y = centerY - labelRadius * Math.cos(degToRad(angle))
        const isActive = i === currentPosition
        return { label, x, y, isActive, index: i }
      })
    : []

  if (!style) {
    return (
      <div style={{
        width: '100%', height: '100%',
        display: 'flex', alignItems: 'center', justifyContent: 'center',
        background: '#374151', borderRadius: '4px',
        color: '#9CA3AF', fontSize: '12px', textAlign: 'center', padding: '8px',
      }}>
        Style not found
      </div>
    )
  }

  return (
    <div
      style={{
        width: '100%', height: '100%',
        position: 'relative',
        display: 'flex',
        flexDirection: config.labelLayout === 'legend' ? 'row' : 'column',
        alignItems: 'center',
        justifyContent: 'center',
        gap: '8px',
      }}
    >
      {/* SVG container for base + rotating selector */}
      <div style={{
        position: 'relative',
        width: config.labelLayout === 'legend' ? size * 0.6 : '100%',
        height: config.labelLayout === 'legend' ? size * 0.6 : '100%',
      }}>
        {/* Static base */}
        {layers?.base && (
          <div style={{ position: 'absolute', inset: 0 }}>
            <SafeSVG content={layers.base} style={{ width: '100%', height: '100%' }} />
          </div>
        )}

        {/* Rotating selector */}
        {layers?.selector && (
          <div style={{
            position: 'absolute', inset: 0,
            transform: `rotate(${currentAngle}deg)`,
            transformOrigin: 'center center',
            transition: 'none', // Per CONTEXT.md: keep current motion (instant)
          }}>
            <SafeSVG content={layers.selector} style={{ width: '100%', height: '100%' }} />
          </div>
        )}

        {/* Radial labels (preserved from existing implementation) */}
        {config.labelLayout === 'radial' && (
          <svg
            style={{
              position: 'absolute', inset: 0,
              overflow: 'visible',
              pointerEvents: 'none',
            }}
            viewBox={`0 0 ${size} ${size}`}
          >
            {radialLabels.map(({ label, x, y, isActive, index }) => (
              <text
                key={index}
                x={x}
                y={y}
                textAnchor="middle"
                dominantBaseline="middle"
                fontSize={config.labelFontSize}
                fill={config.labelColor}
                fontWeight={isActive ? 'bold' : 'normal'}
                opacity={isActive ? 1 : 0.6}
                fontFamily={config.fontFamily}
              >
                {label}
              </text>
            ))}
          </svg>
        )}
      </div>

      {/* Legend layout (preserved from existing implementation) */}
      {config.labelLayout === 'legend' && (
        <div
          style={{
            display: 'flex',
            flexDirection: 'column',
            gap: '2px',
            fontSize: `${config.labelFontSize}px`,
            fontFamily: config.labelFontFamily,
            fontWeight: config.labelFontWeight,
          }}
        >
          {labels.slice(0, positionCount).map((label, i) => (
            <span
              key={i}
              style={{
                color: config.labelColor,
                opacity: i === currentPosition ? 1 : 0.5,
                fontWeight: i === currentPosition ? 'bold' : 'normal',
              }}
            >
              {i + 1}. {label}
            </span>
          ))}
        </div>
      )}
    </div>
  )
}
```

4. Create delegating RotarySwitchRenderer:
```typescript
export function RotarySwitchRenderer({ config }: RotarySwitchRendererProps) {
  if (!config.styleId) {
    return <DefaultRotarySwitchRenderer config={config} />
  }
  return <StyledRotarySwitchRenderer config={config} />
}
```

**RockerSwitchProperties.tsx:**

Add Style section:
```typescript
import { useLicense } from '../../hooks/useLicense'
import { ButtonLayers } from '../../types/elementStyle'

// In component:
const { isPro } = useLicense()
const getStylesByCategory = useStore((state) => state.getStylesByCategory)
const getElementStyle = useStore((state) => state.getElementStyle)
const buttonStyles = getStylesByCategory('button')
```

Layer names for Rocker: `['base', 'position-0', 'position-1', 'position-2']`

**RotarySwitchProperties.tsx:**

Add same Style section. Layer names for Rotary: `['base', 'selector']`
  </action>
  <verify>
- TypeScript compiles: `npx tsc --noEmit`
- Dev server runs: `npm run dev`
- Rotary Switch renders on canvas
- Property panels show Style dropdown
  </verify>
  <done>Rotary Switch supports SVG styling with rotating selector, both property panels updated</done>
</task>

</tasks>

<verification>
1. TypeScript compiles: `npx tsc --noEmit`
2. Dev server starts: `npm run dev`
3. Place Rocker Switch on canvas, verify 3-position behavior works
4. Place Rotary Switch on canvas, verify rotation works
5. Check property panels show "Style" section
</verification>

<success_criteria>
1. Rocker Switch renders with position-0/1/2 SVG layers when style applied
2. Position changes are instant (no intermediate states) per CONTEXT.md
3. Rotary Switch renders with static base + rotating selector when style applied
4. Position labels remain programmatic (existing behavior preserved)
5. Both elements still work with default CSS when no styleId set
6. Property panels show SVG Style dropdown
</success_criteria>

<output>
After completion, create `.planning/phases/56-button-switch-styling/56-04-SUMMARY.md`
</output>
