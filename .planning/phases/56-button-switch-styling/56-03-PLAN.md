---
phase: 56-button-switch-styling
plan: 03
type: execute
wave: 2
depends_on: ["56-01"]
files_modified:
  - src/components/elements/renderers/controls/ToggleSwitchRenderer.tsx
  - src/components/elements/renderers/controls/PowerButtonRenderer.tsx
  - src/components/Properties/ToggleSwitchProperties.tsx
  - src/components/Properties/PowerButtonProperties.tsx
autonomous: true

must_haves:
  truths:
    - "Toggle Switch renders with on/off SVG states"
    - "Toggle Switch indicator layer toggles independently"
    - "Power Button renders with LED indicator layer that lights on active"
    - "LED color is user-configurable via property panel"
  artifacts:
    - path: "src/components/elements/renderers/controls/ToggleSwitchRenderer.tsx"
      provides: "StyledToggleSwitchRenderer with on/off state layers"
      contains: "StyledToggleSwitchRenderer"
    - path: "src/components/elements/renderers/controls/PowerButtonRenderer.tsx"
      provides: "StyledPowerButtonRenderer with LED indicator"
      contains: "StyledPowerButtonRenderer"
  key_links:
    - from: "ToggleSwitchRenderer.tsx"
      to: "extractElementLayer"
      via: "import"
      pattern: "import.*extractElementLayer"
    - from: "PowerButtonProperties.tsx"
      to: "getStylesByCategory"
      via: "store selector"
      pattern: "getStylesByCategory.*button"
---

<objective>
Add SVG styling support to Toggle Switch and Power Button with independent indicator/LED layers.

Purpose: Enable user-customizable toggle and power button artwork with state-driven indicators.
Output: StyledToggleSwitchRenderer, StyledPowerButtonRenderer, updated property panels.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/56-button-switch-styling/56-CONTEXT.md
@.planning/phases/56-button-switch-styling/56-RESEARCH.md
@.planning/phases/56-button-switch-styling/56-01-SUMMARY.md
@src/components/elements/renderers/controls/ToggleSwitchRenderer.tsx
@src/components/elements/renderers/controls/PowerButtonRenderer.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add StyledToggleSwitchRenderer with on/off state layers</name>
  <files>src/components/elements/renderers/controls/ToggleSwitchRenderer.tsx</files>
  <action>
Follow the delegation pattern to add SVG styling support:

1. Add imports at top:
```typescript
import { useMemo } from 'react'
import { useStore } from '../../../../store'
import { SafeSVG } from '../../../SafeSVG'
import { extractElementLayer } from '../../../../services/elementLayers'
import { applyAllColorOverrides } from '../../../../services/knobLayers'
```

2. Rename current ToggleSwitchRenderer to DefaultToggleSwitchRenderer (keep ALL existing code)

3. Create StyledToggleSwitchRenderer:
```typescript
function StyledToggleSwitchRenderer({ config }: ToggleSwitchRendererProps) {
  const getElementStyle = useStore((state) => state.getElementStyle)
  const style = config.styleId ? getElementStyle(config.styleId) : undefined

  if (style && style.category !== 'button') {
    console.warn('ToggleSwitch requires button category style')
    return null
  }

  const svgContent = useMemo(() => {
    if (!style) return ''
    return applyAllColorOverrides(style.svgContent, style.layers, config.colorOverrides)
  }, [style, config.colorOverrides])

  const layers = useMemo(() => {
    if (!style || !svgContent) return null
    return {
      body: style.layers.body ? extractElementLayer(svgContent, style.layers.body) : null,
      on: style.layers.on ? extractElementLayer(svgContent, style.layers.on) : null,
      off: style.layers.off ? extractElementLayer(svgContent, style.layers.off) : null,
      indicator: style.layers.indicator ? extractElementLayer(svgContent, style.layers.indicator) : null,
    }
  }, [style, svgContent])

  if (!style) {
    return (
      <div style={{
        width: '100%', height: '100%',
        display: 'flex', alignItems: 'center', justifyContent: 'center',
        background: '#374151', borderRadius: '4px',
        color: '#9CA3AF', fontSize: '12px', textAlign: 'center', padding: '8px',
      }}>
        Style not found
      </div>
    )
  }

  return (
    <div style={{ position: 'relative', width: '100%', height: '100%' }}>
      {/* Background body - always visible */}
      {layers?.body && (
        <div style={{ position: 'absolute', inset: 0 }}>
          <SafeSVG content={layers.body} style={{ width: '100%', height: '100%' }} />
        </div>
      )}

      {/* Off state layer - visible when off */}
      {layers?.off && (
        <div style={{
          position: 'absolute', inset: 0,
          opacity: config.isOn ? 0 : 1,
          transition: 'none', // Per CONTEXT.md: layer swap only, no sliding
        }}>
          <SafeSVG content={layers.off} style={{ width: '100%', height: '100%' }} />
        </div>
      )}

      {/* On state layer - visible when on */}
      {layers?.on && (
        <div style={{
          position: 'absolute', inset: 0,
          opacity: config.isOn ? 1 : 0,
          transition: 'none',
        }}>
          <SafeSVG content={layers.on} style={{ width: '100%', height: '100%' }} />
        </div>
      )}

      {/* Indicator layer - toggles independently (but same state variable per RESEARCH.md) */}
      {layers?.indicator && (
        <div style={{
          position: 'absolute', inset: 0,
          opacity: config.isOn ? 1 : 0,
          transition: 'none',
        }}>
          <SafeSVG content={layers.indicator} style={{ width: '100%', height: '100%' }} />
        </div>
      )}
    </div>
  )
}
```

4. Create delegating ToggleSwitchRenderer:
```typescript
export function ToggleSwitchRenderer({ config }: ToggleSwitchRendererProps) {
  if (!config.styleId) {
    return <DefaultToggleSwitchRenderer config={config} />
  }
  return <StyledToggleSwitchRenderer config={config} />
}
```

IMPORTANT: If ToggleSwitchElementConfig doesn't have styleId/colorOverrides, they need to be added to types/elements.ts.
  </action>
  <verify>
- TypeScript compiles: `npx tsc --noEmit`
- Dev server runs: `npm run dev`
- Toggle Switch renders on canvas
  </verify>
  <done>Toggle Switch supports SVG styling with on/off state swapping and independent indicator</done>
</task>

<task type="auto">
  <name>Task 2: Add StyledPowerButtonRenderer + update both property panels</name>
  <files>
    src/components/elements/renderers/controls/PowerButtonRenderer.tsx
    src/components/Properties/ToggleSwitchProperties.tsx
    src/components/Properties/PowerButtonProperties.tsx
  </files>
  <action>
**PowerButtonRenderer.tsx:**

1. Add imports at top:
```typescript
import { useMemo } from 'react'
import { useStore } from '../../../../store'
import { SafeSVG } from '../../../SafeSVG'
import { extractElementLayer } from '../../../../services/elementLayers'
import { applyAllColorOverrides } from '../../../../services/knobLayers'
```

2. Rename current PowerButtonRenderer to DefaultPowerButtonRenderer (keep ALL existing code)

3. Create StyledPowerButtonRenderer:
```typescript
function StyledPowerButtonRenderer({ config }: PowerButtonRendererProps) {
  const getElementStyle = useStore((state) => state.getElementStyle)
  const style = config.styleId ? getElementStyle(config.styleId) : undefined

  if (style && style.category !== 'button') {
    console.warn('PowerButton requires button category style')
    return null
  }

  const svgContent = useMemo(() => {
    if (!style) return ''
    return applyAllColorOverrides(style.svgContent, style.layers, config.colorOverrides)
  }, [style, config.colorOverrides])

  const layers = useMemo(() => {
    if (!style || !svgContent) return null
    return {
      normal: style.layers.normal ? extractElementLayer(svgContent, style.layers.normal) : null,
      pressed: style.layers.pressed ? extractElementLayer(svgContent, style.layers.pressed) : null,
      icon: style.layers.icon ? extractElementLayer(svgContent, style.layers.icon) : null,
      led: style.layers.led ? extractElementLayer(svgContent, style.layers.led) : null,
    }
  }, [style, svgContent])

  if (!style) {
    return (
      <div style={{
        width: '100%', height: '100%',
        display: 'flex', alignItems: 'center', justifyContent: 'center',
        background: '#374151', borderRadius: '4px',
        color: '#9CA3AF', fontSize: '12px', textAlign: 'center', padding: '8px',
      }}>
        Style not found
      </div>
    )
  }

  return (
    <div style={{ position: 'relative', width: '100%', height: '100%' }}>
      {/* Normal state - visible when NOT on */}
      {layers?.normal && (
        <div style={{
          position: 'absolute', inset: 0,
          opacity: config.isOn ? 0 : 1,
          transition: 'none',
        }}>
          <SafeSVG content={layers.normal} style={{ width: '100%', height: '100%' }} />
        </div>
      )}

      {/* Pressed state - visible when on */}
      {layers?.pressed && (
        <div style={{
          position: 'absolute', inset: 0,
          opacity: config.isOn ? 1 : 0,
          transition: 'none',
        }}>
          <SafeSVG content={layers.pressed} style={{ width: '100%', height: '100%' }} />
        </div>
      )}

      {/* Icon layer - always visible */}
      {layers?.icon && (
        <div style={{ position: 'absolute', inset: 0 }}>
          <SafeSVG content={layers.icon} style={{ width: '100%', height: '100%' }} />
        </div>
      )}

      {/* LED indicator - toggles with isOn, colorable via ledColor override */}
      {layers?.led && (
        <div style={{
          position: 'absolute', inset: 0,
          opacity: config.isOn ? 1 : 0,
          transition: 'none',
        }}>
          <SafeSVG content={layers.led} style={{ width: '100%', height: '100%' }} />
        </div>
      )}

      {/* Text label (fallback if no label layer) */}
      {config.label && (
        <div style={{
          position: 'absolute', inset: 0,
          display: 'flex', alignItems: 'center', justifyContent: 'center',
          color: config.textColor,
          fontSize: `${config.fontSize}px`,
          fontFamily: config.fontFamily,
          fontWeight: config.fontWeight,
          pointerEvents: 'none',
        }}>
          {config.label}
        </div>
      )}
    </div>
  )
}
```

4. Create delegating PowerButtonRenderer:
```typescript
export function PowerButtonRenderer({ config }: PowerButtonRendererProps) {
  if (!config.styleId) {
    return <DefaultPowerButtonRenderer config={config} />
  }
  return <StyledPowerButtonRenderer config={config} />
}
```

**ToggleSwitchProperties.tsx:**

Add Style section following SliderProperties pattern:

```typescript
import { useLicense } from '../../hooks/useLicense'
import { ButtonLayers } from '../../types/elementStyle'

// Add these to the component:
const { isPro } = useLicense()
const getStylesByCategory = useStore((state) => state.getStylesByCategory)
const getElementStyle = useStore((state) => state.getElementStyle)
const buttonStyles = getStylesByCategory('button')
```

Add Style section at top:
```typescript
{/* Style Section */}
<PropertySection title="Style">
  <div>
    <label className="block text-xs text-gray-400 mb-1">SVG Style</label>
    <select
      value={element.styleId || ''}
      onChange={(e) => onUpdate({
        styleId: e.target.value || undefined,
        colorOverrides: e.target.value ? element.colorOverrides : undefined
      })}
      className="w-full bg-gray-700 border border-gray-600 text-white rounded px-2 py-1.5 text-sm"
      disabled={!isPro && buttonStyles.length > 0}
    >
      <option value="">Default (CSS)</option>
      {buttonStyles.map(style => (
        <option key={style.id} value={style.id}>{style.name}</option>
      ))}
    </select>
    {!isPro && buttonStyles.length > 0 && (
      <p className="text-xs text-amber-500 mt-1">Pro license required for SVG styles</p>
    )}
  </div>
</PropertySection>

{/* Color Overrides */}
{isPro && element.styleId && (() => {
  const style = getElementStyle(element.styleId)
  if (!style || style.category !== 'button') return null

  const layerNames: Array<keyof ButtonLayers> = ['body', 'on', 'off', 'indicator']
  const existingLayers = layerNames.filter((layerName) => style.layers[layerName])

  if (existingLayers.length === 0) return null

  return (
    <PropertySection title="Color Overrides">
      {existingLayers.map((layerName) => (
        <ColorInput
          key={layerName}
          label={layerName.charAt(0).toUpperCase() + layerName.slice(1)}
          value={element.colorOverrides?.[layerName] || ''}
          onChange={(color) => {
            const newOverrides = { ...element.colorOverrides }
            if (color) {
              newOverrides[layerName] = color
            } else {
              delete newOverrides[layerName]
            }
            onUpdate({ colorOverrides: newOverrides })
          }}
        />
      ))}
      <button
        onClick={() => onUpdate({ colorOverrides: undefined })}
        className="w-full text-left text-sm text-red-400 hover:text-red-300 mt-1"
      >
        Reset to Original Colors
      </button>
    </PropertySection>
  )
})()}
```

**PowerButtonProperties.tsx:**

Add same Style section pattern. Layer names for Power Button: `['normal', 'pressed', 'icon', 'led']`

The LED color override uses the 'led' layer name. The existing ledOnColor/ledOffColor in PowerButtonElementConfig are for the default CSS renderer - they remain as fallbacks.
  </action>
  <verify>
- TypeScript compiles: `npx tsc --noEmit`
- Dev server runs: `npm run dev`
- Toggle Switch and Power Button property panels show Style dropdown
  </verify>
  <done>Toggle Switch and Power Button support SVG styling with indicator/LED layers</done>
</task>

</tasks>

<verification>
1. TypeScript compiles: `npx tsc --noEmit`
2. Dev server starts: `npm run dev`
3. Place Toggle Switch on canvas, verify it renders with default CSS
4. Place Power Button on canvas, verify it renders with default CSS
5. Check property panels show "Style" section
</verification>

<success_criteria>
1. Toggle Switch renders with on/off SVG layers when style applied
2. Toggle Switch indicator toggles independently
3. Power Button renders with LED indicator when style applied
4. LED is colorable via color overrides
5. Both elements still work with default CSS when no styleId set
6. Property panels show SVG Style dropdown and color overrides
</success_criteria>

<output>
After completion, create `.planning/phases/56-button-switch-styling/56-03-SUMMARY.md`
</output>
