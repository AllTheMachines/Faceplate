---
phase: 23-professional-meters
plan: 04
type: execute
wave: 2
depends_on: ["23-01"]
files_modified:
  - src/types/elements/displays.ts
  - src/components/elements/renderers/displays/meters/KMeterRenderer.tsx
  - src/components/elements/renderers/displays/meters/CorrelationMeterRenderer.tsx
  - src/components/elements/renderers/displays/meters/StereoWidthMeterRenderer.tsx
  - src/components/elements/renderers/displays/meters/index.ts
  - src/components/elements/renderers/displays/index.ts
  - src/components/elements/renderers/index.ts
autonomous: true

must_haves:
  truths:
    - "User can render K-12 Meter with -32 to +12 dB range"
    - "User can render K-14 Meter with -34 to +14 dB range"
    - "User can render K-20 Meter with -40 to +20 dB range"
    - "User can render Correlation Meter showing -1 to +1 range as horizontal bar"
    - "User can render Stereo Width Meter showing 0-200% range as horizontal bar"
  artifacts:
    - path: "src/types/elements/displays.ts"
      provides: "Element configs for 8 meter types (K-System + Analysis)"
      contains: "K12MeterMonoElementConfig|K20MeterStereoElementConfig|CorrelationMeterElementConfig|StereoWidthMeterElementConfig"
    - path: "src/components/elements/renderers/displays/meters/KMeterRenderer.tsx"
      provides: "K-System meter renderers for K-12, K-14, K-20"
      exports: ["K12MeterMonoRenderer", "K12MeterStereoRenderer", "K14MeterMonoRenderer", "K14MeterStereoRenderer", "K20MeterMonoRenderer", "K20MeterStereoRenderer"]
    - path: "src/components/elements/renderers/displays/meters/CorrelationMeterRenderer.tsx"
      provides: "Phase correlation meter with horizontal bar"
      exports: ["CorrelationMeterRenderer"]
    - path: "src/components/elements/renderers/displays/meters/StereoWidthMeterRenderer.tsx"
      provides: "Stereo width meter with horizontal bar (0-200%)"
      exports: ["StereoWidthMeterRenderer"]
  key_links:
    - from: "CorrelationMeterRenderer.tsx"
      to: "meterUtils.ts"
      via: "import utilities"
      pattern: "import.*from.*meterUtils"
---

<objective>
Create K-System (K-12, K-14, K-20) and analysis (Correlation, Stereo Width) meter element types.

Purpose: K-System meters follow Bob Katz calibrated monitoring standards with different headroom amounts. Correlation Meter shows phase relationship (-1 to +1), Stereo Width Meter shows M/S ratio (0-200%). Analysis meters use horizontal bar rendering per CONTEXT.md.

Output: 8 new element types (K-12/14/20 mono/stereo + Correlation + Stereo Width) registered in the renderer registry.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/23-professional-meters/23-CONTEXT.md
@.planning/phases/23-professional-meters/23-RESEARCH.md
@.planning/phases/23-professional-meters/23-01-SUMMARY.md
@src/types/elements/displays.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add K-System meter element type definitions</name>
  <files>src/types/elements/displays.ts</files>
  <action>
Add K-System meter definitions (K-12, K-14, K-20) to displays.ts:

```typescript
// K-12 Meter - Bob Katz standard, -32 to +12 dB, 600ms ballistics
export interface K12MeterMonoElementConfig extends BaseProfessionalMeterConfig {
  type: 'k12metermono'
  ballisticsType: 'K_SYSTEM' // 600ms RMS integration
  kType: 'K-12' // 12dB headroom
}

export interface K12MeterStereoElementConfig extends BaseProfessionalMeterConfig {
  type: 'k12meterstereo'
  ballisticsType: 'K_SYSTEM'
  kType: 'K-12'
  valueL: number
  valueR: number
  showChannelLabels: boolean
}

// K-14 Meter - Bob Katz standard, -34 to +14 dB
export interface K14MeterMonoElementConfig extends BaseProfessionalMeterConfig {
  type: 'k14metermono'
  ballisticsType: 'K_SYSTEM'
  kType: 'K-14' // 14dB headroom
}

export interface K14MeterStereoElementConfig extends BaseProfessionalMeterConfig {
  type: 'k14meterstereo'
  ballisticsType: 'K_SYSTEM'
  kType: 'K-14'
  valueL: number
  valueR: number
  showChannelLabels: boolean
}

// K-20 Meter - Bob Katz standard, -40 to +20 dB
export interface K20MeterMonoElementConfig extends BaseProfessionalMeterConfig {
  type: 'k20metermono'
  ballisticsType: 'K_SYSTEM'
  kType: 'K-20' // 20dB headroom
}

export interface K20MeterStereoElementConfig extends BaseProfessionalMeterConfig {
  type: 'k20meterstereo'
  ballisticsType: 'K_SYSTEM'
  kType: 'K-20'
  valueL: number
  valueR: number
  showChannelLabels: boolean
}
```

Add type guards for all 6 K-System types:

```typescript
export function isK12MeterMono(element: { type: string }): element is K12MeterMonoElementConfig {
  return element.type === 'k12metermono'
}
export function isK12MeterStereo(element: { type: string }): element is K12MeterStereoElementConfig {
  return element.type === 'k12meterstereo'
}
export function isK14MeterMono(element: { type: string }): element is K14MeterMonoElementConfig {
  return element.type === 'k14metermono'
}
export function isK14MeterStereo(element: { type: string }): element is K14MeterStereoElementConfig {
  return element.type === 'k14meterstereo'
}
export function isK20MeterMono(element: { type: string }): element is K20MeterMonoElementConfig {
  return element.type === 'k20metermono'
}
export function isK20MeterStereo(element: { type: string }): element is K20MeterStereoElementConfig {
  return element.type === 'k20meterstereo'
}
```

Add factory functions:

```typescript
// K-12: -32 to +12 dB (44 segment range)
export function createK12MeterMono(overrides?: Partial<K12MeterMonoElementConfig>): K12MeterMonoElementConfig {
  // K-System color zones: green below 0, yellow 0 to K, red above K
  const k12ColorZones = [
    { startDb: -32, endDb: 0, color: '#10b981' },
    { startDb: 0, endDb: 12, color: '#ef4444' },
  ]

  return {
    id: crypto.randomUUID(),
    type: 'k12metermono',
    name: 'K-12 Meter',
    x: 0,
    y: 0,
    width: 30,
    height: 180,
    rotation: 0,
    zIndex: 0,
    locked: false,
    visible: true,
    value: 0.45, // -12 dB on K-12 scale
    minDb: -32,
    maxDb: 12,
    orientation: 'vertical',
    segmentCount: 44,
    segmentGap: 1,
    scalePosition: 'outside',
    showMajorTicks: true,
    showMinorTicks: true,
    showNumericReadout: false,
    colorZones: k12ColorZones,
    showPeakHold: true,
    peakHoldStyle: 'line',
    peakHoldDuration: 2000,
    ballisticsType: 'K_SYSTEM',
    kType: 'K-12',
    ...overrides,
  }
}

// Similar factories for K12Stereo, K14Mono, K14Stereo, K20Mono, K20Stereo
// K-14: -34 to +14 dB (48 segments)
// K-20: -40 to +20 dB (60 segments)
```

Add all 6 types to DisplayElement union.
  </action>
  <verify>grep "K20MeterStereoElementConfig" src/types/elements/displays.ts</verify>
  <done>6 K-System meter types defined with Bob Katz standard ranges (K-12, K-14, K-20)</done>
</task>

<task type="auto">
  <name>Task 2: Add Correlation and Stereo Width meter type definitions</name>
  <files>src/types/elements/displays.ts</files>
  <action>
Add analysis meter definitions (Correlation, Stereo Width) to displays.ts:

```typescript
// ============================================================================
// Analysis Meter Configurations (horizontal bars)
// ============================================================================

// Correlation Meter - Phase relationship, -1 to +1 range
export interface CorrelationMeterElementConfig extends BaseElementConfig {
  type: 'correlationmeter'

  // Value (-1 to +1, not normalized)
  value: number // -1 = out of phase, 0 = uncorrelated, +1 = in phase

  // Visual
  orientation: 'horizontal' // Always horizontal per CONTEXT.md
  barHeight: number // Height of the indicator bar
  showScale: boolean
  scalePosition: 'above' | 'below'
  showNumericReadout: boolean

  // Color zones
  colorZones: Array<{
    start: number // -1 to +1
    end: number
    color: string
  }>
}

// Stereo Width Meter - M/S ratio, 0-200% range
export interface StereoWidthMeterElementConfig extends BaseElementConfig {
  type: 'stereowidthmeter'

  // Value (0-200 percentage, stored as 0-2)
  value: number // 0 = mono, 1 = normal, 2 = 200% width

  // Visual
  orientation: 'horizontal' // Always horizontal per CONTEXT.md
  barHeight: number
  showScale: boolean
  scalePosition: 'above' | 'below'
  showNumericReadout: boolean

  // Color zones
  colorZones: Array<{
    start: number // 0-200 percentage
    end: number
    color: string
  }>
}
```

Add type guards:

```typescript
export function isCorrelationMeter(element: { type: string }): element is CorrelationMeterElementConfig {
  return element.type === 'correlationmeter'
}

export function isStereoWidthMeter(element: { type: string }): element is StereoWidthMeterElementConfig {
  return element.type === 'stereowidthmeter'
}
```

Add factory functions:

```typescript
export function createCorrelationMeter(overrides?: Partial<CorrelationMeterElementConfig>): CorrelationMeterElementConfig {
  // Correlation zones: red (-1 to 0), yellow (0 to 0.5), green (0.5 to 1)
  const correlationColorZones = [
    { start: -1, end: 0, color: '#ef4444' },    // Red: out of phase
    { start: 0, end: 0.5, color: '#eab308' },   // Yellow: wide stereo
    { start: 0.5, end: 1, color: '#10b981' },   // Green: mono compatible
  ]

  return {
    id: crypto.randomUUID(),
    type: 'correlationmeter',
    name: 'Correlation Meter',
    x: 0,
    y: 0,
    width: 200,
    height: 40,
    rotation: 0,
    zIndex: 0,
    locked: false,
    visible: true,
    value: 0.7, // Default: fairly mono-compatible
    orientation: 'horizontal',
    barHeight: 12,
    showScale: true,
    scalePosition: 'below',
    showNumericReadout: true,
    colorZones: correlationColorZones,
    ...overrides,
  }
}

export function createStereoWidthMeter(overrides?: Partial<StereoWidthMeterElementConfig>): StereoWidthMeterElementConfig {
  // Width zones: green (0-100%), yellow (100-150%), red (150-200%)
  const widthColorZones = [
    { start: 0, end: 100, color: '#10b981' },
    { start: 100, end: 150, color: '#eab308' },
    { start: 150, end: 200, color: '#ef4444' },
  ]

  return {
    id: crypto.randomUUID(),
    type: 'stereowidthmeter',
    name: 'Stereo Width Meter',
    x: 0,
    y: 0,
    width: 200,
    height: 40,
    rotation: 0,
    zIndex: 0,
    locked: false,
    visible: true,
    value: 1.0, // Default: 100% (normal stereo)
    orientation: 'horizontal',
    barHeight: 12,
    showScale: true,
    scalePosition: 'below',
    showNumericReadout: true,
    colorZones: widthColorZones,
    ...overrides,
  }
}
```

Add both types to DisplayElement union.
  </action>
  <verify>grep "CorrelationMeterElementConfig\|StereoWidthMeterElementConfig" src/types/elements/displays.ts</verify>
  <done>Correlation and Stereo Width meter types defined with appropriate ranges and horizontal orientation</done>
</task>

<task type="auto">
  <name>Task 3: Create renderers and register in registry</name>
  <files>
    src/components/elements/renderers/displays/meters/KMeterRenderer.tsx
    src/components/elements/renderers/displays/meters/CorrelationMeterRenderer.tsx
    src/components/elements/renderers/displays/meters/StereoWidthMeterRenderer.tsx
    src/components/elements/renderers/displays/meters/index.ts
    src/components/elements/renderers/displays/index.ts
    src/components/elements/renderers/index.ts
  </files>
  <action>
**KMeterRenderer.tsx:**
Create K-System meter renderers following the same pattern as RMSMeterRenderer. All 6 variants (K12/K14/K20 mono/stereo) use SegmentedMeter with their respective dB ranges.

```typescript
import React from 'react'
import type {
  K12MeterMonoElementConfig,
  K12MeterStereoElementConfig,
  K14MeterMonoElementConfig,
  K14MeterStereoElementConfig,
  K20MeterMonoElementConfig,
  K20MeterStereoElementConfig,
} from '../../../../../types/elements/displays'
import { SegmentedMeter } from './SegmentedMeter'
import { MeterScale } from './MeterScale'

// K-12 renderers (follow RMS pattern)
export function K12MeterMonoRenderer({ config }: { config: K12MeterMonoElementConfig }) {
  // Same structure as RMSMeterMonoRenderer
}

export function K12MeterStereoRenderer({ config }: { config: K12MeterStereoElementConfig }) {
  // Same structure as RMSMeterStereoRenderer
}

// K-14 renderers
export function K14MeterMonoRenderer({ config }: { config: K14MeterMonoElementConfig }) { /* same pattern */ }
export function K14MeterStereoRenderer({ config }: { config: K14MeterStereoElementConfig }) { /* same pattern */ }

// K-20 renderers
export function K20MeterMonoRenderer({ config }: { config: K20MeterMonoElementConfig }) { /* same pattern */ }
export function K20MeterStereoRenderer({ config }: { config: K20MeterStereoElementConfig }) { /* same pattern */ }
```

**CorrelationMeterRenderer.tsx:**
Horizontal bar meter with center marker at 0:

```typescript
import React from 'react'
import type { CorrelationMeterElementConfig } from '../../../../../types/elements/displays'

interface Props {
  config: CorrelationMeterElementConfig
}

export function CorrelationMeterRenderer({ config }: Props) {
  const { width, height, value, barHeight, showScale, scalePosition, showNumericReadout, colorZones } = config

  // Normalize -1 to +1 to 0-1 for positioning
  const normalized = (value + 1) / 2 // -1 -> 0, 0 -> 0.5, +1 -> 1

  // Find color based on value
  const getColor = (v: number) => {
    const zone = colorZones.find(z => v >= z.start && v < z.end)
    return zone?.color || '#666666'
  }

  const scaleHeight = showScale ? 16 : 0
  const readoutHeight = showNumericReadout ? 18 : 0
  const meterAreaHeight = height - scaleHeight - readoutHeight

  return (
    <div style={{ width, height, display: 'flex', flexDirection: 'column' }}>
      {/* Scale above */}
      {showScale && scalePosition === 'above' && (
        <div style={{
          display: 'flex',
          justifyContent: 'space-between',
          fontSize: 10,
          color: '#999',
          height: scaleHeight,
        }}>
          <span>-1</span>
          <span>0</span>
          <span>+1</span>
        </div>
      )}

      {/* Meter bar area */}
      <div style={{
        flex: 1,
        display: 'flex',
        alignItems: 'center',
        position: 'relative',
      }}>
        {/* Background track */}
        <div style={{
          width: '100%',
          height: barHeight,
          backgroundColor: '#333',
          borderRadius: 2,
          position: 'relative',
        }}>
          {/* Center marker at 0 correlation */}
          <div style={{
            position: 'absolute',
            left: '50%',
            top: 0,
            bottom: 0,
            width: 2,
            backgroundColor: '#666',
            transform: 'translateX(-50%)',
          }} />

          {/* Indicator */}
          <div style={{
            position: 'absolute',
            left: `${normalized * 100}%`,
            top: 0,
            bottom: 0,
            width: 4,
            backgroundColor: getColor(value),
            transform: 'translateX(-50%)',
            borderRadius: 2,
            transition: 'none',
          }} />
        </div>
      </div>

      {/* Scale below */}
      {showScale && scalePosition === 'below' && (
        <div style={{
          display: 'flex',
          justifyContent: 'space-between',
          fontSize: 10,
          color: '#999',
          height: scaleHeight,
        }}>
          <span>-1</span>
          <span>0</span>
          <span>+1</span>
        </div>
      )}

      {/* Numeric readout */}
      {showNumericReadout && (
        <div style={{
          textAlign: 'center',
          fontSize: 12,
          color: getColor(value),
          height: readoutHeight,
        }}>
          {value >= 0 ? '+' : ''}{value.toFixed(2)}
        </div>
      )}
    </div>
  )
}
```

**StereoWidthMeterRenderer.tsx:**
Horizontal bar meter for 0-200% range:

```typescript
import React from 'react'
import type { StereoWidthMeterElementConfig } from '../../../../../types/elements/displays'

interface Props {
  config: StereoWidthMeterElementConfig
}

export function StereoWidthMeterRenderer({ config }: Props) {
  const { width, height, value, barHeight, showScale, scalePosition, showNumericReadout, colorZones } = config

  // value is 0-2 (representing 0-200%)
  const percentage = value * 100
  const normalized = value / 2 // 0-2 -> 0-1

  // Find color based on percentage value
  const getColor = (pct: number) => {
    const zone = colorZones.find(z => pct >= z.start && pct < z.end)
    return zone?.color || '#666666'
  }

  const scaleHeight = showScale ? 16 : 0
  const readoutHeight = showNumericReadout ? 18 : 0

  return (
    <div style={{ width, height, display: 'flex', flexDirection: 'column' }}>
      {/* Scale above */}
      {showScale && scalePosition === 'above' && (
        <div style={{
          display: 'flex',
          justifyContent: 'space-between',
          fontSize: 10,
          color: '#999',
          height: scaleHeight,
        }}>
          <span>0%</span>
          <span>100%</span>
          <span>200%</span>
        </div>
      )}

      {/* Meter bar area */}
      <div style={{
        flex: 1,
        display: 'flex',
        alignItems: 'center',
        position: 'relative',
      }}>
        {/* Background track */}
        <div style={{
          width: '100%',
          height: barHeight,
          backgroundColor: '#333',
          borderRadius: 2,
          position: 'relative',
        }}>
          {/* Center marker at 100% */}
          <div style={{
            position: 'absolute',
            left: '50%',
            top: 0,
            bottom: 0,
            width: 2,
            backgroundColor: '#666',
            transform: 'translateX(-50%)',
          }} />

          {/* Fill bar from left */}
          <div style={{
            position: 'absolute',
            left: 0,
            top: 0,
            bottom: 0,
            width: `${normalized * 100}%`,
            backgroundColor: getColor(percentage),
            borderRadius: 2,
            transition: 'none',
          }} />
        </div>
      </div>

      {/* Scale below */}
      {showScale && scalePosition === 'below' && (
        <div style={{
          display: 'flex',
          justifyContent: 'space-between',
          fontSize: 10,
          color: '#999',
          height: scaleHeight,
        }}>
          <span>0%</span>
          <span>100%</span>
          <span>200%</span>
        </div>
      )}

      {/* Numeric readout */}
      {showNumericReadout && (
        <div style={{
          textAlign: 'center',
          fontSize: 12,
          color: getColor(percentage),
          height: readoutHeight,
        }}>
          {percentage.toFixed(0)}%
        </div>
      )}
    </div>
  )
}
```

**Update meters/index.ts** to export all new renderers.

**Update displays/index.ts** to re-export from meters.

**Update renderers/index.ts** to register all 8 new meter types:
```typescript
['k12metermono', K12MeterMonoRenderer as RendererComponent],
['k12meterstereo', K12MeterStereoRenderer as RendererComponent],
['k14metermono', K14MeterMonoRenderer as RendererComponent],
['k14meterstereo', K14MeterStereoRenderer as RendererComponent],
['k20metermono', K20MeterMonoRenderer as RendererComponent],
['k20meterstereo', K20MeterStereoRenderer as RendererComponent],
['correlationmeter', CorrelationMeterRenderer as RendererComponent],
['stereowidthmeter', StereoWidthMeterRenderer as RendererComponent],
```
  </action>
  <verify>grep -l "CorrelationMeterRenderer\|K20MeterStereoRenderer" src/components/elements/renderers/index.ts</verify>
  <done>8 additional meter renderers created: K-System (6) + Correlation + Stereo Width</done>
</task>

</tasks>

<verification>
1. `grep "type: 'k20metermono'" src/types/elements/displays.ts` - K-System type definitions exist
2. `grep "createCorrelationMeter" src/types/elements/displays.ts` - Analysis factory functions exist
3. `ls src/components/elements/renderers/displays/meters/CorrelationMeterRenderer.tsx` - Analysis renderer files exist
4. `grep "correlationmeter" src/components/elements/renderers/index.ts` - Registry entries exist
5. TypeScript compilation: `npx tsc --noEmit`
</verification>

<success_criteria>
- 8 element types defined: K-12/14/20 mono/stereo + Correlation + Stereo Width
- K-System meters have correct ranges: K-12 (-32 to +12), K-14 (-34 to +14), K-20 (-40 to +20)
- Correlation Meter renders as horizontal bar with -1/0/+1 scale
- Stereo Width Meter renders as horizontal bar with 0%/100%/200% scale
- Analysis meters have center markers (0 for correlation, 100% for width)
- All 8 types registered in rendererRegistry
</success_criteria>

<output>
After completion, create `.planning/phases/23-professional-meters/23-04-SUMMARY.md`
</output>
