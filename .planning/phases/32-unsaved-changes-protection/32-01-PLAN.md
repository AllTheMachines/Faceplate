---
phase: 32-unsaved-changes-protection
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/store/dirtyStateSlice.ts
  - src/store/index.ts
  - src/hooks/useBeforeUnload.ts
  - src/hooks/useDirtyState.ts
  - src/components/Layout/LeftPanel.tsx
  - src/components/project/SaveLoadPanel.tsx
autonomous: true

must_haves:
  truths:
    - "Document title shows asterisk prefix when project has unsaved changes"
    - "Document title removes asterisk after successful save"
    - "Last saved timestamp displays relative time ('2 minutes ago')"
    - "Never saved projects show 'Never saved' indicator"
    - "Dirty state correctly detects changes after save"
  artifacts:
    - path: "src/store/dirtyStateSlice.ts"
      provides: "Dirty state tracking slice with lastSavedSnapshot and lastSavedTimestamp"
      exports: ["DirtyStateSlice", "createDirtyStateSlice"]
    - path: "src/hooks/useBeforeUnload.ts"
      provides: "beforeunload event hook"
      exports: ["useBeforeUnload"]
    - path: "src/hooks/useDirtyState.ts"
      provides: "Dirty state detection hook"
      exports: ["useDirtyState"]
  key_links:
    - from: "src/store/index.ts"
      to: "src/store/dirtyStateSlice.ts"
      via: "slice composition"
      pattern: "createDirtyStateSlice"
    - from: "src/App.tsx"
      to: "src/hooks/useBeforeUnload.ts"
      via: "hook usage"
      pattern: "useBeforeUnload"
    - from: "src/components/Layout/LeftPanel.tsx"
      to: "src/store/index.ts"
      via: "dirty state subscription"
      pattern: "isDirty|lastSavedTimestamp"
---

<objective>
Implement dirty state tracking infrastructure and visual indicators for unsaved changes.

Purpose: Enable the app to detect when the project has unsaved changes, display relative time since last save, and update the document title with asterisk prefix.

Output: DirtyStateSlice with snapshot comparison, useBeforeUnload and useDirtyState hooks, updated LeftPanel with relative time display, document title asterisk management.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/32-unsaved-changes-protection/32-CONTEXT.md
@.planning/phases/32-unsaved-changes-protection/32-RESEARCH.md
@src/store/index.ts
@src/store/elementsSlice.ts
@src/components/Layout/LeftPanel.tsx
@src/components/project/SaveLoadPanel.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create dirty state slice and integrate with store</name>
  <files>src/store/dirtyStateSlice.ts, src/store/index.ts</files>
  <action>
1. Create `src/store/dirtyStateSlice.ts` with:
   - State: `savedStateSnapshot: string | null` (JSON of last saved state)
   - State: `lastSavedTimestamp: number | null` (Unix timestamp of last save)
   - Action: `setSavedState(snapshot: string, timestamp: number)` - called after successful save
   - Action: `clearSavedState()` - for new project/clear canvas
   - Selector: `isDirty()` - compares current serializable state against savedStateSnapshot

   For isDirty comparison, serialize these fields (matching project save format):
   - elements, canvasWidth, canvasHeight, backgroundColor, backgroundType
   - gradientConfig, snapToGrid, gridSize, assets, knobStyles

   Logic:
   - If savedStateSnapshot is null AND elements.length > 0: dirty (never saved, has content)
   - If savedStateSnapshot is null AND elements.length === 0: not dirty (fresh empty project)
   - Otherwise: compare JSON.stringify of current state vs savedStateSnapshot

2. Update `src/store/index.ts`:
   - Import and add DirtyStateSlice to Store type
   - Add createDirtyStateSlice to the combined store composition
   - Add to temporal partialize to EXCLUDE savedStateSnapshot and lastSavedTimestamp from undo history

Note: Use StateCreator<Store, [], [], DirtyStateSlice> pattern for slice typing (same as existing slices).
  </action>
  <verify>TypeScript compiles without errors: `npm run build`</verify>
  <done>DirtyStateSlice exists with isDirty(), setSavedState(), clearSavedState() actions integrated into main store</done>
</task>

<task type="auto">
  <name>Task 2: Create hooks and install date-fns</name>
  <files>src/hooks/useBeforeUnload.ts, src/hooks/useDirtyState.ts, package.json</files>
  <action>
1. Install date-fns: `npm install date-fns`

2. Create `src/hooks/useBeforeUnload.ts`:
   ```typescript
   import { useEffect } from 'react'

   export function useBeforeUnload(enabled: boolean) {
     useEffect(() => {
       if (!enabled) return

       const handleBeforeUnload = (event: BeforeUnloadEvent) => {
         event.preventDefault()
         event.returnValue = '' // Required for Chrome
         return '' // For legacy browsers
       }

       window.addEventListener('beforeunload', handleBeforeUnload)

       return () => {
         window.removeEventListener('beforeunload', handleBeforeUnload)
       }
     }, [enabled])
   }
   ```

3. Create `src/hooks/useDirtyState.ts`:
   Hook that subscribes to store and provides:
   - `isDirty: boolean` - reactive dirty state
   - `lastSavedTimestamp: number | null` - for relative time display

   Use useStore selector pattern to subscribe to isDirty() result and lastSavedTimestamp.

   Important: isDirty() is a function in the store, so call it inside the selector:
   ```typescript
   const isDirty = useStore((state) => state.isDirty())
   ```
  </action>
  <verify>`npm run build` succeeds, date-fns appears in package.json dependencies</verify>
  <done>useBeforeUnload and useDirtyState hooks exist and are importable</done>
</task>

<task type="auto">
  <name>Task 3: Update LeftPanel with relative time and document title</name>
  <files>src/components/Layout/LeftPanel.tsx, src/App.tsx</files>
  <action>
1. Update `src/components/Layout/LeftPanel.tsx`:
   - Remove import of `lastUpdated` from buildInfo.ts (no longer needed in header)
   - Import `formatDistanceToNow` from 'date-fns'
   - Import `useDirtyState` hook (or use useStore directly)
   - Subscribe to `lastSavedTimestamp` from store

   Replace the existing timestamp display area (yellow badge showing build time) with:
   - A `LastSavedIndicator` component or inline logic that:
     - Shows "Never saved" if lastSavedTimestamp is null
     - Shows "Last saved: {formatDistanceToNow(lastSavedTimestamp, { addSuffix: true })}" otherwise
     - Uses useState + useEffect with 60-second setInterval to force re-render for auto-update

   Keep the "VST3 UI Designer" subtitle, just replace the yellow timestamp badge.

   Style: Use `text-xs text-gray-500` for the "Last saved" text (subtle, not attention-grabbing).

2. Update `src/App.tsx`:
   - Import useBeforeUnload hook
   - Import useStore for isDirty
   - Add document title management with useEffect:
     ```typescript
     const isDirty = useStore((state) => state.isDirty())

     useBeforeUnload(isDirty)

     useEffect(() => {
       const baseTitle = 'Faceplate - VST3 UI Designer'
       document.title = isDirty ? `* ${baseTitle}` : baseTitle
     }, [isDirty])
     ```

   Note: The app name is "Faceplate" per LeftPanel header.
  </action>
  <verify>
1. Run `npm run dev` and open browser
2. Add an element to canvas - document title should show asterisk prefix
3. "Last saved" should show "Never saved" for new project
  </verify>
  <done>Document title shows asterisk when dirty, LeftPanel shows relative time since last save</done>
</task>

</tasks>

<verification>
1. TypeScript compilation: `npm run build` completes without errors
2. Document title behavior:
   - Fresh load: "Faceplate - VST3 UI Designer" (no asterisk)
   - After adding element: "* Faceplate - VST3 UI Designer" (asterisk appears)
3. Last saved indicator:
   - Fresh project: Shows "Never saved"
   - Text updates periodically (every 60 seconds) - observable after saving in Plan 02
4. Store integration:
   - isDirty() returns false on fresh load
   - isDirty() returns true after adding element
   - savedStateSnapshot starts as null
</verification>

<success_criteria>
- DirtyStateSlice provides accurate dirty state detection via snapshot comparison
- useBeforeUnload hook manages browser warning lifecycle
- Document title shows/hides asterisk based on dirty state
- LeftPanel displays "Never saved" for new projects
- All TypeScript types compile without errors
</success_criteria>

<output>
After completion, create `.planning/phases/32-unsaved-changes-protection/32-01-SUMMARY.md`
</output>
