---
phase: 14-security-foundation-upload-pipeline
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - src/lib/svg-validator.ts
  - src/lib/svg-validator.test.ts
autonomous: true

must_haves:
  truths:
    - "SVG files over 1MB are rejected with clear error message"
    - "SVG files with more than 5000 elements are rejected with clear error message"
    - "SVG files containing DOCTYPE declarations are rejected with clear error message"
    - "Invalid SVG syntax is rejected with parse error message"
    - "Valid SVG files pass validation with metadata"
  artifacts:
    - path: "src/lib/svg-validator.ts"
      provides: "SVG validation functions"
      exports: ["validateSVGFile", "validateSVGContent", "SVGValidationResult"]
    - path: "src/lib/svg-validator.test.ts"
      provides: "Comprehensive validation tests"
      min_lines: 80
  key_links:
    - from: "src/lib/svg-validator.ts"
      to: "DOMParser"
      via: "SVG parsing for element count"
      pattern: "new DOMParser"
---

<objective>
Create SVG file validation logic with comprehensive test coverage using TDD.

Purpose: Implements SEC-05 (DOCTYPE rejection), SEC-06 (size limit), SEC-07 (element limit) - the first line of defense against malicious SVG content. Validation runs BEFORE sanitization to reject obviously problematic files early with clear user-facing error messages.

Output: Tested validation functions that validate SVG files against security requirements.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/14-security-foundation-upload-pipeline/14-CONTEXT.md
@.planning/phases/14-security-foundation-upload-pipeline/14-RESEARCH.md
</context>

<feature>
  <name>SVG File Validator</name>
  <files>src/lib/svg-validator.ts, src/lib/svg-validator.test.ts</files>
  <behavior>
    SVG validation functions that check files before storage:

    validateSVGFile(file: File) => SVGValidationResult
    - File > 1MB -> { valid: false, error: "File too large (X.XXmb). Maximum is 1MB." }
    - File <= 1MB -> { valid: true }

    validateSVGContent(content: string) => SVGValidationResult
    - Contains "<!DOCTYPE" -> { valid: false, error: "DOCTYPE not allowed..." }
    - Invalid XML syntax -> { valid: false, error: "Invalid SVG format..." }
    - Element count > 5000 -> { valid: false, error: "Too many elements (X). Maximum is 5000." }
    - Contains dangerous elements (script, foreignObject, animate, etc.) -> { valid: false, error: "Rejected: SVG contains dangerous elements..." }
    - Valid SVG -> { valid: true, metadata: { size, elementCount } }

    Test cases:
    - 500KB valid SVG -> passes
    - 1.5MB SVG -> fails with size error
    - SVG with DOCTYPE -> fails with DOCTYPE error
    - SVG with 6000 elements -> fails with element count error
    - SVG with <script> tag -> fails with dangerous element error
    - SVG with <foreignObject> -> fails with dangerous element error
    - SVG with <animate> -> fails with dangerous element error
    - Malformed XML -> fails with parse error
    - Valid minimal SVG -> passes with metadata
  </behavior>
  <implementation>
    1. Create SVGValidationResult interface with discriminated union
    2. Implement validateSVGFile - check file.size against 1MB limit
    3. Implement validateSVGContent:
       - Check for DOCTYPE string (case-insensitive)
       - Parse with DOMParser, check for parsererror
       - Count elements with querySelectorAll('*')
       - Check for dangerous tags: script, foreignObject, animate, animateTransform, animateMotion, set
    4. Export functions and types

    Error message format (from CONTEXT.md):
    - Size: "File too large (2.3MB). Maximum is 1MB."
    - DOCTYPE: "DOCTYPE not allowed. Remove <!DOCTYPE> declaration and try again."
    - Elements: "Too many elements (6000). Maximum is 5000."
    - Dangerous: "Rejected: SVG contains dangerous elements that cannot be sanitized: <script> (1), <animate> (3)"
    - Parse: "Invalid SVG format. File could not be parsed."
  </implementation>
</feature>

<verification>
- `npm test -- svg-validator` passes all test cases
- Test file contains at least 8 test cases covering all validation rules
- TypeScript compiles without errors: `npx tsc --noEmit`
</verification>

<success_criteria>
- validateSVGFile rejects files > 1MB with formatted size in error
- validateSVGContent rejects DOCTYPE with specific message
- validateSVGContent rejects element count > 5000 with actual count in error
- validateSVGContent rejects dangerous elements with element names listed
- validateSVGContent returns metadata (size, elementCount) for valid SVG
- All test cases pass
</success_criteria>

<output>
After completion, create `.planning/phases/14-security-foundation-upload-pipeline/14-01-SUMMARY.md`
</output>
