---
phase: 14-security-foundation-upload-pipeline
plan: 02
type: tdd
wave: 1
depends_on: []
files_modified:
  - package.json
  - src/lib/svg-sanitizer.ts
  - src/lib/svg-sanitizer.test.ts
autonomous: true

must_haves:
  truths:
    - "SVG content is sanitized by DOMPurify with strict allowlist"
    - "Script tags are removed from SVG content"
    - "Foreign object elements are removed from SVG content"
    - "External URL references are blocked"
    - "Safe SVG elements (path, circle, rect, g) are preserved"
    - "Gradients and stops are preserved"
  artifacts:
    - path: "src/lib/svg-sanitizer.ts"
      provides: "DOMPurify-based SVG sanitization"
      exports: ["sanitizeSVG", "SANITIZE_CONFIG"]
    - path: "src/lib/svg-sanitizer.test.ts"
      provides: "Sanitization test coverage"
      min_lines: 60
  key_links:
    - from: "src/lib/svg-sanitizer.ts"
      to: "dompurify"
      via: "import DOMPurify"
      pattern: "import.*DOMPurify"
---

<objective>
Install DOMPurify and create SVG sanitization logic with comprehensive test coverage using TDD.

Purpose: Implements SEC-01 (upload sanitization) core logic - the DOMPurify configuration that will be used at all sanitization points (upload, load, render, export). This is the security foundation for all SVG handling.

Output: Tested sanitization function that removes dangerous content while preserving safe SVG elements.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/14-security-foundation-upload-pipeline/14-CONTEXT.md
@.planning/phases/14-security-foundation-upload-pipeline/14-RESEARCH.md
</context>

<feature>
  <name>SVG Sanitizer with DOMPurify</name>
  <files>src/lib/svg-sanitizer.ts, src/lib/svg-sanitizer.test.ts</files>
  <behavior>
    DOMPurify-based SVG sanitization with strict allowlist configuration:

    sanitizeSVG(svgContent: string) => string
    - Removes script tags: `<script>alert(1)</script>` -> removed
    - Removes foreignObject: `<foreignObject>...</foreignObject>` -> removed
    - Removes SMIL animations: `<animate>`, `<animateTransform>`, etc. -> removed
    - Blocks external URLs: `href="http://evil.com"` -> removed
    - Preserves safe elements: svg, g, path, circle, rect, ellipse, line, polyline, polygon
    - Preserves text: text, tspan
    - Preserves gradients: defs, linearGradient, radialGradient, stop
    - Preserves clipping: clipPath, mask
    - Preserves safe attributes: viewBox, width, height, d, fill, stroke, transform, etc.

    Test cases:
    - Script tag injection -> script removed, rest preserved
    - foreignObject -> removed
    - SMIL animate element -> removed
    - External xlink:href -> href removed
    - javascript: URL in href -> href removed
    - Valid SVG with path -> path preserved
    - SVG with gradient -> gradient and stops preserved
    - SVG with transform -> transform preserved
    - Nested dangerous content in g -> dangerous content removed, g preserved
    - Empty SVG -> returns empty SVG structure
  </behavior>
  <implementation>
    1. Install dependencies: `npm install dompurify @types/dompurify`
    2. Create SANITIZE_CONFIG constant with:
       - ALLOWED_TAGS: strict allowlist (NO USE_PROFILES - they conflict)
       - ALLOWED_ATTR: safe SVG attributes only
       - ALLOWED_URI_REGEXP: /^(?!.*:)/ to block ALL URLs (only fragment refs allowed)
       - SAFE_FOR_XML: true
    3. Create sanitizeSVG function that calls DOMPurify.sanitize with config
    4. Export config for potential hook usage in future

    CRITICAL from RESEARCH.md:
    - Do NOT combine USE_PROFILES with ALLOWED_TAGS (override conflict)
    - Block ALL external URLs with ALLOWED_URI_REGEXP
    - Include style attribute but DOMPurify will sanitize CSS
  </implementation>
</feature>

<verification>
- `npm install` succeeds with dompurify and @types/dompurify
- `npm test -- svg-sanitizer` passes all test cases
- Test file contains at least 10 test cases covering sanitization rules
- TypeScript compiles without errors: `npx tsc --noEmit`
</verification>

<success_criteria>
- DOMPurify installed and importable
- sanitizeSVG removes all dangerous elements (script, foreignObject, animate)
- sanitizeSVG blocks external URL references
- sanitizeSVG preserves safe SVG structure and attributes
- All test cases pass
</success_criteria>

<output>
After completion, create `.planning/phases/14-security-foundation-upload-pipeline/14-02-SUMMARY.md`
</output>
