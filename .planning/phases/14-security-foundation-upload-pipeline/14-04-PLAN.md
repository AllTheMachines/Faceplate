---
phase: 14-security-foundation-upload-pipeline
plan: 04
type: execute
wave: 2
depends_on: ["14-01", "14-02"]
files_modified:
  - src/services/serialization.ts
  - src/services/export/htmlGenerator.ts
  - src/schemas/project.ts
autonomous: true

must_haves:
  truths:
    - "Project JSON re-sanitizes all SVG content when loading (tampering protection)"
    - "Exported HTML includes CSP meta tag for XSS prevention"
    - "Exported HTML sanitizes any inline SVG content"
    - "Project schema supports assets array for SVG storage"
  artifacts:
    - path: "src/services/serialization.ts"
      provides: "Re-sanitization on project load"
      contains: "sanitizeSVG"
    - path: "src/services/export/htmlGenerator.ts"
      provides: "CSP header and sanitized export"
      contains: "Content-Security-Policy"
    - path: "src/schemas/project.ts"
      provides: "Schema with SVGAsset type"
      contains: "SVGAssetSchema"
  key_links:
    - from: "src/services/serialization.ts"
      to: "src/lib/svg-sanitizer.ts"
      via: "import sanitizeSVG"
      pattern: "import.*sanitizeSVG.*svg-sanitizer"
    - from: "src/services/export/htmlGenerator.ts"
      to: "Content-Security-Policy"
      via: "meta tag"
      pattern: "Content-Security-Policy"
---

<objective>
Integrate SVG sanitization into serialization and export systems.

Purpose: Implements SEC-02 (re-sanitize on load), SEC-04 (sanitize before export), and adds CSP headers to exported HTML. This completes the defense-in-depth chain: sanitize at upload (Plan 02), re-sanitize at load (this plan), re-sanitize at render (Plan 03), sanitize at export (this plan).

Output: Complete security integration across all SVG handling points.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/14-security-foundation-upload-pipeline/14-CONTEXT.md
@.planning/phases/14-security-foundation-upload-pipeline/14-RESEARCH.md
@src/lib/svg-sanitizer.ts
@src/lib/svg-validator.ts
@src/services/serialization.ts
@src/services/export/htmlGenerator.ts
@src/schemas/project.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add SVGAsset schema to project</name>
  <files>src/schemas/project.ts</files>
  <action>
    Add SVGAsset schema to support asset storage in project files:

    ```typescript
    // Add after existing schemas
    export const SVGAssetSchema = z.object({
      id: z.string(),
      name: z.string(),
      content: z.string(), // Always sanitized SVG content
      category: z.enum(['logo', 'icon', 'decoration', 'background']),
      notes: z.string().optional(),
      uploadedAt: z.number(),
      metadata: z.object({
        originalSize: z.number(),
        elementCount: z.number(),
      }),
    });

    export type SVGAsset = z.infer<typeof SVGAssetSchema>;
    ```

    Update ProjectSchema to include assets array:
    ```typescript
    export const ProjectSchema = z.object({
      version: z.string(),
      canvas: CanvasConfigSchema,
      elements: z.array(ElementConfigSchema),
      assets: z.array(SVGAssetSchema).optional().default([]), // New field
      selectedIds: z.array(z.string()).optional(),
    });
    ```

    This prepares the schema for Phase 15 (Asset Library) while supporting re-sanitization in serialization.
  </action>
  <verify>`npx tsc --noEmit` compiles without errors</verify>
  <done>SVGAssetSchema exported and ProjectSchema includes optional assets array</done>
</task>

<task type="auto">
  <name>Task 2: Add re-sanitization to project load</name>
  <files>src/services/serialization.ts</files>
  <action>
    Update deserializeProject to re-sanitize all SVG content on load:

    1. Import sanitizeSVG from svg-sanitizer
    2. After successful validation, re-sanitize all asset content
    3. Log warning (via console.warn) if sanitization modifies content - indicates possible tampering

    ```typescript
    import { sanitizeSVG } from '../lib/svg-sanitizer';

    // In deserializeProject, after schema validation succeeds:
    if (result.success) {
      const data = result.data;

      // Re-sanitize all SVG assets (SEC-02: tampering protection)
      if (data.assets && data.assets.length > 0) {
        data.assets = data.assets.map(asset => {
          const resanitized = sanitizeSVG(asset.content);
          // Log if content changed during re-sanitization (possible tampering)
          if (resanitized !== asset.content) {
            console.warn(`Asset "${asset.name}" was modified during re-sanitization (possible tampering)`);
          }
          return {
            ...asset,
            content: resanitized
          };
        });
      }

      return { success: true, data };
    }
    ```

    Note: Silent re-sanitization per CONTEXT.md - only log to console if changes detected, no toast (that would be disruptive for normal project load).
  </action>
  <verify>TypeScript compiles and existing serialization tests still pass</verify>
  <done>deserializeProject re-sanitizes all SVG assets on load with tampering detection</done>
</task>

<task type="auto">
  <name>Task 3: Add CSP to exported HTML</name>
  <files>src/services/export/htmlGenerator.ts</files>
  <action>
    Add Content-Security-Policy meta tag to exported HTML for XSS prevention:

    1. Find the HTML template generation (likely in generateHTML or similar)
    2. Add CSP meta tag in the <head> section
    3. Also add sanitization for any SVG content embedded in export

    CSP meta tag to add:
    ```html
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data: blob:; font-src 'self' data:;">
    ```

    This CSP:
    - Allows inline scripts (needed for JUCE bridge)
    - Allows inline styles (needed for element styling)
    - Allows data: and blob: URLs for images (SVG as data URI)
    - Blocks external resource loading

    If SVG content is included in export, import sanitizeSVG and sanitize before embedding.
  </action>
  <verify>Export HTML and verify CSP meta tag is present in output</verify>
  <done>Exported HTML includes CSP meta tag for security</done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` compiles without errors
- ProjectSchema includes assets array with SVGAssetSchema
- deserializeProject imports and uses sanitizeSVG
- Generated HTML export contains Content-Security-Policy meta tag
- Run existing tests to ensure no regressions
</verification>

<success_criteria>
- SVGAssetSchema added to project.ts with all required fields
- ProjectSchema updated to include optional assets array
- deserializeProject re-sanitizes all SVG assets on load
- Console warning logged if re-sanitization modifies content
- Exported HTML includes CSP meta tag
- No regressions in existing functionality
</success_criteria>

<output>
After completion, create `.planning/phases/14-security-foundation-upload-pipeline/14-04-SUMMARY.md`
</output>
