---
phase: 11-element-consolidation
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/Properties/ImageProperties.tsx
autonomous: true

must_haves:
  truths:
    - "Image element has file picker button in property panel"
    - "User can select image file from local filesystem"
    - "Selected image appears on canvas immediately"
  artifacts:
    - path: "src/components/Properties/ImageProperties.tsx"
      provides: "File picker button for image selection"
      contains: "fileOpen"
  key_links:
    - from: "ImageProperties.tsx"
      to: "browser-fs-access"
      via: "fileOpen import"
      pattern: "import.*fileOpen.*from.*browser-fs-access"
---

<objective>
Add file picker for Image element source selection

Purpose: Address BUG-09 from UAT feedback - Image Source should allow selecting images from a file picker rather than only showing base64 info or URL input.

Output: Updated ImageProperties component with file picker button that opens native file dialog and embeds selected image as base64
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/11-element-consolidation/11-RESEARCH.md

@src/components/Properties/ImageProperties.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add file picker functionality to ImageProperties</name>
  <files>src/components/Properties/ImageProperties.tsx</files>
  <action>
Add a file picker button using browser-fs-access (already installed in the project).

1. Add import at top of file:
```tsx
import { fileOpen } from 'browser-fs-access'
```

2. Add a file picker handler function inside the component:
```tsx
const handleSelectImage = async () => {
  try {
    const file = await fileOpen({
      mimeTypes: ['image/*'],
      extensions: ['.png', '.jpg', '.jpeg', '.gif', '.svg', '.webp'],
      description: 'Image files',
      multiple: false,
    })

    // Convert to base64 data URL for embedding
    const reader = new FileReader()
    reader.onloadend = () => {
      const base64 = reader.result as string
      onUpdate({ src: base64 })
    }
    reader.readAsDataURL(file)
  } catch (err) {
    // User cancelled the file picker - silently ignore
    console.debug('File picker cancelled')
  }
}
```

3. Update the Source PropertySection to always show the file picker button, plus show image info if one is loaded:
```tsx
<PropertySection title="Source">
  <button
    onClick={handleSelectImage}
    className="w-full bg-blue-600 hover:bg-blue-700 text-white rounded px-3 py-2 text-sm font-medium transition-colors"
  >
    Select Image File...
  </button>

  {element.src ? (
    <div className="mt-3 text-xs text-gray-400">
      {isBase64 ? (
        <>
          <p className="font-medium text-gray-300">Image loaded (embedded)</p>
          <p className="mt-1 text-gray-500 truncate">
            {element.src.substring(0, 60)}...
          </p>
        </>
      ) : (
        <>
          <p className="font-medium text-gray-300">External URL</p>
          <p className="mt-1 text-gray-500 break-all">{element.src}</p>
        </>
      )}
      <button
        onClick={() => onUpdate({ src: '' })}
        className="mt-2 text-red-400 hover:text-red-300 text-xs underline"
      >
        Clear image
      </button>
    </div>
  ) : (
    <p className="mt-2 text-xs text-gray-500">No image selected</p>
  )}

  {/* Keep URL input as alternative */}
  <div className="mt-3 pt-3 border-t border-gray-700">
    <TextInput
      label="Or enter URL"
      value={isBase64 ? '' : element.src}
      onChange={(src) => onUpdate({ src })}
      placeholder="https://example.com/image.png"
    />
  </div>
</PropertySection>
```

Note: The URL input is disabled/cleared when a base64 image is loaded to prevent confusion. Users can clear the image first if they want to switch to URL mode.
  </action>
  <verify>
Run the app (`npm run dev`), add an Image element to the canvas. In the property panel, you should see a "Select Image File..." button. Click it - a native file picker dialog should open. Select a PNG or JPG image - it should appear on the canvas. The property panel should show "Image loaded (embedded)" with a truncated base64 preview.
  </verify>
  <done>Image element has working file picker button that loads images from local filesystem</done>
</task>

<task type="auto">
  <name>Task 2: Add image preview thumbnail in properties</name>
  <files>src/components/Properties/ImageProperties.tsx</files>
  <action>
Add a small preview thumbnail of the loaded image in the properties panel for better UX.

After the "Image loaded" text but before the "Clear image" button, add:
```tsx
{element.src && (
  <div className="mt-2 border border-gray-600 rounded overflow-hidden bg-gray-800">
    <img
      src={element.src}
      alt="Preview"
      className="w-full h-20 object-contain"
    />
  </div>
)}
```

Full updated section structure:
```tsx
{element.src ? (
  <div className="mt-3 text-xs text-gray-400">
    {isBase64 ? (
      <p className="font-medium text-gray-300">Image loaded (embedded)</p>
    ) : (
      <>
        <p className="font-medium text-gray-300">External URL</p>
        <p className="mt-1 text-gray-500 break-all">{element.src}</p>
      </>
    )}

    {/* Preview thumbnail */}
    <div className="mt-2 border border-gray-600 rounded overflow-hidden bg-gray-800">
      <img
        src={element.src}
        alt="Preview"
        className="w-full h-20 object-contain"
      />
    </div>

    <button
      onClick={() => onUpdate({ src: '' })}
      className="mt-2 text-red-400 hover:text-red-300 text-xs underline"
    >
      Clear image
    </button>
  </div>
) : (
  <p className="mt-2 text-xs text-gray-500">No image selected</p>
)}
```

This gives users visual confirmation of which image is loaded without having to look at the canvas.
  </action>
  <verify>
Add an Image element, select an image file. In the properties panel, verify a small thumbnail preview appears below the "Image loaded" text. The thumbnail should show the image scaled to fit within the panel width while maintaining aspect ratio.
  </verify>
  <done>Image properties show a thumbnail preview of the loaded image</done>
</task>

</tasks>

<verification>
1. `npm run dev` - app starts without errors
2. `npm run typecheck` - no TypeScript errors
3. Add Image element - "Select Image File..." button visible
4. Click button - native file picker opens
5. Select image file - image appears on canvas
6. Properties show thumbnail preview of loaded image
7. "Clear image" button removes the image
8. URL input still works as alternative
</verification>

<success_criteria>
- File picker button visible in Image properties
- Clicking button opens native file dialog
- Selecting image embeds it as base64 and shows on canvas
- Thumbnail preview shows in properties panel
- Clear button removes the image
- URL input remains as alternative method
- No errors when user cancels file picker
</success_criteria>

<output>
After completion, create `.planning/phases/11-element-consolidation/11-03-SUMMARY.md`
</output>
