---
phase: 12-export-roundtrip-testing
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .planning/phases/12-export-roundtrip-testing/12-VERIFICATION.md
autonomous: false

must_haves:
  truths:
    - "Effect Starter template loads with all 6 elements correctly positioned"
    - "Instrument Starter template loads with all 14 elements correctly positioned"
    - "Exported JUCE bundle contains dynamic bridge pattern with integer resultId"
    - "Exported C++ contains four native function registrations"
    - "HTML preview works standalone with mock JUCE backend"
    - "Round-trip (save/load) preserves identical canvas state"
  artifacts:
    - path: ".planning/phases/12-export-roundtrip-testing/12-VERIFICATION.md"
      provides: "Verification results document"
      contains: "all verification checks passed or failed"
  key_links:
    - from: "templates/*.json"
      to: "canvas rendering"
      via: "templateStore.loadTemplate()"
      pattern: "elements rendered at x,y positions"
    - from: "jsGenerator.ts"
      to: "exported bindings.js"
      via: "generateBindingsJS()"
      pattern: "createJUCEFunctionWrappers, nextResultId"
    - from: "cppGenerator.ts"
      to: "exported bindings.cpp"
      via: "generateCPP()"
      pattern: "withNativeFunction.*setParameter|getParameter|beginGesture|endGesture"
---

<objective>
Verify the complete export and round-trip pipeline works correctly for v1 release.

Purpose: This validation phase confirms that built-in templates load correctly, exports produce working JUCE WebView2 code with the dynamic bridge pattern, and save/load round-trips preserve state. This is the final verification before v1.0 release.

Output: VERIFICATION.md with all test results documented
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-export-roundtrip-testing/12-RESEARCH.md

# Template files to verify
@templates/effect-starter.json
@templates/instrument-starter.json

# Export generators to verify
@src/services/export/jsGenerator.ts
@src/services/export/cppGenerator.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Verify template loading</name>
  <files>.planning/phases/12-export-roundtrip-testing/12-VERIFICATION.md</files>
  <action>
    Start the dev server and verify both built-in templates load correctly:

    1. Start dev server: `npm run dev`
    2. Open app in browser (typically http://localhost:5173)

    **Effect Starter verification:**
    - Click Load Template dropdown in toolbar
    - Select "Effect Starter"
    - Verify canvas dimensions: 500x300px, background #1a1a2e
    - Verify 6 elements appear:
      * label-plugin-title at (150, 30) - "EFX Template"
      * label-status at (180, 75) - "Connecting..."
      * knob-volume at (215, 120) - 70x70 with parameterId "volume"
      * label-volume at (215, 200) - "Volume"
      * meter-output at (380, 120) - 25x120 vertical meter
      * label-output at (365, 245) - "Output"
    - Click each element to confirm selectable

    **Instrument Starter verification:**
    - Select "Instrument Starter" template
    - Verify canvas dimensions: 600x400px, background #1a1a2e
    - Verify 14 elements appear:
      * Title label, section labels, ADSR knobs (Attack, Decay, Sustain, Release)
      * Gain knob with parameterId "gain"
      * All labels positioned correctly
    - Click each element to confirm selectable

    Record results in VERIFICATION.md with PASS/FAIL for each check.
  </action>
  <verify>
    Both templates load without errors. All elements visible and selectable.
    VERIFICATION.md created with template loading results.
  </verify>
  <done>
    Effect Starter loads with 6 correctly positioned elements.
    Instrument Starter loads with 14 correctly positioned elements.
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify JUCE export bundle</name>
  <files>.planning/phases/12-export-roundtrip-testing/12-VERIFICATION.md</files>
  <action>
    Export the Effect Starter template as a JUCE bundle and verify contents:

    1. Load Effect Starter template
    2. Click Export dropdown, select "Export JUCE Bundle"
    3. Save ZIP file (e.g., effect-starter-juce.zip)
    4. Extract ZIP and verify 6 files exist:
       - index.html
       - styles.css
       - components.js
       - bindings.js
       - bindings.cpp
       - README.md

    **bindings.js verification (dynamic bridge pattern):**
    Use grep to verify these patterns in bindings.js:
    ```bash
    grep -c "nextResultId = 1" bindings.js           # Should output: 1 (integer init)
    grep -c "Math.random()" bindings.js              # Should output: 0 (MUST NOT exist)
    grep -c "createJUCEFunctionWrappers" bindings.js # Should output: >= 1
    grep -c "__juce__functions" bindings.js          # Should output: >= 2
    grep -c "nextResultId++" bindings.js             # Should output: 1 (increment)
    ```

    **bindings.cpp verification (4 native functions):**
    Use grep to verify these patterns in bindings.cpp:
    ```bash
    grep -c "withNativeFunction.*setParameter" bindings.cpp   # Should output: 1
    grep -c "withNativeFunction.*getParameter" bindings.cpp   # Should output: 1
    grep -c "withNativeFunction.*beginGesture" bindings.cpp   # Should output: 1
    grep -c "withNativeFunction.*endGesture" bindings.cpp     # Should output: 1
    ```

    Record all grep results in VERIFICATION.md with PASS/FAIL for each pattern.
  </action>
  <verify>
    ZIP contains all 6 files.
    bindings.js contains dynamic bridge pattern with integer resultId.
    bindings.cpp contains all 4 native function registrations.
  </verify>
  <done>
    Exported bindings.js contains createJUCEFunctionWrappers, integer nextResultId (not Math.random).
    Exported bindings.cpp contains setParameter, getParameter, beginGesture, endGesture.
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify HTML preview standalone mode</name>
  <files>.planning/phases/12-export-roundtrip-testing/12-VERIFICATION.md</files>
  <action>
    Export Effect Starter as HTML preview and verify standalone operation:

    1. Load Effect Starter template in designer
    2. Click Export dropdown, select "Export HTML Preview"
    3. Save ZIP file (e.g., effect-starter-preview.zip)
    4. Extract ZIP and verify 5 files exist:
       - index.html
       - styles.css
       - components.js
       - bindings.js
       - README.md
       (No bindings.cpp - this is standalone preview)

    5. Open index.html directly in browser (file:// or use `npx serve .`)
    6. Verify:
       - Status indicator shows "Standalone Mode" (amber text)
       - Elements render correctly
       - Knob is draggable (drag up/down)
       - Console shows "[Mock] setParameter(...)" when dragging
       - No JavaScript errors in console

    Record results in VERIFICATION.md.
  </action>
  <verify>
    HTML preview opens in browser without errors.
    Status shows "Standalone Mode".
    Knob interaction logs mock setParameter calls.
  </verify>
  <done>
    Standalone HTML preview works in browser with mock JUCE backend.
    Knob interaction produces mock setParameter console logs.
  </done>
</task>

<task type="auto">
  <name>Task 4: Verify round-trip integrity</name>
  <files>.planning/phases/12-export-roundtrip-testing/12-VERIFICATION.md</files>
  <action>
    Test save/load round-trip preserves state:

    1. Load Effect Starter template
    2. Make a modification: Move the volume knob to position (100, 150)
    3. Save project: File > Save Project (or Ctrl+S)
    4. Name it "roundtrip-test.json"
    5. Record the saved state:
       - Element count (should be 6)
       - knob-volume position (should be 100, 150)
       - Canvas dimensions (should be 500, 300)

    6. Create new design (or reload page)
    7. Load the saved project: File > Open Project
    8. Select "roundtrip-test.json"
    9. Verify restored state matches:
       - Element count: 6
       - knob-volume position: (100, 150) exactly
       - Canvas dimensions: 500x300
       - All other elements at original positions

    **Additional round-trip test:**
    10. Save the loaded project again as "roundtrip-test-2.json"
    11. Compare JSON files (open both in text editor):
        - Element IDs should match
        - Positions should match
        - Canvas settings should match
        (Element array order may differ - this is OK)

    Record results in VERIFICATION.md.
  </action>
  <verify>
    Saved project loads with identical canvas state.
    Modified knob position preserved exactly.
    Double round-trip produces equivalent JSON.
  </verify>
  <done>
    Round-trip (save -> load) preserves all element positions, properties, and canvas settings.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Completed all Phase 12 verification tasks:
    1. Template loading (Effect Starter + Instrument Starter)
    2. JUCE export bundle verification (dynamic bridge pattern, C++ functions)
    3. HTML preview standalone mode
    4. Save/load round-trip integrity
  </what-built>
  <how-to-verify>
    Review VERIFICATION.md for all test results:

    1. Open `.planning/phases/12-export-roundtrip-testing/12-VERIFICATION.md`
    2. Confirm all sections show PASS:
       - Template Loading: Effect Starter PASS, Instrument Starter PASS
       - JUCE Export: All grep patterns match expected counts
       - HTML Preview: Standalone mode works with mock backend
       - Round-Trip: State preserved after save/load cycle

    If any section shows FAIL, review the failure details and decide if:
    - It's a genuine bug requiring a gap closure plan
    - It's acceptable for v1.0 release
    - It should be logged in ISSUES-v1.1.md for later

    Optionally run the verification yourself:
    - npm run dev
    - Load templates, export bundles, test round-trip
  </how-to-verify>
  <resume-signal>Type "approved" if all verifications pass, or describe issues found</resume-signal>
</task>

</tasks>

<verification>
All Phase 12 success criteria verified:
1. Effect Starter template loads with all elements correctly positioned
2. Instrument Starter template loads with all elements correctly positioned
3. Exported bindings.js contains dynamic bridge pattern (createJUCEFunctionWrappers, polling init)
4. Exported bindings.js uses integer resultId (not Math.random)
5. Exported bindings.cpp contains four native functions
6. Standalone preview works in browser (mock mode)
7. Round-trip: export -> reimport project JSON -> identical canvas state
</verification>

<success_criteria>
Phase 12 complete when:
- [ ] VERIFICATION.md exists with all test results
- [ ] Template loading: PASS for both templates
- [ ] JUCE export: PASS for dynamic bridge pattern and C++ functions
- [ ] HTML preview: PASS for standalone mode
- [ ] Round-trip: PASS for state preservation
- [ ] Human approval checkpoint passed
</success_criteria>

<output>
After completion, create `.planning/phases/12-export-roundtrip-testing/12-01-SUMMARY.md`
</output>
