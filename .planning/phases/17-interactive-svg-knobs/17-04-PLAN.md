---
phase: 17-interactive-svg-knobs
plan: "04"
type: execute
wave: 3
depends_on: ["17-01", "17-02"]
files_modified:
  - src/components/dialogs/LayerMappingDialog.tsx
  - src/components/dialogs/ManageKnobStylesDialog.tsx
  - src/components/dialogs/index.ts
autonomous: true

must_haves:
  truths:
    - "User can import SVG file and see auto-detected layer mappings"
    - "User can manually adjust layer assignments before confirming"
    - "User can set rotation range (default 270°) when creating style"
    - "User can view, rename, and delete existing knob styles"
    - "Delete shows usage warning if style is referenced by knob elements"
  artifacts:
    - path: "src/components/dialogs/LayerMappingDialog.tsx"
      provides: "Dialog for importing SVG and mapping layers to knob roles"
      exports: ["LayerMappingDialog"]
      min_lines: 150
    - path: "src/components/dialogs/ManageKnobStylesDialog.tsx"
      provides: "Dialog for listing, renaming, deleting knob styles"
      exports: ["ManageKnobStylesDialog"]
      min_lines: 100
  key_links:
    - from: "src/components/dialogs/LayerMappingDialog.tsx"
      to: "src/services/knobLayers.ts"
      via: "detectKnobLayers, getSuggestedLayers"
      pattern: "import.*detectKnobLayers"
    - from: "src/components/dialogs/ManageKnobStylesDialog.tsx"
      to: "src/store/index.ts"
      via: "useStore for knobStyles CRUD"
      pattern: "useStore.*knobStyles"
---

<objective>
Create dialogs for importing SVG knob designs with layer mapping and managing existing knob styles.

Purpose: Enable users to create reusable knob styles from SVG files and manage their style library.
Output: LayerMappingDialog for new imports, ManageKnobStylesDialog for viewing/editing existing styles.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-interactive-svg-knobs/17-RESEARCH.md
@.planning/phases/17-interactive-svg-knobs/17-CONTEXT.md
@src/components/dialogs/ImportAssetDialog.tsx (dialog pattern reference)
@src/components/dialogs/DeleteAssetDialog.tsx (delete with usage warning pattern)
@src/services/knobLayers.ts (layer detection utilities)
@src/types/knobStyle.ts (types)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create LayerMappingDialog component</name>
  <files>src/components/dialogs/LayerMappingDialog.tsx</files>
  <action>
Create `src/components/dialogs/LayerMappingDialog.tsx`:

```typescript
import { useState, useCallback, useEffect } from 'react'
import { useDropzone } from 'react-dropzone'
import toast from 'react-hot-toast'
import { useStore } from '../../store'
import { validateSVG } from '../../services/svg'
import { sanitizeSVG } from '../../services/svgSanitizer'
import { detectKnobLayers, getSuggestedLayers, DetectedLayers } from '../../services/knobLayers'
import { KnobStyleLayers } from '../../types/knobStyle'
import { SafeSVG } from '../SafeSVG'

interface LayerMappingDialogProps {
  isOpen: boolean
  onClose: () => void
}

type LayerRole = 'indicator' | 'track' | 'arc' | 'glow' | 'shadow' | 'exclude'

export function LayerMappingDialog({ isOpen, onClose }: LayerMappingDialogProps) {
  const addKnobStyle = useStore((state) => state.addKnobStyle)

  // Dialog state
  const [step, setStep] = useState<'upload' | 'mapping' | 'config'>('upload')
  const [svgContent, setSvgContent] = useState<string>('')
  const [styleName, setStyleName] = useState<string>('')
  const [detected, setDetected] = useState<DetectedLayers | null>(null)
  const [mappings, setMappings] = useState<Record<string, LayerRole>>({})
  const [minAngle, setMinAngle] = useState(-135)
  const [maxAngle, setMaxAngle] = useState(135)

  // Reset state when dialog opens/closes
  useEffect(() => {
    if (!isOpen) {
      setStep('upload')
      setSvgContent('')
      setStyleName('')
      setDetected(null)
      setMappings({})
      setMinAngle(-135)
      setMaxAngle(135)
    }
  }, [isOpen])

  // File upload handling
  const onDrop = useCallback(async (acceptedFiles: File[]) => {
    const file = acceptedFiles[0]
    if (!file) return

    try {
      const content = await file.text()

      // Validate SVG
      const validationResult = validateSVG(content)
      if (!validationResult.valid) {
        toast.error(`Invalid SVG: ${validationResult.errors.join(', ')}`)
        return
      }

      // Sanitize SVG
      const sanitized = sanitizeSVG(content)

      // Detect layers
      const detectedLayers = detectKnobLayers(sanitized)
      const suggested = getSuggestedLayers(detectedLayers)

      // Initialize mappings from suggestions
      const initialMappings: Record<string, LayerRole> = {}
      const allIdentifiers = [
        ...detectedLayers.indicator,
        ...detectedLayers.track,
        ...detectedLayers.arc,
        ...detectedLayers.glow,
        ...detectedLayers.shadow,
        ...detectedLayers.unmapped,
      ]

      allIdentifiers.forEach((id) => {
        if (detectedLayers.indicator.includes(id)) initialMappings[id] = 'indicator'
        else if (detectedLayers.track.includes(id)) initialMappings[id] = 'track'
        else if (detectedLayers.arc.includes(id)) initialMappings[id] = 'arc'
        else if (detectedLayers.glow.includes(id)) initialMappings[id] = 'glow'
        else if (detectedLayers.shadow.includes(id)) initialMappings[id] = 'shadow'
        else initialMappings[id] = 'exclude'
      })

      setSvgContent(sanitized)
      setDetected(detectedLayers)
      setMappings(initialMappings)
      setStyleName(file.name.replace(/\.svg$/i, ''))
      setStep('mapping')
    } catch (error) {
      toast.error('Failed to read SVG file')
    }
  }, [])

  const { getRootProps, getInputProps, isDragActive } = useDropzone({
    onDrop,
    accept: { 'image/svg+xml': ['.svg'] },
    multiple: false,
  })

  // Handle mapping change
  const handleMappingChange = (identifier: string, role: LayerRole) => {
    setMappings((prev) => ({ ...prev, [identifier]: role }))
  }

  // Build KnobStyleLayers from mappings
  const buildLayers = (): KnobStyleLayers => {
    const layers: KnobStyleLayers = {}
    Object.entries(mappings).forEach(([id, role]) => {
      if (role !== 'exclude' && !layers[role]) {
        layers[role] = id
      }
    })
    return layers
  }

  // Validation: must have at least indicator mapped
  const hasIndicator = Object.values(mappings).includes('indicator')

  // Handle create style
  const handleCreate = () => {
    if (!styleName.trim()) {
      toast.error('Please enter a style name')
      return
    }

    if (!hasIndicator) {
      toast.error('At least one layer must be mapped as Indicator')
      return
    }

    const layers = buildLayers()
    addKnobStyle({
      name: styleName.trim(),
      svgContent,
      layers,
      minAngle,
      maxAngle,
    })

    toast.success(`Knob style "${styleName}" created`)
    onClose()
  }

  if (!isOpen) return null

  return (
    <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
      <div className="bg-gray-800 rounded-lg p-6 max-w-2xl w-full max-h-[90vh] overflow-y-auto">
        <h2 className="text-xl font-bold mb-4">
          {step === 'upload' && 'Import Knob Design'}
          {step === 'mapping' && 'Map Layers'}
          {step === 'config' && 'Configure Style'}
        </h2>

        {/* Step 1: Upload */}
        {step === 'upload' && (
          <div
            {...getRootProps()}
            className={`
              border-2 border-dashed rounded-lg p-8 text-center cursor-pointer
              transition-colors
              ${isDragActive ? 'border-blue-500 bg-blue-500/10' : 'border-gray-600 hover:border-gray-500'}
            `}
          >
            <input {...getInputProps()} />
            <div className="text-gray-400">
              <p className="mb-2">Drag & drop an SVG file here</p>
              <p className="text-sm">or click to browse</p>
            </div>
          </div>
        )}

        {/* Step 2: Layer Mapping */}
        {step === 'mapping' && detected && (
          <>
            <div className="grid grid-cols-2 gap-4 mb-4">
              {/* Preview */}
              <div className="bg-gray-900 rounded-lg p-4">
                <p className="text-sm text-gray-400 mb-2">Preview</p>
                <div className="w-32 h-32 mx-auto">
                  <SafeSVG content={svgContent} style={{ width: '100%', height: '100%' }} />
                </div>
              </div>

              {/* Layer List */}
              <div>
                <p className="text-sm text-gray-400 mb-2">Detected Layers</p>
                <div className="space-y-2 max-h-60 overflow-y-auto">
                  {Object.keys(mappings).map((id) => (
                    <div key={id} className="flex items-center gap-2">
                      <span className="text-sm text-gray-300 flex-1 truncate" title={id}>
                        {id}
                      </span>
                      <select
                        value={mappings[id]}
                        onChange={(e) => handleMappingChange(id, e.target.value as LayerRole)}
                        className="bg-gray-700 border border-gray-600 text-white rounded px-2 py-1 text-sm"
                      >
                        <option value="indicator">Indicator</option>
                        <option value="track">Track</option>
                        <option value="arc">Arc</option>
                        <option value="glow">Glow</option>
                        <option value="shadow">Shadow</option>
                        <option value="exclude">Exclude</option>
                      </select>
                    </div>
                  ))}
                </div>
              </div>
            </div>

            {!hasIndicator && (
              <p className="text-sm text-amber-400 mb-4">
                At least one layer must be mapped as Indicator
              </p>
            )}

            <div className="flex gap-2">
              <button
                onClick={() => setStep('upload')}
                className="flex-1 bg-gray-700 hover:bg-gray-600 text-white rounded px-4 py-2"
              >
                Back
              </button>
              <button
                onClick={() => setStep('config')}
                disabled={!hasIndicator}
                className="flex-1 bg-blue-600 hover:bg-blue-700 disabled:opacity-50 text-white rounded px-4 py-2"
              >
                Next
              </button>
            </div>
          </>
        )}

        {/* Step 3: Configuration */}
        {step === 'config' && (
          <>
            <div className="space-y-4 mb-4">
              <div>
                <label className="block text-sm text-gray-400 mb-1">Style Name</label>
                <input
                  type="text"
                  value={styleName}
                  onChange={(e) => setStyleName(e.target.value)}
                  className="w-full bg-gray-700 border border-gray-600 text-white rounded px-3 py-2"
                  placeholder="My Knob Style"
                />
              </div>

              <div className="grid grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm text-gray-400 mb-1">Min Angle (°)</label>
                  <input
                    type="number"
                    value={minAngle}
                    onChange={(e) => setMinAngle(Number(e.target.value))}
                    className="w-full bg-gray-700 border border-gray-600 text-white rounded px-3 py-2"
                  />
                </div>
                <div>
                  <label className="block text-sm text-gray-400 mb-1">Max Angle (°)</label>
                  <input
                    type="number"
                    value={maxAngle}
                    onChange={(e) => setMaxAngle(Number(e.target.value))}
                    className="w-full bg-gray-700 border border-gray-600 text-white rounded px-3 py-2"
                  />
                </div>
              </div>

              <p className="text-sm text-gray-500">
                Rotation range: {maxAngle - minAngle}° (Default: 270° from -135° to +135°)
              </p>
            </div>

            <div className="flex gap-2">
              <button
                onClick={() => setStep('mapping')}
                className="flex-1 bg-gray-700 hover:bg-gray-600 text-white rounded px-4 py-2"
              >
                Back
              </button>
              <button
                onClick={handleCreate}
                className="flex-1 bg-blue-600 hover:bg-blue-700 text-white rounded px-4 py-2"
              >
                Create Style
              </button>
            </div>
          </>
        )}

        {/* Cancel button */}
        <button
          onClick={onClose}
          className="w-full mt-4 bg-gray-700 hover:bg-gray-600 text-white rounded px-4 py-2"
        >
          Cancel
        </button>
      </div>
    </div>
  )
}
```
  </action>
  <verify>Run `npx tsc --noEmit` - no type errors.</verify>
  <done>LayerMappingDialog allows SVG upload, layer mapping, and style creation</done>
</task>

<task type="auto">
  <name>Task 2: Create ManageKnobStylesDialog component</name>
  <files>src/components/dialogs/ManageKnobStylesDialog.tsx</files>
  <action>
Create `src/components/dialogs/ManageKnobStylesDialog.tsx`:

```typescript
import { useState } from 'react'
import toast from 'react-hot-toast'
import { useStore } from '../../store'
import { LayerMappingDialog } from './LayerMappingDialog'
import { SafeSVG } from '../SafeSVG'

interface ManageKnobStylesDialogProps {
  isOpen: boolean
  onClose: () => void
}

export function ManageKnobStylesDialog({ isOpen, onClose }: ManageKnobStylesDialogProps) {
  const knobStyles = useStore((state) => state.knobStyles)
  const elements = useStore((state) => state.elements)
  const removeKnobStyle = useStore((state) => state.removeKnobStyle)
  const updateKnobStyle = useStore((state) => state.updateKnobStyle)

  const [showImport, setShowImport] = useState(false)
  const [editingId, setEditingId] = useState<string | null>(null)
  const [editName, setEditName] = useState('')

  // Count how many elements use a style
  const getStyleUsage = (styleId: string): number => {
    return elements.filter(
      (el) => el.type === 'knob' && 'styleId' in el && el.styleId === styleId
    ).length
  }

  // Handle delete with usage check
  const handleDelete = (styleId: string, styleName: string) => {
    const usage = getStyleUsage(styleId)
    if (usage > 0) {
      const confirmed = window.confirm(
        `"${styleName}" is used by ${usage} knob element${usage > 1 ? 's' : ''}. ` +
        `Delete anyway? Knobs will revert to default style.`
      )
      if (!confirmed) return
    }

    removeKnobStyle(styleId)
    toast.success(`Deleted style "${styleName}"`)
  }

  // Handle rename
  const handleStartRename = (styleId: string, currentName: string) => {
    setEditingId(styleId)
    setEditName(currentName)
  }

  const handleSaveRename = () => {
    if (editingId && editName.trim()) {
      updateKnobStyle(editingId, { name: editName.trim() })
      toast.success('Style renamed')
    }
    setEditingId(null)
    setEditName('')
  }

  if (!isOpen) return null

  return (
    <>
      <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
        <div className="bg-gray-800 rounded-lg p-6 max-w-2xl w-full max-h-[80vh] overflow-y-auto">
          <h2 className="text-xl font-bold mb-4">Manage Knob Styles</h2>

          {/* Import New Style Button */}
          <button
            onClick={() => setShowImport(true)}
            className="w-full mb-4 bg-blue-600 hover:bg-blue-700 text-white rounded px-4 py-2 flex items-center justify-center gap-2"
          >
            <span>+</span>
            <span>Import New Knob Style</span>
          </button>

          {/* Styles List */}
          {knobStyles.length === 0 ? (
            <p className="text-gray-400 text-center py-8">
              No knob styles yet. Import one to get started.
            </p>
          ) : (
            <div className="space-y-2">
              {knobStyles.map((style) => {
                const usage = getStyleUsage(style.id)
                const isEditing = editingId === style.id

                return (
                  <div
                    key={style.id}
                    className="flex items-center gap-3 bg-gray-700 p-3 rounded"
                  >
                    {/* Preview thumbnail */}
                    <div className="w-12 h-12 flex-shrink-0 bg-gray-900 rounded">
                      <SafeSVG
                        content={style.svgContent}
                        style={{ width: '100%', height: '100%' }}
                      />
                    </div>

                    {/* Name and info */}
                    <div className="flex-1 min-w-0">
                      {isEditing ? (
                        <input
                          type="text"
                          value={editName}
                          onChange={(e) => setEditName(e.target.value)}
                          onKeyDown={(e) => {
                            if (e.key === 'Enter') handleSaveRename()
                            if (e.key === 'Escape') setEditingId(null)
                          }}
                          onBlur={handleSaveRename}
                          autoFocus
                          className="bg-gray-600 border border-gray-500 text-white rounded px-2 py-1 text-sm w-full"
                        />
                      ) : (
                        <div className="font-medium text-white truncate">{style.name}</div>
                      )}
                      <div className="text-xs text-gray-400">
                        {style.maxAngle - style.minAngle}° range
                        {usage > 0 && ` • Used by ${usage} knob${usage > 1 ? 's' : ''}`}
                      </div>
                    </div>

                    {/* Actions */}
                    {!isEditing && (
                      <div className="flex gap-2 flex-shrink-0">
                        <button
                          onClick={() => handleStartRename(style.id, style.name)}
                          className="text-blue-400 hover:text-blue-300 text-sm px-2 py-1"
                        >
                          Rename
                        </button>
                        <button
                          onClick={() => handleDelete(style.id, style.name)}
                          className="text-red-400 hover:text-red-300 text-sm px-2 py-1"
                        >
                          Delete
                        </button>
                      </div>
                    )}
                  </div>
                )
              })}
            </div>
          )}

          {/* Close button */}
          <button
            onClick={onClose}
            className="w-full mt-4 bg-gray-700 hover:bg-gray-600 text-white rounded px-4 py-2"
          >
            Close
          </button>
        </div>
      </div>

      {/* Import dialog (nested) */}
      <LayerMappingDialog
        isOpen={showImport}
        onClose={() => setShowImport(false)}
      />
    </>
  )
}
```
  </action>
  <verify>Run `npx tsc --noEmit` - no type errors.</verify>
  <done>ManageKnobStylesDialog allows viewing, renaming, and deleting knob styles with usage warnings</done>
</task>

<task type="auto">
  <name>Task 3: Export dialogs from index</name>
  <files>src/components/dialogs/index.ts</files>
  <action>
Check if `src/components/dialogs/index.ts` exists. If it does, add exports for the new dialogs.
If it doesn't exist, create it.

Add or update to include:
```typescript
export { LayerMappingDialog } from './LayerMappingDialog'
export { ManageKnobStylesDialog } from './ManageKnobStylesDialog'
```

Preserve any existing exports.
  </action>
  <verify>Run `npx tsc --noEmit` - no import errors.</verify>
  <done>Dialog components are exported from index.ts</done>
</task>

</tasks>

<verification>
Run the following to verify all changes:
```bash
npx tsc --noEmit
npm run dev
```

Manual verification (after UI integration in 17-05):
- Import dialog shows when triggered
- Layer detection works on sample SVG
- Layer mappings can be adjusted
- Style is created and appears in ManageKnobStylesDialog
- Delete shows usage warning when style is in use
</verification>

<success_criteria>
- [ ] LayerMappingDialog has 3-step flow: upload -> mapping -> config
- [ ] SVG upload validates and sanitizes content
- [ ] Layer detection auto-populates mapping dropdowns
- [ ] User can override layer assignments
- [ ] Rotation range is configurable (default 270°)
- [ ] ManageKnobStylesDialog lists all styles with thumbnails
- [ ] Rename with inline edit and blur-to-save
- [ ] Delete shows confirmation with usage count
- [ ] TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/17-interactive-svg-knobs/17-04-SUMMARY.md`
</output>
