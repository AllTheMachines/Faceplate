---
phase: 17-interactive-svg-knobs
plan: "03"
type: execute
wave: 2
depends_on: ["17-01", "17-02"]
files_modified:
  - src/components/elements/renderers/KnobRenderer.tsx
autonomous: true

must_haves:
  truths:
    - "Knob with styleId renders using SVG layers from the knob style"
    - "Knob without styleId renders default CSS gradient knob (backward compatible)"
    - "Indicator layer rotates based on normalized value (0-1 maps to minAngle-maxAngle)"
    - "Color overrides are applied to SVG before rendering"
    - "Arc layer opacity animates based on value"
    - "Glow layer intensity increases with value"
  artifacts:
    - path: "src/components/elements/renderers/KnobRenderer.tsx"
      provides: "Conditional rendering - styled SVG knob or default CSS knob"
      contains: "styleId"
      min_lines: 150
  key_links:
    - from: "src/components/elements/renderers/KnobRenderer.tsx"
      to: "src/store/index.ts"
      via: "useStore for getKnobStyle"
      pattern: "useStore.*getKnobStyle"
    - from: "src/components/elements/renderers/KnobRenderer.tsx"
      to: "src/services/knobLayers.ts"
      via: "extractLayer, applyAllColorOverrides"
      pattern: "import.*extractLayer"
    - from: "src/components/elements/renderers/KnobRenderer.tsx"
      to: "src/components/SafeSVG.tsx"
      via: "SafeSVG for sanitized rendering"
      pattern: "import.*SafeSVG"
---

<objective>
Update KnobRenderer to render styled SVG knobs with layer-based animation and color overrides.

Purpose: Enable knob elements to display custom SVG designs with rotation animation and per-instance styling.
Output: KnobRenderer conditionally renders default CSS knob (no style) or styled SVG knob (with style).
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-interactive-svg-knobs/17-RESEARCH.md
@src/components/elements/renderers/KnobRenderer.tsx (existing implementation)
@src/components/SafeSVG.tsx (SVG rendering component)
@src/services/knobLayers.ts (layer utilities from 17-02)
@src/types/knobStyle.ts (types from 17-01)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Refactor KnobRenderer to support styled and default modes</name>
  <files>src/components/elements/renderers/KnobRenderer.tsx</files>
  <action>
Update KnobRenderer.tsx to conditionally render styled SVG knob or default CSS knob.

Structure the file as follows:

```typescript
import { KnobElementConfig } from '../../../types/elements'
import { useStore } from '../../../store'
import { SafeSVG } from '../../SafeSVG'
import { extractLayer, applyAllColorOverrides } from '../../../services/knobLayers'
import { useMemo } from 'react'

interface KnobRendererProps {
  config: KnobElementConfig
}

// Keep existing formatValue utility
function formatValue(/* ... existing implementation ... */) { /* ... */ }

// Keep existing polarToCartesian utility
function polarToCartesian(/* ... existing implementation ... */) { /* ... */ }

// Keep existing describeArc utility
function describeArc(/* ... existing implementation ... */) { /* ... */ }

// ============================================================================
// Default CSS Knob (existing implementation, extracted)
// ============================================================================

function DefaultKnobRenderer({ config }: KnobRendererProps) {
  // Move ALL existing KnobRenderer implementation here
  // This preserves backward compatibility for knobs without styles
  // ... existing arc/indicator SVG rendering code ...
}

// ============================================================================
// Styled SVG Knob (new implementation)
// ============================================================================

function StyledKnobRenderer({ config }: KnobRendererProps) {
  const getKnobStyle = useStore((state) => state.getKnobStyle)
  const style = getKnobStyle(config.styleId!)

  // Memoize SVG content with color overrides applied
  const svgContent = useMemo(() => {
    if (!style) return ''
    return applyAllColorOverrides(style.svgContent, style.layers, config.colorOverrides)
  }, [style, config.colorOverrides])

  // Calculate rotation angle for indicator
  const normalizedValue = (config.value - config.min) / (config.max - config.min)
  const rotationRange = style ? style.maxAngle - style.minAngle : 270
  const minAngle = style?.minAngle ?? -135
  const indicatorAngle = minAngle + normalizedValue * rotationRange

  // Memoize layer extraction (expensive DOM operations)
  const layers = useMemo(() => {
    if (!style || !svgContent) return null
    return {
      track: style.layers.track ? extractLayer(svgContent, style.layers.track) : null,
      shadow: style.layers.shadow ? extractLayer(svgContent, style.layers.shadow) : null,
      arc: style.layers.arc ? extractLayer(svgContent, style.layers.arc) : null,
      indicator: style.layers.indicator ? extractLayer(svgContent, style.layers.indicator) : null,
      glow: style.layers.glow ? extractLayer(svgContent, style.layers.glow) : null,
    }
  }, [style, svgContent])

  // If style was deleted, show placeholder
  if (!style) {
    return (
      <div
        style={{
          width: '100%',
          height: '100%',
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center',
          background: '#374151',
          borderRadius: '50%',
          color: '#9CA3AF',
          fontSize: '12px',
          textAlign: 'center',
          padding: '8px',
        }}
      >
        Style not found
      </div>
    )
  }

  return (
    <div style={{ position: 'relative', width: '100%', height: '100%' }}>
      {/* Track - static background */}
      {layers?.track && (
        <div style={{ position: 'absolute', inset: 0 }}>
          <SafeSVG content={layers.track} style={{ width: '100%', height: '100%' }} />
        </div>
      )}

      {/* Shadow - static */}
      {layers?.shadow && (
        <div style={{ position: 'absolute', inset: 0 }}>
          <SafeSVG content={layers.shadow} style={{ width: '100%', height: '100%' }} />
        </div>
      )}

      {/* Arc - animated by value (opacity fades in) */}
      {layers?.arc && (
        <div
          style={{
            position: 'absolute',
            inset: 0,
            opacity: normalizedValue,
            transition: 'opacity 0.05s ease-out',
          }}
        >
          <SafeSVG content={layers.arc} style={{ width: '100%', height: '100%' }} />
        </div>
      )}

      {/* Indicator - rotates */}
      {layers?.indicator && (
        <div
          style={{
            position: 'absolute',
            inset: 0,
            transform: `rotate(${indicatorAngle}deg)`,
            transformOrigin: 'center center',
            transition: 'transform 0.05s ease-out',
          }}
        >
          <SafeSVG content={layers.indicator} style={{ width: '100%', height: '100%' }} />
        </div>
      )}

      {/* Glow - intensity by value (30% to 100% opacity) */}
      {layers?.glow && (
        <div
          style={{
            position: 'absolute',
            inset: 0,
            opacity: normalizedValue * 0.7 + 0.3,
            transition: 'opacity 0.05s ease-out',
          }}
        >
          <SafeSVG content={layers.glow} style={{ width: '100%', height: '100%' }} />
        </div>
      )}

      {/* Label and Value display - use same logic as default knob */}
      {/* Copy label/value display code from DefaultKnobRenderer */}
    </div>
  )
}

// ============================================================================
// Main KnobRenderer (delegates to default or styled)
// ============================================================================

export function KnobRenderer({ config }: KnobRendererProps) {
  // If no style assigned, use default CSS knob
  if (!config.styleId) {
    return <DefaultKnobRenderer config={config} />
  }

  // Use styled SVG knob
  return <StyledKnobRenderer config={config} />
}
```

Key implementation notes:
1. Extract current implementation into DefaultKnobRenderer for backward compatibility
2. Create StyledKnobRenderer that uses layer extraction and SafeSVG
3. Use useMemo to cache expensive DOM operations (extractLayer calls)
4. Apply color overrides before layer extraction
5. Indicator rotates using CSS transform (hardware-accelerated)
6. Arc opacity and glow intensity animate based on normalized value
7. Main KnobRenderer delegates based on styleId presence
  </action>
  <verify>
Run `npx tsc --noEmit` - no type errors.
Run `npm run dev` - app starts.
Create a knob element on canvas - should render default CSS knob (existing behavior).
  </verify>
  <done>KnobRenderer supports both default CSS knob and styled SVG knob rendering</done>
</task>

<task type="auto">
  <name>Task 2: Add label/value display to StyledKnobRenderer</name>
  <files>src/components/elements/renderers/KnobRenderer.tsx</files>
  <action>
Extract the label/value display logic into a shared component or duplicate in StyledKnobRenderer.

In StyledKnobRenderer, add label and value display support:

1. Copy getLabelStyle and getValueStyle helper functions
2. Add formattedValue calculation using formatValue utility
3. Add label span when config.showLabel is true
4. Add value span when config.showValue is true

The label/value positioning is independent of whether the knob uses default or styled rendering.

Add after the layers rendering in StyledKnobRenderer:
```typescript
// Calculate formatted value for display
const formattedValue = formatValue(
  normalizedValue,
  config.min,
  config.max,
  config.valueFormat,
  config.valueSuffix,
  config.valueDecimalPlaces
)

// ... inside the return JSX, after the glow layer:

{/* Label */}
{config.showLabel && (
  <span style={getLabelStyle(config)}>
    {config.labelText}
  </span>
)}

{/* Value Display */}
{config.showValue && (
  <span style={getValueStyle(config)}>
    {formattedValue}
  </span>
)}
```

Extract getLabelStyle and getValueStyle into module-level functions that take config as parameter.
  </action>
  <verify>Run `npm run dev`. Verify knob with showLabel/showValue displays correctly.</verify>
  <done>StyledKnobRenderer includes label and value display matching DefaultKnobRenderer</done>
</task>

</tasks>

<verification>
Run the following to verify all changes:
```bash
npx tsc --noEmit
npm run dev
```

Manual verification:
- Create knob element - should render default CSS knob
- Default knob responds to value changes (arc fills, indicator rotates)
- Label and value display work on default knob
- No console errors
</verification>

<success_criteria>
- [ ] KnobRenderer without styleId renders default CSS knob unchanged
- [ ] StyledKnobRenderer extracts and renders layers with correct transforms
- [ ] Indicator rotates based on value and style's angle range
- [ ] Arc layer opacity animates with value
- [ ] Glow layer intensity animates with value
- [ ] Label and value display work in both modes
- [ ] useMemo caches expensive operations
- [ ] TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/17-interactive-svg-knobs/17-03-SUMMARY.md`
</output>
