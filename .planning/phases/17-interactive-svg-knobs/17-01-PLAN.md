---
phase: 17-interactive-svg-knobs
plan: "01"
type: execute
wave: 1
depends_on: []
files_modified:
  - src/types/knobStyle.ts
  - src/store/knobStylesSlice.ts
  - src/store/index.ts
  - src/types/elements.ts
autonomous: true

must_haves:
  truths:
    - "KnobStyle type defines layer mappings (indicator, track, arc, glow, shadow)"
    - "KnobStylesSlice provides CRUD operations for knob styles"
    - "Knob styles are included in undo/redo history"
    - "KnobElementConfig has optional styleId and colorOverrides fields"
  artifacts:
    - path: "src/types/knobStyle.ts"
      provides: "KnobStyle interface definition"
      exports: ["KnobStyle", "KnobStyleLayers", "ColorOverrides"]
    - path: "src/store/knobStylesSlice.ts"
      provides: "Zustand slice for knob style state management"
      exports: ["KnobStylesSlice", "createKnobStylesSlice"]
    - path: "src/store/index.ts"
      provides: "Store with KnobStylesSlice integrated"
      contains: "createKnobStylesSlice"
    - path: "src/types/elements.ts"
      provides: "KnobElementConfig with styleId and colorOverrides"
      contains: "styleId?: string"
  key_links:
    - from: "src/store/knobStylesSlice.ts"
      to: "src/types/knobStyle.ts"
      via: "import KnobStyle"
      pattern: "import.*KnobStyle.*from"
    - from: "src/store/index.ts"
      to: "src/store/knobStylesSlice.ts"
      via: "spread into combined store"
      pattern: "createKnobStylesSlice"
---

<objective>
Create the KnobStyle type system and Zustand store slice for managing custom knob designs.

Purpose: Foundation for storing reusable knob styles that can be applied to multiple knob elements.
Output: Types and state management for knob styles with CRUD operations.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-interactive-svg-knobs/17-RESEARCH.md
@src/store/assetsSlice.ts (pattern for slice creation)
@src/store/index.ts (store integration pattern)
@src/types/elements.ts (KnobElementConfig to extend)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create KnobStyle type definitions</name>
  <files>src/types/knobStyle.ts</files>
  <action>
Create new file `src/types/knobStyle.ts` with:

```typescript
/**
 * Knob Style type system for custom SVG knob designs
 */

// Layer mappings - which SVG elements map to which functional roles
export interface KnobStyleLayers {
  indicator?: string  // Element id/class that rotates with value (REQUIRED)
  track?: string      // Static background arc
  arc?: string        // Value fill arc (opacity animates)
  glow?: string       // Glow effect (intensity by value)
  shadow?: string     // Shadow effect
}

// Per-instance color overrides (sparse - only store explicit overrides)
export interface ColorOverrides {
  indicator?: string
  track?: string
  arc?: string
  glow?: string
  shadow?: string
}

// Main KnobStyle interface
export interface KnobStyle {
  id: string              // crypto.randomUUID()
  name: string            // User-editable name
  svgContent: string      // Sanitized original SVG

  // Layer Mappings
  layers: KnobStyleLayers

  // Rotation Configuration (degrees from top, clockwise positive)
  minAngle: number        // Default -135
  maxAngle: number        // Default 135 (270Â° total range)

  createdAt: number       // Date.now() timestamp
}
```

Export all interfaces for use across the codebase.
  </action>
  <verify>TypeScript compiles without errors: `npx tsc --noEmit`</verify>
  <done>KnobStyle, KnobStyleLayers, and ColorOverrides types are defined and exported</done>
</task>

<task type="auto">
  <name>Task 2: Create KnobStylesSlice</name>
  <files>src/store/knobStylesSlice.ts</files>
  <action>
Create new file `src/store/knobStylesSlice.ts` following the pattern from assetsSlice.ts:

```typescript
import { StateCreator } from 'zustand'
import { KnobStyle } from '../types/knobStyle'

export interface KnobStylesSlice {
  // State
  knobStyles: KnobStyle[]

  // Actions
  addKnobStyle: (style: Omit<KnobStyle, 'id' | 'createdAt'>) => void
  removeKnobStyle: (id: string) => void
  updateKnobStyle: (id: string, updates: Partial<KnobStyle>) => void
  setKnobStyles: (styles: KnobStyle[]) => void  // For project load
  getKnobStyle: (id: string) => KnobStyle | undefined
}

export const createKnobStylesSlice: StateCreator<KnobStylesSlice, [], [], KnobStylesSlice> = (
  set,
  get
) => ({
  // Default state
  knobStyles: [],

  // Actions
  addKnobStyle: (styleData) =>
    set((state) => ({
      knobStyles: [
        ...state.knobStyles,
        {
          ...styleData,
          id: crypto.randomUUID(),
          createdAt: Date.now(),
        },
      ],
    })),

  removeKnobStyle: (id) =>
    set((state) => ({
      knobStyles: state.knobStyles.filter((style) => style.id !== id),
    })),

  updateKnobStyle: (id, updates) =>
    set((state) => ({
      knobStyles: state.knobStyles.map((style) =>
        style.id === id ? { ...style, ...updates } : style
      ),
    })),

  setKnobStyles: (styles) =>
    set(() => ({
      knobStyles: styles,
    })),

  getKnobStyle: (id) => {
    return get().knobStyles.find((style) => style.id === id)
  },
})
```

Match the pattern from assetsSlice.ts for consistency.
  </action>
  <verify>TypeScript compiles without errors: `npx tsc --noEmit`</verify>
  <done>KnobStylesSlice is created with CRUD operations</done>
</task>

<task type="auto">
  <name>Task 3: Integrate KnobStylesSlice into store</name>
  <files>src/store/index.ts</files>
  <action>
Update `src/store/index.ts` to:

1. Import the new slice:
   ```typescript
   import { createKnobStylesSlice, KnobStylesSlice } from './knobStylesSlice'
   ```

2. Add KnobStylesSlice to the Store type:
   ```typescript
   export type Store = CanvasSlice & ViewportSlice & ElementsSlice & TemplateSlice & AssetsSlice & KnobStylesSlice
   ```

3. Spread createKnobStylesSlice in the store creation:
   ```typescript
   (...a) => ({
     ...createCanvasSlice(...a),
     ...createViewportSlice(...a),
     ...createElementsSlice(...a),
     ...createTemplateSlice(...a),
     ...createAssetsSlice(...a),
     ...createKnobStylesSlice(...a),
   }),
   ```

Note: knobStyles are NOT excluded from temporal partialize, so they ARE included in undo/redo history (user may want to undo style deletion).
  </action>
  <verify>Run `npx tsc --noEmit` - no type errors. Run `npm run dev` - app starts without errors.</verify>
  <done>KnobStylesSlice is integrated into the Zustand store with undo/redo support</done>
</task>

<task type="auto">
  <name>Task 4: Extend KnobElementConfig with style fields</name>
  <files>src/types/elements.ts</files>
  <action>
Update `src/types/elements.ts` to extend KnobElementConfig with style-related fields:

1. Import ColorOverrides at the top:
   ```typescript
   import { ColorOverrides } from './knobStyle'
   ```

2. Add fields to KnobElementConfig interface (after existing properties):
   ```typescript
   // SVG Knob Style (optional - if undefined, render default CSS knob)
   styleId?: string

   // Per-instance color overrides (only used when styleId is set)
   colorOverrides?: ColorOverrides
   ```

The existing properties (value, min, max, trackColor, fillColor, indicatorColor, etc.) are preserved for backward compatibility and for when no style is applied.
  </action>
  <verify>Run `npx tsc --noEmit` - no type errors. Existing knob functionality unaffected.</verify>
  <done>KnobElementConfig includes optional styleId and colorOverrides fields</done>
</task>

</tasks>

<verification>
Run the following to verify all changes:
```bash
npx tsc --noEmit
npm run dev
```

Manual verification:
- App starts without errors
- Existing knob elements render correctly (no style applied = default CSS knob)
- No type errors in IDE
</verification>

<success_criteria>
- [ ] KnobStyle type is defined with all required fields
- [ ] KnobStylesSlice provides add, remove, update, get operations
- [ ] Store exports getKnobStyle selector
- [ ] KnobElementConfig has styleId and colorOverrides fields
- [ ] TypeScript compiles without errors
- [ ] App runs and existing knob elements work unchanged
</success_criteria>

<output>
After completion, create `.planning/phases/17-interactive-svg-knobs/17-01-SUMMARY.md`
</output>
