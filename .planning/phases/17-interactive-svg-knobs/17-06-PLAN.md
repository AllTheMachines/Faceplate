---
phase: 17-interactive-svg-knobs
plan: "06"
type: execute
wave: 4
depends_on: ["17-01", "17-03", "17-04", "17-05"]
files_modified:
  - src/services/projectSchema.ts
  - src/services/projectSerializer.ts
  - src/store/index.ts
  - src/services/exportHtml.ts
  - src/services/exportCss.ts
autonomous: true

must_haves:
  truths:
    - "Knob styles are saved in project JSON alongside assets and elements"
    - "Project load restores knob styles and re-sanitizes SVG content"
    - "Knobs with styles export with working rotation animation in JUCE"
    - "Exported HTML includes sanitized SVG and CSP headers"
    - "Elements referencing deleted styles degrade gracefully"
  artifacts:
    - path: "src/services/projectSchema.ts"
      provides: "Zod schema for knobStyles array"
      contains: "knobStyles"
    - path: "src/services/projectSerializer.ts"
      provides: "Save/load logic including knob styles"
      contains: "knobStyles"
    - path: "src/services/exportHtml.ts"
      provides: "HTML export with styled knob rendering"
      contains: "styleId"
  key_links:
    - from: "src/services/projectSerializer.ts"
      to: "src/store/index.ts"
      via: "setKnobStyles action"
      pattern: "setKnobStyles"
    - from: "src/services/exportHtml.ts"
      to: "src/services/knobLayers.ts"
      via: "extractLayer, applyAllColorOverrides"
      pattern: "import.*extractLayer"
---

<objective>
Add knob style persistence (save/load) and HTML/CSS export support for styled knobs.

Purpose: Enable knob styles to survive save/load and export working interactive knobs for JUCE WebView2.
Output: Project serialization includes knobStyles, export generates working styled knobs.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-interactive-svg-knobs/17-RESEARCH.md
@src/services/projectSchema.ts (Zod schema for validation)
@src/services/projectSerializer.ts (save/load logic)
@src/services/exportHtml.ts (HTML generation)
@src/services/exportCss.ts (CSS generation)
@src/services/knobLayers.ts (layer utilities)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add knobStyles to project schema</name>
  <files>src/services/projectSchema.ts</files>
  <action>
Update `src/services/projectSchema.ts` to include knob styles in the project schema.

1. Add KnobStyle schema near the Asset schema:
```typescript
// Knob Style Layers schema
const KnobStyleLayersSchema = z.object({
  indicator: z.string().optional(),
  track: z.string().optional(),
  arc: z.string().optional(),
  glow: z.string().optional(),
  shadow: z.string().optional(),
})

// Knob Style schema
const KnobStyleSchema = z.object({
  id: z.string(),
  name: z.string(),
  svgContent: z.string(),
  layers: KnobStyleLayersSchema,
  minAngle: z.number(),
  maxAngle: z.number(),
  createdAt: z.number(),
})
```

2. Add knobStyles to the ProjectSchema:
```typescript
export const ProjectSchema = z.object({
  version: z.literal('1.1'),  // Increment version for new feature
  metadata: MetadataSchema,
  elements: z.array(ElementSchema),
  assets: z.array(AssetSchema).optional().default([]),
  knobStyles: z.array(KnobStyleSchema).optional().default([]),  // NEW
})
```

3. Update KnobElementSchema to include styleId and colorOverrides:
```typescript
const KnobElementSchema = z.object({
  // ... existing fields ...
  styleId: z.string().optional(),
  colorOverrides: z.object({
    indicator: z.string().optional(),
    track: z.string().optional(),
    arc: z.string().optional(),
    glow: z.string().optional(),
    shadow: z.string().optional(),
  }).optional(),
})
```

Note: Keep version as '1.0' for backward compatibility if possible, or handle version migration.
  </action>
  <verify>Run `npx tsc --noEmit` - no type errors.</verify>
  <done>Project schema includes knobStyles array and knob styleId/colorOverrides fields</done>
</task>

<task type="auto">
  <name>Task 2: Update project serializer for knob styles</name>
  <files>src/services/projectSerializer.ts</files>
  <action>
Update `src/services/projectSerializer.ts` to save and load knob styles.

1. Update the save function to include knobStyles:
```typescript
export function serializeProject(): string {
  const state = useStore.getState()

  const project = {
    version: '1.0',  // Keep version, schema handles optional fields
    metadata: {
      canvasWidth: state.canvasWidth,
      canvasHeight: state.canvasHeight,
      backgroundColor: state.backgroundColor,
      // ... other metadata ...
    },
    elements: state.elements,
    assets: state.assets,
    knobStyles: state.knobStyles,  // NEW
  }

  return JSON.stringify(project, null, 2)
}
```

2. Update the load function to restore knob styles with re-sanitization:
```typescript
import { sanitizeSVG } from './svgSanitizer'

export function deserializeProject(json: string): void {
  const parsed = JSON.parse(json)
  const validated = ProjectSchema.parse(parsed)

  // Re-sanitize SVG content in knob styles (defense-in-depth)
  const sanitizedKnobStyles = (validated.knobStyles || []).map((style) => ({
    ...style,
    svgContent: sanitizeSVG(style.svgContent),
  }))

  // Re-sanitize assets (existing logic)
  const sanitizedAssets = (validated.assets || []).map((asset) => ({
    ...asset,
    svgContent: sanitizeSVG(asset.svgContent),
  }))

  const state = useStore.getState()

  // Load all state
  state.setElements(validated.elements)
  state.setAssets(sanitizedAssets)
  state.setKnobStyles(sanitizedKnobStyles)  // NEW
  // ... restore other state ...
}
```

3. Handle backward compatibility - projects without knobStyles:
```typescript
// In deserializeProject:
const knobStyles = validated.knobStyles || []
```

The schema's `.optional().default([])` handles missing knobStyles gracefully.
  </action>
  <verify>Run `npm run dev`. Create a style. Save project. Reload page. Load project. Style should be restored.</verify>
  <done>Project save includes knobStyles, load restores and re-sanitizes them</done>
</task>

<task type="auto">
  <name>Task 3: Add styled knob export to HTML generator</name>
  <files>src/services/exportHtml.ts</files>
  <action>
Update `src/services/exportHtml.ts` to export styled knobs with working rotation.

1. Add imports:
```typescript
import { extractLayer, applyAllColorOverrides } from './knobLayers'
import { sanitizeSVG } from './svgSanitizer'
```

2. Create a helper function to generate styled knob HTML:
```typescript
function generateStyledKnobHtml(
  element: KnobElementConfig,
  knobStyles: KnobStyle[]
): string {
  const style = knobStyles.find((s) => s.id === element.styleId)
  if (!style) {
    // Style deleted - return placeholder
    return `<div class="knob-placeholder" style="background:#374151;border-radius:50%;display:flex;align-items:center;justify-content:center;color:#9CA3AF;">?</div>`
  }

  // Apply color overrides to SVG
  let svgContent = applyAllColorOverrides(style.svgContent, style.layers, element.colorOverrides)
  svgContent = sanitizeSVG(svgContent)  // Re-sanitize before export (SEC-04)

  // Calculate initial rotation
  const normalizedValue = (element.value - element.min) / (element.max - element.min)
  const rotationRange = style.maxAngle - style.minAngle
  const indicatorAngle = style.minAngle + normalizedValue * rotationRange

  // Extract layers
  const trackSVG = style.layers.track ? sanitizeSVG(extractLayer(svgContent, style.layers.track)) : ''
  const shadowSVG = style.layers.shadow ? sanitizeSVG(extractLayer(svgContent, style.layers.shadow)) : ''
  const arcSVG = style.layers.arc ? sanitizeSVG(extractLayer(svgContent, style.layers.arc)) : ''
  const indicatorSVG = style.layers.indicator ? sanitizeSVG(extractLayer(svgContent, style.layers.indicator)) : ''
  const glowSVG = style.layers.glow ? sanitizeSVG(extractLayer(svgContent, style.layers.glow)) : ''

  // Generate HTML with layers
  return `
<div class="styled-knob" data-style-id="${style.id}" data-min-angle="${style.minAngle}" data-max-angle="${style.maxAngle}">
  ${trackSVG ? `<div class="knob-layer knob-track">${trackSVG}</div>` : ''}
  ${shadowSVG ? `<div class="knob-layer knob-shadow">${shadowSVG}</div>` : ''}
  ${arcSVG ? `<div class="knob-layer knob-arc" style="opacity:${normalizedValue}">${arcSVG}</div>` : ''}
  ${indicatorSVG ? `<div class="knob-layer knob-indicator" style="transform:rotate(${indicatorAngle}deg)">${indicatorSVG}</div>` : ''}
  ${glowSVG ? `<div class="knob-layer knob-glow" style="opacity:${normalizedValue * 0.7 + 0.3}">${glowSVG}</div>` : ''}
</div>`
}
```

3. Update the element rendering logic to use styled knob export when styleId is present:
```typescript
// In the element rendering switch/if:
if (element.type === 'knob') {
  if (element.styleId) {
    return generateStyledKnobHtml(element, knobStyles)
  }
  // ... existing default knob HTML generation ...
}
```

4. Pass knobStyles to the HTML generation function:
```typescript
export function exportHtml(elements: ElementConfig[], knobStyles: KnobStyle[]): string {
  // ... use knobStyles when rendering knob elements ...
}
```
  </action>
  <verify>Run export. Knobs with styles should have layered SVG HTML with data attributes.</verify>
  <done>Styled knobs export with layered SVG and rotation data attributes</done>
</task>

<task type="auto">
  <name>Task 4: Add styled knob CSS to export</name>
  <files>src/services/exportCss.ts</files>
  <action>
Update `src/services/exportCss.ts` to include CSS for styled knob layers.

Add CSS for styled knob rendering:
```css
/* Styled Knob Layers */
.styled-knob {
  position: relative;
  width: 100%;
  height: 100%;
}

.knob-layer {
  position: absolute;
  inset: 0;
  pointer-events: none;
}

.knob-layer svg {
  width: 100%;
  height: 100%;
}

.knob-indicator {
  transform-origin: center center;
  transition: transform 0.05s ease-out;
}

.knob-arc,
.knob-glow {
  transition: opacity 0.05s ease-out;
}
```

Add this to the base CSS output or include conditionally when styled knobs are present.
  </action>
  <verify>Run export. CSS output should include styled knob layer rules.</verify>
  <done>Export CSS includes rules for styled knob layer positioning and transitions</done>
</task>

</tasks>

<verification>
Run the following to verify all changes:
```bash
npx tsc --noEmit
npm run dev
```

End-to-end verification:
1. Create a knob style (import SVG, map layers)
2. Apply style to a knob element
3. Customize with color overrides
4. Save project
5. Reload page
6. Load project - style and overrides preserved
7. Export project
8. Verify exported HTML has styled knob with layers
9. Verify CSS has layer positioning rules
</verification>

<success_criteria>
- [ ] Project JSON includes knobStyles array
- [ ] Load re-sanitizes knobStyle SVG content
- [ ] Knob styleId and colorOverrides persist through save/load
- [ ] Export generates layered HTML for styled knobs
- [ ] Export re-sanitizes SVG before output (SEC-04)
- [ ] Export CSS includes styled knob layer rules
- [ ] Missing styles degrade gracefully in export
- [ ] TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/17-interactive-svg-knobs/17-06-SUMMARY.md`
</output>
