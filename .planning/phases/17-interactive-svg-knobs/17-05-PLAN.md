---
phase: 17-interactive-svg-knobs
plan: "05"
type: execute
wave: 3
depends_on: ["17-01", "17-03", "17-04"]
files_modified:
  - src/components/Properties/KnobProperties.tsx
autonomous: true

must_haves:
  truths:
    - "Property panel shows style selector dropdown for knob elements"
    - "Selecting a style from dropdown updates knob's styleId"
    - "Default (CSS) option is available and selected when no style"
    - "'Manage styles...' link opens ManageKnobStylesDialog"
    - "Color override inputs appear when a style is selected"
    - "Only color inputs for existing layers are shown"
  artifacts:
    - path: "src/components/Properties/KnobProperties.tsx"
      provides: "Knob style selection and color override UI"
      contains: "styleId"
      min_lines: 250
  key_links:
    - from: "src/components/Properties/KnobProperties.tsx"
      to: "src/store/index.ts"
      via: "useStore for knobStyles"
      pattern: "useStore.*knobStyles"
    - from: "src/components/Properties/KnobProperties.tsx"
      to: "src/components/dialogs/ManageKnobStylesDialog.tsx"
      via: "import and render dialog"
      pattern: "ManageKnobStylesDialog"
---

<objective>
Extend KnobProperties to include knob style selection dropdown and per-instance color override controls.

Purpose: Enable users to apply and customize knob styles through the property panel.
Output: KnobProperties with style dropdown, "Manage styles..." link, and color override swatches.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-interactive-svg-knobs/17-RESEARCH.md
@.planning/phases/17-interactive-svg-knobs/17-CONTEXT.md
@src/components/Properties/KnobProperties.tsx (existing implementation)
@src/components/Properties/SvgGraphicProperties.tsx (dropdown pattern)
@src/components/dialogs/ManageKnobStylesDialog.tsx (dialog from 17-04)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add style selection section to KnobProperties</name>
  <files>src/components/Properties/KnobProperties.tsx</files>
  <action>
Update KnobProperties.tsx to add knob style selection:

1. Add necessary imports at the top:
```typescript
import { useState } from 'react'
import { useStore } from '../../store'
import { ManageKnobStylesDialog } from '../dialogs/ManageKnobStylesDialog'
```

2. Add state and store hooks inside the component:
```typescript
export function KnobProperties({ element, onUpdate }: KnobPropertiesProps) {
  const [showManageDialog, setShowManageDialog] = useState(false)
  const knobStyles = useStore((state) => state.knobStyles)
  const getKnobStyle = useStore((state) => state.getKnobStyle)

  // ... existing code ...
```

3. Add a new PropertySection at the TOP of the return (before Value section):
```typescript
{/* Knob Style */}
<PropertySection title="Knob Style">
  <div>
    <label className="block text-xs text-gray-400 mb-1">Style</label>
    <select
      value={element.styleId || ''}
      onChange={(e) => onUpdate({ styleId: e.target.value || undefined })}
      className="w-full bg-gray-700 border border-gray-600 text-white rounded px-2 py-1.5 text-sm"
    >
      <option value="">Default (CSS Gradient)</option>
      {knobStyles.map((style) => (
        <option key={style.id} value={style.id}>
          {style.name}
        </option>
      ))}
    </select>
  </div>

  {/* Manage Styles Link */}
  <button
    onClick={() => setShowManageDialog(true)}
    className="w-full mt-2 text-blue-400 hover:text-blue-300 text-sm transition-colors text-left"
  >
    Manage styles...
  </button>
</PropertySection>
```

4. Add the ManageKnobStylesDialog at the end of the return (inside the fragment):
```typescript
{/* Manage Styles Dialog */}
<ManageKnobStylesDialog
  isOpen={showManageDialog}
  onClose={() => setShowManageDialog(false)}
/>
```

The style dropdown appears as the first property section, giving it prominence.
  </action>
  <verify>Run `npm run dev`. Select a knob element. Style dropdown should appear with "Default" and any created styles.</verify>
  <done>Style selector dropdown is added to KnobProperties with "Manage styles..." link</done>
</task>

<task type="auto">
  <name>Task 2: Add color override controls</name>
  <files>src/components/Properties/KnobProperties.tsx</files>
  <action>
Add color override controls that appear when a style is selected.

After the style dropdown section, add a conditional section for color overrides:

```typescript
{/* Color Overrides - only show when a style is selected */}
{element.styleId && (
  <PropertySection title="Color Overrides">
    {(() => {
      const style = getKnobStyle(element.styleId)
      if (!style) return <p className="text-sm text-gray-500">Style not found</p>

      return (
        <>
          {style.layers.indicator && (
            <ColorInput
              label="Indicator"
              value={element.colorOverrides?.indicator || '#ffffff'}
              onChange={(color) =>
                onUpdate({
                  colorOverrides: {
                    ...element.colorOverrides,
                    indicator: color,
                  },
                })
              }
            />
          )}

          {style.layers.track && (
            <ColorInput
              label="Track"
              value={element.colorOverrides?.track || '#666666'}
              onChange={(color) =>
                onUpdate({
                  colorOverrides: {
                    ...element.colorOverrides,
                    track: color,
                  },
                })
              }
            />
          )}

          {style.layers.arc && (
            <ColorInput
              label="Arc"
              value={element.colorOverrides?.arc || '#888888'}
              onChange={(color) =>
                onUpdate({
                  colorOverrides: {
                    ...element.colorOverrides,
                    arc: color,
                  },
                })
              }
            />
          )}

          {style.layers.glow && (
            <ColorInput
              label="Glow"
              value={element.colorOverrides?.glow || '#ffffff'}
              onChange={(color) =>
                onUpdate({
                  colorOverrides: {
                    ...element.colorOverrides,
                    glow: color,
                  },
                })
              }
            />
          )}

          {style.layers.shadow && (
            <ColorInput
              label="Shadow"
              value={element.colorOverrides?.shadow || '#000000'}
              onChange={(color) =>
                onUpdate({
                  colorOverrides: {
                    ...element.colorOverrides,
                    shadow: color,
                  },
                })
              }
            />
          )}

          {/* Reset button */}
          <button
            onClick={() => onUpdate({ colorOverrides: undefined })}
            className="w-full mt-2 bg-gray-700 hover:bg-gray-600 text-white rounded px-3 py-2 text-sm transition-colors"
          >
            Reset to Original Colors
          </button>
        </>
      )
    })()}
  </PropertySection>
)}
```

Key implementation details:
- Only shown when element.styleId is set
- Only show color inputs for layers that exist in the selected style
- Default colors are placeholders (actual colors come from SVG)
- "Reset" button clears all overrides
- Sparse storage: only store explicit overrides
  </action>
  <verify>Run `npm run dev`. Apply a style to a knob. Color override inputs should appear for mapped layers only.</verify>
  <done>Color override controls show for each mapped layer in the selected style</done>
</task>

<task type="auto">
  <name>Task 3: Hide default CSS properties when style is applied</name>
  <files>src/components/Properties/KnobProperties.tsx</files>
  <action>
When a knob has a style applied, certain CSS-specific properties (trackColor, fillColor, indicatorColor, trackWidth) become irrelevant since the SVG defines the appearance.

Wrap these sections with conditional rendering:

```typescript
{/* Only show CSS style properties when no SVG style is applied */}
{!element.styleId && (
  <>
    {/* Arc Geometry */}
    <PropertySection title="Arc Geometry">
      {/* ... existing arc geometry controls ... */}
    </PropertySection>

    {/* Style (arc/filled/dot/line) */}
    <PropertySection title="Style">
      {/* ... existing style dropdown ... */}
    </PropertySection>

    {/* Colors (CSS knob) */}
    <PropertySection title="Colors">
      {/* ... existing track/fill/indicator color inputs ... */}
    </PropertySection>
  </>
)}
```

Keep these sections visible for default CSS knobs:
- Value (always visible - applies to both)
- Label (always visible - applies to both)
- Value Display (always visible - applies to both)

This creates a clean UX where:
- No style -> show CSS knob configuration
- Style applied -> show color overrides only (colors still customizable via overrides)
  </action>
  <verify>Run `npm run dev`. Select default style - CSS properties visible. Select SVG style - CSS properties hidden, color overrides visible.</verify>
  <done>CSS-specific properties are hidden when SVG style is applied</done>
</task>

</tasks>

<verification>
Run the following to verify all changes:
```bash
npx tsc --noEmit
npm run dev
```

Manual verification:
1. Select a knob element
2. Style dropdown appears at top with "Default" and any styles
3. Click "Manage styles..." - ManageKnobStylesDialog opens
4. Select a style from dropdown - knob renders with that style
5. Color Overrides section appears with inputs for mapped layers only
6. Change a color override - knob updates in real-time
7. Click "Reset" - colors revert to original SVG
8. Switch to Default - CSS properties reappear, color overrides disappear
</verification>

<success_criteria>
- [ ] Style dropdown shows "Default" + all knob styles
- [ ] Selecting style updates element.styleId
- [ ] "Manage styles..." link opens ManageKnobStylesDialog
- [ ] Color override inputs appear only for existing layers
- [ ] Color changes update element.colorOverrides
- [ ] "Reset" button clears all color overrides
- [ ] CSS properties hidden when style applied
- [ ] CSS properties visible when no style (default)
- [ ] TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/17-interactive-svg-knobs/17-05-SUMMARY.md`
</output>
