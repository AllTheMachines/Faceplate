---
phase: 27-containers-polish
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/types/elements/containers.ts
  - src/components/elements/renderers/containers/TooltipRenderer.tsx
  - src/components/elements/renderers/containers/index.ts
  - src/components/elements/renderers/index.ts
  - src/components/Properties/TooltipProperties.tsx
  - src/components/Properties/index.ts
  - src/App.tsx
autonomous: true

must_haves:
  truths:
    - "Tooltip element appears in palette under Containers category"
    - "Tooltip shows configurable hover delay (300-500ms)"
    - "Tooltip content supports rich HTML text"
    - "Tooltip position can be set to top/bottom/left/right"
    - "Tooltip arrow can be toggled on/off"
  artifacts:
    - path: "src/types/elements/containers.ts"
      provides: "TooltipElementConfig interface and createTooltip factory"
      contains: "interface TooltipElementConfig"
    - path: "src/components/elements/renderers/containers/TooltipRenderer.tsx"
      provides: "DOM overlay tooltip with hover detection"
      min_lines: 80
    - path: "src/components/Properties/TooltipProperties.tsx"
      provides: "Property panel for tooltip configuration"
      min_lines: 60
  key_links:
    - from: "src/components/elements/renderers/index.ts"
      to: "TooltipRenderer"
      via: "rendererRegistry entry"
      pattern: "tooltip.*TooltipRenderer"
    - from: "src/components/Properties/index.ts"
      to: "TooltipProperties"
      via: "propertyRegistry entry"
      pattern: "tooltip.*TooltipProperties"
---

<objective>
Create Tooltip element with DOM overlay rendering, hover detection, and configurable positioning

Purpose: Enable users to add informational hover tooltips to their plugin UIs (CONT-01)
Output: TooltipElementConfig type, TooltipRenderer, TooltipProperties, registry entries, palette entry
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/27-containers-polish/27-CONTEXT.md
@.planning/phases/27-containers-polish/27-RESEARCH.md
@src/types/elements/containers.ts
@src/components/elements/renderers/index.ts
@src/components/Properties/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Tooltip type and factory function</name>
  <files>src/types/elements/containers.ts</files>
  <action>
Add TooltipElementConfig interface and factory function to src/types/elements/containers.ts:

```typescript
export interface TooltipElementConfig extends BaseElementConfig {
  type: 'tooltip'

  // Trigger & timing
  hoverDelay: number  // 300-500ms recommended (default: 400ms)

  // Content (rich content support - HTML sanitized with DOMPurify)
  content: string  // HTML string

  // Position
  position: 'top' | 'bottom' | 'left' | 'right'
  showArrow: boolean
  offset: number  // Distance from trigger element (default: 8px)

  // Styling
  backgroundColor: string
  textColor: string
  fontSize: number
  padding: number
  borderRadius: number
  maxWidth: number
}

export function isTooltip(element: { type: string }): element is TooltipElementConfig {
  return element.type === 'tooltip'
}

export function createTooltip(overrides?: Partial<TooltipElementConfig>): TooltipElementConfig {
  return {
    id: crypto.randomUUID(),
    type: 'tooltip',
    name: 'Tooltip',
    x: 0,
    y: 0,
    width: 100,   // Trigger area width
    height: 30,   // Trigger area height
    rotation: 0,
    zIndex: 1000, // High z-index for overlay
    locked: false,
    visible: true,
    hoverDelay: 400,
    content: '<p>Tooltip text</p>',
    position: 'top',
    showArrow: true,
    offset: 8,
    backgroundColor: '#1f2937',
    textColor: '#ffffff',
    fontSize: 12,
    padding: 8,
    borderRadius: 4,
    maxWidth: 200,
    ...overrides,
  }
}
```

Update ContainerElement union to include TooltipElementConfig:
```typescript
export type ContainerElement =
  | PanelElementConfig
  | FrameElementConfig
  | GroupBoxElementConfig
  | CollapsibleContainerElementConfig
  | TooltipElementConfig
```
  </action>
  <verify>npx tsc --noEmit passes and grep "interface TooltipElementConfig" src/types/elements/containers.ts</verify>
  <done>TooltipElementConfig interface and createTooltip factory function exist</done>
</task>

<task type="auto">
  <name>Task 2: Create Tooltip renderer with DOM overlay</name>
  <files>src/components/elements/renderers/containers/TooltipRenderer.tsx, src/components/elements/renderers/containers/index.ts, src/components/elements/renderers/index.ts</files>
  <action>
Create src/components/elements/renderers/containers/TooltipRenderer.tsx:

```typescript
/**
 * Tooltip Renderer
 *
 * Renders an invisible trigger area on the Konva canvas.
 * On hover, displays a DOM overlay tooltip above the canvas using React Portal.
 * Sanitizes HTML content with DOMPurify for XSS protection.
 */
import { useState, useEffect, useRef } from 'react'
import { createPortal } from 'react-dom'
import { Rect, Text, Group } from 'react-konva'
import DOMPurify from 'isomorphic-dompurify'
import type { TooltipElementConfig } from '../../../../types/elements/containers'

interface TooltipRendererProps {
  config: TooltipElementConfig
}

export function TooltipRenderer({ config }: TooltipRendererProps) {
  const [showTooltip, setShowTooltip] = useState(false)
  const [tooltipPos, setTooltipPos] = useState({ x: 0, y: 0 })
  const delayTimerRef = useRef<number | null>(null)

  const handleMouseEnter = (e: any) => {
    // Get stage and calculate position relative to viewport
    const stage = e.target.getStage()
    if (!stage) return

    // Get the absolute position of the element on the stage
    const node = e.target
    const absPos = node.getAbsolutePosition()
    const stageContainer = stage.container()
    const stageRect = stageContainer.getBoundingClientRect()

    // Calculate screen position
    const screenX = stageRect.left + absPos.x + config.width / 2
    const screenY = stageRect.top + absPos.y

    // Clear any existing timer
    if (delayTimerRef.current) {
      clearTimeout(delayTimerRef.current)
    }

    // Start delay timer
    delayTimerRef.current = window.setTimeout(() => {
      setTooltipPos({ x: screenX, y: screenY })
      setShowTooltip(true)
    }, config.hoverDelay)
  }

  const handleMouseLeave = () => {
    if (delayTimerRef.current) {
      clearTimeout(delayTimerRef.current)
      delayTimerRef.current = null
    }
    setShowTooltip(false)
  }

  // Cleanup timer on unmount
  useEffect(() => {
    return () => {
      if (delayTimerRef.current) {
        clearTimeout(delayTimerRef.current)
      }
    }
  }, [])

  // Sanitize HTML content
  const sanitizedContent = DOMPurify.sanitize(config.content)

  // Get transform for tooltip position
  const getTransform = () => {
    const offset = config.offset
    switch (config.position) {
      case 'top': return `translate(-50%, -100%) translateY(-${offset}px)`
      case 'bottom': return `translate(-50%, 0) translateY(${config.height + offset}px)`
      case 'left': return `translate(-100%, -50%) translateX(-${config.width / 2 + offset}px) translateY(${config.height / 2}px)`
      case 'right': return `translate(0, -50%) translateX(${config.width / 2 + offset}px) translateY(${config.height / 2}px)`
      default: return 'translate(-50%, -100%)'
    }
  }

  // Get arrow styles
  const getArrowStyle = (): React.CSSProperties => {
    const base: React.CSSProperties = {
      position: 'absolute',
      width: 0,
      height: 0,
      borderStyle: 'solid',
    }
    const bgColor = config.backgroundColor

    switch (config.position) {
      case 'top':
        return {
          ...base,
          bottom: '-6px',
          left: '50%',
          transform: 'translateX(-50%)',
          borderWidth: '6px 6px 0 6px',
          borderColor: `${bgColor} transparent transparent transparent`,
        }
      case 'bottom':
        return {
          ...base,
          top: '-6px',
          left: '50%',
          transform: 'translateX(-50%)',
          borderWidth: '0 6px 6px 6px',
          borderColor: `transparent transparent ${bgColor} transparent`,
        }
      case 'left':
        return {
          ...base,
          right: '-6px',
          top: '50%',
          transform: 'translateY(-50%)',
          borderWidth: '6px 0 6px 6px',
          borderColor: `transparent transparent transparent ${bgColor}`,
        }
      case 'right':
        return {
          ...base,
          left: '-6px',
          top: '50%',
          transform: 'translateY(-50%)',
          borderWidth: '6px 6px 6px 0',
          borderColor: `transparent ${bgColor} transparent transparent`,
        }
      default:
        return base
    }
  }

  return (
    <>
      {/* Visible trigger area in designer (dashed outline) */}
      <Group>
        <Rect
          width={config.width}
          height={config.height}
          fill="transparent"
          stroke="rgba(59, 130, 246, 0.5)"
          strokeWidth={1}
          dash={[4, 4]}
          onMouseEnter={handleMouseEnter}
          onMouseLeave={handleMouseLeave}
        />
        <Text
          text="Tooltip"
          fontSize={10}
          fill="rgba(59, 130, 246, 0.7)"
          x={4}
          y={config.height / 2 - 5}
        />
      </Group>

      {/* DOM overlay tooltip */}
      {showTooltip && createPortal(
        <div
          className="fixed z-[9999] pointer-events-none"
          style={{
            left: tooltipPos.x,
            top: tooltipPos.y,
            transform: getTransform(),
            maxWidth: config.maxWidth,
            backgroundColor: config.backgroundColor,
            color: config.textColor,
            fontSize: config.fontSize,
            padding: config.padding,
            borderRadius: config.borderRadius,
            boxShadow: '0 4px 6px rgba(0, 0, 0, 0.3)',
          }}
          role="tooltip"
          aria-live="polite"
        >
          {config.showArrow && <div style={getArrowStyle()} />}
          <div dangerouslySetInnerHTML={{ __html: sanitizedContent }} />
        </div>,
        document.body
      )}
    </>
  )
}
```

Update src/components/elements/renderers/containers/index.ts to export TooltipRenderer:
```typescript
export { TooltipRenderer } from './TooltipRenderer'
```

Update src/components/elements/renderers/index.ts:
- Import TooltipRenderer from './containers'
- Add to rendererRegistry: `['tooltip', TooltipRenderer as RendererComponent]`
- Add to export list
  </action>
  <verify>npx tsc --noEmit passes and grep "tooltip.*TooltipRenderer" src/components/elements/renderers/index.ts</verify>
  <done>TooltipRenderer creates DOM overlay on hover with configurable delay and position</done>
</task>

<task type="auto">
  <name>Task 3: Create property panel and palette entry</name>
  <files>src/components/Properties/TooltipProperties.tsx, src/components/Properties/index.ts, src/App.tsx</files>
  <action>
Create src/components/Properties/TooltipProperties.tsx:

```typescript
import type { TooltipElementConfig } from '../../types/elements/containers'
import { PropertySection } from './PropertySection'
import { NumberInput } from './NumberInput'
import { TextInput } from './TextInput'
import { ColorInput } from './ColorInput'

interface TooltipPropertiesProps {
  element: TooltipElementConfig
  onUpdate: (updates: Partial<TooltipElementConfig>) => void
}

export function TooltipProperties({ element, onUpdate }: TooltipPropertiesProps) {
  return (
    <>
      <PropertySection title="Trigger Area">
        <NumberInput
          label="Width"
          value={element.width}
          onChange={(width) => onUpdate({ width })}
          min={20}
          max={500}
        />
        <NumberInput
          label="Height"
          value={element.height}
          onChange={(height) => onUpdate({ height })}
          min={10}
          max={200}
        />
      </PropertySection>

      <PropertySection title="Behavior">
        <NumberInput
          label="Hover Delay (ms)"
          value={element.hoverDelay}
          onChange={(hoverDelay) => onUpdate({ hoverDelay })}
          min={100}
          max={1000}
          step={50}
        />
        <div className="space-y-1">
          <label className="text-sm text-gray-400">Position</label>
          <select
            value={element.position}
            onChange={(e) => onUpdate({ position: e.target.value as TooltipElementConfig['position'] })}
            className="w-full bg-gray-700 text-white px-2 py-1 rounded text-sm"
          >
            <option value="top">Top</option>
            <option value="bottom">Bottom</option>
            <option value="left">Left</option>
            <option value="right">Right</option>
          </select>
        </div>
        <NumberInput
          label="Offset (px)"
          value={element.offset}
          onChange={(offset) => onUpdate({ offset })}
          min={0}
          max={50}
        />
        <div className="flex items-center gap-2">
          <input
            type="checkbox"
            id="showArrow"
            checked={element.showArrow}
            onChange={(e) => onUpdate({ showArrow: e.target.checked })}
            className="rounded"
          />
          <label htmlFor="showArrow" className="text-sm text-gray-300">Show Arrow</label>
        </div>
      </PropertySection>

      <PropertySection title="Content">
        <div className="space-y-1">
          <label className="text-sm text-gray-400">HTML Content</label>
          <textarea
            value={element.content}
            onChange={(e) => onUpdate({ content: e.target.value })}
            className="w-full bg-gray-700 text-white px-2 py-1 rounded text-sm h-24 font-mono"
            placeholder="<p>Tooltip text</p>"
          />
          <p className="text-xs text-gray-500">Supports HTML (sanitized for safety)</p>
        </div>
        <NumberInput
          label="Max Width"
          value={element.maxWidth}
          onChange={(maxWidth) => onUpdate({ maxWidth })}
          min={100}
          max={500}
        />
      </PropertySection>

      <PropertySection title="Styling">
        <ColorInput
          label="Background"
          value={element.backgroundColor}
          onChange={(backgroundColor) => onUpdate({ backgroundColor })}
        />
        <ColorInput
          label="Text Color"
          value={element.textColor}
          onChange={(textColor) => onUpdate({ textColor })}
        />
        <NumberInput
          label="Font Size"
          value={element.fontSize}
          onChange={(fontSize) => onUpdate({ fontSize })}
          min={8}
          max={24}
        />
        <NumberInput
          label="Padding"
          value={element.padding}
          onChange={(padding) => onUpdate({ padding })}
          min={0}
          max={32}
        />
        <NumberInput
          label="Border Radius"
          value={element.borderRadius}
          onChange={(borderRadius) => onUpdate({ borderRadius })}
          min={0}
          max={20}
        />
      </PropertySection>
    </>
  )
}
```

Update src/components/Properties/index.ts:
- Import TooltipProperties
- Add to propertyRegistry: `['tooltip', TooltipProperties]`
- Export TooltipProperties

Update src/App.tsx:
- Import createTooltip from types/elements
- Add case 'tooltip' in handleDragEnd switch statement:
  ```typescript
  case 'tooltip':
    newElement = createTooltip({ x: canvasX, y: canvasY, ...variant })
    break
  ```

Add palette entry in palette handling. The palette entries are defined inline in App.tsx or a related component. Look for the existing pattern and add:
```typescript
{
  type: 'tooltip',
  label: 'Tooltip',
  description: 'Hover information overlay',
  category: 'Containers',
}
```
  </action>
  <verify>
1. npx tsc --noEmit passes
2. grep "tooltip.*TooltipProperties" src/components/Properties/index.ts
3. grep "case 'tooltip'" src/App.tsx
  </verify>
  <done>Tooltip property panel and palette entry enable full configuration and drag-to-canvas</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` - TypeScript compiles without errors
2. TooltipElementConfig interface exists in containers.ts
3. TooltipRenderer.tsx exists and exports from containers/index.ts
4. rendererRegistry includes 'tooltip' entry
5. propertyRegistry includes 'tooltip' entry
6. App.tsx handles 'tooltip' in drag-drop switch
7. `npm run dev` shows Tooltip in palette (visual check)
8. Hovering over tooltip element shows DOM overlay after delay
</verification>

<success_criteria>
- Tooltip element type is fully defined with all configuration properties
- Tooltip renderer displays dashed trigger area in designer
- Tooltip DOM overlay appears after configured delay (300-500ms range)
- Tooltip position options (top/bottom/left/right) work correctly
- Tooltip arrow can be toggled on/off
- Tooltip content supports HTML (sanitized)
- Property panel provides full configuration
- Tooltip can be dragged from palette to canvas
</success_criteria>

<output>
After completion, create `.planning/phases/27-containers-polish/27-01-SUMMARY.md`
</output>
