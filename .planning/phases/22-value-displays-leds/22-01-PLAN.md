---
phase: 22-value-displays-leds
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/types/elements/displays.ts
  - src/components/elements/renderers/displays/NumericDisplayRenderer.tsx
  - src/components/elements/renderers/displays/TimeDisplayRenderer.tsx
  - src/components/elements/renderers/displays/PercentageDisplayRenderer.tsx
  - src/components/elements/renderers/displays/RatioDisplayRenderer.tsx
  - src/components/elements/renderers/displays/NoteDisplayRenderer.tsx
  - src/components/elements/renderers/displays/BpmDisplayRenderer.tsx
  - src/components/elements/renderers/displays/EditableDisplayRenderer.tsx
  - src/components/elements/renderers/displays/MultiValueDisplayRenderer.tsx
  - src/components/elements/renderers/displays/index.ts
  - src/components/elements/renderers/index.ts
  - src/utils/valueFormatters.ts
autonomous: true

must_haves:
  truths:
    - "User can add Numeric Display that shows formatted number with configurable decimal places"
    - "User can add Time Display that auto-switches between ms/s/bars format"
    - "User can add Percentage Display that shows 0-100% with % symbol"
    - "User can add Ratio Display that shows compression ratio (4:1, infinity:1)"
    - "User can add Note Display that converts MIDI number to note name (C4, A#3)"
    - "User can add BPM Display that shows tempo with BPM label"
    - "User can add Editable Display that allows double-click to edit value"
    - "User can add Multi-Value Display with stacked values (up to 4)"
  artifacts:
    - path: "src/types/elements/displays.ts"
      provides: "NumericDisplayElementConfig, TimeDisplayElementConfig, PercentageDisplayElementConfig, RatioDisplayElementConfig, NoteDisplayElementConfig, BpmDisplayElementConfig, EditableDisplayElementConfig, MultiValueDisplayElementConfig"
      contains: "type: 'numericdisplay'"
    - path: "src/components/elements/renderers/displays/NumericDisplayRenderer.tsx"
      provides: "Numeric Display rendering with decimal precision"
      exports: ["NumericDisplayRenderer"]
    - path: "src/components/elements/renderers/displays/EditableDisplayRenderer.tsx"
      provides: "Editable Display with double-click edit mode"
      exports: ["EditableDisplayRenderer"]
    - path: "src/utils/valueFormatters.ts"
      provides: "Extended formatting utilities for time, ratio, note, bpm"
      exports: ["formatDisplayValue", "truncateValue"]
  key_links:
    - from: "src/components/elements/renderers/index.ts"
      to: "rendererRegistry"
      via: "Map.set for all 8 display types"
      pattern: "\\['numericdisplay'"
---

<objective>
Implement 8 value display element types with formatting utilities and renderers.

Purpose: Provide audio plugin designers with formatted value displays for showing parameter values in Numeric, Time, Percentage, Ratio, Note, BPM, Editable, and Multi-Value formats.

Output: 8 new display element configs, renderers with value formatting, and utility functions.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-value-displays-leds/22-CONTEXT.md
@.planning/phases/22-value-displays-leds/22-RESEARCH.md

# Existing patterns to extend
@src/types/elements/displays.ts
@src/components/elements/renderers/displays/DbDisplayRenderer.tsx
@src/components/elements/renderers/displays/index.ts
@src/components/elements/renderers/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create value formatting utilities</name>
  <files>
    src/utils/valueFormatters.ts
  </files>
  <action>
    Create a new utility file with extended formatting functions:

    1. **formatDisplayValue(value, min, max, format, options):**
       - format types: 'numeric', 'time', 'percentage', 'ratio', 'note', 'bpm'
       - Calculate actual value from normalized (0-1): actual = min + value * (max - min)
       - Return formatted string with appropriate suffix

       Format implementations:
       - 'numeric': actual.toFixed(options.decimals ?? 2)
       - 'time': Auto-switch based on magnitude:
         - < 1000ms: "${ms.toFixed(0)} ms"
         - < 60000ms: "${(ms/1000).toFixed(2)} s"
         - >= 60000ms: "${bars.toFixed(2)} bars" (using bpm and timeSignature from options)
       - 'percentage': "${(value * 100).toFixed(decimals)}%" (already 0-1)
       - 'ratio': ratio >= 20 ? '∞:1' : `${ratio.toFixed(1)}:1`
       - 'note': Use simple MIDI-to-note conversion (no external library):
         ```typescript
         const noteNames = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B']
         const midiNumber = Math.round(actual)
         const octave = Math.floor(midiNumber / 12) - 1
         const noteName = noteNames[midiNumber % 12]
         return `${noteName}${octave}`
         ```
       - 'bpm': `${actual.toFixed(options.decimals ?? 2)} BPM`

    2. **truncateValue(text, maxWidth, fontSize):**
       - Estimate character width as fontSize * 0.6
       - If estimated width > maxWidth, truncate with ellipsis
       - Return truncated string

    3. **FormatOptions interface:**
       ```typescript
       interface FormatOptions {
         decimals?: number
         bpm?: number // For time format bars calculation
         timeSignature?: number // Beats per bar
         preferSharps?: boolean // For note display
       }
       ```

    Note: Avoid external dependencies. Use simple MIDI-to-note calculation (C4 = 60 standard).
  </action>
  <verify>
    File exists: src/utils/valueFormatters.ts
    Import test: `import { formatDisplayValue, truncateValue } from './utils/valueFormatters'` compiles
  </verify>
  <done>
    Value formatting utilities created with formatDisplayValue and truncateValue.
    All 6 format types implemented with proper suffix handling.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create 8 value display element types and renderers</name>
  <files>
    src/types/elements/displays.ts
    src/components/elements/renderers/displays/NumericDisplayRenderer.tsx
    src/components/elements/renderers/displays/TimeDisplayRenderer.tsx
    src/components/elements/renderers/displays/PercentageDisplayRenderer.tsx
    src/components/elements/renderers/displays/RatioDisplayRenderer.tsx
    src/components/elements/renderers/displays/NoteDisplayRenderer.tsx
    src/components/elements/renderers/displays/BpmDisplayRenderer.tsx
    src/components/elements/renderers/displays/EditableDisplayRenderer.tsx
    src/components/elements/renderers/displays/MultiValueDisplayRenderer.tsx
    src/components/elements/renderers/displays/index.ts
    src/components/elements/renderers/index.ts
  </files>
  <action>
    **Add to displays.ts (after existing types):**

    Common display properties (shared across all new display types):
    - fontStyle: '7segment' | 'modern' (modern = Roboto Mono)
    - bezelStyle: 'inset' | 'flat' | 'none'
    - showGhostSegments: boolean (only for 7-segment style)
    - unitDisplay: 'suffix' | 'label' (suffix inline, label separate)

    1. **NumericDisplayElementConfig:**
       - type: 'numericdisplay'
       - value: number (0-1 normalized)
       - min, max: number (actual value range)
       - decimalPlaces: number
       - unit: string (optional unit label)
       - fontSize, fontFamily, textColor, backgroundColor, padding
       - fontStyle, bezelStyle, showGhostSegments, unitDisplay, borderColor

    2. **TimeDisplayElementConfig:**
       - type: 'timedisplay'
       - value: number (0-1 normalized, mapped to ms)
       - min, max: number (time range in ms)
       - decimalPlaces: number
       - bpm: number (for bars calculation)
       - timeSignature: number (beats per bar)
       - fontSize, fontFamily, textColor, backgroundColor, padding
       - fontStyle, bezelStyle, showGhostSegments, borderColor

    3. **PercentageDisplayElementConfig:**
       - type: 'percentagedisplay'
       - value: number (0-1, displayed as 0-100%)
       - decimalPlaces: number
       - fontSize, fontFamily, textColor, backgroundColor, padding
       - fontStyle, bezelStyle, showGhostSegments, borderColor

    4. **RatioDisplayElementConfig:**
       - type: 'ratiodisplay'
       - value: number (0-1 normalized)
       - min, max: number (ratio range, e.g., 1-20)
       - decimalPlaces: number
       - infinityThreshold: number (default 20, shows ∞:1 at this ratio)
       - fontSize, fontFamily, textColor, backgroundColor, padding
       - fontStyle, bezelStyle, showGhostSegments, borderColor

    5. **NoteDisplayElementConfig:**
       - type: 'notedisplay'
       - value: number (0-1 normalized)
       - min, max: number (MIDI range, e.g., 0-127)
       - preferSharps: boolean (A# vs Bb)
       - showMidiNumber: boolean (show MIDI number below note name)
       - fontSize, fontFamily, textColor, backgroundColor, padding
       - fontStyle, bezelStyle, borderColor

    6. **BpmDisplayElementConfig:**
       - type: 'bpmdisplay'
       - value: number (0-1 normalized)
       - min, max: number (BPM range, e.g., 20-300)
       - decimalPlaces: number
       - showLabel: boolean (show "BPM" suffix)
       - fontSize, fontFamily, textColor, backgroundColor, padding
       - fontStyle, bezelStyle, showGhostSegments, borderColor

    7. **EditableDisplayElementConfig:**
       - type: 'editabledisplay'
       - value: number (0-1 normalized)
       - min, max: number (actual value range)
       - format: 'numeric' | 'percentage' | 'db' (what format to display/edit)
       - decimalPlaces: number
       - fontSize, fontFamily, textColor, backgroundColor, borderColor, padding

    8. **MultiValueDisplayElementConfig:**
       - type: 'multivaluedisplay'
       - values: Array<{ value: number; min: number; max: number; format: string; label?: string; decimalPlaces?: number }>
       - layout: 'vertical' | 'horizontal'
       - fontSize, fontFamily, textColor, backgroundColor, borderColor, padding

    Add type guards: isNumericDisplay, isTimeDisplay, isPercentageDisplay, isRatioDisplay, isNoteDisplay, isBpmDisplay, isEditableDisplay, isMultiValueDisplay

    Add factory functions with sensible defaults:
    - createNumericDisplay: value 0.5, min 0, max 100, 2 decimals
    - createTimeDisplay: value 0.5, min 0, max 1000ms
    - createPercentageDisplay: value 0.5, 0 decimals
    - createRatioDisplay: value 0.2, min 1, max 20
    - createNoteDisplay: value 0.47 (MIDI 60 = C4 when min 0, max 127)
    - createBpmDisplay: value 0.5, min 20, max 300
    - createEditableDisplay: value 0.5, min 0, max 100
    - createMultiValueDisplay: 2 values with labels

    Add to DisplayElement union type.

    **Create renderers following DbDisplayRenderer pattern:**

    All renderers share:
    - Use formatDisplayValue utility for formatting
    - Support fontStyle (7-segment vs modern font)
    - Support bezelStyle (inset box-shadow, flat border, or none)
    - Ghost segments for 7-segment: render "888..." at opacity 0.25 behind value
    - Negative values: show in red (#ff4444) per CONTEXT.md
    - Truncate overflow with ellipsis

    **NumericDisplayRenderer.tsx:**
    - Display formatted number with optional unit
    - Ghost segments match digit count

    **TimeDisplayRenderer.tsx:**
    - Auto-switch ms/s/bars based on value
    - Include suffix in display

    **PercentageDisplayRenderer.tsx:**
    - Display value * 100 with % symbol
    - Ghost segments for 7-segment style

    **RatioDisplayRenderer.tsx:**
    - Display ratio with :1 suffix
    - Show ∞:1 when >= infinityThreshold

    **NoteDisplayRenderer.tsx:**
    - Display note name (C4, A#3)
    - Optional MIDI number below
    - No ghost segments (notes don't use 7-segment)

    **BpmDisplayRenderer.tsx:**
    - Display tempo with optional BPM label
    - Ghost segments for 7-segment style

    **EditableDisplayRenderer.tsx:**
    - Display value in selected format
    - Double-click to enter edit mode (swap div for input)
    - Validate on Enter or blur
    - Show error message briefly, revert to previous value on invalid
    - Use useState for isEditing, editValue, errorMessage
    - Keep focus during error display

    **MultiValueDisplayRenderer.tsx:**
    - Flexbox container with layout direction
    - Map over values array, format each
    - Optional labels above/beside values
    - Max 4 values (validate in factory)

    **Register in displays/index.ts and main index.ts:**
    - Export all 8 renderers from displays/index.ts
    - Add to rendererRegistry Map in main index.ts
  </action>
  <verify>
    npm run build succeeds with no TypeScript errors.
    grep -r "numericdisplay" src/ returns type, renderer, registry entries.
    grep -r "editabledisplay" src/ returns type, renderer, registry entries.
  </verify>
  <done>
    Eight value display element types defined with type guards and factories.
    Eight renderers created with proper formatting and styling.
    Editable Display supports double-click editing with validation.
    All registered in rendererRegistry.
    Build passes.
  </done>
</task>

</tasks>

<verification>
1. TypeScript build: `npm run build` completes with no errors
2. Formatter test:
   - formatDisplayValue(0.5, 0, 100, 'numeric', { decimals: 1 }) returns "50.0"
   - formatDisplayValue(0.47, 0, 127, 'note', {}) returns "C4" (or close to MIDI 60)
   - formatDisplayValue(1, 1, 20, 'ratio', {}) returns "∞:1"
3. Registry verification:
   - grep "numericdisplay" src/components/elements/renderers/index.ts returns entry
   - grep "editabledisplay" src/components/elements/renderers/index.ts returns entry
   - grep "multivaluedisplay" src/components/elements/renderers/index.ts returns entry
4. Type exports:
   - displays.ts exports all 8 new config types
   - Type guards exist for all 8 types
</verification>

<success_criteria>
- All 8 value display types compile without errors
- formatDisplayValue utility handles all 6 format types correctly
- Renderers display formatted values with correct styling:
  - Numeric: shows number with decimals
  - Time: auto-switches ms/s/bars
  - Percentage: shows 0-100%
  - Ratio: shows X:1 or ∞:1
  - Note: shows C4, A#3, etc.
  - BPM: shows tempo with BPM label
  - Editable: allows double-click editing
  - Multi-Value: shows stacked values
- Ghost segments work for 7-segment fontStyle
- Negative values display in red
- All renderers registered in rendererRegistry
</success_criteria>

<output>
After completion, create `.planning/phases/22-value-displays-leds/22-01-SUMMARY.md`
</output>
