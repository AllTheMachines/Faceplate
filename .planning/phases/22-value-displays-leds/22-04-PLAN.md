---
phase: 22-value-displays-leds
plan: 04
type: execute
wave: 2
depends_on: ["22-01", "22-02"]
files_modified:
  - src/services/export/htmlGenerator.ts
  - src/services/export/cssGenerator.ts
autonomous: true

must_haves:
  truths:
    - "Exported HTML includes all 8 value display element types"
    - "Exported HTML includes all 6 LED indicator element types"
    - "Exported CSS includes styles for all display/LED visual states"
    - "Value displays export with correct formatting in text content"
    - "LED elements export with correct color and glow styles"
  artifacts:
    - path: "src/services/export/htmlGenerator.ts"
      provides: "HTML generation for all 14 display/LED types"
      contains: "numericdisplay"
    - path: "src/services/export/cssGenerator.ts"
      provides: "CSS generation for all 14 display/LED types"
      contains: "numericdisplay"
  key_links:
    - from: "src/services/export/htmlGenerator.ts"
      to: "generateElementHTML"
      via: "switch case for each display/LED type"
      pattern: "case 'numericdisplay'"
    - from: "src/services/export/cssGenerator.ts"
      to: "generateElementCSS"
      via: "switch case for each display/LED type"
      pattern: "case 'numericdisplay'"
---

<objective>
Add export support for all 14 display and LED element types to the HTML and CSS generators.

Purpose: Enable users to export their designs including all new value displays and LED indicators for use in JUCE WebView2 plugins.

Output: Updated htmlGenerator.ts and cssGenerator.ts with full support for all 14 new element types.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-value-displays-leds/22-CONTEXT.md
@.planning/phases/22-value-displays-leds/22-RESEARCH.md
@.planning/phases/22-value-displays-leds/22-01-SUMMARY.md
@.planning/phases/22-value-displays-leds/22-02-SUMMARY.md

# Export patterns
@src/services/export/htmlGenerator.ts
@src/services/export/cssGenerator.ts
@src/types/elements/displays.ts
@src/utils/valueFormatters.ts
@src/utils/ledColorPalettes.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add HTML generation for display/LED elements</name>
  <files>
    src/services/export/htmlGenerator.ts
  </files>
  <action>
    Add HTML generation cases for all 14 new element types in the generateElementHTML function:

    **Import utilities:**
    ```typescript
    import { formatDisplayValue } from '../../utils/valueFormatters'
    ```

    **Value Displays (8 types):**

    **Numeric Display (numericdisplay):**
    ```html
    <div id="${id}" class="numericdisplay" data-font-style="${fontStyle}" data-bezel="${bezelStyle}">
      ${showGhostSegments && fontStyle === '7segment' ? `<span class="ghost">${ghostPattern}</span>` : ''}
      <span class="value">${formattedValue}</span>
      ${unitDisplay === 'label' && unit ? `<span class="unit">${unit}</span>` : ''}
    </div>
    ```
    - formattedValue = formatDisplayValue(value, min, max, 'numeric', { decimals: decimalPlaces })
    - ghostPattern = '8'.repeat(formattedValue.replace(/[^0-9.-]/g, '').length)

    **Time Display (timedisplay):**
    ```html
    <div id="${id}" class="timedisplay" data-font-style="${fontStyle}" data-bezel="${bezelStyle}">
      ${showGhostSegments && fontStyle === '7segment' ? `<span class="ghost">${ghostPattern}</span>` : ''}
      <span class="value">${formattedTime}</span>
    </div>
    ```
    - formattedTime = formatDisplayValue(value, min, max, 'time', { decimals, bpm, timeSignature })

    **Percentage Display (percentagedisplay):**
    ```html
    <div id="${id}" class="percentagedisplay" data-font-style="${fontStyle}" data-bezel="${bezelStyle}">
      ${showGhostSegments && fontStyle === '7segment' ? `<span class="ghost">888%</span>` : ''}
      <span class="value">${formattedPercentage}</span>
    </div>
    ```
    - formattedPercentage = formatDisplayValue(value, 0, 1, 'percentage', { decimals: decimalPlaces })

    **Ratio Display (ratiodisplay):**
    ```html
    <div id="${id}" class="ratiodisplay" data-font-style="${fontStyle}" data-bezel="${bezelStyle}">
      ${showGhostSegments && fontStyle === '7segment' ? `<span class="ghost">88:1</span>` : ''}
      <span class="value">${formattedRatio}</span>
    </div>
    ```
    - formattedRatio = formatDisplayValue(value, min, max, 'ratio', { decimals: decimalPlaces })

    **Note Display (notedisplay):**
    ```html
    <div id="${id}" class="notedisplay" data-bezel="${bezelStyle}">
      <span class="note">${noteName}</span>
      ${showMidiNumber ? `<span class="midi">${midiNumber}</span>` : ''}
    </div>
    ```
    - Calculate note using same logic as renderer

    **BPM Display (bpmdisplay):**
    ```html
    <div id="${id}" class="bpmdisplay" data-font-style="${fontStyle}" data-bezel="${bezelStyle}">
      ${showGhostSegments && fontStyle === '7segment' ? `<span class="ghost">888.88</span>` : ''}
      <span class="value">${formattedBpm}</span>
      ${showLabel ? `<span class="label">BPM</span>` : ''}
    </div>
    ```

    **Editable Display (editabledisplay):**
    ```html
    <div id="${id}" class="editabledisplay" data-format="${format}" data-min="${min}" data-max="${max}">
      <span class="value">${formattedValue}</span>
    </div>
    ```
    - Note: Editing functionality requires JavaScript in exported bundle

    **Multi-Value Display (multivaluedisplay):**
    ```html
    <div id="${id}" class="multivaluedisplay" data-layout="${layout}">
      ${values.map((v, i) => `
        <div class="value-item">
          ${v.label ? `<span class="label">${v.label}</span>` : ''}
          <span class="value">${formatDisplayValue(v.value, v.min, v.max, v.format, { decimals: v.decimalPlaces })}</span>
        </div>
      `).join('')}
    </div>
    ```

    **LED Indicators (6 types):**

    **Single LED (singleled):**
    ```html
    <div id="${id}" class="singleled" data-state="${state}" data-shape="${shape}"></div>
    ```

    **Bi-Color LED (bicolorled):**
    ```html
    <div id="${id}" class="bicolorled" data-state="${state}" data-shape="${shape}"></div>
    ```

    **Tri-Color LED (tricolorled):**
    ```html
    <div id="${id}" class="tricolorled" data-state="${state}" data-shape="${shape}"></div>
    ```

    **LED Array (ledarray):**
    ```html
    <div id="${id}" class="ledarray" data-orientation="${orientation}" data-count="${segmentCount}">
      ${Array.from({ length: segmentCount }, (_, i) =>
        `<div class="led-segment" data-index="${i}" data-lit="${i < litCount}"></div>`
      ).join('')}
    </div>
    ```
    - litCount = Math.round(value * segmentCount)

    **LED Ring (ledring):**
    ```html
    <div id="${id}" class="ledring">
      <svg width="${diameter}" height="${diameter}" viewBox="0 0 ${diameter} ${diameter}">
        <circle class="ring-bg" cx="${cx}" cy="${cy}" r="${radius}" fill="none"
          stroke="${offColor}" stroke-width="${thickness}"
          stroke-dasharray="${dashLength} ${gapLength}" opacity="0.3"/>
        <circle class="ring-lit" cx="${cx}" cy="${cy}" r="${radius}" fill="none"
          stroke="${onColor}" stroke-width="${thickness}"
          stroke-dasharray="${litDashArray}"
          transform="rotate(${startAngle} ${cx} ${cy})"
          ${glowEnabled ? `filter="url(#led-glow-${id})"` : ''}/>
        ${glowEnabled ? `
        <defs>
          <filter id="led-glow-${id}">
            <feGaussianBlur stdDeviation="${glowRadius / 3}" result="blur"/>
            <feMerge>
              <feMergeNode in="blur"/>
              <feMergeNode in="SourceGraphic"/>
            </feMerge>
          </filter>
        </defs>
        ` : ''}
      </svg>
    </div>
    ```

    **LED Matrix (ledmatrix):**
    ```html
    <div id="${id}" class="ledmatrix" data-rows="${rows}" data-cols="${columns}">
      ${states.flat().map((isLit, i) =>
        `<div class="led-cell" data-index="${i}" data-lit="${isLit}"></div>`
      ).join('')}
    </div>
    ```
  </action>
  <verify>
    npm run build succeeds.
    grep "numericdisplay" src/services/export/htmlGenerator.ts returns case statement.
    grep "ledmatrix" src/services/export/htmlGenerator.ts returns case statement.
  </verify>
  <done>
    HTML generation added for all 14 display/LED types.
    Value displays include formatted text content.
    LED elements include proper state data attributes.
    LED Ring exports SVG with filter for glow.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add CSS generation for display/LED elements</name>
  <files>
    src/services/export/cssGenerator.ts
  </files>
  <action>
    Add CSS generation cases for all 14 new element types:

    **Value Displays (8 types) - shared base styles:**
    ```css
    /* Base display styles */
    #${id} {
      position: absolute;
      left: ${x}px;
      top: ${y}px;
      width: ${width}px;
      height: ${height}px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: ${fontStyle === '7segment' ? 'DSEG7, monospace' : fontFamily};
      font-size: ${fontSize}px;
      color: ${textColor};
      background-color: ${backgroundColor};
      padding: ${padding}px;
      box-sizing: border-box;
    }
    ```

    **Bezel styles (shared):**
    ```css
    #${id}[data-bezel="inset"] {
      box-shadow: inset 2px 2px 4px rgba(0,0,0,0.5);
      border-radius: 4px;
    }
    #${id}[data-bezel="flat"] {
      border: 2px solid ${borderColor};
      border-radius: 4px;
    }
    #${id}[data-bezel="none"] {
      border: none;
      border-radius: 0;
    }
    ```

    **Ghost segments (7-segment displays):**
    ```css
    #${id}[data-font-style="7segment"] {
      position: relative;
    }
    #${id} .ghost {
      position: absolute;
      opacity: 0.25;
      letter-spacing: 0.05em;
    }
    #${id} .value {
      position: relative;
      z-index: 1;
      letter-spacing: ${fontStyle === '7segment' ? '0.05em' : 'normal'};
    }
    ```

    **Numeric Display specific:**
    ```css
    #${id}.numericdisplay .unit {
      position: absolute;
      bottom: 4px;
      right: 4px;
      font-size: ${fontSize * 0.6}px;
      opacity: 0.7;
    }
    ```

    **Note Display specific:**
    ```css
    #${id}.notedisplay {
      flex-direction: column;
    }
    #${id}.notedisplay .note {
      font-weight: 600;
    }
    #${id}.notedisplay .midi {
      font-size: ${fontSize * 0.5}px;
      opacity: 0.6;
      margin-top: 2px;
    }
    ```

    **Multi-Value Display specific:**
    ```css
    #${id}.multivaluedisplay {
      flex-direction: ${layout === 'vertical' ? 'column' : 'row'};
      justify-content: space-around;
      gap: 4px;
    }
    #${id}.multivaluedisplay .value-item {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    #${id}.multivaluedisplay .label {
      font-size: ${fontSize * 0.7}px;
      opacity: 0.7;
      margin-bottom: 2px;
    }
    ```

    **Editable Display specific:**
    ```css
    #${id}.editabledisplay {
      cursor: pointer;
      border: 2px solid ${borderColor};
      border-radius: 4px;
    }
    ```

    **LED Indicators (6 types):**

    **Single LED:**
    ```css
    #${id}.singleled {
      position: absolute;
      left: ${x}px;
      top: ${y}px;
      width: ${width}px;
      height: ${height}px;
      border-radius: ${shape === 'round' ? '50%' : `${cornerRadius}px`};
      transition: none;
    }
    #${id}.singleled[data-state="off"] {
      background-color: ${offColor};
    }
    #${id}.singleled[data-state="on"] {
      background-color: ${onColor};
      ${glowEnabled ? `box-shadow: 0 0 ${glowRadius}px ${glowIntensity}px ${onColor};` : ''}
    }
    ```

    **Bi-Color LED:**
    ```css
    #${id}.bicolorled {
      position: absolute;
      left: ${x}px;
      top: ${y}px;
      width: ${width}px;
      height: ${height}px;
      border-radius: ${shape === 'round' ? '50%' : `${cornerRadius}px`};
      transition: none;
    }
    #${id}.bicolorled[data-state="green"] {
      background-color: ${greenColor};
      ${glowEnabled ? `box-shadow: 0 0 ${glowRadius}px ${glowIntensity}px ${greenColor};` : ''}
    }
    #${id}.bicolorled[data-state="red"] {
      background-color: ${redColor};
      ${glowEnabled ? `box-shadow: 0 0 ${glowRadius}px ${glowIntensity}px ${redColor};` : ''}
    }
    ```

    **Tri-Color LED:**
    ```css
    #${id}.tricolorled {
      position: absolute;
      left: ${x}px;
      top: ${y}px;
      width: ${width}px;
      height: ${height}px;
      border-radius: ${shape === 'round' ? '50%' : `${cornerRadius}px`};
      transition: none;
    }
    #${id}.tricolorled[data-state="off"] {
      background-color: ${offColor};
    }
    #${id}.tricolorled[data-state="yellow"] {
      background-color: ${yellowColor};
      ${glowEnabled ? `box-shadow: 0 0 ${glowRadius}px ${glowIntensity}px ${yellowColor};` : ''}
    }
    #${id}.tricolorled[data-state="red"] {
      background-color: ${redColor};
      ${glowEnabled ? `box-shadow: 0 0 ${glowRadius}px ${glowIntensity}px ${redColor};` : ''}
    }
    ```

    **LED Array:**
    ```css
    #${id}.ledarray {
      position: absolute;
      left: ${x}px;
      top: ${y}px;
      width: ${width}px;
      height: ${height}px;
      display: flex;
      flex-direction: ${orientation === 'horizontal' ? 'row' : 'column'};
      gap: ${spacing}px;
      align-items: center;
      justify-content: space-between;
    }
    #${id}.ledarray .led-segment {
      flex: 1;
      max-width: ${orientation === 'horizontal' ? `${width / segmentCount - spacing}px` : '100%'};
      max-height: ${orientation === 'vertical' ? `${height / segmentCount - spacing}px` : '100%'};
      border-radius: ${shape === 'round' ? '50%' : `${cornerRadius}px`};
      transition: none;
    }
    #${id}.ledarray .led-segment[data-lit="false"] {
      background-color: ${offColor};
    }
    #${id}.ledarray .led-segment[data-lit="true"] {
      background-color: ${onColor};
      ${glowEnabled ? `box-shadow: 0 0 ${glowRadius}px ${glowIntensity}px ${onColor};` : ''}
    }
    ```

    **LED Ring:**
    ```css
    #${id}.ledring {
      position: absolute;
      left: ${x}px;
      top: ${y}px;
      width: ${width}px;
      height: ${height}px;
      overflow: visible;
    }
    #${id}.ledring svg {
      overflow: visible;
    }
    ```

    **LED Matrix:**
    ```css
    #${id}.ledmatrix {
      position: absolute;
      left: ${x}px;
      top: ${y}px;
      width: ${width}px;
      height: ${height}px;
      display: grid;
      grid-template-rows: repeat(${rows}, 1fr);
      grid-template-columns: repeat(${columns}, 1fr);
      gap: ${spacing}px;
      padding: ${spacing}px;
    }
    #${id}.ledmatrix .led-cell {
      border-radius: ${shape === 'round' ? '50%' : `${cornerRadius}px`};
      justify-self: center;
      align-self: center;
      width: calc(100% - ${spacing}px);
      height: calc(100% - ${spacing}px);
      transition: none;
    }
    #${id}.ledmatrix .led-cell[data-lit="false"] {
      background-color: ${offColor};
    }
    #${id}.ledmatrix .led-cell[data-lit="true"] {
      background-color: ${onColor};
      ${glowEnabled ? `box-shadow: 0 0 ${glowRadius}px ${glowIntensity}px ${onColor};` : ''}
    }
    ```

    **DSEG Font face (if 7-segment displays used):**
    Add to font face generation if any element uses fontStyle === '7segment':
    ```css
    @font-face {
      font-family: 'DSEG7';
      src: url('./fonts/DSEG7-Classic-MINI.woff2') format('woff2');
      font-weight: normal;
      font-style: normal;
      font-display: block;
    }
    ```
  </action>
  <verify>
    npm run build succeeds.
    grep "numericdisplay" src/services/export/cssGenerator.ts returns case statement.
    grep "ledmatrix" src/services/export/cssGenerator.ts returns case statement.
  </verify>
  <done>
    CSS generation added for all 14 display/LED types.
    All styles use transition: none for instant state changes.
    Bezel styles implemented (inset/flat/none).
    Ghost segments styled with opacity 0.25.
    LED glow uses box-shadow.
    LED Matrix uses CSS Grid layout.
  </done>
</task>

</tasks>

<verification>
1. TypeScript build: `npm run build` completes with no errors
2. Export test:
   - npm run dev
   - Add one of each new display/LED type to canvas
   - Export project
   - Verify exported HTML contains elements for each type
   - Verify exported CSS contains styles for each type
3. Code verification:
   - grep -c "numericdisplay" src/services/export/htmlGenerator.ts returns at least 1
   - grep -c "ledmatrix" src/services/export/cssGenerator.ts returns at least 1
4. State export:
   - Verify data-state, data-lit attributes in LED HTML
   - Verify CSS uses these data attributes for state-based styling
   - Verify LED glow box-shadow is conditional on glowEnabled
</verification>

<success_criteria>
- All 14 display/LED types export valid HTML structure
- All CSS includes proper positioning and state-based styles
- Value displays export with formatted text content
- Ghost segments export for 7-segment displays
- LED elements export with correct state attributes
- LED glow uses box-shadow with proper intensity
- LED Ring exports SVG with filter for glow
- LED Matrix exports CSS Grid layout
- All styles use transition: none
- Exported code works in browser preview
</success_criteria>

<output>
After completion, create `.planning/phases/22-value-displays-leds/22-04-SUMMARY.md`
</output>
