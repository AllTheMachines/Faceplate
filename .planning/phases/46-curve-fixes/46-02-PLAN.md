---
phase: 46-curve-fixes
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/elements/renderers/displays/curves/CompressorCurveRenderer.tsx
  - src/components/elements/renderers/displays/curves/EnvelopeDisplayRenderer.tsx
  - src/components/Properties/curves/CompressorCurveProperties.tsx
  - src/components/Properties/curves/EnvelopeDisplayProperties.tsx
autonomous: true

must_haves:
  truths:
    - "Compressor Curve displays visible transfer function line on canvas"
    - "Compressor Curve threshold handle is visible and highlights on hover"
    - "Envelope Display shows visible ADSR curve on canvas"
    - "Envelope Display control point handles are visible and highlight on hover"
  artifacts:
    - path: "src/components/elements/renderers/displays/curves/CompressorCurveRenderer.tsx"
      provides: "Compressor Curve canvas rendering with visible curve and handle"
    - path: "src/components/elements/renderers/displays/curves/EnvelopeDisplayRenderer.tsx"
      provides: "Envelope Display canvas rendering with visible ADSR and handles"
  key_links:
    - from: "CompressorCurveRenderer"
      to: "calculateCompressorOutput"
      via: "threshold/ratio/knee params"
    - from: "EnvelopeDisplayRenderer"
      to: "drawSmoothCurve"
      via: "stage points arrays"
---

<objective>
Fix Compressor Curve and Envelope Display elements to render visibly and respond to hover interaction.

Purpose: These time/level domain curve elements use linear coordinate mapping (not logarithmic frequency). Fixing them together enables pattern consistency.

Output: Both elements display visible curves with working handle hover feedback.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/46-curve-fixes/46-CONTEXT.md
@.planning/phases/46-curve-fixes/46-RESEARCH.md
@src/components/elements/renderers/displays/curves/CompressorCurveRenderer.tsx
@src/components/elements/renderers/displays/curves/EnvelopeDisplayRenderer.tsx
@src/utils/curveRendering.ts
@src/utils/audioMath.ts
@src/types/elements/curves.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Diagnose and fix Compressor Curve visibility</name>
  <files>
    src/components/elements/renderers/displays/curves/CompressorCurveRenderer.tsx
    src/components/Properties/curves/CompressorCurveProperties.tsx
  </files>
  <action>
    Systematically verify Compressor Curve rendering:

    1. **Canvas Setup Verification:**
       - Confirm `useCanvasSetup(width, height, canvasScale)` is called
       - Verify canvas ref and ctx guard

    2. **Transfer Function Calculation:**
       - Verify `calculateCompressorOutput` returns valid dB values
       - Check for correct threshold, ratio, knee handling
       - Log a few sample points to verify: input -60dB, -18dB (threshold), 0dB

    3. **Coordinate Mapping:**
       - Compressor uses linear dB mapping (not log frequency)
       - Verify x = ((inputDb - minDb) / (maxDb - minDb)) * width
       - Verify y = height - ((outputDb - minDb) / (maxDb - minDb)) * height
       - Check points are within bounds

    4. **1:1 Reference Line:**
       - Verify diagonal reference line is visible (rgba white at 0.2 alpha)
       - This helps visualize compression

    5. **Apply Fixes:**
       - If curve invisible: Check stroke after fill in drawSmoothCurve
       - If handle wrong position: Verify threshold-to-coordinate mapping
       - If gain reduction display broken: Check displayMode === 'gainreduction' branch

    **Per CONTEXT.md decisions:**
    - Transfer function with threshold/ratio adjustments
    - Single handle at threshold point on 1:1 line
    - Instant update on property changes
  </action>
  <verify>
    - Add Compressor Curve element to canvas from palette
    - Transfer curve is visible (shows compression knee/slope)
    - 1:1 diagonal reference line is visible
    - Threshold handle is visible at threshold point
    - Hovering over handle changes cursor to pointer
    - Changing threshold/ratio in properties updates curve immediately
  </verify>
  <done>
    Compressor Curve renders visible transfer function with hoverable threshold handle
  </done>
</task>

<task type="auto">
  <name>Task 2: Diagnose and fix Envelope Display visibility</name>
  <files>
    src/components/elements/renderers/displays/curves/EnvelopeDisplayRenderer.tsx
    src/components/Properties/curves/EnvelopeDisplayProperties.tsx
  </files>
  <action>
    Systematically verify Envelope Display rendering:

    1. **ADSR Point Generation:**
       - Check attack, decay, sustain, release values (should be 0-1)
       - Verify time proportions calculate correctly
       - Log attackPoints, decayPoints, sustainPoints, releasePoints arrays

    2. **Curve Segment Drawing:**
       - Verify each segment is drawn with correct color
       - Check showStageColors toggle works (individual vs single color)
       - Verify curveType affects point calculations (linear vs exponential)

    3. **Handle Positions:**
       - 3 handles: end of attack, end of decay, end of sustain
       - Verify handle Y coordinates match curve endpoints
       - Check handles array construction

    4. **Stage Markers:**
       - If showStageMarkers true, verify vertical dashed lines appear
       - Check setLineDash is reset after drawing markers

    5. **Apply Fixes:**
       - If curve segments invisible: Check each segment has visible color
       - If handles at wrong positions: Verify time proportion calculations
       - If exponential curves look wrong: Check curve formulas (Math.pow, Math.exp)

    **Per CONTEXT.md decisions:**
    - Per-segment curve property (linear vs exponential)
    - 3 draggable control points (A, D, S endpoints)
    - Stage markers optional
    - Handle size 8-10px
  </action>
  <verify>
    - Add Envelope Display element to canvas from palette
    - ADSR curve is visible with all 4 stages
    - 3 control point handles are visible
    - Hovering over handles changes cursor to pointer
    - Changing ADSR values in properties updates curve immediately
    - Toggle showStageColors to verify individual segment coloring works
    - Toggle curveType to verify linear vs exponential shapes
  </verify>
  <done>
    Envelope Display shows visible ADSR curve with hoverable control points
  </done>
</task>

</tasks>

<verification>
**Manual Testing:**
1. Start dev server: `npm run dev`
2. Open application in browser
3. Add Compressor Curve from Interactive Curves category
4. Verify: Transfer curve visible, 1:1 line visible, handle visible, hover works
5. Change threshold/ratio - curve updates immediately
6. Add Envelope Display from same category
7. Verify: ADSR curve visible, 3 handles visible, hover works
8. Change ADSR values - curve updates immediately
9. Toggle stage colors and curve type

**Console Check:**
- No canvas-related errors
- No NaN/Infinity in calculations
</verification>

<success_criteria>
1. Compressor Curve displays visible transfer function with compression knee
2. Compressor 1:1 reference line is visible
3. Compressor threshold handle is visible and highlights on hover
4. Envelope Display shows complete ADSR curve (all 4 stages)
5. Envelope 3 control point handles are visible and highlight on hover
6. Both elements respond immediately to property changes
7. Envelope stage colors toggle works correctly
</success_criteria>

<output>
After completion, create `.planning/phases/46-curve-fixes/46-02-SUMMARY.md`
</output>
