---
phase: 46-curve-fixes
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/elements/renderers/displays/curves/EQCurveRenderer.tsx
  - src/components/elements/renderers/displays/curves/FilterResponseRenderer.tsx
  - src/utils/curveRendering.ts
  - src/components/Properties/curves/EQCurveProperties.tsx
  - src/components/Properties/curves/FilterResponseProperties.tsx
autonomous: true

must_haves:
  truths:
    - "EQ Curve displays visible frequency response line on canvas"
    - "EQ Curve band handles are visible and highlight on hover"
    - "Filter Response displays visible cutoff/resonance curve on canvas"
    - "Filter Response cutoff handle is visible and highlights on hover"
  artifacts:
    - path: "src/components/elements/renderers/displays/curves/EQCurveRenderer.tsx"
      provides: "EQ Curve canvas rendering with visible curve and handles"
    - path: "src/components/elements/renderers/displays/curves/FilterResponseRenderer.tsx"
      provides: "Filter Response canvas rendering with visible curve and handle"
  key_links:
    - from: "EQCurveRenderer"
      to: "drawSmoothCurve"
      via: "curveColor and lineWidth props"
    - from: "FilterResponseRenderer"
      to: "calculateFilterResponse"
      via: "filter parameters"
---

<objective>
Fix EQ Curve and Filter Response elements to render visibly and respond to hover interaction.

Purpose: These frequency-domain curve elements share similar patterns (logarithmic frequency scale, dB mapping, frequency grid). Fixing them together enables pattern reuse.

Output: Both elements display visible curves with working handle hover feedback.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/46-curve-fixes/46-CONTEXT.md
@.planning/phases/46-curve-fixes/46-RESEARCH.md
@src/components/elements/renderers/displays/curves/EQCurveRenderer.tsx
@src/components/elements/renderers/displays/curves/FilterResponseRenderer.tsx
@src/utils/curveRendering.ts
@src/utils/audioMath.ts
@src/types/elements/curves.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Diagnose and fix EQ Curve visibility</name>
  <files>
    src/components/elements/renderers/displays/curves/EQCurveRenderer.tsx
    src/utils/curveRendering.ts
    src/components/Properties/curves/EQCurveProperties.tsx
  </files>
  <action>
    Systematically verify EQ Curve rendering using the research checklist:

    1. **Canvas Setup Verification:**
       - Confirm `useCanvasSetup(width, height, canvasScale)` is called correctly
       - Verify `canvasScale` prop is passed from parent (check Element.tsx or wrapper)
       - Confirm canvas ref is applied and ctx check guards drawing

    2. **Color Visibility Check:**
       - Add temporary debug: log `curveColor`, `lineWidth`, `backgroundColor` values
       - Verify colors contrast (e.g., curveColor '#00ff88' vs backgroundColor '#1a1a1a')
       - Check `lineWidth` is > 0 (default is 2 per factory)

    3. **Curve Points Verification:**
       - Add temporary console.log for first/last few points in compositePoints array
       - Verify points are within canvas bounds (0 to width, 0 to height)
       - Check for NaN/Infinity in coordinate calculations

    4. **Apply Fixes (based on diagnosis):**
       - If curves invisible: Check drawSmoothCurve stroke is after fill
       - If handles invisible: Verify handleColor contrasts with curveColor
       - If hover not working: Ensure hoveredBand state triggers redraw (check dependency array)

    5. **Handle Hover Consistency:**
       - Verify handle size matches CONTEXT.md (8px base, 10px hover)
       - Ensure cursor changes to 'pointer' on hover

    **Per CONTEXT.md decisions:**
    - Line thickness: 1-2px (default 2px is correct)
    - Handle size: 8-10px (current implementation correct)
    - Handles always visible in designer
  </action>
  <verify>
    - Add EQ Curve element to canvas from palette
    - Curve line is visible (bright color against dark background)
    - Band handles are visible as small squares
    - Hovering over a handle changes cursor to pointer
    - Handle grows/highlights on hover
  </verify>
  <done>
    EQ Curve renders visible frequency response line with hoverable band handles
  </done>
</task>

<task type="auto">
  <name>Task 2: Diagnose and fix Filter Response visibility</name>
  <files>
    src/components/elements/renderers/displays/curves/FilterResponseRenderer.tsx
    src/components/Properties/curves/FilterResponseProperties.tsx
  </files>
  <action>
    Apply same systematic verification as EQ Curve:

    1. **Canvas Setup Verification:**
       - Confirm `useCanvasSetup` called with correct params
       - Check canvasScale is passed through

    2. **Filter Response Calculation:**
       - Verify `calculateFilterResponse` returns valid dB values
       - Add debug log for response at cutoff frequency
       - Check for edge cases (very low/high frequencies, resonance values)

    3. **Curve Rendering:**
       - Verify points array is populated with valid coordinates
       - Check drawSmoothCurve is called with correct parameters
       - Ensure lineWidth and curveColor are valid

    4. **Handle Position:**
       - Verify cutoff handle is drawn at correct frequency position
       - Check handleY calculation (response at cutoff should place handle on curve)

    5. **Apply Fixes:**
       - If curve invisible: Same pattern as EQ Curve fixes
       - If handle at wrong position: Check frequencyToX and dbToY calculations
       - If hover not working: Verify isPointInHandle coordinates match drawing coordinates

    **Per CONTEXT.md decisions:**
    - Single handle at cutoff frequency
    - Hover feedback: handle grows/highlights
  </action>
  <verify>
    - Add Filter Response element to canvas from palette
    - Curve line is visible showing filter frequency response
    - Cutoff handle is visible on the curve
    - Hovering over handle changes cursor and highlights
    - Different filter types (lowpass, highpass, etc.) show correct curve shapes
  </verify>
  <done>
    Filter Response renders visible cutoff/resonance curve with hoverable cutoff handle
  </done>
</task>

</tasks>

<verification>
**Manual Testing:**
1. Start dev server: `npm run dev`
2. Open application in browser
3. Add EQ Curve from Interactive Curves category
4. Verify: Curve visible, handles visible, hover works
5. Add Filter Response from same category
6. Verify: Curve visible, handle visible, hover works
7. Test different filter types in property panel

**Console Check:**
- No canvas-related errors in console
- No NaN/Infinity warnings in coordinate calculations
</verification>

<success_criteria>
1. EQ Curve displays visible green frequency response line
2. EQ Curve band handles (3 by default) are visible and highlight on hover
3. Filter Response displays visible filter curve appropriate to filter type
4. Filter Response cutoff handle is visible and highlights on hover
5. Both elements respond to property changes (colors, lineWidth, grid visibility)
</success_criteria>

<output>
After completion, create `.planning/phases/46-curve-fixes/46-01-SUMMARY.md`
</output>
