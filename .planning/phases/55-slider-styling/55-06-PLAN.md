---
phase: 55-slider-styling
plan: 06
type: execute
wave: 2
depends_on: ["55-01"]
files_modified:
  - src/types/elements/controls.ts
  - src/components/elements/renderers/controls/ArcSliderRenderer.tsx
  - src/components/Properties/ArcSliderProperties.tsx
autonomous: true

must_haves:
  truths:
    - "Arc Slider config accepts styleId and colorOverrides properties"
    - "Arc Slider renders with SVG layers when styleId is set"
    - "Thumb follows the SVG arc path using getPointAtLength"
    - "Arc fill layer clips along the curved path"
    - "Thumb rotation to tangent is user-configurable"
    - "Arc Slider renders with CSS when styleId is not set"
    - "Style dropdown shows 'arc' category styles (not 'linear')"
  artifacts:
    - path: "src/types/elements/controls.ts"
      provides: "styleId, colorOverrides, rotateThumbToTangent on ArcSliderElementConfig"
      contains: "rotateThumbToTangent"
    - path: "src/components/elements/renderers/controls/ArcSliderRenderer.tsx"
      provides: "StyledArcSliderRenderer with path-following thumb"
      contains: "getPointAtLength"
    - path: "src/components/Properties/ArcSliderProperties.tsx"
      provides: "Style dropdown for arc category"
      contains: "getStylesByCategory.*arc"
  key_links:
    - from: "src/components/elements/renderers/controls/ArcSliderRenderer.tsx"
      to: "SVGGeometryElement.getPointAtLength"
      via: "Native browser API for path-following"
      pattern: "getPointAtLength"
    - from: "src/components/elements/renderers/controls/ArcSliderRenderer.tsx"
      to: "style.category === 'arc'"
      via: "Category validation"
      pattern: "category.*arc"
---

<objective>
Add SVG styling support to Arc Slider with path-following thumb.

Purpose: Arc Slider is unique because it uses 'arc' category (not 'linear') and the thumb follows a user-drawn SVG path. Per CONTEXT.md decision, thumb position is calculated using native browser API getPointAtLength(). Thumb rotation to tangent is user-configurable.

Output: Arc Slider renders with user-provided SVG layers. Thumb follows the arc path smoothly. Optional tangent rotation for thumb alignment.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/55-slider-styling/55-CONTEXT.md
@.planning/phases/55-slider-styling/55-RESEARCH.md
@.planning/phases/55-slider-styling/55-01-SUMMARY.md

# Key source files
@src/types/elements/controls.ts
@src/types/elementStyle.ts
@src/components/elements/renderers/controls/ArcSliderRenderer.tsx
@src/components/elements/renderers/controls/SliderRenderer.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend ArcSliderElementConfig with styling properties</name>
  <files>src/types/elements/controls.ts</files>
  <action>
Add styleId, colorOverrides, and rotateThumbToTangent to ArcSliderElementConfig.

Find ArcSliderElementConfig interface (around line 576) and add AFTER the existing properties (before the closing brace):

```typescript
// SVG Style (optional - if undefined, render default CSS arc)
// Note: Arc Slider uses 'arc' category, not 'linear'
styleId?: string

// Per-instance color overrides (only used when styleId is set)
colorOverrides?: ColorOverrides

// Thumb rotation (optional - rotate thumb to follow arc tangent)
rotateThumbToTangent?: boolean
```

Also update the createArcSlider factory function (around line 1880) to include the default:
```typescript
rotateThumbToTangent: false,
```
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit`</verify>
  <done>ArcSliderElementConfig includes styleId, colorOverrides, and rotateThumbToTangent</done>
</task>

<task type="auto">
  <name>Task 2: Add StyledArcSliderRenderer with path-following thumb</name>
  <files>src/components/elements/renderers/controls/ArcSliderRenderer.tsx</files>
  <action>
This is the most complex renderer. The thumb must follow an SVG path element using getPointAtLength().

1. Add imports at top:
```typescript
import { useMemo, useRef, useEffect, useState } from 'react'
import { useStore } from '../../../../store'
import { SafeSVG } from '../../../SafeSVG'
import { extractElementLayer } from '../../../../services/elementLayers'
import { applyAllColorOverrides } from '../../../../services/knobLayers'
```

2. Rename existing ArcSliderRenderer to DefaultArcSliderRenderer (keep all existing code unchanged)

3. Create StyledArcSliderRenderer function:

```typescript
function StyledArcSliderRenderer({ config }: ArcSliderRendererProps) {
  const getElementStyle = useStore((state) => state.getElementStyle)
  const style = config.styleId ? getElementStyle(config.styleId) : undefined
  const arcContainerRef = useRef<HTMLDivElement>(null)

  // Category validation - Arc Slider uses 'arc' category
  if (style && style.category !== 'arc') {
    console.warn('ArcSlider requires arc category style')
    return null
  }

  // Calculate normalized value
  const range = config.max - config.min
  const normalizedValue = (config.value - config.min) / range

  // Memoize SVG content with color overrides
  const svgContent = useMemo(() => {
    if (!style) return ''
    return applyAllColorOverrides(style.svgContent, style.layers, config.colorOverrides)
  }, [style, config.colorOverrides])

  // Extract layers (ArcLayers: thumb, track, fill, arc)
  const layers = useMemo(() => {
    if (!style || !svgContent) return null
    return {
      track: style.layers.track ? extractElementLayer(svgContent, style.layers.track) : null,
      fill: style.layers.fill ? extractElementLayer(svgContent, style.layers.fill) : null,
      thumb: style.layers.thumb ? extractElementLayer(svgContent, style.layers.thumb) : null,
      arc: style.layers.arc ? extractElementLayer(svgContent, style.layers.arc) : null,
    }
  }, [style, svgContent])

  // Parse arc path element for getPointAtLength calculations
  const [thumbPosition, setThumbPosition] = useState({ x: 0, y: 0, angle: 0 })

  // Calculate thumb position along arc path
  useEffect(() => {
    if (!layers?.arc) {
      setThumbPosition({ x: config.diameter / 2, y: config.diameter / 2, angle: 0 })
      return
    }

    // Parse the arc SVG to get the path element
    const parser = new DOMParser()
    const doc = parser.parseFromString(layers.arc, 'image/svg+xml')
    const pathElement = doc.querySelector('path') as SVGPathElement | null

    if (!pathElement) {
      console.warn('Arc layer does not contain a path element')
      setThumbPosition({ x: config.diameter / 2, y: config.diameter / 2, angle: 0 })
      return
    }

    // Create an offscreen SVG to calculate path metrics
    const offscreenSvg = document.createElementNS('http://www.w3.org/2000/svg', 'svg')
    offscreenSvg.setAttribute('width', String(config.diameter))
    offscreenSvg.setAttribute('height', String(config.diameter))
    offscreenSvg.style.position = 'absolute'
    offscreenSvg.style.left = '-9999px'
    offscreenSvg.style.visibility = 'hidden'

    const clonedPath = pathElement.cloneNode(true) as SVGPathElement
    offscreenSvg.appendChild(clonedPath)
    document.body.appendChild(offscreenSvg)

    try {
      // Get path length and calculate position
      const totalLength = clonedPath.getTotalLength()
      const lengthAtValue = normalizedValue * totalLength

      // Get point at current value position
      const point = clonedPath.getPointAtLength(lengthAtValue)

      // Calculate tangent angle for optional thumb rotation
      const epsilon = Math.min(0.5, totalLength * 0.01)
      const prevPoint = clonedPath.getPointAtLength(Math.max(0, lengthAtValue - epsilon))
      const nextPoint = clonedPath.getPointAtLength(Math.min(totalLength, lengthAtValue + epsilon))
      const angle = Math.atan2(nextPoint.y - prevPoint.y, nextPoint.x - prevPoint.x) * 180 / Math.PI

      setThumbPosition({ x: point.x, y: point.y, angle })
    } finally {
      document.body.removeChild(offscreenSvg)
    }
  }, [layers?.arc, normalizedValue, config.diameter])

  // Arc fill clip-path (based on normalized value)
  // For arc fill, we use the same percentage approach as linear
  // The fill layer in the SVG should be designed to work with this clipping
  const fillClipPath = useMemo(() => {
    // Simple percentage-based clip from start of arc
    // For more sophisticated arc clipping, users can design their fill layer appropriately
    return `inset(0 ${(1 - normalizedValue) * 100}% 0 0)`
  }, [normalizedValue])

  // Format value display
  const formattedValue = formatValue(
    normalizedValue,
    config.min,
    config.max,
    config.valueFormat,
    config.valueSuffix,
    config.valueDecimalPlaces
  )

  if (!style) {
    return (
      <div style={{
        width: '100%', height: '100%',
        display: 'flex', alignItems: 'center', justifyContent: 'center',
        background: '#374151', borderRadius: '50%',
        color: '#9CA3AF', fontSize: '12px', textAlign: 'center', padding: '8px',
      }}>
        Style not found
      </div>
    )
  }

  return (
    <div
      ref={arcContainerRef}
      style={{ position: 'relative', width: '100%', height: '100%' }}
    >
      {/* Label */}
      {config.showLabel && (
        <span style={getLabelStyle()}>
          {config.labelText}
        </span>
      )}

      {/* Value Display */}
      {config.showValue && (
        <span style={getValueStyle()}>
          {formattedValue}
        </span>
      )}

      {/* Track - static background arc */}
      {layers?.track && (
        <div style={{ position: 'absolute', inset: 0 }}>
          <SafeSVG content={layers.track} style={{ width: '100%', height: '100%' }} />
        </div>
      )}

      {/* Arc path (invisible, used for thumb positioning reference) */}
      {layers?.arc && (
        <div style={{ position: 'absolute', inset: 0, opacity: 0 }}>
          <SafeSVG content={layers.arc} style={{ width: '100%', height: '100%' }} />
        </div>
      )}

      {/* Fill - clipped along arc */}
      {layers?.fill && (
        <div style={{
          position: 'absolute',
          inset: 0,
          clipPath: fillClipPath,
          transition: 'clip-path 0.05s ease-out',
        }}>
          <SafeSVG content={layers.fill} style={{ width: '100%', height: '100%' }} />
        </div>
      )}

      {/* Thumb - positioned along arc path */}
      {layers?.thumb && (
        <div style={{
          position: 'absolute',
          left: `${(thumbPosition.x / config.diameter) * 100}%`,
          top: `${(thumbPosition.y / config.diameter) * 100}%`,
          transform: config.rotateThumbToTangent
            ? `translate(-50%, -50%) rotate(${thumbPosition.angle}deg)`
            : 'translate(-50%, -50%)',
          transition: 'left 0.05s ease-out, top 0.05s ease-out, transform 0.05s ease-out',
        }}>
          <SafeSVG
            content={layers.thumb}
            style={{
              width: `${config.thumbRadius * 2}px`,
              height: `${config.thumbRadius * 2}px`,
            }}
          />
        </div>
      )}
    </div>
  )
}
```

Note: formatValue, getLabelStyle, getValueStyle should already exist in the file - reference them directly.

4. Create main export that delegates:
```typescript
export function ArcSliderRenderer({ config }: ArcSliderRendererProps) {
  if (!config.styleId) {
    return <DefaultArcSliderRenderer config={config} />
  }
  return <StyledArcSliderRenderer config={config} />
}
```
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit`</verify>
  <done>ArcSliderRenderer renders with path-following thumb when styleId is set</done>
</task>

<task type="auto">
  <name>Task 3: Add style controls to ArcSliderProperties</name>
  <files>src/components/Properties/ArcSliderProperties.tsx</files>
  <action>
Arc Slider uses 'arc' category, NOT 'linear'. Update the dropdown accordingly.

1. Add imports:
```typescript
import { useStore } from '../../store'
import { useLicense } from '../../hooks/useLicense'
import { ColorPicker } from './shared/ColorPicker'
```

2. Inside ArcSliderProperties function, add at the beginning:
```typescript
const { isPro } = useLicense()
const getStylesByCategory = useStore((state) => state.getStylesByCategory)
// Note: Arc Slider uses 'arc' category, not 'linear'
const arcStyles = getStylesByCategory('arc')
const currentStyle = config.styleId
  ? arcStyles.find(s => s.id === config.styleId)
  : undefined
```

3. Add style section at TOP of the properties panel:
```tsx
{/* Style Section */}
<div className="space-y-3">
  <h4 className="text-xs font-medium text-gray-400 uppercase tracking-wider">Style</h4>

  {/* Style Dropdown */}
  <div>
    <label className="block text-xs text-gray-400 mb-1">SVG Style</label>
    <select
      value={config.styleId || ''}
      onChange={(e) => updateElement(config.id, {
        styleId: e.target.value || undefined,
        colorOverrides: e.target.value ? config.colorOverrides : undefined
      })}
      className="w-full bg-gray-700 text-white text-sm rounded px-2 py-1.5 border border-gray-600"
      disabled={!isPro && arcStyles.length > 0}
    >
      <option value="">Default (CSS)</option>
      {arcStyles.map(style => (
        <option key={style.id} value={style.id}>{style.name}</option>
      ))}
    </select>
    {!isPro && arcStyles.length > 0 && (
      <p className="text-xs text-amber-500 mt-1">Pro license required for SVG styles</p>
    )}
  </div>

  {/* Thumb Rotation (only when style is selected) */}
  {currentStyle && isPro && (
    <div className="flex items-center gap-2">
      <input
        type="checkbox"
        id="rotateThumbToTangent"
        checked={config.rotateThumbToTangent ?? false}
        onChange={(e) => updateElement(config.id, {
          rotateThumbToTangent: e.target.checked
        })}
        className="rounded border-gray-600 bg-gray-700 text-blue-500"
      />
      <label htmlFor="rotateThumbToTangent" className="text-sm text-gray-300">
        Rotate thumb to tangent
      </label>
    </div>
  )}

  {/* Color Overrides (only when style is selected) */}
  {currentStyle && isPro && (
    <div className="space-y-2">
      <label className="block text-xs text-gray-400">Color Overrides</label>
      {currentStyle.layers.thumb && (
        <ColorPicker
          label="Thumb"
          value={config.colorOverrides?.thumb || ''}
          onChange={(color) => updateElement(config.id, {
            colorOverrides: { ...config.colorOverrides, thumb: color || undefined }
          })}
        />
      )}
      {currentStyle.layers.track && (
        <ColorPicker
          label="Track"
          value={config.colorOverrides?.track || ''}
          onChange={(color) => updateElement(config.id, {
            colorOverrides: { ...config.colorOverrides, track: color || undefined }
          })}
        />
      )}
      {currentStyle.layers.fill && (
        <ColorPicker
          label="Fill"
          value={config.colorOverrides?.fill || ''}
          onChange={(color) => updateElement(config.id, {
            colorOverrides: { ...config.colorOverrides, fill: color || undefined }
          })}
        />
      )}
      {currentStyle.layers.arc && (
        <ColorPicker
          label="Arc Path"
          value={config.colorOverrides?.arc || ''}
          onChange={(color) => updateElement(config.id, {
            colorOverrides: { ...config.colorOverrides, arc: color || undefined }
          })}
        />
      )}
    </div>
  )}
</div>
```
  </action>
  <verify>Dev server runs without errors, style dropdown visible in Arc Slider properties panel with 'arc' category styles</verify>
  <done>Arc Slider properties panel shows arc category styles, tangent rotation toggle, and color overrides</done>
</task>

</tasks>

<verification>
1. TypeScript compiles: `npx tsc --noEmit`
2. Dev server starts: `npm run dev`
3. Add Arc Slider to canvas - should render with CSS (default)
4. If arc styles exist, dropdown shows them (NOT linear styles)
5. If styleId set:
   - Thumb follows the arc path smoothly
   - Fill clips along the value progression
   - Tangent rotation toggle affects thumb orientation
</verification>

<success_criteria>
- Arc Slider config has styleId, colorOverrides, and rotateThumbToTangent
- Arc Slider renders with path-following thumb when styleId is set
- Thumb uses getPointAtLength to follow user-drawn SVG path
- Thumb rotation to tangent is configurable
- Style dropdown shows 'arc' category styles (not 'linear')
- CSS rendering unchanged when no styleId
</success_criteria>

<output>
After completion, create `.planning/phases/55-slider-styling/55-06-SUMMARY.md`
</output>
