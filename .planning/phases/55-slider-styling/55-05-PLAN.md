---
phase: 55-slider-styling
plan: 05
type: execute
wave: 2
depends_on: ["55-01"]
files_modified:
  - src/components/elements/renderers/controls/MultiSliderRenderer.tsx
  - src/components/Properties/MultiSliderProperties.tsx
autonomous: true

must_haves:
  truths:
    - "Multi-Slider renders all bands with shared SVG style when styleId is set"
    - "Each band renders with individual fill based on its bandValue"
    - "Bands share consistent appearance from single style configuration"
    - "Multi-Slider renders with CSS when styleId is not set"
    - "Style dropdown appears in Multi-Slider properties panel"
  artifacts:
    - path: "src/components/elements/renderers/controls/MultiSliderRenderer.tsx"
      provides: "StyledMultiSliderRenderer with shared style across bands"
      contains: "StyledMultiSliderRenderer"
    - path: "src/components/Properties/MultiSliderProperties.tsx"
      provides: "Style dropdown and color overrides"
      contains: "getStylesByCategory"
  key_links:
    - from: "src/components/elements/renderers/controls/MultiSliderRenderer.tsx"
      to: "config.bandValues"
      via: "Individual band value rendering"
      pattern: "bandValues"
    - from: "src/components/elements/renderers/controls/MultiSliderRenderer.tsx"
      to: "config.styleId"
      via: "Shared style for all bands"
      pattern: "styleId"
---

<objective>
Add SVG styling support to Multi-Slider with shared style across bands.

Purpose: Multi-Slider shows multiple parallel sliders (for EQ, multi-band controls). Per CONTEXT.md decision, all bands share ONE SVG style for consistent appearance. Each band renders with its own fill level based on bandValues[index].

Output: Multi-Slider renders all bands with shared SVG layers. Each band has independent fill based on its value.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/55-slider-styling/55-CONTEXT.md
@.planning/phases/55-slider-styling/55-RESEARCH.md
@.planning/phases/55-slider-styling/55-01-SUMMARY.md

# Key source files
@src/types/elements/controls.ts
@src/components/elements/renderers/controls/MultiSliderRenderer.tsx
@src/components/elements/renderers/controls/SliderRenderer.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add StyledMultiSliderRenderer with shared style</name>
  <files>src/components/elements/renderers/controls/MultiSliderRenderer.tsx</files>
  <action>
Multi-Slider is unique because it has multiple bands, each needing independent fill positioning but all sharing the same SVG style.

1. Add imports at top:
```typescript
import { useMemo } from 'react'
import { useStore } from '../../../../store'
import { SafeSVG } from '../../../SafeSVG'
import { extractElementLayer } from '../../../../services/elementLayers'
import { applyAllColorOverrides } from '../../../../services/knobLayers'
```

2. Rename existing MultiSliderRenderer to DefaultMultiSliderRenderer (keep all existing code unchanged)

3. Create helper component for single styled band:

```typescript
interface StyledBandProps {
  svgLayers: {
    track: string | null
    fill: string | null
    thumb: string | null
  }
  value: number // 0-1 normalized
  bandWidth: number
  bandHeight: number
  thumbHeight: number
}

function StyledBand({ svgLayers, value, bandWidth, bandHeight, thumbHeight }: StyledBandProps) {
  // Multi-slider bands are always vertical
  const thumbPos = (1 - value) * (bandHeight - thumbHeight)
  const fillClipPath = `inset(${(1 - value) * 100}% 0 0 0)`

  return (
    <div style={{ position: 'relative', width: bandWidth, height: bandHeight }}>
      {/* Track */}
      {svgLayers.track && (
        <div style={{ position: 'absolute', inset: 0 }}>
          <SafeSVG content={svgLayers.track} style={{ width: '100%', height: '100%' }} />
        </div>
      )}

      {/* Fill */}
      {svgLayers.fill && (
        <div style={{
          position: 'absolute',
          inset: 0,
          clipPath: fillClipPath,
          transition: 'clip-path 0.05s ease-out',
        }}>
          <SafeSVG content={svgLayers.fill} style={{ width: '100%', height: '100%' }} />
        </div>
      )}

      {/* Thumb */}
      {svgLayers.thumb && (
        <div style={{
          position: 'absolute',
          inset: 0,
          transform: `translateY(${thumbPos}px)`,
          transition: 'transform 0.05s ease-out',
        }}>
          <SafeSVG content={svgLayers.thumb} style={{ width: '100%', height: '100%' }} />
        </div>
      )}
    </div>
  )
}
```

4. Create StyledMultiSliderRenderer function:

```typescript
function StyledMultiSliderRenderer({ config }: MultiSliderRendererProps) {
  const getElementStyle = useStore((state) => state.getElementStyle)
  const style = config.styleId ? getElementStyle(config.styleId) : undefined

  // Category validation
  if (style && style.category !== 'linear') {
    console.warn('MultiSlider requires linear category style')
    return null
  }

  // Memoize SVG content with color overrides (shared for all bands)
  const svgContent = useMemo(() => {
    if (!style) return ''
    return applyAllColorOverrides(style.svgContent, style.layers, config.colorOverrides)
  }, [style, config.colorOverrides])

  // Extract layers once (shared for all bands)
  const layers = useMemo(() => {
    if (!style || !svgContent) return null
    return {
      track: style.layers.track ? extractElementLayer(svgContent, style.layers.track) : null,
      fill: style.layers.fill ? extractElementLayer(svgContent, style.layers.fill) : null,
      thumb: style.layers.thumb ? extractElementLayer(svgContent, style.layers.thumb) : null,
    }
  }, [style, svgContent])

  // Calculate band dimensions
  const bandWidth = (config.width - (config.bandGap * (config.bandCount - 1))) / config.bandCount
  const bandHeight = config.height

  // Normalize band values
  const normalizedValues = config.bandValues.map(v =>
    (v - config.min) / (config.max - config.min)
  )

  // Generate frequency-style labels if needed
  const getLabel = (index: number) => {
    if (config.customLabels && config.customLabels[index]) {
      return config.customLabels[index]
    }
    if (config.labelStyle === 'frequency') {
      // Common EQ frequencies
      const frequencies = ['31', '62', '125', '250', '500', '1k', '2k', '4k', '8k', '16k']
      return frequencies[index % frequencies.length]
    }
    if (config.labelStyle === 'index') {
      return String(index + 1)
    }
    return ''
  }

  if (!style) {
    return (
      <div style={{
        width: '100%', height: '100%',
        display: 'flex', alignItems: 'center', justifyContent: 'center',
        background: '#374151', borderRadius: '4px',
        color: '#9CA3AF', fontSize: '12px', textAlign: 'center', padding: '8px',
      }}>
        Style not found
      </div>
    )
  }

  return (
    <div style={{
      position: 'relative',
      width: '100%',
      height: '100%',
      display: 'flex',
      flexDirection: 'row',
      gap: `${config.bandGap}px`,
    }}>
      {normalizedValues.map((value, index) => (
        <div key={index} style={{ display: 'flex', flexDirection: 'column', alignItems: 'center' }}>
          {/* Band with shared style */}
          <StyledBand
            svgLayers={layers!}
            value={value}
            bandWidth={bandWidth}
            bandHeight={bandHeight - (config.labelStyle !== 'hidden' ? 16 : 0)}
            thumbHeight={10} // Default thumb height for multi-slider
          />

          {/* Label */}
          {config.labelStyle !== 'hidden' && (
            <span style={{
              marginTop: '4px',
              fontSize: `${config.labelFontSize}px`,
              fontFamily: config.labelFontFamily,
              fontWeight: config.labelFontWeight,
              color: config.labelColor,
              userSelect: 'none',
            }}>
              {getLabel(index)}
            </span>
          )}
        </div>
      ))}
    </div>
  )
}
```

5. Create main export that delegates:
```typescript
export function MultiSliderRenderer({ config }: MultiSliderRendererProps) {
  if (!config.styleId) {
    return <DefaultMultiSliderRenderer config={config} />
  }
  return <StyledMultiSliderRenderer config={config} />
}
```
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit`</verify>
  <done>MultiSliderRenderer renders all bands with shared SVG style when styleId is set</done>
</task>

<task type="auto">
  <name>Task 2: Add style controls to MultiSliderProperties</name>
  <files>src/components/Properties/MultiSliderProperties.tsx</files>
  <action>
Follow exact pattern from SliderProperties (Plan 01 Task 3):

1. Add imports (if not already present):
```typescript
import { useStore } from '../../store'
import { useLicense } from '../../hooks/useLicense'
import { ColorPicker } from './shared/ColorPicker'
```

2. Inside MultiSliderProperties function, add at the beginning:
```typescript
const { isPro } = useLicense()
const getStylesByCategory = useStore((state) => state.getStylesByCategory)
const linearStyles = getStylesByCategory('linear')
const currentStyle = config.styleId
  ? linearStyles.find(s => s.id === config.styleId)
  : undefined
```

3. Add style section at TOP of the properties panel (before Band Count or first existing section):
```tsx
{/* Style Section */}
<div className="space-y-3">
  <h4 className="text-xs font-medium text-gray-400 uppercase tracking-wider">Style</h4>

  {/* Style Dropdown */}
  <div>
    <label className="block text-xs text-gray-400 mb-1">SVG Style</label>
    <select
      value={config.styleId || ''}
      onChange={(e) => updateElement(config.id, {
        styleId: e.target.value || undefined,
        colorOverrides: e.target.value ? config.colorOverrides : undefined
      })}
      className="w-full bg-gray-700 text-white text-sm rounded px-2 py-1.5 border border-gray-600"
      disabled={!isPro && linearStyles.length > 0}
    >
      <option value="">Default (CSS)</option>
      {linearStyles.map(style => (
        <option key={style.id} value={style.id}>{style.name}</option>
      ))}
    </select>
    {!isPro && linearStyles.length > 0 && (
      <p className="text-xs text-amber-500 mt-1">Pro license required for SVG styles</p>
    )}
  </div>

  {/* Color Overrides (only when style is selected) */}
  {currentStyle && isPro && (
    <div className="space-y-2">
      <label className="block text-xs text-gray-400">Color Overrides (shared by all bands)</label>
      {currentStyle.layers.thumb && (
        <ColorPicker
          label="Thumb"
          value={config.colorOverrides?.thumb || ''}
          onChange={(color) => updateElement(config.id, {
            colorOverrides: { ...config.colorOverrides, thumb: color || undefined }
          })}
        />
      )}
      {currentStyle.layers.track && (
        <ColorPicker
          label="Track"
          value={config.colorOverrides?.track || ''}
          onChange={(color) => updateElement(config.id, {
            colorOverrides: { ...config.colorOverrides, track: color || undefined }
          })}
        />
      )}
      {currentStyle.layers.fill && (
        <ColorPicker
          label="Fill"
          value={config.colorOverrides?.fill || ''}
          onChange={(color) => updateElement(config.id, {
            colorOverrides: { ...config.colorOverrides, fill: color || undefined }
          })}
        />
      )}
    </div>
  )}
</div>
```
  </action>
  <verify>Dev server runs without errors, style dropdown visible in Multi-Slider properties panel</verify>
  <done>Multi-Slider properties panel shows style dropdown and color overrides</done>
</task>

</tasks>

<verification>
1. TypeScript compiles: `npx tsc --noEmit`
2. Dev server starts: `npm run dev`
3. Add Multi-Slider to canvas - should render with CSS (default)
4. If linear styles exist, dropdown shows them
5. If styleId set:
   - All bands share same SVG appearance
   - Each band has independent fill based on its bandValue
   - Labels display correctly below bands
</verification>

<success_criteria>
- Multi-Slider renders all bands with shared SVG style when styleId is set
- Each band has independent fill based on its bandValue
- Color overrides apply consistently across all bands
- CSS rendering unchanged when no styleId
- Style dropdown and color overrides work in properties panel
</success_criteria>

<output>
After completion, create `.planning/phases/55-slider-styling/55-05-SUMMARY.md`
</output>
