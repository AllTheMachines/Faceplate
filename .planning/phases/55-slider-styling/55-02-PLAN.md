---
phase: 55-slider-styling
plan: 02
type: execute
wave: 2
depends_on: ["55-01"]
files_modified:
  - src/components/elements/renderers/controls/RangeSliderRenderer.tsx
  - src/components/Properties/RangeSliderProperties.tsx
autonomous: true

must_haves:
  truths:
    - "Range Slider renders with two SVG thumbs (thumb-low and thumb-high) when styleId is set"
    - "Range Slider fill clips between low and high thumb positions"
    - "Active thumb renders on top when dragged near the other thumb"
    - "Range Slider renders with CSS when styleId is not set"
    - "Style dropdown appears in Range Slider properties panel"
  artifacts:
    - path: "src/components/elements/renderers/controls/RangeSliderRenderer.tsx"
      provides: "StyledRangeSliderRenderer with dual thumbs"
      contains: "StyledRangeSliderRenderer"
    - path: "src/components/Properties/RangeSliderProperties.tsx"
      provides: "Style dropdown and color overrides"
      contains: "getStylesByCategory"
  key_links:
    - from: "src/components/elements/renderers/controls/RangeSliderRenderer.tsx"
      to: "useStore getElementStyle"
      via: "Zustand store selector"
      pattern: "getElementStyle"
    - from: "src/components/elements/renderers/controls/RangeSliderRenderer.tsx"
      to: "extractElementLayer"
      via: "Layer extraction for thumb-low, thumb-high, track, fill"
      pattern: "extractElementLayer.*thumb"
---

<objective>
Add SVG styling support to Range Slider with dual thumb rendering.

Purpose: Range Slider is unique because it has TWO thumbs (thumb-low and thumb-high) that can be visually differentiated in the SVG. The fill clips between the two thumb positions. Per CONTEXT.md decision, users provide both thumb layers in their SVG.

Output: Range Slider renders with user-provided SVG layers including two distinct thumbs. Fill shows range between thumbs.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/55-slider-styling/55-CONTEXT.md
@.planning/phases/55-slider-styling/55-RESEARCH.md
@.planning/phases/55-slider-styling/55-01-SUMMARY.md

# Key source files
@src/types/elements/controls.ts
@src/types/elementStyle.ts
@src/components/elements/renderers/controls/RangeSliderRenderer.tsx
@src/components/elements/renderers/controls/SliderRenderer.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add StyledRangeSliderRenderer with dual thumbs</name>
  <files>src/components/elements/renderers/controls/RangeSliderRenderer.tsx</files>
  <action>
Follow the pattern from Plan 01's StyledSliderRenderer with these differences for dual thumbs:

1. Add imports at top:
```typescript
import { useMemo } from 'react'
import { useStore } from '../../../../store'
import { SafeSVG } from '../../../SafeSVG'
import { extractElementLayer } from '../../../../services/elementLayers'
import { applyAllColorOverrides } from '../../../../services/knobLayers'
```

2. Rename existing RangeSliderRenderer to DefaultRangeSliderRenderer (keep all code unchanged)

3. Create StyledRangeSliderRenderer function:

```typescript
function StyledRangeSliderRenderer({ config }: RangeSliderRendererProps) {
  const getElementStyle = useStore((state) => state.getElementStyle)
  const style = config.styleId ? getElementStyle(config.styleId) : undefined

  // Category validation
  if (style && style.category !== 'linear') {
    console.warn('RangeSlider requires linear category style')
    return null
  }

  // Calculate normalized values
  const range = config.max - config.min
  const normalizedMin = (config.minValue - config.min) / range
  const normalizedMax = (config.maxValue - config.min) / range

  // Memoize SVG content with color overrides
  const svgContent = useMemo(() => {
    if (!style) return ''
    return applyAllColorOverrides(style.svgContent, style.layers, config.colorOverrides)
  }, [style, config.colorOverrides])

  // Extract layers - Range Slider uses thumb-low and thumb-high
  // Fall back to generic 'thumb' layer if specific ones not found
  const layers = useMemo(() => {
    if (!style || !svgContent) return null
    const linearLayers = style.layers
    return {
      track: linearLayers.track ? extractElementLayer(svgContent, linearLayers.track) : null,
      fill: linearLayers.fill ? extractElementLayer(svgContent, linearLayers.fill) : null,
      // Try thumb-low/thumb-high first, fall back to thumb for both
      thumbLow: linearLayers['thumb-low']
        ? extractElementLayer(svgContent, linearLayers['thumb-low'])
        : (linearLayers.thumb ? extractElementLayer(svgContent, linearLayers.thumb) : null),
      thumbHigh: linearLayers['thumb-high']
        ? extractElementLayer(svgContent, linearLayers['thumb-high'])
        : (linearLayers.thumb ? extractElementLayer(svgContent, linearLayers.thumb) : null),
    }
  }, [style, svgContent])

  // Thumb positions
  const isVertical = config.orientation === 'vertical'
  const thumbLowPos = isVertical
    ? (1 - normalizedMin) * (config.height - config.thumbHeight)
    : normalizedMin * (config.width - config.thumbWidth)
  const thumbHighPos = isVertical
    ? (1 - normalizedMax) * (config.height - config.thumbHeight)
    : normalizedMax * (config.width - config.thumbWidth)

  // Range fill clip-path (between low and high)
  const rangeFillClipPath = useMemo(() => {
    const start = Math.min(normalizedMin, normalizedMax)
    const end = Math.max(normalizedMin, normalizedMax)

    if (isVertical) {
      // Vertical: clip from bottom (start%) to top (1-end%)
      return `inset(${(1 - end) * 100}% 0 ${start * 100}% 0)`
    } else {
      // Horizontal: clip from left (start%) to right (1-end%)
      return `inset(0 ${(1 - end) * 100}% 0 ${start * 100}%)`
    }
  }, [isVertical, normalizedMin, normalizedMax])

  if (!style) {
    return (
      <div style={{
        width: '100%', height: '100%',
        display: 'flex', alignItems: 'center', justifyContent: 'center',
        background: '#374151', borderRadius: '4px',
        color: '#9CA3AF', fontSize: '12px', textAlign: 'center', padding: '8px',
      }}>
        Style not found
      </div>
    )
  }

  return (
    <div style={{ position: 'relative', width: '100%', height: '100%' }}>
      {/* Track - static background */}
      {layers?.track && (
        <div style={{ position: 'absolute', inset: 0 }}>
          <SafeSVG content={layers.track} style={{ width: '100%', height: '100%' }} />
        </div>
      )}

      {/* Fill - clipped between low and high */}
      {layers?.fill && (
        <div style={{
          position: 'absolute',
          inset: 0,
          clipPath: rangeFillClipPath,
          transition: 'clip-path 0.05s ease-out',
        }}>
          <SafeSVG content={layers.fill} style={{ width: '100%', height: '100%' }} />
        </div>
      )}

      {/* Low thumb */}
      {layers?.thumbLow && (
        <div style={{
          position: 'absolute',
          inset: 0,
          transform: isVertical
            ? `translateY(${thumbLowPos}px)`
            : `translateX(${thumbLowPos}px)`,
          transition: 'transform 0.05s ease-out',
          zIndex: 1, // Lower thumb default z-index
        }}>
          <SafeSVG content={layers.thumbLow} style={{ width: '100%', height: '100%' }} />
        </div>
      )}

      {/* High thumb */}
      {layers?.thumbHigh && (
        <div style={{
          position: 'absolute',
          inset: 0,
          transform: isVertical
            ? `translateY(${thumbHighPos}px)`
            : `translateX(${thumbHighPos}px)`,
          transition: 'transform 0.05s ease-out',
          zIndex: 2, // Higher thumb on top by default
        }}>
          <SafeSVG content={layers.thumbHigh} style={{ width: '100%', height: '100%' }} />
        </div>
      )}
    </div>
  )
}
```

4. Create main export that delegates:
```typescript
export function RangeSliderRenderer({ config }: RangeSliderRendererProps) {
  if (!config.styleId) {
    return <DefaultRangeSliderRenderer config={config} />
  }
  return <StyledRangeSliderRenderer config={config} />
}
```

Note: The LinearLayers interface has thumb/track/fill. For Range Slider, we extend the convention to support 'thumb-low' and 'thumb-high' as additional layer keys. The layer extraction handles this by trying the specific names first, falling back to generic 'thumb'.
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit`</verify>
  <done>RangeSliderRenderer renders with dual SVG thumbs when styleId is set</done>
</task>

<task type="auto">
  <name>Task 2: Add style controls to RangeSliderProperties</name>
  <files>src/components/Properties/RangeSliderProperties.tsx</files>
  <action>
Follow exact pattern from SliderProperties (Plan 01 Task 3):

1. Add imports:
```typescript
import { useStore } from '../../store'
import { useLicense } from '../../hooks/useLicense'
import { ColorPicker } from './shared/ColorPicker'
```

2. Inside RangeSliderProperties function, add at the beginning:
```typescript
const { isPro } = useLicense()
const getStylesByCategory = useStore((state) => state.getStylesByCategory)
const linearStyles = getStylesByCategory('linear')
const currentStyle = config.styleId
  ? linearStyles.find(s => s.id === config.styleId)
  : undefined
```

3. Add style section at TOP of the properties panel (before Orientation or first existing section):
```tsx
{/* Style Section */}
<div className="space-y-3">
  <h4 className="text-xs font-medium text-gray-400 uppercase tracking-wider">Style</h4>

  {/* Style Dropdown */}
  <div>
    <label className="block text-xs text-gray-400 mb-1">SVG Style</label>
    <select
      value={config.styleId || ''}
      onChange={(e) => updateElement(config.id, {
        styleId: e.target.value || undefined,
        colorOverrides: e.target.value ? config.colorOverrides : undefined
      })}
      className="w-full bg-gray-700 text-white text-sm rounded px-2 py-1.5 border border-gray-600"
      disabled={!isPro && linearStyles.length > 0}
    >
      <option value="">Default (CSS)</option>
      {linearStyles.map(style => (
        <option key={style.id} value={style.id}>{style.name}</option>
      ))}
    </select>
    {!isPro && linearStyles.length > 0 && (
      <p className="text-xs text-amber-500 mt-1">Pro license required for SVG styles</p>
    )}
  </div>

  {/* Color Overrides (only when style is selected) */}
  {currentStyle && isPro && (
    <div className="space-y-2">
      <label className="block text-xs text-gray-400">Color Overrides</label>
      {(currentStyle.layers['thumb-low'] || currentStyle.layers.thumb) && (
        <ColorPicker
          label="Thumb Low"
          value={config.colorOverrides?.['thumb-low'] || config.colorOverrides?.thumb || ''}
          onChange={(color) => updateElement(config.id, {
            colorOverrides: { ...config.colorOverrides, 'thumb-low': color || undefined }
          })}
        />
      )}
      {(currentStyle.layers['thumb-high'] || currentStyle.layers.thumb) && (
        <ColorPicker
          label="Thumb High"
          value={config.colorOverrides?.['thumb-high'] || ''}
          onChange={(color) => updateElement(config.id, {
            colorOverrides: { ...config.colorOverrides, 'thumb-high': color || undefined }
          })}
        />
      )}
      {currentStyle.layers.track && (
        <ColorPicker
          label="Track"
          value={config.colorOverrides?.track || ''}
          onChange={(color) => updateElement(config.id, {
            colorOverrides: { ...config.colorOverrides, track: color || undefined }
          })}
        />
      )}
      {currentStyle.layers.fill && (
        <ColorPicker
          label="Fill"
          value={config.colorOverrides?.fill || ''}
          onChange={(color) => updateElement(config.id, {
            colorOverrides: { ...config.colorOverrides, fill: color || undefined }
          })}
        />
      )}
    </div>
  )}
</div>
```
  </action>
  <verify>Dev server runs without errors, style dropdown visible in Range Slider properties panel</verify>
  <done>Range Slider properties panel shows style dropdown and dual thumb color overrides</done>
</task>

</tasks>

<verification>
1. TypeScript compiles: `npx tsc --noEmit`
2. Dev server starts: `npm run dev`
3. Add a Range Slider to canvas - should render with CSS (default)
4. If linear styles exist, dropdown shows them
5. If styleId set, slider renders with SVG layers (two thumbs if style has thumb-low/thumb-high)
6. Fill appears between the two thumb positions
</verification>

<success_criteria>
- Range Slider renders with two distinct SVG thumbs when styleId is set
- Fill layer clips correctly between low and high thumb positions
- CSS rendering unchanged when no styleId
- Style dropdown and color overrides work in properties panel
</success_criteria>

<output>
After completion, create `.planning/phases/55-slider-styling/55-02-SUMMARY.md`
</output>
