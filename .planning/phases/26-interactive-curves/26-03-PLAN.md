---
phase: 26-interactive-curves
plan: 03
type: execute
wave: 2
depends_on: ["26-01"]
files_modified:
  - src/components/elements/renderers/displays/curves/CompressorCurveRenderer.tsx
  - src/components/elements/renderers/displays/curves/EnvelopeDisplayRenderer.tsx
  - src/components/elements/renderers/displays/curves/index.ts
  - src/components/elements/renderers/displays/index.ts
  - src/components/elements/renderers/index.ts
autonomous: true

must_haves:
  truths:
    - "Compressor Curve displays input/output transfer function"
    - "Compressor Curve shows threshold, ratio, and knee correctly"
    - "Compressor Curve shows 1:1 reference diagonal line"
    - "Envelope Display shows ADSR curve with proper exponential shapes"
    - "Envelope Display handles shown at A/D/S/R control points"
  artifacts:
    - path: "src/components/elements/renderers/displays/curves/CompressorCurveRenderer.tsx"
      provides: "Canvas renderer for compressor transfer function"
      min_lines: 80
    - path: "src/components/elements/renderers/displays/curves/EnvelopeDisplayRenderer.tsx"
      provides: "Canvas renderer for ADSR envelope visualization"
      min_lines: 100
  key_links:
    - from: "src/components/elements/renderers/index.ts"
      to: "CompressorCurveRenderer"
      via: "rendererRegistry entry"
      pattern: "compressorcurve.*CompressorCurveRenderer"
    - from: "src/components/elements/renderers/index.ts"
      to: "EnvelopeDisplayRenderer"
      via: "rendererRegistry entry"
      pattern: "envelopedisplay.*EnvelopeDisplayRenderer"
---

<objective>
Create Canvas renderers for Compressor Curve and Envelope Display elements

Purpose: Enable dynamics visualization (compressor transfer function) and modulation visualization (ADSR envelope)
Output: CompressorCurveRenderer.tsx, EnvelopeDisplayRenderer.tsx, registered in rendererRegistry
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/26-interactive-curves/26-CONTEXT.md
@.planning/phases/26-interactive-curves/26-RESEARCH.md
@src/components/elements/renderers/displays/visualizations/SpectrumAnalyzerRenderer.tsx
@src/hooks/useCanvasSetup.ts
@src/utils/audioMath.ts
@src/utils/curveRendering.ts
@src/types/elements/curves.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Compressor Curve renderer</name>
  <files>src/components/elements/renderers/displays/curves/CompressorCurveRenderer.tsx</files>
  <action>
Create src/components/elements/renderers/displays/curves/CompressorCurveRenderer.tsx:

Import:
- useCanvasSetup hook
- CompressorCurveElementConfig from types/elements/curves
- calculateCompressorOutput from audioMath
- drawSmoothCurve, drawHandle, isPointInHandle, drawLinearGrid, generateMockCompressor from curveRendering

Static mock data: Use generateMockCompressor() or config values

Track hoveredHandle state for threshold handle hover

useLayoutEffect drawing logic:
1. Clear canvas with backgroundColor
2. If showGrid, draw linear grid with drawLinearGrid()

3. Draw 1:1 reference line (diagonal from bottom-left to top-right):
   - ctx.strokeStyle = 'rgba(255, 255, 255, 0.2)'
   - ctx.lineWidth = 1
   - ctx.beginPath()
   - ctx.moveTo(0, height)
   - ctx.lineTo(width, 0)
   - ctx.stroke()

4. Calculate compressor transfer curve:
   - Loop inputDb from minDb to maxDb in 0.5dB steps
   - For each inputDb, calculate outputDb = calculateCompressorOutput(inputDb, threshold, ratio, knee)
   - Convert to canvas coordinates:
     - x = ((inputDb - minDb) / (maxDb - minDb)) * width
     - y = height - ((outputDb - minDb) / (maxDb - minDb)) * height
   - Collect points array

5. Draw transfer curve with drawSmoothCurve()
6. If showFill, include fill parameters

7. Draw handle at threshold position:
   - thresholdX = ((threshold - minDb) / (maxDb - minDb)) * width
   - thresholdY = height - ((threshold - minDb) / (maxDb - minDb)) * height (on 1:1 line)
   - Draw with drawHandle()

8. If displayMode === 'gainreduction':
   - Draw vertical bar showing gain reduction amount at example input level
   - (Alternative visualization mode per CONTEXT.md)

9. Draw dB labels if showDbLabels:
   - Input axis (bottom): minDb to maxDb
   - Output axis (left): minDb to maxDb

Mouse events: Same pattern as EQ Curve for handle hover
  </action>
  <verify>File exists and TypeScript compiles with npx tsc --noEmit</verify>
  <done>Compressor Curve renderer displays transfer function with threshold handle and 1:1 reference line</done>
</task>

<task type="auto">
  <name>Task 2: Create Envelope Display renderer and register both</name>
  <files>src/components/elements/renderers/displays/curves/EnvelopeDisplayRenderer.tsx, src/components/elements/renderers/displays/curves/index.ts, src/components/elements/renderers/index.ts</files>
  <action>
Create src/components/elements/renderers/displays/curves/EnvelopeDisplayRenderer.tsx:

Import:
- useCanvasSetup hook
- EnvelopeDisplayElementConfig from types/elements/curves
- drawSmoothCurve, drawHandle, isPointInHandle, drawLinearGrid, generateMockADSR from curveRendering

Static mock data: Use generateMockADSR() or config values

Track hoveredHandle state (4 handles for A/D/S/R points)

useLayoutEffect drawing logic:
1. Clear canvas with backgroundColor
2. If showGrid, draw linear grid with drawLinearGrid()

3. Calculate time proportions:
   - totalTime = attack + decay + 0.3 + release (0.3 = sustain hold)
   - attackTime = (attack / totalTime) * width
   - decayTime = (decay / totalTime) * width
   - sustainTime = (0.3 / totalTime) * width
   - releaseTime = (release / totalTime) * width

4. Build envelope points array:
   - Attack phase (0 to peak):
     - If curveType === 'exponential': level = Math.pow(t, 0.3) (logarithmic curve)
     - If curveType === 'linear': level = t
     - Sample 20 points from 0 to attackTime

   - Decay phase (peak to sustain):
     - If curveType === 'exponential': level = 1 - (1 - sustain) * (1 - Math.exp(-5 * t))
     - If curveType === 'linear': level = 1 - (1 - sustain) * t
     - Sample 20 points

   - Sustain phase (flat line at sustain level):
     - Two points for horizontal line

   - Release phase (sustain to zero):
     - If curveType === 'exponential': level = sustain * Math.exp(-5 * t)
     - If curveType === 'linear': level = sustain * (1 - t)
     - Sample 20 points

5. If showStageColors, draw each stage segment with its color:
   - Attack: attackColor
   - Decay: decayColor
   - Sustain: sustainColor
   - Release: releaseColor
   Else draw entire curve with curveColor

6. If showFill, fill under curve

7. Draw handles at control points:
   - Handle 1: End of attack (x = attackTime, y = 0 = peak)
   - Handle 2: End of decay (x = attackTime + decayTime, y = sustain level)
   - Handle 3: End of sustain (x = attackTime + decayTime + sustainTime, y = sustain level)
   - Handle 4: End of release (x = width, y = height = zero)
   - Or simpler: just show handles at A/D/S points

8. If showStageMarkers, draw vertical dashed lines at stage boundaries

Update src/components/elements/renderers/displays/curves/index.ts:
- Add exports for CompressorCurveRenderer and EnvelopeDisplayRenderer

Update src/components/elements/renderers/index.ts:
- Import CompressorCurveRenderer, EnvelopeDisplayRenderer from './displays'
- Add to rendererRegistry:
  - ['compressorcurve', CompressorCurveRenderer as RendererComponent]
  - ['envelopedisplay', EnvelopeDisplayRenderer as RendererComponent]
- Add to re-exports
  </action>
  <verify>npx tsc --noEmit passes, rendererRegistry includes both new types</verify>
  <done>Envelope Display renderer shows ADSR curve with exponential/linear curve types, both renderers registered</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` - TypeScript compiles without errors
2. CompressorCurveRenderer.tsx exists in curves/
3. EnvelopeDisplayRenderer.tsx exists in curves/
4. curves/index.ts exports all 4 curve renderers (EQ, Filter, Compressor, Envelope)
5. rendererRegistry includes 'compressorcurve' and 'envelopedisplay' entries
</verification>

<success_criteria>
- Compressor Curve displays input/output transfer function with soft knee
- Compressor Curve shows 1:1 reference diagonal line
- Compressor Curve handle at threshold position highlights on hover
- Envelope Display shows ADSR with configurable exponential or linear curves
- Envelope Display handles at control points (A/D/S transitions)
- Both use HiDPI Canvas scaling with useCanvasSetup hook
- Both follow Phase 25 static preview pattern
</success_criteria>

<output>
After completion, create `.planning/phases/26-interactive-curves/26-03-SUMMARY.md`
</output>
