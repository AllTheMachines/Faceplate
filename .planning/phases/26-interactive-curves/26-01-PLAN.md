---
phase: 26-interactive-curves
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/types/elements/curves.ts
  - src/types/elements/index.ts
  - src/utils/audioMath.ts
  - src/utils/curveRendering.ts
autonomous: true

must_haves:
  truths:
    - "TypeScript compiles without errors for curve element types"
    - "Biquad filter frequency response can be calculated for any frequency"
    - "Logarithmic frequency-to-X and X-to-frequency conversions are accurate"
    - "Bezier curve drawing produces smooth curves through control points"
    - "Square handle drawing and hit detection work correctly"
  artifacts:
    - path: "src/types/elements/curves.ts"
      provides: "5 curve element type interfaces with factory functions"
      contains: "EQCurveElementConfig"
    - path: "src/utils/audioMath.ts"
      provides: "Biquad filter response, frequency conversion utilities"
      exports: ["frequencyToX", "xToFrequency", "calculateBiquadResponse", "dbToY", "yToDb"]
    - path: "src/utils/curveRendering.ts"
      provides: "Bezier curve and handle rendering utilities"
      exports: ["drawSmoothCurve", "drawHandle", "isPointInHandle"]
  key_links:
    - from: "src/types/elements/index.ts"
      to: "src/types/elements/curves.ts"
      via: "re-export CurveElement union"
      pattern: "export.*CurveElement"
---

<objective>
Create foundational TypeScript types for 5 interactive curve elements and audio math utilities

Purpose: Enable Canvas-based curve editor renderers with proper frequency/dB mapping, biquad filter calculations, and handle interaction
Output: Types file (curves.ts), audio math utilities (audioMath.ts), curve rendering utilities (curveRendering.ts)
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/26-interactive-curves/26-CONTEXT.md
@.planning/phases/26-interactive-curves/26-RESEARCH.md
@src/types/elements/visualizations.ts
@src/hooks/useCanvasSetup.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create curve element types</name>
  <files>src/types/elements/curves.ts, src/types/elements/index.ts</files>
  <action>
Create src/types/elements/curves.ts following the pattern from visualizations.ts:

**EQCurveElementConfig:**
- type: 'eqcurve'
- bands: EQBand[] (frequency: number, gain: number, Q: number)
- bandCount: 1-16
- minDb: number (e.g., -24)
- maxDb: number (e.g., +24)
- minFreq: number (e.g., 20)
- maxFreq: number (e.g., 20000)
- showGrid: boolean, gridColor: string
- showFrequencyLabels: boolean, showDbLabels: boolean
- curveColor: string, lineWidth: 1-4
- showFill: boolean, fillColor: string, fillOpacity: number
- showIndividualBands: boolean (composite only vs individual + composite)
- handleColor: string, handleHoverColor: string
- backgroundColor: string
- canvasScale: number

**CompressorCurveElementConfig:**
- type: 'compressorcurve'
- threshold: number (dB)
- ratio: number
- knee: number (dB)
- minDb: number (e.g., -60)
- maxDb: number (e.g., 0)
- displayMode: 'transfer' | 'gainreduction'
- showGrid: boolean, gridColor: string
- showDbLabels: boolean
- curveColor: string, lineWidth: 1-4
- showFill: boolean, fillColor: string
- handleColor: string, handleHoverColor: string
- backgroundColor: string
- canvasScale: number

**EnvelopeDisplayElementConfig:**
- type: 'envelopedisplay'
- attack: number (0-1 time proportion)
- decay: number (0-1)
- sustain: number (0-1 level)
- release: number (0-1)
- curveType: 'linear' | 'exponential'
- showStageColors: boolean
- attackColor: string, decayColor: string, sustainColor: string, releaseColor: string
- curveColor: string, lineWidth: 1-4
- showFill: boolean, fillColor: string
- showGrid: boolean, gridColor: string
- showStageMarkers: boolean
- handleColor: string, handleHoverColor: string
- backgroundColor: string
- canvasScale: number

**LFODisplayElementConfig:**
- type: 'lfodisplay'
- shape: 'sine' | 'triangle' | 'saw-up' | 'saw-down' | 'square' | 'pulse' | 'sample-hold' | 'smooth-random'
- pulseWidth: number (0-1, for pulse shape)
- showGrid: boolean, gridColor: string
- waveformColor: string, lineWidth: 1-4
- showFill: boolean, fillColor: string
- backgroundColor: string
- canvasScale: number

**FilterResponseElementConfig:**
- type: 'filterresponse'
- filterType: 'lowpass' | 'highpass' | 'bandpass' | 'notch' | 'lowshelf' | 'highshelf' | 'peak'
- cutoffFrequency: number
- resonance: number (Q)
- gain: number (dB, for shelf/peak)
- minDb: number, maxDb: number
- minFreq: number, maxFreq: number
- showGrid: boolean, gridColor: string
- showFrequencyLabels: boolean, showDbLabels: boolean
- curveColor: string, lineWidth: 1-4
- showFill: boolean, fillColor: string
- handleColor: string, handleHoverColor: string
- backgroundColor: string
- canvasScale: number

Include:
- Type guards (isEQCurve, isCompressorCurve, isEnvelopeDisplay, isLFODisplay, isFilterResponse)
- Factory functions with sensible defaults (createEQCurve, createCompressorCurve, etc.)
- CurveElement union type
- EQBand interface

Update src/types/elements/index.ts to:
- Import and re-export all curve types
- Add CurveElement to ElementConfig union
  </action>
  <verify>npx tsc --noEmit passes</verify>
  <done>5 curve element type interfaces exist with factory functions, type guards, and CurveElement union exported from index.ts</done>
</task>

<task type="auto">
  <name>Task 2: Create audio math and curve rendering utilities</name>
  <files>src/utils/audioMath.ts, src/utils/curveRendering.ts</files>
  <action>
Create src/utils/audioMath.ts with frequency/dB conversion and biquad filter math:

```typescript
// Logarithmic frequency scale (industry standard for audio)
export function frequencyToX(
  frequency: number,
  width: number,
  minFreq: number = 20,
  maxFreq: number = 20000
): number

export function xToFrequency(
  x: number,
  width: number,
  minFreq: number = 20,
  maxFreq: number = 20000
): number

// dB to Y coordinate mapping
export function dbToY(
  db: number,
  height: number,
  minDb: number,
  maxDb: number
): number

export function yToDb(
  y: number,
  height: number,
  minDb: number,
  maxDb: number
): number

// Biquad filter frequency response (Audio EQ Cookbook formulas)
export function calculateBiquadResponse(
  frequency: number,
  centerFreq: number,
  gain: number,
  Q: number,
  sampleRate?: number
): number // Returns dB

// Filter type-specific biquad calculations
export function calculateFilterResponse(
  frequency: number,
  filterType: 'lowpass' | 'highpass' | 'bandpass' | 'notch' | 'lowshelf' | 'highshelf' | 'peak',
  cutoffFreq: number,
  Q: number,
  gain: number,
  sampleRate?: number
): number // Returns dB

// Compressor transfer function
export function calculateCompressorOutput(
  inputDb: number,
  threshold: number,
  ratio: number,
  knee: number
): number // Returns outputDb
```

Create src/utils/curveRendering.ts with Canvas drawing utilities:

```typescript
// Draw smooth Bezier curve through points
export function drawSmoothCurve(
  ctx: CanvasRenderingContext2D,
  points: { x: number; y: number }[],
  strokeStyle: string,
  lineWidth: number,
  fill?: boolean,
  fillStyle?: string,
  height?: number // For fill to bottom
): void

// Draw square handle (8px base, 10px hover per CONTEXT.md)
export function drawHandle(
  ctx: CanvasRenderingContext2D,
  x: number,
  y: number,
  isHovered: boolean,
  normalColor: string,
  hoverColor: string
): void

// Point-in-handle hit detection
export function isPointInHandle(
  mouseX: number,
  mouseY: number,
  handleX: number,
  handleY: number,
  isHovered?: boolean // Affects size (8 vs 10px)
): boolean

// Draw frequency grid with logarithmic scale
export function drawFrequencyGrid(
  ctx: CanvasRenderingContext2D,
  width: number,
  height: number,
  gridColor: string,
  showFrequencyLabels: boolean,
  showDbLabels: boolean,
  minFreq: number,
  maxFreq: number,
  minDb: number,
  maxDb: number
): void

// Draw linear grid (for envelope/compressor)
export function drawLinearGrid(
  ctx: CanvasRenderingContext2D,
  width: number,
  height: number,
  gridColor: string,
  divisions: number
): void

// Generate mock EQ bands for static preview
export function generateMockEQBands(bandCount: number): { frequency: number; gain: number; Q: number }[]

// Generate mock ADSR values
export function generateMockADSR(): { attack: number; decay: number; sustain: number; release: number }

// Generate mock compressor settings
export function generateMockCompressor(): { threshold: number; ratio: number; knee: number }
```

Follow RESEARCH.md formulas exactly for biquad calculations. Use log10 for frequency scale. Handle colors: #00ff88 normal, #00ffff hover.
  </action>
  <verify>npx tsc --noEmit passes</verify>
  <done>Audio math utilities calculate biquad response correctly, frequency/dB conversions work, curve rendering utilities draw smooth curves and handles</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` - TypeScript compiles without errors
2. All 5 curve element types exported from src/types/elements/index.ts
3. audioMath.ts exports frequencyToX, xToFrequency, dbToY, yToDb, calculateBiquadResponse, calculateFilterResponse, calculateCompressorOutput
4. curveRendering.ts exports drawSmoothCurve, drawHandle, isPointInHandle, drawFrequencyGrid, drawLinearGrid
</verification>

<success_criteria>
- TypeScript types for all 5 curve elements defined with proper interfaces
- Factory functions create elements with sensible defaults
- Audio math utilities implement Audio EQ Cookbook formulas
- Curve rendering utilities draw smooth Bezier curves and square handles
- All utilities are pure functions with no side effects
</success_criteria>

<output>
After completion, create `.planning/phases/26-interactive-curves/26-01-SUMMARY.md`
</output>
