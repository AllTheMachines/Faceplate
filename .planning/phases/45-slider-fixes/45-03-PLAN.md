---
phase: 45-slider-fixes
plan: 03
type: execute
wave: 3
depends_on: ["45-02"]
files_modified:
  - src/components/elements/renderers/controls/AsciiSliderRenderer.tsx
  - src/components/Properties/AsciiSliderProperties.tsx
  - src/types/elements/controls.ts
autonomous: true

must_haves:
  truths:
    - "ASCII Slider responds to vertical drag with smooth value changes"
    - "Shift+drag provides 10x finer control (slower sensitivity)"
    - "Dragging ASCII Slider updates value in real-time"
    - "ASCII Slider drag does not conflict with canvas element positioning"
  artifacts:
    - path: "src/components/elements/renderers/controls/AsciiSliderRenderer.tsx"
      provides: "Drag interaction with Shift key fine control"
      contains: "onPointerDown"
    - path: "src/types/elements/controls.ts"
      provides: "dragSensitivity property for AsciiSliderElementConfig"
      contains: "dragSensitivity"
  key_links:
    - from: "AsciiSliderRenderer.tsx"
      to: "e.stopPropagation()"
      via: "pointer event handler"
      pattern: "stopPropagation"
    - from: "AsciiSliderRenderer.tsx"
      to: "useStore"
      via: "store update"
      pattern: "updateElement.*value"
---

<objective>
Implement drag interaction for ASCII Slider with Shift key fine control.

Purpose: Address GitHub #37 - ASCII Slider dragging doesn't feel natural. Add pointer event-based drag interaction with 10x fine control when Shift is held.

Output: ASCII Slider that responds to vertical drag with smooth, predictable value changes.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/45-slider-fixes/45-CONTEXT.md
@.planning/phases/45-slider-fixes/45-RESEARCH.md
@src/components/elements/renderers/controls/AsciiSliderRenderer.tsx
@src/components/elements/BaseElement.tsx
@src/store/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add drag interaction infrastructure</name>
  <files>
    src/types/elements/controls.ts
    src/components/elements/renderers/controls/AsciiSliderRenderer.tsx
  </files>
  <action>
Implement pointer event-based drag interaction for ASCII Slider:

1. **Type definition** (controls.ts - AsciiSliderElementConfig):
   Add interaction properties:
   ```typescript
   // Interaction
   dragSensitivity: number  // Pixels per full range (default: 100)
   ```

2. **Factory update** (createAsciiSlider):
   ```typescript
   dragSensitivity: 100,  // 100px vertical drag = full range
   ```

3. **Renderer update** (AsciiSliderRenderer.tsx):
   Add interaction layer using PointerEvent API:

   ```typescript
   import { useState, useRef, useCallback } from 'react'
   import { useStore } from '../../../../store'

   // Inside component:
   const [isDragging, setIsDragging] = useState(false)
   const dragStartRef = useRef({ mouseY: 0, startValue: 0 })
   const elementRef = useRef<HTMLDivElement>(null)

   // Get store action
   const updateElement = useStore((state) => state.updateElement)

   const handlePointerDown = useCallback((e: React.PointerEvent) => {
     // CRITICAL: Prevent BaseElement from handling this as canvas drag
     e.stopPropagation()
     e.preventDefault()

     setIsDragging(true)
     dragStartRef.current = {
       mouseY: e.clientY,
       startValue: config.value,
     }

     // Capture pointer for reliable tracking even outside element
     elementRef.current?.setPointerCapture(e.pointerId)
   }, [config.value])

   const handlePointerMove = useCallback((e: React.PointerEvent) => {
     if (!isDragging) return

     // Shift key = 10x finer control
     const sensitivity = e.shiftKey ? 0.1 : 1.0

     // Vertical drag: up = increase (inverted Y axis)
     const pixelsPerFullRange = config.dragSensitivity ?? 100
     const deltaY = dragStartRef.current.mouseY - e.clientY  // Inverted
     const normalizedDelta = (deltaY / pixelsPerFullRange) * sensitivity

     // Calculate new value clamped to range
     const range = config.max - config.min
     const newValue = Math.max(
       config.min,
       Math.min(
         config.max,
         dragStartRef.current.startValue + normalizedDelta * range
       )
     )

     // Update element in store (live preview)
     updateElement(config.id, { value: newValue })
   }, [isDragging, config.id, config.min, config.max, config.dragSensitivity, updateElement])

   const handlePointerUp = useCallback((e: React.PointerEvent) => {
     if (!isDragging) return

     setIsDragging(false)
     elementRef.current?.releasePointerCapture(e.pointerId)
   }, [isDragging])
   ```

4. **Attach handlers to root div**:
   ```typescript
   return (
     <div
       ref={elementRef}
       className="w-full h-full flex items-center"
       style={{
         // ... existing styles ...
         cursor: isDragging ? 'ns-resize' : 'pointer',
       }}
       onPointerDown={handlePointerDown}
       onPointerMove={handlePointerMove}
       onPointerUp={handlePointerUp}
       onPointerCancel={handlePointerUp}  // Handle cancel like up
     >
       {displayText}
     </div>
   )
   ```

   Apply same to the above/below value position branch (the alternate return statement).

IMPORTANT: e.stopPropagation() is CRITICAL to prevent BaseElement.tsx from capturing the drag as element movement.
  </action>
  <verify>
    - `npm run build` succeeds
    - Add ASCII Slider to canvas
    - Click and drag vertically on slider
    - Value changes smoothly as you drag
    - Dragging up increases value, dragging down decreases
    - Element does NOT move on canvas while dragging value
    - Cursor shows ns-resize during drag
  </verify>
  <done>
    - ASCII Slider responds to vertical drag
    - Drag does not conflict with canvas element positioning
    - Value updates in real-time during drag
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement Shift key fine control and add property panel options</name>
  <files>
    src/components/elements/renderers/controls/AsciiSliderRenderer.tsx
    src/components/Properties/AsciiSliderProperties.tsx
  </files>
  <action>
Verify Shift key fine control and add drag sensitivity to property panel:

1. **Verify Shift key works** (AsciiSliderRenderer.tsx):
   - The handlePointerMove already checks e.shiftKey on EVERY move event
   - This allows user to press/release Shift mid-drag
   - Sensitivity: 0.1 (10x slower) when Shift held, 1.0 normal
   - Test: Start drag, then hold Shift -> movement should become finer

2. **Property panel update** (AsciiSliderProperties.tsx):
   Add "Interaction" section with drag sensitivity control:
   ```typescript
   <PropertySection title="Interaction">
     <NumberInput
       label="Drag Sensitivity"
       value={element.dragSensitivity ?? 100}
       onChange={(dragSensitivity) => onUpdate({ dragSensitivity })}
       min={20}
       max={500}
     />
     <p className="text-xs text-gray-500 mt-1">
       Pixels for full range. Lower = more sensitive. Hold Shift for fine control.
     </p>
   </PropertySection>
   ```

3. **Verify live value display**:
   - ASCII Slider already shows value (formattedValue)
   - During drag, value should update in real-time
   - No additional work needed - updateElement triggers re-render

4. **Edge cases to handle**:
   - If drag starts but pointer leaves window: onPointerCancel handles this
   - If value reaches min/max during drag: clamping prevents overshoot
   - If element.id changes: useCallback deps handle this
  </action>
  <verify>
    - Hold Shift while dragging -> movement is 10x slower (finer control)
    - Release Shift mid-drag -> sensitivity returns to normal immediately
    - Drag Sensitivity input appears in property panel
    - Adjusting sensitivity changes how far you need to drag for full range
    - Help text explains the Shift key fine control feature
  </verify>
  <done>
    - Shift+drag provides 10x finer control
    - User can toggle fine control mid-drag by pressing/releasing Shift
    - Drag sensitivity is configurable via property panel
    - SLD-01 complete: ASCII Slider dragging feels natural
  </done>
</task>

</tasks>

<verification>
1. `npm run build` - no TypeScript errors
2. Manual testing:
   - ASCII Slider drag: smooth, predictable value changes
   - Shift key: finer control, can toggle mid-drag
   - No canvas drag conflict (element stays in place)
3. Property panel: drag sensitivity control visible and functional
</verification>

<success_criteria>
- SLD-01 (ASCII Slider drag feel): Dragging feels natural with smooth value changes
- Fine control mode: Shift+drag is 10x slower
- Live preview: Value updates in real-time during drag
- No regression: Element positioning still works via selection/drag handles
</success_criteria>

<output>
After completion, create `.planning/phases/45-slider-fixes/45-03-SUMMARY.md`
</output>
