---
phase: 13-extended-elements
plan: 15
type: execute
wave: 1
depends_on: []
files_modified:
  - src/App.tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "All palette elements appear at drop position on canvas"
    - "Elements appear centered on the mouse cursor position when dropped"
    - "Knobs, sliders, and all other elements behave identically for positioning"
  artifacts:
    - path: "src/App.tsx"
      provides: "Fixed handleDragEnd coordinate calculation"
      contains: "width.*height.*center"
  key_links:
    - from: "src/App.tsx handleDragEnd"
      to: "element creation"
      via: "coordinate calculation with centering"
      pattern: "canvasX.*canvasY"
---

<objective>
Fix element drop positioning bug where non-knob/slider elements appear offset from mouse position.

Purpose: Elements dropped from palette should appear centered on the mouse cursor, not offset by hundreds of pixels. Currently only knobs and sliders appear correctly positioned.

Output: All elements from palette appear at the correct drop position on canvas.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/App.tsx
@src/components/Palette/PaletteItem.tsx
</context>

<diagnosis>
The positioning bug occurs because:

1. `event.activatorEvent` captures the pointer position at the START of drag (where user clicked in palette)
2. The calculation `pointerEvent.clientX + event.delta.x` gives the final screen position
3. The element is created with its top-left corner at this position

The issue: Different palette items have different preview heights (knob: 40x40, collapsible: 50x50, etc.). The click position within the palette item varies, but the code doesn't account for this offset.

Why knobs/sliders work: Their preview sizes are small and roughly centered in the palette item container. The visual offset is minimal.

Why others fail: Larger preview elements or those with different aspect ratios have the click point at varying distances from the visual center, causing elements to appear offset when dropped.

Fix: After calculating canvasX/canvasY, offset by half the element's width/height to CENTER the element on the drop position rather than placing its top-left corner there.
</diagnosis>

<tasks>

<task type="auto">
  <name>Task 1: Center elements on drop position</name>
  <files>src/App.tsx</files>
  <action>
In the handleDragEnd function, after the switch statement creates newElement (around line 235), add centering logic BEFORE calling addElement:

```typescript
// Center element on drop position (not top-left corner)
if (newElement) {
  newElement.x = canvasX - newElement.width / 2
  newElement.y = canvasY - newElement.height / 2
}

addElement(newElement)
```

This centers the element on the mouse position rather than placing its top-left corner there.

The fix is simple: subtract half the width/height from the calculated canvas position to shift the element so its CENTER is at the drop point.
  </action>
  <verify>
1. Run `npm run dev`
2. Drag a Button from palette - should appear centered on mouse
3. Drag a Panel from palette - should appear centered on mouse
4. Drag a Collapsible from palette - should appear centered on mouse
5. Drag a Knob from palette - should still appear correctly
6. Drag a GroupBox from palette - should appear centered on mouse
7. All elements should appear at the same relative position to the mouse cursor
  </verify>
  <done>All palette elements appear centered on the drop position, with no offset between different element types.</done>
</task>

</tasks>

<verification>
1. npm run dev succeeds
2. Drop multiple element types from palette
3. All elements appear centered on mouse position
4. No visual offset between knobs/sliders and other elements
</verification>

<success_criteria>
- All palette elements (knob, slider, button, panel, collapsible, groupbox, etc.) appear at the same relative position to the mouse cursor when dropped
- Elements are centered on the drop position, not placed with top-left corner at drop position
- No regression in existing knob/slider positioning
</success_criteria>

<output>
After completion, create `.planning/phases/13-extended-elements/13-15-SUMMARY.md`
</output>
