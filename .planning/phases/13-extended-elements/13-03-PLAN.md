---
phase: 13-extended-elements
plan: 03
type: execute
wave: 2
depends_on: ["02"]
files_modified:
  - src/types/elements.ts
  - src/components/elements/Element.tsx
  - src/components/elements/renderers/CollapsibleRenderer.tsx
  - src/components/Properties/CollapsibleProperties.tsx
  - src/components/Properties/PropertyPanel.tsx
  - src/components/Palette/Palette.tsx
  - src/services/export/htmlGenerator.ts
  - src/services/export/cssGenerator.ts
autonomous: true

must_haves:
  truths:
    - "User can add Collapsible Container element from palette"
    - "Collapsible Container shows header with label and collapse toggle indicator"
    - "Collapsed state can be toggled in property panel"
    - "Collapsible Container has configurable max-height and scroll behavior"
    - "Element exports correctly to HTML/CSS with collapse animation CSS"
  artifacts:
    - path: "src/types/elements.ts"
      provides: "CollapsibleContainerElementConfig interface"
      contains: "type: 'collapsible'"
    - path: "src/components/elements/renderers/CollapsibleRenderer.tsx"
      provides: "Collapsible container with header and toggle"
      contains: "collapsed"
  key_links:
    - from: "src/components/Properties/CollapsibleProperties.tsx"
      to: "src/types/elements.ts"
      via: "collapsed, scrollBehavior, maxContentHeight properties"
---

<objective>
Add Collapsible Container element with header, collapse toggle, and scroll support.

Purpose: Complex plugin UIs need collapsible sections to manage screen real estate. This is requirement ELEM-08 (container subsection).

Output:
- CollapsibleContainerElementConfig type definition
- CollapsibleRenderer with header/toggle/content areas
- Property panel for collapse state and scroll configuration
- Palette entry in Containers category
- Export support with CSS transitions
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/13-extended-elements/13-CONTEXT.md
@.planning/phases/13-extended-elements/13-RESEARCH.md
@.planning/phases/13-extended-elements/13-02-SUMMARY.md

@src/types/elements.ts
@src/components/elements/Element.tsx
@src/components/Properties/PropertyPanel.tsx
@src/components/Palette/Palette.tsx
@src/services/export/htmlGenerator.ts
@src/services/export/cssGenerator.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add CollapsibleContainerElementConfig type</name>
  <files>src/types/elements.ts</files>
  <action>
Add CollapsibleContainerElementConfig interface:
```typescript
export interface CollapsibleContainerElementConfig extends BaseElementConfig {
  type: 'collapsible'

  // Header
  headerText: string
  headerFontSize: number
  headerColor: string
  headerBackground: string
  headerHeight: number

  // Content Area
  contentBackground: string
  maxContentHeight: number  // 0 = no limit
  scrollBehavior: 'auto' | 'hidden' | 'scroll'

  // State
  collapsed: boolean

  // Border
  borderWidth: number
  borderColor: string
  borderRadius: number
}
```

Update ElementConfig union to include CollapsibleContainerElementConfig.

Add type guard:
```typescript
export function isCollapsible(element: ElementConfig): element is CollapsibleContainerElementConfig {
  return element.type === 'collapsible'
}
```

Add factory function:
```typescript
export function createCollapsible(overrides?: Partial<CollapsibleContainerElementConfig>): CollapsibleContainerElementConfig {
  return {
    id: crypto.randomUUID(),
    type: 'collapsible',
    name: 'Collapsible',
    x: 0, y: 0,
    width: 220, height: 180,
    rotation: 0, zIndex: 0,
    locked: false, visible: true,
    headerText: 'Section',
    headerFontSize: 14,
    headerColor: '#e2e8f0',
    headerBackground: '#334155',
    headerHeight: 32,
    contentBackground: '#1e293b',
    maxContentHeight: 0,
    scrollBehavior: 'auto',
    collapsed: false,
    borderWidth: 1,
    borderColor: '#475569',
    borderRadius: 6,
    ...overrides,
  }
}
```
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit`</verify>
  <done>CollapsibleContainerElementConfig type defined with type guard and factory function</done>
</task>

<task type="auto">
  <name>Task 2: Create CollapsibleRenderer and update Element switch</name>
  <files>
src/components/elements/renderers/CollapsibleRenderer.tsx
src/components/elements/Element.tsx
  </files>
  <action>
Create CollapsibleRenderer.tsx:
```tsx
import type { CollapsibleContainerElementConfig } from '../../../types/elements'

interface CollapsibleRendererProps {
  config: CollapsibleContainerElementConfig
}

export function CollapsibleRenderer({ config }: CollapsibleRendererProps) {
  // Calculate content height when not collapsed
  const contentHeight = config.height - config.headerHeight - (config.borderWidth * 2)

  return (
    <div
      className="collapsible-element"
      style={{
        width: '100%',
        height: '100%',
        display: 'flex',
        flexDirection: 'column',
        border: `${config.borderWidth}px solid ${config.borderColor}`,
        borderRadius: `${config.borderRadius}px`,
        overflow: 'hidden',
      }}
    >
      {/* Header */}
      <div
        className="collapsible-header"
        style={{
          height: `${config.headerHeight}px`,
          minHeight: `${config.headerHeight}px`,
          padding: '0 12px',
          background: config.headerBackground,
          display: 'flex',
          justifyContent: 'space-between',
          alignItems: 'center',
          cursor: 'pointer',
          userSelect: 'none',
        }}
      >
        <span
          style={{
            fontSize: `${config.headerFontSize}px`,
            fontWeight: 600,
            color: config.headerColor,
          }}
        >
          {config.headerText}
        </span>
        <span
          style={{
            fontSize: '12px',
            color: config.headerColor,
            opacity: 0.7,
            transform: config.collapsed ? 'rotate(0deg)' : 'rotate(180deg)',
            transition: 'transform 0.2s ease',
          }}
        >
          ▼
        </span>
      </div>

      {/* Content Area */}
      <div
        className="collapsible-content"
        style={{
          flex: config.collapsed ? 0 : 1,
          height: config.collapsed ? 0 : 'auto',
          maxHeight: config.collapsed
            ? 0
            : (config.maxContentHeight > 0 ? `${config.maxContentHeight}px` : `${contentHeight}px`),
          overflow: config.collapsed ? 'hidden' : config.scrollBehavior,
          background: config.contentBackground,
          transition: 'max-height 0.3s ease, flex 0.3s ease',
        }}
      />
    </div>
  )
}
```

Update Element.tsx:
1. Import CollapsibleRenderer
2. Add case to switch:
```tsx
case 'collapsible':
  return <CollapsibleRenderer config={element} />
```
  </action>
  <verify>TypeScript compiles and running app shows no console errors when rendering collapsible element</verify>
  <done>CollapsibleRenderer created with header/toggle/content; Element.tsx routes correctly</done>
</task>

<task type="auto">
  <name>Task 3: Add property panel, palette entry, and export support</name>
  <files>
src/components/Properties/CollapsibleProperties.tsx
src/components/Properties/PropertyPanel.tsx
src/components/Palette/Palette.tsx
src/services/export/htmlGenerator.ts
src/services/export/cssGenerator.ts
  </files>
  <action>
Create CollapsibleProperties.tsx:
```tsx
import { PropertySection } from './PropertySection'
import { TextInput } from './TextInput'
import { NumberInput } from './NumberInput'
import { ColorInput } from './ColorInput'
import type { CollapsibleContainerElementConfig, ElementConfig } from '../../types/elements'

interface CollapsiblePropertiesProps {
  element: CollapsibleContainerElementConfig
  onUpdate: (updates: Partial<ElementConfig>) => void
}

export function CollapsibleProperties({ element, onUpdate }: CollapsiblePropertiesProps) {
  return (
    <>
      <PropertySection title="Header">
        <TextInput
          label="Header Text"
          value={element.headerText}
          onChange={(headerText) => onUpdate({ headerText })}
        />
        <NumberInput
          label="Header Height"
          value={element.headerHeight}
          onChange={(headerHeight) => onUpdate({ headerHeight })}
          min={24}
          max={64}
        />
        <NumberInput
          label="Font Size"
          value={element.headerFontSize}
          onChange={(headerFontSize) => onUpdate({ headerFontSize })}
          min={10}
          max={24}
        />
        <ColorInput
          label="Text Color"
          value={element.headerColor}
          onChange={(headerColor) => onUpdate({ headerColor })}
        />
        <ColorInput
          label="Background"
          value={element.headerBackground}
          onChange={(headerBackground) => onUpdate({ headerBackground })}
        />
      </PropertySection>

      <PropertySection title="Content">
        <ColorInput
          label="Background"
          value={element.contentBackground}
          onChange={(contentBackground) => onUpdate({ contentBackground })}
        />
        <NumberInput
          label="Max Height (0=none)"
          value={element.maxContentHeight}
          onChange={(maxContentHeight) => onUpdate({ maxContentHeight })}
          min={0}
          max={1000}
        />
        <div>
          <label className="block text-xs text-gray-400 mb-1">Scroll Behavior</label>
          <select
            value={element.scrollBehavior}
            onChange={(e) => onUpdate({ scrollBehavior: e.target.value as 'auto' | 'hidden' | 'scroll' })}
            className="w-full bg-gray-700 border border-gray-600 text-white rounded px-2 py-1.5 text-sm"
          >
            <option value="auto">Auto</option>
            <option value="hidden">Hidden</option>
            <option value="scroll">Scroll</option>
          </select>
        </div>
      </PropertySection>

      <PropertySection title="State">
        <label className="flex items-center gap-2 text-sm cursor-pointer select-none">
          <input
            type="checkbox"
            checked={element.collapsed}
            onChange={(e) => onUpdate({ collapsed: e.target.checked })}
            className="rounded border-gray-600 bg-gray-700 text-blue-500 focus:ring-blue-500"
          />
          <span className="text-gray-300">Collapsed</span>
        </label>
      </PropertySection>

      <PropertySection title="Border">
        <NumberInput
          label="Border Width"
          value={element.borderWidth}
          onChange={(borderWidth) => onUpdate({ borderWidth })}
          min={0}
          max={10}
        />
        <ColorInput
          label="Border Color"
          value={element.borderColor}
          onChange={(borderColor) => onUpdate({ borderColor })}
        />
        <NumberInput
          label="Border Radius"
          value={element.borderRadius}
          onChange={(borderRadius) => onUpdate({ borderRadius })}
          min={0}
          max={24}
        />
      </PropertySection>
    </>
  )
}
```

Update PropertyPanel.tsx:
1. Import CollapsibleProperties
2. Add case:
```tsx
case 'collapsible':
  return <CollapsibleProperties element={selectedElement} onUpdate={handleUpdate} />
```

Update Palette.tsx - add Collapsible to the existing Containers category (created by 13-02):
```typescript
{ id: 'collapsible', type: 'collapsible', name: 'Collapsible' },
```

Update htmlGenerator.ts:
```typescript
case 'collapsible':
  return `<div id="${id}" class="${baseClass} collapsible-element${element.collapsed ? ' collapsed' : ''}" data-type="collapsible" data-collapsed="${element.collapsed}" style="${positionStyle}">
    <div class="collapsible-header">
      <span class="collapsible-title">${escapeHTML(element.headerText)}</span>
      <span class="collapsible-toggle">▼</span>
    </div>
    <div class="collapsible-content"></div>
  </div>`
```

Update cssGenerator.ts:
```typescript
case 'collapsible':
  const contentMaxHeight = element.maxContentHeight > 0
    ? `${element.maxContentHeight}px`
    : `${element.height - element.headerHeight - element.borderWidth * 2}px`
  return `${selector} {
  display: flex;
  flex-direction: column;
  border: ${element.borderWidth}px solid ${element.borderColor};
  border-radius: ${element.borderRadius}px;
  overflow: hidden;
}

${selector} .collapsible-header {
  height: ${element.headerHeight}px;
  min-height: ${element.headerHeight}px;
  padding: 0 12px;
  background: ${element.headerBackground};
  display: flex;
  justify-content: space-between;
  align-items: center;
  cursor: pointer;
  user-select: none;
}

${selector} .collapsible-title {
  font-size: ${element.headerFontSize}px;
  font-weight: 600;
  color: ${element.headerColor};
}

${selector} .collapsible-toggle {
  font-size: 12px;
  color: ${element.headerColor};
  opacity: 0.7;
  transition: transform 0.2s ease;
}

${selector}.collapsed .collapsible-toggle {
  transform: rotate(0deg);
}

${selector}:not(.collapsed) .collapsible-toggle {
  transform: rotate(180deg);
}

${selector} .collapsible-content {
  flex: 1;
  background: ${element.contentBackground};
  max-height: ${contentMaxHeight};
  overflow: ${element.scrollBehavior};
  transition: max-height 0.3s ease;
}

${selector}.collapsed .collapsible-content {
  max-height: 0;
  overflow: hidden;
}`
```
  </action>
  <verify>
1. Run `npm run dev`
2. Drag Collapsible from Containers category to canvas
3. Verify header with toggle arrow appears
4. In property panel, toggle "Collapsed" checkbox
5. Verify element visually collapses (content area shrinks)
6. Export project, verify HTML has collapsed class when collapsed
7. Verify CSS includes transition styles
  </verify>
  <done>CollapsibleProperties complete; Palette entry added; Export generates collapsible HTML/CSS with animation</done>
</task>

</tasks>

<verification>
1. TypeScript compiles: `npm run build`
2. Collapsible Container appears in Palette (Containers category)
3. Element renders with header, toggle indicator, and content area
4. Property panel has Header, Content, State, Border sections
5. Toggling "Collapsed" checkbox updates visual state
6. Exported HTML contains collapsible structure
7. Exported CSS contains collapse animation transitions
</verification>

<success_criteria>
- [ ] CollapsibleContainerElementConfig type exists with all properties
- [ ] Type guard isCollapsible works correctly
- [ ] Factory function createCollapsible has sensible defaults
- [ ] CollapsibleRenderer shows header with toggle and content area
- [ ] Element.tsx handles 'collapsible' type
- [ ] CollapsibleProperties has all configuration sections
- [ ] Palette Containers category includes Collapsible
- [ ] HTML export generates correct structure
- [ ] CSS export generates transition animations
- [ ] Collapsed state affects visual rendering
</success_criteria>

<output>
After completion, create `.planning/phases/13-extended-elements/13-03-SUMMARY.md`
</output>
