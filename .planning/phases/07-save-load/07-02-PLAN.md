---
phase: 07-save-load
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - src/services/fileSystem.ts
  - src/components/project/SaveLoadPanel.tsx
  - src/components/layout/RightPanel.tsx
  - src/store/elementsSlice.ts
  - src/store/canvasSlice.ts
autonomous: true

must_haves:
  truths:
    - "User can click Save and download project as .json file"
    - "User can click Load and select a .json file to restore"
    - "Loaded project restores all elements, canvas settings, and layer order"
    - "Invalid files show clear error message (not crash)"
  artifacts:
    - path: "src/services/fileSystem.ts"
      provides: "File save/load operations"
      exports: ["saveProjectFile", "loadProjectFile"]
    - path: "src/components/project/SaveLoadPanel.tsx"
      provides: "Save/Load UI buttons"
      exports: ["SaveLoadPanel"]
  key_links:
    - from: "src/services/fileSystem.ts"
      to: "browser-fs-access"
      via: "fileSave and fileOpen functions"
      pattern: "fileSave|fileOpen"
    - from: "src/components/project/SaveLoadPanel.tsx"
      to: "src/services/fileSystem.ts"
      via: "Button onClick handlers"
      pattern: "saveProjectFile|loadProjectFile"
    - from: "SaveLoadPanel"
      to: "useStore"
      via: "Read state for save, write state on load"
      pattern: "useStore.*elements|setElements"
---

<objective>
Create file system service for save/load operations and integrate Save/Load UI into the right panel with proper error handling.

Purpose: Completes the persistence feature by wiring serialization to actual file operations and providing user-accessible buttons.

Output: Working save/load functionality - user can save project to .json file and load it back with full state restoration.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-save-load/07-01-SUMMARY.md
@src/services/serialization.ts
@src/schemas/project.ts
@src/store/index.ts
@src/store/elementsSlice.ts
@src/store/canvasSlice.ts
@src/components/layout/RightPanel.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create file system service</name>
  <files>
    src/services/fileSystem.ts
  </files>
  <action>
1. Create `src/services/fileSystem.ts` using browser-fs-access:

   **saveProjectFile function:**
   ```typescript
   import { fileSave } from 'browser-fs-access';

   export async function saveProjectFile(jsonContent: string, suggestedName?: string): Promise<void>
   ```
   - Use fileSave() with options:
     - fileName: suggestedName || 'project.json'
     - extensions: ['.json']
     - description: 'VST3 WebView UI Project'
     - mimeTypes: ['application/json']
   - Let browser-fs-access handle fallback for browsers without File System Access API
   - Errors bubble up (caller handles)

   **loadProjectFile function:**
   ```typescript
   import { fileOpen } from 'browser-fs-access';

   export interface LoadResult {
     success: true;
     content: string;
     fileName: string;
   } | {
     success: false;
     error: string;
   }

   export async function loadProjectFile(): Promise<LoadResult>
   ```
   - Use fileOpen() with options:
     - extensions: ['.json']
     - description: 'VST3 WebView UI Project'
     - mimeTypes: ['application/json']
   - Read file content as text
   - Return { success: true, content, fileName } on success
   - Catch errors:
     - User cancellation (AbortError): return { success: false, error: 'File selection cancelled' }
     - Other errors: return { success: false, error: error.message }

IMPORTANT: browser-fs-access handles progressive enhancement automatically - modern browsers get native file picker, older browsers get fallback. No need to implement fallback manually.
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - Manual test: Import and call saveProjectFile with test JSON - should show save dialog
    - Manual test: Import and call loadProjectFile - should show file picker
  </verify>
  <done>
    File system service provides save/load operations with proper error handling and automatic browser fallback.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create SaveLoadPanel and integrate into RightPanel</name>
  <files>
    src/components/project/SaveLoadPanel.tsx
    src/components/layout/RightPanel.tsx
  </files>
  <action>
1. Create `src/components/project/SaveLoadPanel.tsx`:

   ```typescript
   export function SaveLoadPanel(): JSX.Element
   ```

   **State:**
   - loading: boolean (disable buttons during operations)
   - error: string | null (show error message if load fails)

   **Save handler:**
   - Get state from useStore: elements, canvasWidth, canvasHeight, backgroundColor, backgroundType, gradientConfig, snapToGrid, gridSize, selectedIds
   - Call serializeProject() to get JSON string
   - Call saveProjectFile() with JSON
   - Handle errors with try/catch, show in error state

   **Load handler:**
   - Call loadProjectFile() to get file content
   - If cancelled, do nothing
   - Call deserializeProject() to validate
   - If validation fails, set error state with message
   - If success, update store:
     - setElements(data.elements)
     - setCanvasDimensions(data.canvas.canvasWidth, data.canvas.canvasHeight)
     - setBackgroundColor(data.canvas.backgroundColor)
     - setBackgroundType(data.canvas.backgroundType)
     - setSnapToGrid(data.canvas.snapToGrid)
     - setGridSize(data.canvas.gridSize)
     - If selectedIds in data, selectMultiple(data.selectedIds)
   - Clear error state on success

   **UI:**
   - Section header "Project" with collapsible pattern (like HelpPanel)
   - Two buttons: "Save Project" and "Load Project" with icons
   - Error message display below buttons (red text, dismissible)
   - Disable buttons while loading state is true
   - Use existing button styling from the codebase

2. Update `src/components/layout/RightPanel.tsx`:
   - Import SaveLoadPanel
   - Add SaveLoadPanel at the top of the right panel (before PropertyPanel or ZOrderPanel)
   - This puts save/load controls in a prominent, accessible location

IMPORTANT:
- On load, clear existing elements first (setElements replaces, doesn't append)
- Handle gradientConfig which may be undefined in loaded data
- Show loading state to prevent double-clicks
- Error messages should be user-friendly (from zod-error formatting)
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - `npm run dev` starts without errors
    - Visual: SaveLoadPanel appears in right panel
    - Functional: Click Save -> file picker appears, file downloads as .json
    - Functional: Click Load -> file picker appears, selecting valid .json restores state
    - Functional: Load invalid file -> error message appears
  </verify>
  <done>
    SaveLoadPanel provides working save/load buttons, integrated into RightPanel, with proper error display.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add missing store setters if needed</name>
  <files>
    src/store/canvasSlice.ts
  </files>
  <action>
Review canvasSlice.ts and ensure all necessary setters exist for loading:

Required setters (verify these exist, add if missing):
- setCanvasDimensions(width, height) - EXISTS
- setBackgroundColor(color) - EXISTS
- setBackgroundType(type) - EXISTS
- setGradientConfig(config) - EXISTS (but may need to handle undefined)
- setSnapToGrid(enabled) - EXISTS
- setGridSize(size) - EXISTS

If setGradientConfig doesn't handle undefined gracefully, update it:
```typescript
setGradientConfig: (config) =>
  set({ gradientConfig: config }),
```

Also verify elementsSlice.ts has:
- setElements(elements) - EXISTS
- selectMultiple(ids) - EXISTS

This task may be a no-op if all setters already exist. Verify and document.
  </action>
  <verify>
    - Review each setter in canvasSlice.ts and elementsSlice.ts
    - Confirm load operation can restore all state fields
    - `npx tsc --noEmit` passes
  </verify>
  <done>
    All store setters needed for loading project state are verified to exist and work correctly.
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles: `npx tsc --noEmit`
2. Dev server runs: `npm run dev`
3. Save flow: Add elements to canvas -> Click Save -> Select location -> .json file created with version "1.0.0"
4. Load flow: Click Load -> Select saved .json -> Canvas shows loaded elements in correct positions
5. Error handling: Load invalid JSON -> Error message displayed, app doesn't crash
6. Round-trip: Save -> Clear canvas -> Load same file -> Identical state restored
7. Layer order: Elements maintain z-order (array position) after load
</verification>

<success_criteria>
- SaveLoadPanel visible in right panel with Save/Load buttons
- Clicking Save opens file dialog and downloads .json file
- Clicking Load opens file dialog and restores project state
- Invalid files show user-friendly error message
- All element properties preserved: position, size, colors, type-specific props
- Canvas settings preserved: dimensions, background, snap settings
- Layer order preserved: elements render in same order after load
- Selection state optionally preserved
</success_criteria>

<output>
After completion, create `.planning/phases/07-save-load/07-02-SUMMARY.md`
</output>
