---
phase: 07-save-load
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - src/schemas/project.ts
  - src/services/serialization.ts
autonomous: true

must_haves:
  truths:
    - "Zod schemas validate all 6 element types correctly"
    - "Serialization produces versioned JSON with all state"
    - "Deserialization catches invalid/corrupt data with user-friendly errors"
  artifacts:
    - path: "src/schemas/project.ts"
      provides: "Zod schemas for project structure"
      exports: ["ProjectSchema", "ElementConfigSchema", "CanvasConfigSchema"]
    - path: "src/services/serialization.ts"
      provides: "Serialize/deserialize functions"
      exports: ["serializeProject", "deserializeProject"]
  key_links:
    - from: "src/schemas/project.ts"
      to: "src/types/elements.ts"
      via: "Zod schemas mirror TypeScript discriminated unions"
      pattern: "z\\.discriminatedUnion.*type"
    - from: "src/services/serialization.ts"
      to: "src/schemas/project.ts"
      via: "Import and use schemas for validation"
      pattern: "ProjectSchema\\.safeParse"
---

<objective>
Create Zod schemas that mirror the existing TypeScript element types and build serialization services that convert Zustand state to versioned JSON with validation.

Purpose: Establishes the data layer for project persistence - schemas ensure type safety at runtime, serialization provides the bridge between app state and file format.

Output: Zod schemas for all element types, serialization service with serialize/deserialize functions, version 1.0.0 format established.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/types/elements.ts
@src/store/canvasSlice.ts
@src/store/elementsSlice.ts
@src/store/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies and create Zod schemas</name>
  <files>
    package.json
    src/schemas/project.ts
  </files>
  <action>
1. Install dependencies:
   ```bash
   npm install zod browser-fs-access zod-error
   ```

2. Create `src/schemas/project.ts` with Zod schemas that EXACTLY mirror the TypeScript types in `src/types/elements.ts`:

   - Create base element schema with shared fields (id, name, x, y, width, height, rotation, zIndex, locked, visible, parameterId optional)

   - Create element-specific schemas using z.discriminatedUnion('type', [...]):
     - KnobElementSchema: type='knob', diameter, value, min, max, startAngle, endAngle, style (enum), trackColor, fillColor, indicatorColor, trackWidth
     - SliderElementSchema: type='slider', orientation (enum), value, min, max, trackColor, trackFillColor, thumbColor, thumbWidth, thumbHeight
     - ButtonElementSchema: type='button', mode (enum), label, pressed, backgroundColor, textColor, borderColor, borderRadius
     - LabelElementSchema: type='label', text, fontSize, fontFamily, fontWeight, color, textAlign (enum)
     - MeterElementSchema: type='meter', orientation, value, min, max, colorStops (array of {position, color}), backgroundColor, showPeakHold
     - ImageElementSchema: type='image', src, fit (enum)

   - Create ElementConfigSchema as z.discriminatedUnion('type', [all element schemas])

   - Create CanvasConfigSchema with: canvasWidth, canvasHeight, backgroundColor, backgroundType, gradientConfig optional, snapToGrid, gridSize

   - Create ProjectSchema with:
     - version: z.string() (will be "1.0.0")
     - canvas: CanvasConfigSchema
     - elements: z.array(ElementConfigSchema)
     - selectedIds: z.array(z.string()) optional (for restoring selection state)

   - Export inferred types: ProjectData, CanvasConfig, etc.

IMPORTANT: Use z.discriminatedUnion() for element types (O(1) lookup) not z.union() (O(n) sequential). This matches the research recommendation.
  </action>
  <verify>
    - `npm ls zod browser-fs-access zod-error` shows all three installed
    - `npx tsc --noEmit` passes with no type errors
    - Schema exports are importable: add temporary test in a file
  </verify>
  <done>
    Zod schemas exist that mirror all 6 element types with discriminated union, canvas config, and versioned project structure.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create serialization service with validation</name>
  <files>
    src/services/serialization.ts
  </files>
  <action>
1. Create `src/services/serialization.ts` with:

   **serializeProject function:**
   ```typescript
   export function serializeProject(state: {
     elements: ElementConfig[];
     canvasWidth: number;
     canvasHeight: number;
     backgroundColor: string;
     backgroundType: 'color' | 'gradient' | 'image';
     gradientConfig?: GradientConfig;
     snapToGrid: boolean;
     gridSize: number;
     selectedIds: string[];
   }): string
   ```
   - Create ProjectData object with version "1.0.0"
   - Extract only domain state (NOT viewport - scale, offsetX, offsetY are camera, not document)
   - JSON.stringify with 2-space indent for human readability
   - Return JSON string

   **deserializeProject function:**
   ```typescript
   export interface DeserializeResult {
     success: true;
     data: ProjectData;
   } | {
     success: false;
     error: string;
   }

   export function deserializeProject(json: string): DeserializeResult
   ```
   - Try JSON.parse, catch syntax errors with user-friendly message
   - Use ProjectSchema.safeParse() for validation
   - On validation error, use zod-error's generateErrorMessage() to format user-friendly error
   - Return typed result (success/error discriminated union)

   **Version migration stub:**
   ```typescript
   function migrateProject(data: unknown): unknown {
     // For v1.0.0, no migration needed
     // Future: check version field and apply migrations
     return data;
   }
   ```
   - Call migrateProject before validation to handle future schema changes

IMPORTANT:
- Do NOT include viewport state (scale, offsetX, offsetY) - this is camera position, not document state
- DO include selectedIds - selection is meaningful state to restore
- Use generateErrorMessage from zod-error for user-friendly validation errors
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - Create manual test: serialize sample state, deserialize it back, verify round-trip
    - Test with invalid JSON: should return error with message
    - Test with valid JSON but wrong schema: should return validation error
  </verify>
  <done>
    Serialization service can convert store state to versioned JSON and back with full validation and user-friendly error messages.
  </done>
</task>

</tasks>

<verification>
1. Dependencies installed: `npm ls zod browser-fs-access zod-error`
2. TypeScript compiles: `npx tsc --noEmit`
3. Schemas match types: Compare ProjectSchema fields to ElementConfig union
4. Round-trip test: serializeProject(state) -> deserializeProject(json) -> identical data
5. Error handling: deserializeProject('invalid') returns error with message
</verification>

<success_criteria>
- Zod, browser-fs-access, zod-error installed in package.json
- src/schemas/project.ts exports ProjectSchema with discriminated union for all 6 element types
- src/services/serialization.ts exports serializeProject and deserializeProject
- Serialized JSON includes version "1.0.0"
- Invalid JSON returns user-friendly error message (not raw Zod error)
- TypeScript compilation passes
</success_criteria>

<output>
After completion, create `.planning/phases/07-save-load/07-01-SUMMARY.md`
</output>
