---
phase: 37-font-management-system
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/store/fontsSlice.ts
  - src/store/index.ts
autonomous: true

must_haves:
  truths:
    - "App state tracks custom fonts and loading status"
    - "App state persists selected fonts directory path"
    - "State updates trigger UI re-renders in font dropdowns"
  artifacts:
    - path: "src/store/fontsSlice.ts"
      provides: "Zustand slice for font state management"
      exports: ["createFontsSlice", "FontsSlice"]
    - path: "src/store/index.ts"
      provides: "Combined store with fonts slice"
      contains: "fontsSlice"
  key_links:
    - from: "src/store/index.ts"
      to: "src/store/fontsSlice.ts"
      via: "imports and combines slice"
      pattern: "createFontsSlice"
---

<objective>
Create the Zustand state management slice for font management.

Purpose: Provide reactive state for custom fonts that components can subscribe to. The slice tracks loaded fonts, directory path, loading states, and exposes actions for scanning and loading fonts.

Output: A fontsSlice integrated into the main Zustand store that components can use for font selection.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/37-font-management-system/37-RESEARCH.md

# Existing store architecture
@src/store/index.ts
@src/store/assetsSlice.ts

# Font services (created in parallel)
# src/services/fonts/fontStorage.ts
# src/services/fonts/fontManager.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create fonts Zustand slice</name>
  <files>
    - src/store/fontsSlice.ts
  </files>
  <action>
Create `src/store/fontsSlice.ts` with state and actions for font management.

**State interface:**
```typescript
import { StateCreator } from 'zustand'
import type { FontMetadata, StoredFont } from '../services/fonts/fontParser'

export interface CustomFont {
  family: string          // CSS font-family value
  name: string            // Display name (from fullName or family)
  format: 'ttf' | 'otf' | 'woff' | 'woff2'
  category: 'custom'      // Always 'custom' for user fonts
}

export interface FontsSlice {
  // State
  customFonts: CustomFont[]           // Loaded custom fonts
  fontsDirectoryPath: string | null   // Display path of selected directory
  fontsLoading: boolean               // True during scan/load
  fontsError: string | null           // Last error message
  lastScanTime: number | null         // Timestamp of last successful scan

  // Actions
  setCustomFonts: (fonts: CustomFont[]) => void
  setFontsDirectoryPath: (path: string | null) => void
  setFontsLoading: (loading: boolean) => void
  setFontsError: (error: string | null) => void
  setLastScanTime: (time: number | null) => void
  clearFontsState: () => void
}
```

**Implementation:**
```typescript
export const createFontsSlice: StateCreator<FontsSlice, [], [], FontsSlice> = (set) => ({
  // Initial state
  customFonts: [],
  fontsDirectoryPath: null,
  fontsLoading: false,
  fontsError: null,
  lastScanTime: null,

  // Actions
  setCustomFonts: (fonts) => set({ customFonts: fonts, fontsError: null }),

  setFontsDirectoryPath: (path) => set({ fontsDirectoryPath: path }),

  setFontsLoading: (loading) => set({ fontsLoading: loading }),

  setFontsError: (error) => set({ fontsError: error }),

  setLastScanTime: (time) => set({ lastScanTime: time }),

  clearFontsState: () => set({
    customFonts: [],
    fontsDirectoryPath: null,
    fontsLoading: false,
    fontsError: null,
    lastScanTime: null,
  }),
})
```

**Notes:**
- Keep slice simple - orchestration logic lives in fontManager service
- CustomFont is a simplified view of StoredFont for UI consumption
- State is excluded from undo history (will be added to partialize in next task)
- No async actions in slice - use fontManager in components
  </action>
  <verify>
    - `npx tsc --noEmit src/store/fontsSlice.ts` compiles
    - Slice exports createFontsSlice and FontsSlice type
  </verify>
  <done>
    - fontsSlice.ts created with all state fields and actions
    - CustomFont type defined for UI consumption
    - Clean separation between state (slice) and logic (fontManager)
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate fonts slice into main store</name>
  <files>
    - src/store/index.ts
  </files>
  <action>
Update `src/store/index.ts` to include the fonts slice.

**Changes (in this order):**

1. Add import at top:
```typescript
import { createFontsSlice, FontsSlice } from './fontsSlice'
```

2. Update Store type to include FontsSlice:
```typescript
export type Store = CanvasSlice & ViewportSlice & ElementsSlice & TemplateSlice & AssetsSlice & KnobStylesSlice & DirtyStateSlice & ContainerEditorSlice & FontsSlice
```

3. Add fontsSlice to store creation (inside the create() call):
```typescript
export const useStore = create<Store>()(
  temporal(
    (...a) => ({
      ...createCanvasSlice(...a),
      ...createViewportSlice(...a),
      ...createElementsSlice(...a),
      ...createTemplateSlice(...a),
      ...createAssetsSlice(...a),
      ...createKnobStylesSlice(...a),
      ...createDirtyStateSlice(...a),
      ...createContainerEditorSlice(...a),
      ...createFontsSlice(...a),
    }),
    // ... rest of config
  )
)
```

4. Exclude fonts state from undo history - add to partialize exclusions:
```typescript
partialize: (state) => {
  const {
    scale, offsetX, offsetY, isPanning, dragStart, lockAllMode,
    selectedIds, lastSelectedId, liveDragValues,
    savedStateSnapshot, lastSavedTimestamp,
    editingContainerId, containerEditStack,
    // Add fonts state - not undoable
    customFonts, fontsDirectoryPath, fontsLoading, fontsError, lastScanTime,
    ...rest
  } = state
  return rest
}
```

**Verification order:**
- First add import and slice to store creation
- Then add partialize exclusions
- Run TypeScript check after each step if unsure
  </action>
  <verify>
    - `npx tsc --noEmit src/store/index.ts` compiles
    - `npm run build` completes without errors
  </verify>
  <done>
    - FontsSlice integrated into combined Store type
    - createFontsSlice called in store creation
    - All font state fields excluded from undo history partialize
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `npm run build` completes without errors
2. Store exports FontsSlice type
3. Font state is accessible via useStore
4. Font state changes don't create undo history entries
</verification>

<success_criteria>
- fontsSlice.ts created with CustomFont type, state, and actions
- Main store includes fonts slice in combined type
- Font state excluded from temporal undo tracking
- TypeScript compilation passes
</success_criteria>

<output>
After completion, create `.planning/phases/37-font-management-system/37-02-SUMMARY.md`
</output>
