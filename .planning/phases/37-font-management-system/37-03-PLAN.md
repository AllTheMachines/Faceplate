---
phase: 37-font-management-system
plan: 03
type: execute
wave: 2
depends_on: ["37-01", "37-02"]
files_modified:
  - src/components/Settings/FontSettings.tsx
  - src/components/Layout/LeftPanel.tsx
  - src/hooks/useFonts.ts
autonomous: true

must_haves:
  truths:
    - "User can select a fonts folder via file picker dialog"
    - "User can trigger manual rescan of fonts folder"
    - "Selected folder path is displayed with copy button"
    - "Loading state shown during font scanning"
    - "Error messages displayed when scan fails"
    - "Font count displayed after successful scan"
  artifacts:
    - path: "src/components/Settings/FontSettings.tsx"
      provides: "Settings UI panel for font management"
      exports: ["FontSettings"]
    - path: "src/hooks/useFonts.ts"
      provides: "Hook for font operations with loading states"
      exports: ["useFonts"]
    - path: "src/components/Layout/LeftPanel.tsx"
      provides: "Left panel with fonts settings button"
      contains: "FontSettings"
  key_links:
    - from: "src/components/Settings/FontSettings.tsx"
      to: "src/hooks/useFonts.ts"
      via: "hook usage"
      pattern: "useFonts"
    - from: "src/hooks/useFonts.ts"
      to: "src/services/fonts/fontManager.ts"
      via: "service calls"
      pattern: "fontManager"
    - from: "src/hooks/useFonts.ts"
      to: "src/services/fonts/fontStorage.ts"
      via: "imports getAllFonts"
      pattern: "import.*getAllFonts.*from.*fontStorage"
---

<objective>
Create the Settings UI for font folder management.

Purpose: Provide a user interface where users can select their fonts folder, trigger rescans, and see the status of their custom fonts. This enables the core font management workflow: select folder -> scan -> use fonts.

Output: FontSettings component accessible from LeftPanel, with folder selection, rescan button, path display, and status indicators.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/37-font-management-system/37-RESEARCH.md

# Prior plan summaries (when available)
# @.planning/phases/37-font-management-system/37-01-SUMMARY.md
# @.planning/phases/37-font-management-system/37-02-SUMMARY.md

# Existing layout
@src/components/Layout/LeftPanel.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useFonts hook for font operations</name>
  <files>
    - src/hooks/useFonts.ts
  </files>
  <action>
Create `src/hooks/useFonts.ts` - a React hook that wraps font operations with state management.

**Hook interface:**
```typescript
export interface UseFontsReturn {
  // State from store
  customFonts: CustomFont[]
  fontsDirectoryPath: string | null
  fontsLoading: boolean
  fontsError: string | null
  lastScanTime: number | null

  // Actions
  selectDirectory: () => Promise<void>
  rescanDirectory: () => Promise<void>
  clearDirectory: () => Promise<void>
  restoreOnMount: () => Promise<void>
}
```

**Implementation:**
```typescript
import { useCallback, useEffect } from 'react'
import { useStore } from '../store'
import { fontManager } from '../services/fonts/fontManager'
import { getAllFonts } from '../services/fonts/fontStorage'
import type { CustomFont } from '../store/fontsSlice'

export function useFonts(): UseFontsReturn {
  const {
    customFonts,
    fontsDirectoryPath,
    fontsLoading,
    fontsError,
    lastScanTime,
    setCustomFonts,
    setFontsDirectoryPath,
    setFontsLoading,
    setFontsError,
    setLastScanTime,
    clearFontsState,
  } = useStore()

  // Convert StoredFont[] to CustomFont[] for UI
  const updateFontsFromStorage = useCallback(async () => {
    const storedFonts = await getAllFonts()
    const customFonts: CustomFont[] = storedFonts.map(f => ({
      family: f.family,
      name: f.metadata.fullName || f.metadata.family,
      format: f.metadata.format,
      category: 'custom' as const,
    }))
    setCustomFonts(customFonts)
  }, [setCustomFonts])

  const selectDirectory = useCallback(async () => {
    setFontsLoading(true)
    setFontsError(null)

    try {
      const result = await fontManager.selectFontsDirectory()
      if (!result) {
        setFontsLoading(false)
        return // User cancelled
      }

      setFontsDirectoryPath(result.path)

      // Scan and store fonts
      const scanResult = await fontManager.scanAndStoreFonts(result.handle)

      // Load fonts into document for preview
      const storedFonts = await getAllFonts()
      await fontManager.loadFontsIntoDocument(storedFonts)

      // Update state
      await updateFontsFromStorage()
      setLastScanTime(Date.now())

      if (scanResult.errors.length > 0) {
        setFontsError(`Loaded ${scanResult.loaded} fonts. ${scanResult.errors.length} files failed to parse.`)
      }
    } catch (error) {
      setFontsError(error instanceof Error ? error.message : 'Failed to select fonts directory')
    } finally {
      setFontsLoading(false)
    }
  }, [setFontsLoading, setFontsError, setFontsDirectoryPath, setLastScanTime, updateFontsFromStorage])

  const rescanDirectory = useCallback(async () => {
    setFontsLoading(true)
    setFontsError(null)

    try {
      const result = await fontManager.restoreDirectoryAccess()
      if (!result) {
        setFontsError('No fonts directory selected. Please select a folder first.')
        setFontsLoading(false)
        return
      }

      const scanResult = await fontManager.scanAndStoreFonts(result.handle)
      const storedFonts = await getAllFonts()
      await fontManager.loadFontsIntoDocument(storedFonts)
      await updateFontsFromStorage()
      setLastScanTime(Date.now())

      if (scanResult.errors.length > 0) {
        setFontsError(`Loaded ${scanResult.loaded} fonts. ${scanResult.errors.length} files failed to parse.`)
      }
    } catch (error) {
      setFontsError(error instanceof Error ? error.message : 'Failed to rescan fonts directory')
    } finally {
      setFontsLoading(false)
    }
  }, [setFontsLoading, setFontsError, setLastScanTime, updateFontsFromStorage])

  const clearDirectory = useCallback(async () => {
    await fontManager.clearLoadedFonts()
    await clearFontsState()
  }, [clearFontsState])

  const restoreOnMount = useCallback(async () => {
    setFontsLoading(true)
    try {
      // Try to restore from stored handle
      const result = await fontManager.restoreDirectoryAccess()
      if (result) {
        setFontsDirectoryPath(result.path)
      }

      // Load fonts from IndexedDB regardless of directory access
      const storedFonts = await getAllFonts()
      if (storedFonts.length > 0) {
        await fontManager.loadFontsIntoDocument(storedFonts)
        await updateFontsFromStorage()
      }
    } catch (error) {
      console.warn('Failed to restore fonts on mount:', error)
    } finally {
      setFontsLoading(false)
    }
  }, [setFontsLoading, setFontsDirectoryPath, updateFontsFromStorage])

  return {
    customFonts,
    fontsDirectoryPath,
    fontsLoading,
    fontsError,
    lastScanTime,
    selectDirectory,
    rescanDirectory,
    clearDirectory,
    restoreOnMount,
  }
}
```

**Important:** The import for `getAllFonts` must come directly from fontStorage:
```typescript
import { getAllFonts } from '../services/fonts/fontStorage'
```
This ensures the function is available. The barrel export in `src/services/fonts/index.ts` (from Plan 37-01) re-exports it, but importing directly from the source is clearer.
  </action>
  <verify>
    - `npx tsc --noEmit src/hooks/useFonts.ts` compiles
  </verify>
  <done>
    - useFonts hook created with all operations
    - Hook wraps fontManager service with React state
    - getAllFonts imported directly from fontStorage.ts
    - Error handling for all async operations
  </done>
</task>

<task type="auto">
  <name>Task 2: Create FontSettings component</name>
  <files>
    - src/components/Settings/FontSettings.tsx
  </files>
  <action>
Create `src/components/Settings/FontSettings.tsx` - the settings panel for font management.

**Component:**
```typescript
import { useEffect, useState } from 'react'
import { useFonts } from '../../hooks/useFonts'
import { formatDistanceToNow } from 'date-fns'

interface FontSettingsProps {
  isOpen: boolean
  onClose: () => void
}

export function FontSettings({ isOpen, onClose }: FontSettingsProps) {
  const {
    customFonts,
    fontsDirectoryPath,
    fontsLoading,
    fontsError,
    lastScanTime,
    selectDirectory,
    rescanDirectory,
    clearDirectory,
    restoreOnMount,
  } = useFonts()

  const [copied, setCopied] = useState(false)

  // Restore fonts on mount
  useEffect(() => {
    restoreOnMount()
  }, [restoreOnMount])

  // Copy path to clipboard
  const handleCopyPath = async () => {
    if (fontsDirectoryPath) {
      await navigator.clipboard.writeText(fontsDirectoryPath)
      setCopied(true)
      setTimeout(() => setCopied(false), 2000)
    }
  }

  if (!isOpen) return null

  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50">
      <div className="bg-gray-800 rounded-lg shadow-xl w-full max-w-md mx-4">
        {/* Header */}
        <div className="flex items-center justify-between p-4 border-b border-gray-700">
          <h2 className="text-lg font-semibold text-white">Font Settings</h2>
          <button
            onClick={onClose}
            className="text-gray-400 hover:text-white transition-colors"
          >
            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>

        {/* Content */}
        <div className="p-4 space-y-4">
          {/* Fonts Directory Section */}
          <div>
            <h3 className="text-sm font-medium text-gray-300 mb-2">Custom Fonts Directory</h3>

            {fontsDirectoryPath ? (
              <div className="space-y-2">
                {/* Path display with copy */}
                <div className="flex items-center gap-2">
                  <div className="flex-1 bg-gray-900 rounded px-3 py-2 text-sm text-gray-300 font-mono truncate">
                    {fontsDirectoryPath}
                  </div>
                  <button
                    onClick={handleCopyPath}
                    className="px-3 py-2 bg-gray-700 hover:bg-gray-600 rounded text-sm text-gray-300 transition-colors"
                    title="Copy path"
                  >
                    {copied ? 'Copied!' : 'Copy'}
                  </button>
                </div>

                {/* Action buttons */}
                <div className="flex gap-2">
                  <button
                    onClick={rescanDirectory}
                    disabled={fontsLoading}
                    className="flex-1 px-4 py-2 bg-blue-600 hover:bg-blue-500 disabled:bg-gray-600 disabled:cursor-not-allowed rounded text-sm text-white font-medium transition-colors"
                  >
                    {fontsLoading ? 'Scanning...' : 'Rescan Fonts'}
                  </button>
                  <button
                    onClick={selectDirectory}
                    disabled={fontsLoading}
                    className="px-4 py-2 bg-gray-700 hover:bg-gray-600 disabled:bg-gray-600 disabled:cursor-not-allowed rounded text-sm text-gray-300 transition-colors"
                  >
                    Change
                  </button>
                </div>
              </div>
            ) : (
              <button
                onClick={selectDirectory}
                disabled={fontsLoading}
                className="w-full px-4 py-3 bg-blue-600 hover:bg-blue-500 disabled:bg-gray-600 disabled:cursor-not-allowed rounded text-white font-medium transition-colors"
              >
                {fontsLoading ? 'Loading...' : 'Select Fonts Folder'}
              </button>
            )}
          </div>

          {/* Status Section */}
          <div className="bg-gray-900 rounded p-3 space-y-2">
            <div className="flex justify-between text-sm">
              <span className="text-gray-400">Custom fonts loaded:</span>
              <span className="text-white font-medium">{customFonts.length}</span>
            </div>
            {lastScanTime && (
              <div className="flex justify-between text-sm">
                <span className="text-gray-400">Last scan:</span>
                <span className="text-gray-300">
                  {formatDistanceToNow(lastScanTime, { addSuffix: true })}
                </span>
              </div>
            )}
          </div>

          {/* Error display */}
          {fontsError && (
            <div className="bg-red-900/30 border border-red-700 rounded p-3 text-sm text-red-300">
              {fontsError}
            </div>
          )}

          {/* Clear button */}
          {fontsDirectoryPath && (
            <button
              onClick={clearDirectory}
              className="w-full px-4 py-2 text-sm text-red-400 hover:text-red-300 hover:bg-red-900/20 rounded transition-colors"
            >
              Clear Custom Fonts
            </button>
          )}

          {/* Info text */}
          <p className="text-xs text-gray-500">
            Select a folder containing .ttf, .otf, .woff, or .woff2 font files.
            Fonts will be available in all font dropdowns and bundled with exports.
          </p>
        </div>
      </div>
    </div>
  )
}
```

Also create the Settings directory if needed:
```bash
mkdir -p src/components/Settings
```
  </action>
  <verify>
    - `npx tsc --noEmit src/components/Settings/FontSettings.tsx` compiles
  </verify>
  <done>
    - FontSettings component created with full UI
    - Select folder, rescan, copy path, clear functionality
    - Loading states and error display
    - Dark theme styling matching app
  </done>
</task>

<task type="auto">
  <name>Task 3: Add FontSettings access to LeftPanel</name>
  <files>
    - src/components/Layout/LeftPanel.tsx
  </files>
  <action>
Update `src/components/Layout/LeftPanel.tsx` to include a button to open FontSettings.

**Changes:**

1. Add imports at top:
```typescript
import { useState } from 'react'
import { FontSettings } from '../Settings/FontSettings'
```

2. Add state for dialog visibility inside LeftPanel component:
```typescript
const [fontSettingsOpen, setFontSettingsOpen] = useState(false)
```

3. Add a "Fonts" button in the logo/settings area (near the build timestamp):
Find the area with the logo and timestamp display. Add a fonts button nearby:

```tsx
{/* Fonts settings button */}
<button
  onClick={() => setFontSettingsOpen(true)}
  className="text-xs text-gray-400 hover:text-blue-400 transition-colors"
  title="Manage custom fonts"
>
  Fonts
</button>
```

4. Add the FontSettings dialog at the end of the component (before closing fragment/div):
```tsx
<FontSettings
  isOpen={fontSettingsOpen}
  onClose={() => setFontSettingsOpen(false)}
/>
```

**Placement guidance:**
Look for the section with `lastUpdated` or build info. Place the Fonts button in that area so it's accessible but not prominent. It should be near other settings/info elements.
  </action>
  <verify>
    - `npx tsc --noEmit src/components/Layout/LeftPanel.tsx` compiles
    - `npm run build` completes
  </verify>
  <done>
    - LeftPanel has Fonts button to open settings dialog
    - FontSettings dialog renders when button clicked
    - Full font management workflow accessible from UI
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `npm run build` completes without errors
2. Clicking "Fonts" button opens FontSettings dialog
3. "Select Fonts Folder" button works (opens file picker)
4. After selecting folder, fonts are scanned and count displayed
5. "Rescan Fonts" button triggers rescan
6. Path is copyable with copy button
7. Error messages display when operations fail
</verification>

<success_criteria>
- FontSettings dialog accessible from LeftPanel
- User can select fonts directory via file picker
- User can trigger manual rescan
- Folder path displayed with copy button
- Loading states shown during operations
- Font count and last scan time displayed
- Errors displayed clearly
</success_criteria>

<output>
After completion, create `.planning/phases/37-font-management-system/37-03-SUMMARY.md`
</output>
