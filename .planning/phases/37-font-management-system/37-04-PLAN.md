---
phase: 37-font-management-system
plan: 04
type: execute
wave: 2
depends_on: ["37-01", "37-02"]
files_modified:
  - src/components/Properties/shared/FontDropdown.tsx
  - src/components/Properties/LabelProperties.tsx
autonomous: true

must_haves:
  truths:
    - "Font dropdown shows built-in and custom fonts"
    - "Each font name displays in its own typeface (font preview)"
    - "Custom fonts appear in separate section from built-in"
    - "Font selection updates element property"
  artifacts:
    - path: "src/components/Properties/shared/FontDropdown.tsx"
      provides: "Custom font dropdown with preview"
      exports: ["FontDropdown"]
    - path: "src/components/Properties/LabelProperties.tsx"
      provides: "Label properties using FontDropdown"
      contains: "FontDropdown"
  key_links:
    - from: "src/components/Properties/shared/FontDropdown.tsx"
      to: "src/store/fontsSlice.ts"
      via: "store subscription"
      pattern: "useStore"
    - from: "src/components/Properties/LabelProperties.tsx"
      to: "src/components/Properties/shared/FontDropdown.tsx"
      via: "component usage"
      pattern: "FontDropdown"
---

<objective>
Create a custom font dropdown with font preview and integrate it into property panels.

Purpose: Replace native select elements with a custom dropdown that shows each font name in its own typeface. This enables users to visually preview fonts before selection, which is critical for design workflows.

Output: FontDropdown component that displays built-in and custom fonts with preview, integrated into LabelProperties and ready for other panels.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/37-font-management-system/37-RESEARCH.md

# Prior plan summaries (when available)
# @.planning/phases/37-font-management-system/37-01-SUMMARY.md
# @.planning/phases/37-font-management-system/37-02-SUMMARY.md

# Existing font dropdown usage
@src/components/Properties/LabelProperties.tsx

# Existing font registry
@src/services/fonts/fontRegistry.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create FontDropdown component</name>
  <files>
    - src/components/Properties/shared/FontDropdown.tsx
  </files>
  <action>
Create `src/components/Properties/shared/FontDropdown.tsx` - a custom dropdown that displays fonts in their own typeface.

**Design rationale:**
- Native select elements don't reliably render font-family per option across browsers (Firefox bug)
- Custom dropdown allows full styling control and font preview
- Dropdown uses click-outside to close (consistent with other dropdowns in app)
- Sections separate built-in and custom fonts for clarity

**Component:**
```typescript
import { useState, useRef, useEffect } from 'react'
import { useStore } from '../../../store'
import { AVAILABLE_FONTS } from '../../../services/fonts/fontRegistry'

interface FontDropdownProps {
  value: string                    // Current font-family value
  onChange: (family: string) => void
  label?: string
}

export function FontDropdown({ value, onChange, label = 'Font Family' }: FontDropdownProps) {
  const [isOpen, setIsOpen] = useState(false)
  const dropdownRef = useRef<HTMLDivElement>(null)
  const customFonts = useStore(state => state.customFonts)

  // Get display name for current value
  const currentFont = AVAILABLE_FONTS.find(f => f.family === value)
    || customFonts.find(f => f.family === value)
  const displayName = currentFont?.name || value

  // Click outside to close
  useEffect(() => {
    function handleClickOutside(event: MouseEvent) {
      if (dropdownRef.current && !dropdownRef.current.contains(event.target as Node)) {
        setIsOpen(false)
      }
    }

    if (isOpen) {
      document.addEventListener('mousedown', handleClickOutside)
      return () => document.removeEventListener('mousedown', handleClickOutside)
    }
  }, [isOpen])

  const handleSelect = (family: string) => {
    onChange(family)
    setIsOpen(false)
  }

  return (
    <div ref={dropdownRef} className="relative">
      <label className="block text-xs text-gray-400 mb-1">{label}</label>

      {/* Trigger button */}
      <button
        type="button"
        onClick={() => setIsOpen(!isOpen)}
        className="w-full flex items-center justify-between bg-gray-700 border border-gray-600 text-white rounded px-2 py-1.5 text-sm hover:bg-gray-650 transition-colors"
        style={{ fontFamily: value }}
      >
        <span className="truncate">{displayName}</span>
        <svg
          className={`w-4 h-4 ml-2 transition-transform ${isOpen ? 'rotate-180' : ''}`}
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
        </svg>
      </button>

      {/* Dropdown menu */}
      {isOpen && (
        <div className="absolute z-50 w-full mt-1 bg-gray-800 border border-gray-600 rounded shadow-lg max-h-64 overflow-y-auto">
          {/* Built-in fonts section */}
          <div className="px-2 py-1.5 text-xs text-gray-500 bg-gray-750 border-b border-gray-700">
            Built-in Fonts
          </div>
          {AVAILABLE_FONTS.map((font) => (
            <button
              key={font.family}
              type="button"
              onClick={() => handleSelect(font.family)}
              className={`w-full text-left px-3 py-2 text-sm hover:bg-gray-700 transition-colors ${
                value === font.family ? 'bg-blue-600/20 text-blue-300' : 'text-gray-300'
              }`}
              style={{ fontFamily: font.family }}
            >
              {font.name}
            </button>
          ))}

          {/* Custom fonts section (if any) */}
          {customFonts.length > 0 && (
            <>
              <div className="px-2 py-1.5 text-xs text-gray-500 bg-gray-750 border-t border-b border-gray-700">
                Custom Fonts ({customFonts.length})
              </div>
              {customFonts.map((font) => (
                <button
                  key={font.family}
                  type="button"
                  onClick={() => handleSelect(font.family)}
                  className={`w-full text-left px-3 py-2 text-sm hover:bg-gray-700 transition-colors ${
                    value === font.family ? 'bg-blue-600/20 text-blue-300' : 'text-gray-300'
                  }`}
                  style={{ fontFamily: font.family }}
                >
                  {font.name}
                </button>
              ))}
            </>
          )}
        </div>
      )}
    </div>
  )
}
```

**Styling notes:**
- `bg-gray-750` is between 700 and 800 - use `bg-gray-700/80` if not available
- Dropdown z-index 50 ensures it appears above other content
- Max height 64 (256px) with overflow scroll for long font lists
- Selected font highlighted with blue tint
  </action>
  <verify>
    - `npx tsc --noEmit src/components/Properties/shared/FontDropdown.tsx` compiles
  </verify>
  <done>
    - FontDropdown component created with custom dropdown UI
    - Shows fonts in their own typeface for preview
    - Separates built-in and custom fonts into sections
    - Click-outside closes dropdown
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate FontDropdown into LabelProperties</name>
  <files>
    - src/components/Properties/LabelProperties.tsx
  </files>
  <action>
Update `src/components/Properties/LabelProperties.tsx` to use FontDropdown instead of native select.

**Changes:**

1. Replace the select import with FontDropdown:
```typescript
import { FontDropdown } from './shared/FontDropdown'
```

2. Remove the AVAILABLE_FONTS import (no longer needed directly):
```typescript
// Remove: import { AVAILABLE_FONTS } from '../../services/fonts/fontRegistry'
```

3. Replace the font family select element with FontDropdown:

**Before:**
```tsx
<div>
  <label className="block text-xs text-gray-400 mb-1">Font Family</label>
  <select
    value={element.fontFamily}
    onChange={(e) => onUpdate({ fontFamily: e.target.value })}
    className="w-full bg-gray-700 border border-gray-600 text-white rounded px-2 py-1.5 text-sm"
  >
    {AVAILABLE_FONTS.map((font) => (
      <option key={font.name} value={font.family}>
        {font.name}
      </option>
    ))}
  </select>
  <p
    className="text-xs text-gray-500 mt-1"
    style={{
      fontFamily: element.fontFamily,
      fontWeight: element.fontWeight
    }}
  >
    Preview: {element.text || 'Sample Text'}
  </p>
</div>
```

**After:**
```tsx
<FontDropdown
  value={element.fontFamily}
  onChange={(fontFamily) => onUpdate({ fontFamily })}
/>
<p
  className="text-xs text-gray-500 mt-1"
  style={{
    fontFamily: element.fontFamily,
    fontWeight: element.fontWeight
  }}
>
  Preview: {element.text || 'Sample Text'}
</p>
```

The preview text below the dropdown is kept as it shows the selected font with the current weight applied.
  </action>
  <verify>
    - `npx tsc --noEmit src/components/Properties/LabelProperties.tsx` compiles
    - `npm run build` completes
  </verify>
  <done>
    - LabelProperties uses FontDropdown component
    - Native select replaced with custom dropdown
    - Font preview with weight still shown below dropdown
  </done>
</task>

<task type="auto">
  <name>Task 3: Create shared exports and update index</name>
  <files>
    - src/components/Properties/shared/index.ts
  </files>
  <action>
Create or update `src/components/Properties/shared/index.ts` to export FontDropdown.

**If file doesn't exist, create it:**
```typescript
export { FontDropdown } from './FontDropdown'
```

**If file exists, add the export:**
```typescript
export { FontDropdown } from './FontDropdown'
```

This enables clean imports like:
```typescript
import { FontDropdown } from './shared'
```
  </action>
  <verify>
    - `npx tsc --noEmit src/components/Properties/shared/index.ts` compiles
  </verify>
  <done>
    - FontDropdown exported from shared/index.ts
    - Clean import path available for other property panels
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `npm run build` completes without errors
2. Opening Label properties shows custom font dropdown
3. Dropdown shows built-in fonts section with fonts in their typeface
4. If custom fonts are loaded, they appear in separate section
5. Selecting a font updates the element
6. Font preview below dropdown updates correctly
</verification>

<success_criteria>
- FontDropdown component shows fonts in their own typeface
- Built-in and custom fonts in separate sections
- LabelProperties uses FontDropdown
- Click outside closes dropdown
- Selected font highlighted
- Works with both built-in and custom fonts
</success_criteria>

<output>
After completion, create `.planning/phases/37-font-management-system/37-04-SUMMARY.md`
</output>
