---
phase: 53-foundation
plan: 02
type: execute
wave: 2
depends_on: ["53-01"]
files_modified:
  - src/services/elementLayers.ts
  - src/services/svgLayerDetection.ts
autonomous: true

must_haves:
  truths:
    - "detectElementLayers() identifies layers for any category from SVG content"
    - "Layer detection uses category-specific naming conventions"
    - "Extracted layers preserve viewBox coordinates"
  artifacts:
    - path: "src/services/elementLayers.ts"
      provides: "Generalized layer detection and extraction"
      exports: ["detectElementLayers", "extractElementLayer", "getLayerConventionsForCategory"]
    - path: "src/services/svgLayerDetection.ts"
      provides: "Updated detection using new service"
      contains: "detectElementLayers"
  key_links:
    - from: "src/services/elementLayers.ts"
      to: "src/types/elementStyle.ts"
      via: "import ElementCategory type"
      pattern: "import.*ElementCategory.*from.*elementStyle"
    - from: "src/services/elementLayers.ts"
      to: "src/services/export/svgElementExport.ts"
      via: "uses LAYER_CONVENTIONS"
      pattern: "LAYER_CONVENTIONS"
---

<objective>
Create generalized layer detection service that works for all element categories.

Purpose: Enable SVG import workflow for sliders, buttons, meters, and other controls - not just knobs. The service detects which SVG layers match expected naming conventions for a given category.

Output:
- detectElementLayers(svgContent, category) function
- extractElementLayer(svgContent, layerId) function with viewBox preservation
- getLayerConventionsForCategory(category) function
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/53-foundation/53-RESEARCH.md
@.planning/phases/53-foundation/53-01-SUMMARY.md

# Existing patterns to follow
@src/services/knobLayers.ts
@src/services/svgLayerDetection.ts
@src/services/export/svgElementExport.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create elementLayers.ts service</name>
  <files>src/services/elementLayers.ts</files>
  <action>
Create new file src/services/elementLayers.ts based on patterns from knobLayers.ts and svgLayerDetection.ts:

1. Import ElementCategory from types/elementStyle.ts
2. Import LAYER_CONVENTIONS from export/svgElementExport.ts

3. CATEGORY_TO_CONVENTION map (maps our 5 categories to LAYER_CONVENTIONS keys):
   ```typescript
   const CATEGORY_TO_CONVENTION: Record<ElementCategory, keyof typeof LAYER_CONVENTIONS> = {
     rotary: 'knob',
     linear: 'slider',
     arc: 'slider',  // Arc uses slider conventions (thumb, track, fill)
     button: 'button',
     meter: 'meter',
   }
   ```

4. getLayerConventionsForCategory(category: ElementCategory): string[]
   - Returns LAYER_CONVENTIONS[CATEGORY_TO_CONVENTION[category]]

5. DetectedElementLayers interface:
   ```typescript
   interface DetectedElementLayers {
     [layerRole: string]: string[]  // Multiple possible matches per role
   }
   ```

6. detectElementLayers(svgContent: string, category: ElementCategory): DetectedElementLayers
   - Parse SVG with DOMParser
   - Check for parsererror
   - Get conventions for category
   - Initialize empty arrays for each expected layer role
   - Scan all SVG elements (skip svg, defs, clippath, mask, gradients, pattern, filter, style)
   - For each element with id or class:
     - Extract identifier (id or first class)
     - Convert to lowercase for matching
     - Match against each convention pattern (use layer key as pattern, e.g., "indicator", "thumb")
     - If match found, push identifier to detected[role] array
   - Return detected layers

7. extractElementLayer(svgContent: string, layerIdentifier: string): string
   - Parse SVG with DOMParser
   - Find element by id (with CSS.escape) or class
   - Clone the element
   - Get original SVG's viewBox, width, height
   - Create new SVG wrapper with same viewBox
   - Append cloned element
   - Serialize with XMLSerializer
   - Return new SVG string

Use escapeCSSSelector helper (inline or import from svgLayerDetection.ts).

Add JSDoc comments explaining each function.
  </action>
  <verify>
Run `npx tsc --noEmit` - no type errors.
Manual test: Call detectElementLayers with sample SVG containing "slider-thumb" and "slider-track" ids, verify they're detected in 'linear' category.
  </verify>
  <done>
detectElementLayers(svgContent, category) returns detected layers by role.
extractElementLayer preserves viewBox from original SVG.
getLayerConventionsForCategory returns correct conventions array.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update svgLayerDetection.ts to use new service</name>
  <files>src/services/svgLayerDetection.ts</files>
  <action>
Update src/services/svgLayerDetection.ts to optionally use the new category-aware detection:

1. Import detectElementLayers from './elementLayers'
2. Import ElementCategory from '../types/elementStyle'

3. Add new function detectLayersForCategory(svgContent: string, category: ElementCategory):
   - Calls detectElementLayers(svgContent, category)
   - Returns LayerDetectionResult format (matched, unmapped, missing, allLayers)
   - This provides a bridge between the new category-based detection and existing LayerDetectionResult interface

4. Keep existing detectLayersForType function working (backward compatibility)
   - It still uses element type strings like "knob", "slider"

5. Update getExpectedLayersForType to handle additional category mappings:
   - Add cases for 'arc', 'rotary', 'linear', 'button', 'meter' as direct category inputs
   - This allows callers to pass either element type ("slider") or category ("linear")

Do NOT break existing functionality - this is additive only.
  </action>
  <verify>
Run `npx tsc --noEmit` - no type errors.
Existing detectLayersForType still works with "knob", "slider" inputs.
New detectLayersForCategory works with ElementCategory inputs.
  </verify>
  <done>
detectLayersForCategory function added for category-aware detection.
Existing detectLayersForType still works (backward compatible).
Both functions return consistent LayerDetectionResult format.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. detectElementLayers identifies layers correctly for all 5 categories
3. extractElementLayer creates valid SVG with preserved viewBox
4. Existing detection functions still work
</verification>

<success_criteria>
- [ ] src/services/elementLayers.ts exists with all exports
- [ ] detectElementLayers works for rotary, linear, arc, button, meter
- [ ] extractElementLayer preserves viewBox from source SVG
- [ ] svgLayerDetection.ts has new detectLayersForCategory function
- [ ] Backward compatibility maintained
- [ ] TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/53-foundation/53-02-SUMMARY.md`
</output>
