---
phase: 53-foundation
plan: 03
type: execute
wave: 2
depends_on: ["53-01"]
files_modified:
  - src/schemas/project.ts
  - src/services/serialization.ts
autonomous: true

must_haves:
  truths:
    - "Project schema v3.0.0 includes elementStyles array"
    - "Old v2.0.0 projects auto-migrate knobStyles to elementStyles on load"
    - "knobStyles array preserved for backward compatibility"
    - "Projects save and load elementStyles correctly"
  artifacts:
    - path: "src/schemas/project.ts"
      provides: "v3.0.0 schema with ElementStyleSchema"
      exports: ["ElementStyleSchema", "ProjectSchemaV3"]
      contains: "elementStyles"
    - path: "src/services/serialization.ts"
      provides: "Migration from v2 to v3"
      contains: "migrateV2ToV3"
  key_links:
    - from: "src/schemas/project.ts"
      to: "src/types/elementStyle.ts"
      via: "schema mirrors type"
      pattern: "ElementStyleSchema"
    - from: "src/services/serialization.ts"
      to: "src/schemas/project.ts"
      via: "imports schema"
      pattern: "ProjectSchemaV3"
---

<objective>
Extend project schema to v3.0.0 with elementStyles and implement automatic migration.

Purpose: Enable saving and loading of element styles across all categories. Old projects with knobStyles auto-migrate to also have elementStyles (additive migration - don't delete knobStyles).

Output:
- Project schema v3.0.0 with elementStyles array
- Migration function v2.0.0 -> v3.0.0
- Updated serialization with elementStyles support
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/53-foundation/53-RESEARCH.md
@.planning/phases/53-foundation/53-01-SUMMARY.md

# Existing patterns to follow
@src/schemas/project.ts
@src/services/serialization.ts
@src/types/elementStyle.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add ElementStyleSchema and v3.0.0 to project.ts</name>
  <files>src/schemas/project.ts</files>
  <action>
Update src/schemas/project.ts:

1. Create layer schemas for each category:
   ```typescript
   const RotaryLayersSchema = z.object({
     indicator: z.string().optional(),
     track: z.string().optional(),
     arc: z.string().optional(),
     glow: z.string().optional(),
     shadow: z.string().optional(),
   })

   const LinearLayersSchema = z.object({
     thumb: z.string().optional(),
     track: z.string().optional(),
     fill: z.string().optional(),
   })

   const ArcLayersSchema = z.object({
     thumb: z.string().optional(),
     track: z.string().optional(),
     fill: z.string().optional(),
     arc: z.string().optional(),
   })

   const ButtonLayersSchema = z.object({
     body: z.string().optional(),
     label: z.string().optional(),
     icon: z.string().optional(),
     pressed: z.string().optional(),
     normal: z.string().optional(),
   })

   const MeterLayersSchema = z.object({
     body: z.string().optional(),
     fill: z.string().optional(),
     scale: z.string().optional(),
     peak: z.string().optional(),
     segments: z.string().optional(),
   })
   ```

2. Create ElementStyleSchema as discriminated union:
   ```typescript
   export const ElementStyleSchema = z.discriminatedUnion('category', [
     z.object({
       category: z.literal('rotary'),
       id: z.string(),
       name: z.string(),
       svgContent: z.string(),
       layers: RotaryLayersSchema,
       minAngle: z.number(),
       maxAngle: z.number(),
       createdAt: z.number(),
     }),
     z.object({
       category: z.literal('linear'),
       id: z.string(),
       name: z.string(),
       svgContent: z.string(),
       layers: LinearLayersSchema,
       createdAt: z.number(),
     }),
     z.object({
       category: z.literal('arc'),
       id: z.string(),
       name: z.string(),
       svgContent: z.string(),
       layers: ArcLayersSchema,
       minAngle: z.number(),
       maxAngle: z.number(),
       arcRadius: z.number(),
       createdAt: z.number(),
     }),
     z.object({
       category: z.literal('button'),
       id: z.string(),
       name: z.string(),
       svgContent: z.string(),
       layers: ButtonLayersSchema,
       createdAt: z.number(),
     }),
     z.object({
       category: z.literal('meter'),
       id: z.string(),
       name: z.string(),
       svgContent: z.string(),
       layers: MeterLayersSchema,
       createdAt: z.number(),
     }),
   ])

   export type ElementStyle = z.infer<typeof ElementStyleSchema>
   ```

3. Create ProjectSchemaV3 (copy V2 and add elementStyles):
   ```typescript
   export const ProjectSchemaV3 = z.object({
     version: z.string(),
     windows: z.array(UIWindowSchema),
     elements: z.array(ElementConfigSchema),
     assets: z.array(SVGAssetSchema).optional().default([]),
     knobStyles: z.array(KnobStyleSchema).optional().default([]), // Keep for backward compat
     elementStyles: z.array(ElementStyleSchema).optional().default([]), // NEW
     layers: z.array(LayerSchema).optional().default([]),
     selectedIds: z.array(z.string()).optional(),
     snapToGrid: z.boolean().optional().default(false),
     gridSize: z.number().optional().default(10),
     showGrid: z.boolean().optional().default(false),
     gridColor: z.string().optional().default('#ffffff'),
     lastModified: z.number().optional(),
   })
   ```

4. Update ProjectSchema union to include V3:
   ```typescript
   export const ProjectSchema = z.union([ProjectSchemaV3, ProjectSchemaV2, ProjectSchemaV1])
   ```

5. Update exported types:
   ```typescript
   export type ProjectDataV3 = z.infer<typeof ProjectSchemaV3>
   export type ProjectData = ProjectDataV3 // v3 is now canonical
   ```

6. Export ElementStyleSchema and ProjectSchemaV3.
  </action>
  <verify>
Run `npx tsc --noEmit` - no type errors.
ElementStyleSchema validates sample data correctly.
  </verify>
  <done>
ElementStyleSchema is discriminated union with 5 variants.
ProjectSchemaV3 includes elementStyles array.
ProjectData type is now v3 format.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update serialization with v3 migration</name>
  <files>src/services/serialization.ts</files>
  <action>
Update src/services/serialization.ts:

1. Update CURRENT_VERSION to '3.0.0'

2. Update SUPPORTED_VERSIONS to include '3.0.0':
   ```typescript
   const SUPPORTED_VERSIONS = ['1.0.0', '1.0', '2.0.0', '3.0.0']
   ```

3. Update SerializationInput interface to include elementStyles:
   ```typescript
   export interface SerializationInput {
     // ... existing fields
     elementStyles: import('../types/elementStyle').ElementStyle[]
   }
   ```

4. Update serializeProject to save version 3.0.0 and include elementStyles:
   ```typescript
   const projectData: ProjectData = {
     version: '3.0.0',
     // ... existing fields
     elementStyles: state.elementStyles,
     // ... rest
   }
   ```

5. Import ProjectSchemaV3 and ElementStyle type

6. Add isV2Format check function:
   ```typescript
   function isV2Format(data: unknown): data is ProjectDataV2 {
     if (typeof data !== 'object' || data === null) return false
     const obj = data as Record<string, unknown>
     // Has windows (v2+) but no elementStyles or version is 2.x
     if ('windows' in obj) {
       if (!('elementStyles' in obj)) return true
       if (typeof obj.version === 'string' && obj.version.startsWith('2.')) return true
     }
     return false
   }
   ```

7. Add migrateV2ToV3 function:
   ```typescript
   function migrateV2ToV3(data: ProjectDataV2): ProjectDataV3 {
     // Auto-migrate knobStyles to elementStyles (additive)
     const migratedElementStyles: ElementStyle[] = (data.knobStyles || []).map(ks => ({
       category: 'rotary' as const,
       id: ks.id,
       name: ks.name,
       svgContent: ks.svgContent,
       layers: {
         indicator: ks.layers.indicator,
         track: ks.layers.track,
         arc: ks.layers.arc,
         glow: ks.layers.glow,
         shadow: ks.layers.shadow,
       },
       minAngle: ks.minAngle,
       maxAngle: ks.maxAngle,
       createdAt: ks.createdAt,
     }))

     return {
       ...data,
       version: '3.0.0',
       elementStyles: migratedElementStyles,
       // Keep knobStyles for backward compat (don't delete)
       knobStyles: data.knobStyles || [],
     }
   }
   ```

8. Update migrateProject to handle v2 -> v3:
   - After v1 check, add v2 check: if (isV2Format(data)) return migrateV2ToV3(data)

9. Update deserializeProject to validate against V3 schema:
   - Change ProjectSchemaV2.safeParse to ProjectSchemaV3.safeParse

10. Add re-sanitization for elementStyles SVG content (same as knobStyles):
    ```typescript
    if (data.elementStyles && data.elementStyles.length > 0) {
      data.elementStyles = data.elementStyles.map(style => {
        const resanitized = sanitizeSVG(style.svgContent)
        if (resanitized !== style.svgContent) {
          console.warn(`Element style "${style.name}" was modified during re-sanitization`)
        }
        return { ...style, svgContent: resanitized }
      })
    }
    ```

11. Update version check to allow v3:
    ```typescript
    const majorVersion = parseInt(version.split('.')[0] || '0')
    if (majorVersion < 1 || majorVersion > 3) {
      // ...
    }
    ```
  </action>
  <verify>
Run `npx tsc --noEmit` - no type errors.
Test migration: Load a v2.0.0 project file, verify it migrates to v3.0.0 with elementStyles array.
Save project, verify JSON contains version "3.0.0" and elementStyles array.
  </verify>
  <done>
CURRENT_VERSION is '3.0.0'.
v2 projects auto-migrate to v3 with knobStyles converted to elementStyles.
knobStyles preserved for backward compatibility.
elementStyles saved and loaded correctly.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. Open existing project with knobStyles, verify elementStyles populated
3. Save project, verify v3.0.0 format with elementStyles
4. Load saved project, verify data intact
</verification>

<success_criteria>
- [ ] ElementStyleSchema is Zod discriminated union
- [ ] ProjectSchemaV3 includes elementStyles
- [ ] CURRENT_VERSION is '3.0.0'
- [ ] migrateV2ToV3 converts knobStyles to elementStyles
- [ ] Backward compatibility: knobStyles not deleted
- [ ] Re-sanitization applied to elementStyles SVG
- [ ] TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/53-foundation/53-03-SUMMARY.md`
</output>
