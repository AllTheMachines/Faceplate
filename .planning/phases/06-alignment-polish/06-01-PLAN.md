---
phase: 06-alignment-polish
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/Canvas/hooks/useCopyPaste.ts
  - src/components/Canvas/hooks/useKeyboardShortcuts.ts
autonomous: true

must_haves:
  truths:
    - "User can copy selected elements with Ctrl+C"
    - "User can paste copied elements with Ctrl+V"
    - "Pasted elements appear 20px offset from originals"
    - "Pasted elements have new UUIDs (no ID conflicts)"
    - "Pasted elements become selected after paste"
    - "Paste operation is undoable with Ctrl+Z"
  artifacts:
    - path: "src/components/Canvas/hooks/useCopyPaste.ts"
      provides: "Copy/paste logic with in-memory clipboard"
      exports: ["useCopyPaste"]
    - path: "src/components/Canvas/hooks/useKeyboardShortcuts.ts"
      provides: "Ctrl+C and Ctrl+V keyboard shortcuts"
      contains: "mod+c"
  key_links:
    - from: "useCopyPaste.ts"
      to: "useStore"
      via: "getElement, addElement, clearSelection, selectMultiple"
      pattern: "useStore.*getElement|addElement"
    - from: "useKeyboardShortcuts.ts"
      to: "useCopyPaste.ts"
      via: "copyToClipboard, pasteFromClipboard"
      pattern: "useCopyPaste"
---

<objective>
Implement copy/paste functionality for canvas elements using Ctrl+C/Ctrl+V keyboard shortcuts.

Purpose: Enable users to efficiently duplicate and reposition elements, which is essential for creating complex UIs with repeated controls (e.g., channel strips with multiple identical faders).

Output: Working copy/paste with proper deep cloning, UUID regeneration, position offset, and undo support.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-alignment-polish/06-RESEARCH.md

# Existing keyboard shortcuts infrastructure
@src/components/Canvas/hooks/useKeyboardShortcuts.ts

# Store with element actions
@src/store/elementsSlice.ts
@src/store/index.ts

# Element types (need deep clone for nested objects like colorStops)
@src/types/elements.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useCopyPaste hook with in-memory clipboard</name>
  <files>src/components/Canvas/hooks/useCopyPaste.ts</files>
  <action>
Create a new hook `useCopyPaste` that manages copy/paste operations:

1. Use `useRef<ElementConfig[]>([])` for in-memory clipboard storage (primary clipboard)

2. Implement `copyToClipboard()`:
   - Get selected element IDs from store via `useStore((state) => state.selectedIds)`
   - Map IDs to elements using `getElement(id)`
   - Filter out undefined results
   - Store elements array in clipboardRef.current
   - Optionally write JSON to system clipboard via `navigator.clipboard.writeText()` wrapped in try/catch (non-blocking, for debugging)

3. Implement `pasteFromClipboard()`:
   - Return early if clipboardRef.current is empty
   - Define PASTE_OFFSET = 20 (pixels)
   - For each element in clipboard:
     - Use `structuredClone(original)` for deep clone (handles nested objects like colorStops in meters)
     - Generate new ID: `id: crypto.randomUUID()`
     - Offset position: `x: cloned.x + PASTE_OFFSET, y: cloned.y + PASTE_OFFSET`
     - Call `addElement(pasted)` - this is automatically tracked by zundo for undo
     - Collect pasted IDs
   - After all elements pasted, select them: `clearSelection()` then `selectMultiple(pastedIds)`

4. Return `{ copyToClipboard, pasteFromClipboard }` from hook

Use these store selectors:
- `selectedIds`: `useStore((state) => state.selectedIds)`
- `getElement`: `useStore((state) => state.getElement)`
- `addElement`: `useStore((state) => state.addElement)`
- `clearSelection`: `useStore((state) => state.clearSelection)`
- `selectMultiple`: `useStore((state) => state.selectMultiple)`

Do NOT use enableOnFormTags in this hook - that's for the keyboard shortcuts in useKeyboardShortcuts.ts.
  </action>
  <verify>
File exists with correct exports:
```bash
grep -q "export function useCopyPaste" src/components/Canvas/hooks/useCopyPaste.ts && echo "Hook exported"
grep -q "structuredClone" src/components/Canvas/hooks/useCopyPaste.ts && echo "Uses structuredClone"
grep -q "crypto.randomUUID" src/components/Canvas/hooks/useCopyPaste.ts && echo "Generates new UUIDs"
```
TypeScript compiles without errors: `npx tsc --noEmit`
  </verify>
  <done>
useCopyPaste hook exists with copyToClipboard and pasteFromClipboard functions that deep clone elements, generate new UUIDs, and offset positions by 20px.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Ctrl+C and Ctrl+V shortcuts to useKeyboardShortcuts</name>
  <files>src/components/Canvas/hooks/useKeyboardShortcuts.ts</files>
  <action>
Modify the existing useKeyboardShortcuts hook to add copy/paste shortcuts:

1. Import useCopyPaste hook:
   ```typescript
   import { useCopyPaste } from './useCopyPaste'
   ```

2. Call the hook at the top of useKeyboardShortcuts function:
   ```typescript
   const { copyToClipboard, pasteFromClipboard } = useCopyPaste()
   ```

3. Add Copy shortcut (Ctrl+C / Cmd+C):
   ```typescript
   useHotkeys(
     'mod+c',
     (e) => {
       e.preventDefault()
       copyToClipboard()
     },
     { enableOnFormTags: false }
   )
   ```

4. Add Paste shortcut (Ctrl+V / Cmd+V):
   ```typescript
   useHotkeys(
     'mod+v',
     (e) => {
       e.preventDefault()
       pasteFromClipboard()
     },
     { enableOnFormTags: false }
   )
   ```

Note: Use 'mod+c' and 'mod+v' (not 'ctrl+c, meta+c') - the 'mod' modifier in react-hotkeys-hook automatically maps to Ctrl on Windows/Linux and Cmd on Mac.

Use `enableOnFormTags: false` to prevent copy/paste shortcuts from firing when user is typing in property panel inputs - this matches the pattern used for z-order shortcuts.
  </action>
  <verify>
Shortcuts added correctly:
```bash
grep -q "mod+c" src/components/Canvas/hooks/useKeyboardShortcuts.ts && echo "Copy shortcut added"
grep -q "mod+v" src/components/Canvas/hooks/useKeyboardShortcuts.ts && echo "Paste shortcut added"
grep -q "useCopyPaste" src/components/Canvas/hooks/useKeyboardShortcuts.ts && echo "Hook imported"
```
TypeScript compiles: `npx tsc --noEmit`
App runs without errors: `npm run dev` (check no console errors)
  </verify>
  <done>
Ctrl+C copies selected elements to clipboard, Ctrl+V pastes elements at 20px offset with new UUIDs. Shortcuts don't fire when typing in form inputs.
  </done>
</task>

</tasks>

<verification>
## Functional Tests

1. **Copy single element:**
   - Add a knob to canvas via palette
   - Select it (click)
   - Press Ctrl+C (no visible change - copied to memory)
   - Press Ctrl+V
   - Verify: New knob appears 20px down and right from original
   - Verify: New knob is now selected (blue border), original is deselected

2. **Copy multiple elements:**
   - Add knob and slider to canvas
   - Marquee select both
   - Press Ctrl+C
   - Press Ctrl+V
   - Verify: Two new elements appear offset from originals
   - Verify: Both pasted elements are selected

3. **Unique IDs on paste:**
   - Copy and paste an element
   - Select original, verify only original has blue border
   - Select pasted, verify only pasted has blue border
   - Delete pasted, verify original remains

4. **Undo paste:**
   - Paste elements
   - Press Ctrl+Z
   - Verify: Pasted elements disappear

5. **Form input protection:**
   - Select an element
   - Click in a text input in property panel
   - Type "Ctrl+C"
   - Verify: Letter "c" appears (not copy triggered)

6. **Deep clone (meter with colorStops):**
   - Add a meter via palette
   - Copy and paste it
   - Select pasted meter, change a color stop color
   - Verify: Original meter color stops unchanged
</verification>

<success_criteria>
- [ ] Ctrl+C copies all selected elements to in-memory clipboard
- [ ] Ctrl+V creates new elements with unique UUIDs
- [ ] Pasted elements offset by 20px on both x and y axes
- [ ] Pasted elements become selected (original selection cleared)
- [ ] Ctrl+Z undoes paste operation
- [ ] Shortcuts disabled in form inputs (enableOnFormTags: false)
- [ ] Deep clone works for elements with nested objects (meters)
- [ ] TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/06-alignment-polish/06-01-SUMMARY.md`
</output>
