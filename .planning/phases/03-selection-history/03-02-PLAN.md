---
phase: 03-selection-history
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/components/Canvas/SelectionOverlay.tsx
  - src/components/Canvas/hooks/useKeyboardShortcuts.ts
  - src/components/Canvas/hooks/index.ts
  - src/components/Canvas/Canvas.tsx
autonomous: true

must_haves:
  truths:
    - "Selected elements show visual feedback (blue border)"
    - "User can undo with Ctrl+Z"
    - "User can redo with Ctrl+Y"
    - "User can delete selected elements with Delete/Backspace"
    - "User can clear selection with Escape"
  artifacts:
    - path: "src/components/Canvas/SelectionOverlay.tsx"
      provides: "Visual selection indicator"
      min_lines: 30
    - path: "src/components/Canvas/hooks/useKeyboardShortcuts.ts"
      provides: "Keyboard shortcut handling"
      exports: ["useKeyboardShortcuts"]
  key_links:
    - from: "src/components/Canvas/hooks/useKeyboardShortcuts.ts"
      to: "useStore.temporal"
      via: "zundo temporal API"
      pattern: "undo|redo"
    - from: "src/components/Canvas/SelectionOverlay.tsx"
      to: "selectedIds state"
      via: "useStore selector"
      pattern: "selectedIds"
---

<objective>
Add selection visuals and keyboard shortcuts for undo/redo/delete.

Purpose: Users need visual feedback to know what's selected, and keyboard shortcuts are the primary way to interact with undo/redo. This plan makes selection visible and wires up essential keyboard commands.

Output: SelectionOverlay component showing selected elements, useKeyboardShortcuts hook with Ctrl+Z/Y/Delete/Escape.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-selection-history/03-CONTEXT.md
@.planning/phases/03-selection-history/03-RESEARCH.md
@src/store/elementsSlice.ts
@src/store/index.ts
@src/components/Canvas/Canvas.tsx
@src/components/elements/BaseElement.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SelectionOverlay component</name>
  <files>src/components/Canvas/SelectionOverlay.tsx</files>
  <action>
Create a component that renders selection visuals (blue border + resize handles) for selected elements.

**Props:**
```typescript
interface SelectionOverlayProps {
  elementId: string
}
```

**Implementation:**
1. Get element from store using `useStore(state => state.getElement(elementId))`
2. If element not found, return null
3. Render a div positioned absolutely at element's x, y, width, height
4. Style with:
   - `border: 2px solid #3b82f6` (blue-500)
   - `pointerEvents: 'none'` (don't capture clicks)
   - `position: 'absolute'`
   - Match element's rotation transform
5. Add resize handles at corners and edges (8 handles total):
   - 4 corners: nw, ne, sw, se
   - 4 edges: n, s, e, w (centered on edge)
   - Each handle: 8x8px white square with blue border
   - Handles positioned outside the selection border
   - For now, handles are visual only (resize is Phase 5)

**Handle positioning (relative to selection box):**
- nw: left: -4px, top: -4px
- ne: right: -4px, top: -4px
- sw: left: -4px, bottom: -4px
- se: right: -4px, bottom: -4px
- n: left: 50%, top: -4px, transform: translateX(-50%)
- s: left: 50%, bottom: -4px, transform: translateX(-50%)
- e: right: -4px, top: 50%, transform: translateY(-50%)
- w: left: -4px, top: 50%, transform: translateY(-50%)

**Note:** Handles are decorative in this phase. Interactive resize comes in Phase 5.
  </action>
  <verify>Component renders without errors when element exists</verify>
  <done>SelectionOverlay shows blue border and 8 resize handles around selected element</done>
</task>

<task type="auto">
  <name>Task 2: Create useKeyboardShortcuts hook</name>
  <files>src/components/Canvas/hooks/useKeyboardShortcuts.ts, src/components/Canvas/hooks/index.ts</files>
  <action>
Create a hook using react-hotkeys-hook for keyboard shortcuts.

**Shortcuts to implement:**
1. `ctrl+z` - Undo: call `useStore.temporal.getState().undo()`
2. `ctrl+y` or `ctrl+shift+z` - Redo: call `useStore.temporal.getState().redo()`
3. `delete` or `backspace` - Delete selected: remove all elements in selectedIds, then clearSelection
4. `escape` - Clear selection: call clearSelection()

**Implementation:**
```typescript
import { useHotkeys } from 'react-hotkeys-hook'
import { useStore } from '../../../store'

export function useKeyboardShortcuts() {
  const selectedIds = useStore((state) => state.selectedIds)
  const removeElement = useStore((state) => state.removeElement)
  const clearSelection = useStore((state) => state.clearSelection)

  // Undo
  useHotkeys('ctrl+z', () => {
    useStore.temporal.getState().undo()
  }, { preventDefault: true })

  // Redo (both Ctrl+Y and Ctrl+Shift+Z)
  useHotkeys('ctrl+y, ctrl+shift+z', () => {
    useStore.temporal.getState().redo()
  }, { preventDefault: true })

  // Delete selected elements
  useHotkeys('delete, backspace', () => {
    if (selectedIds.length > 0) {
      selectedIds.forEach((id) => removeElement(id))
      clearSelection()
    }
  }, { preventDefault: true }, [selectedIds, removeElement, clearSelection])

  // Clear selection
  useHotkeys('escape', () => {
    clearSelection()
  }, [clearSelection])
}
```

**Important:**
- Pass dependency arrays to useHotkeys for callbacks that use state
- Use `preventDefault: true` for Ctrl+Z/Y to prevent browser default
- Delete should only act if there are selected elements

**Update hooks/index.ts:**
Add export: `export { useKeyboardShortcuts } from './useKeyboardShortcuts'`
  </action>
  <verify>Hook compiles without errors, shortcuts can be tested manually after Canvas integration</verify>
  <done>useKeyboardShortcuts exports from hooks/index.ts with all 4 shortcuts implemented</done>
</task>

<task type="auto">
  <name>Task 3: Integrate into Canvas component</name>
  <files>src/components/Canvas/Canvas.tsx</files>
  <action>
Wire up SelectionOverlay and useKeyboardShortcuts into the Canvas.

**Changes to Canvas.tsx:**

1. Import SelectionOverlay and useKeyboardShortcuts:
```typescript
import { SelectionOverlay } from './SelectionOverlay'
import { usePan, useZoom, useKeyboardShortcuts } from './hooks'
```

2. Add selectedIds selector:
```typescript
const selectedIds = useStore((state) => state.selectedIds)
```

3. Call useKeyboardShortcuts:
```typescript
useKeyboardShortcuts()
```

4. Render SelectionOverlay for each selected element (inside canvas-background div, after elements):
```typescript
{/* Selection overlays */}
{selectedIds.map((id) => (
  <SelectionOverlay key={`selection-${id}`} elementId={id} />
))}
```

**Ordering matters:** Selection overlays should render AFTER elements so they appear on top (or use higher zIndex).
  </action>
  <verify>`npm run build` succeeds, app displays without errors</verify>
  <done>Canvas renders selection overlays for selected elements and responds to keyboard shortcuts</done>
</task>

</tasks>

<verification>
1. `npm run build` completes without errors
2. Selection overlay component exists with proper styling
3. Keyboard shortcuts hook uses react-hotkeys-hook
4. Canvas imports and uses both SelectionOverlay and useKeyboardShortcuts
5. Manual test: Ctrl+Z/Y work (check console for undo/redo calls if no elements to undo)
</verification>

<success_criteria>
- Selected elements show blue border with 8 resize handles
- Ctrl+Z triggers undo
- Ctrl+Y or Ctrl+Shift+Z triggers redo
- Delete/Backspace removes selected elements
- Escape clears selection
- All visuals render correctly within canvas transforms (zoom/pan)
</success_criteria>

<output>
After completion, create `.planning/phases/03-selection-history/03-02-SUMMARY.md`
</output>
