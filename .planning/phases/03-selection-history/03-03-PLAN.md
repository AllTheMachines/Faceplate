---
phase: 03-selection-history
plan: 03
type: execute
wave: 3
depends_on: ["03-02"]
files_modified:
  - src/components/elements/Element.tsx
  - src/components/Canvas/Canvas.tsx
autonomous: true

must_haves:
  truths:
    - "User can click an element to select it (single selection)"
    - "User can Shift+click to add element to selection (multi-select)"
    - "User can Ctrl/Cmd+click to toggle element in selection"
    - "Clicking canvas background clears selection"
  artifacts:
    - path: "src/components/elements/Element.tsx"
      provides: "Click handlers for selection"
      contains: "onClick"
    - path: "src/components/Canvas/Canvas.tsx"
      provides: "Background click handler"
      contains: "clearSelection"
  key_links:
    - from: "src/components/elements/Element.tsx"
      to: "selectElement|toggleSelection|addToSelection"
      via: "click event handler"
      pattern: "onClick.*select"
---

<objective>
Implement click-to-select functionality on elements.

Purpose: Click selection is the primary way users select elements for editing. This enables CANV-04 (click to select single element) and CANV-05 (Shift+click for multi-select).

Output: Elements respond to clicks with appropriate selection behavior based on modifier keys.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-selection-history/03-CONTEXT.md
@.planning/phases/03-selection-history/03-RESEARCH.md
@src/components/elements/Element.tsx
@src/components/elements/BaseElement.tsx
@src/components/Canvas/Canvas.tsx
@src/store/elementsSlice.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add click handlers to Element component</name>
  <files>src/components/elements/Element.tsx</files>
  <action>
Modify the Element component to handle click events for selection.

**Selection behavior (from research):**
1. **Plain click:** Select this element only (clear previous selection)
2. **Shift+click:** Add to selection (range selection would require z-order, simplified to addToSelection)
3. **Ctrl/Cmd+click:** Toggle element in selection

**Implementation:**

1. Import selection actions from store:
```typescript
import { useStore } from '../../store'
```

2. Get selection actions:
```typescript
const selectElement = useStore((state) => state.selectElement)
const toggleSelection = useStore((state) => state.toggleSelection)
const addToSelection = useStore((state) => state.addToSelection)
```

3. Create click handler:
```typescript
const handleClick = (e: React.MouseEvent) => {
  // Stop propagation to prevent canvas background click
  e.stopPropagation()

  if (e.shiftKey) {
    // Shift+click: add to selection
    addToSelection(element.id)
  } else if (e.ctrlKey || e.metaKey) {
    // Ctrl/Cmd+click: toggle in selection
    toggleSelection(element.id)
  } else {
    // Plain click: select only this element
    selectElement(element.id)
  }
}
```

4. Pass onClick to BaseElement or wrap the element rendering with clickable container.

**Option A (preferred):** Modify BaseElement to accept onClick prop
**Option B:** Wrap Element's return value in a clickable div

Choose Option A - modify BaseElement to accept and forward onClick.

**Also add CSS to prevent text selection during shift-click:**
Add `userSelect: 'none'` to the element's style to prevent browser text selection behavior.
  </action>
  <verify>Click on element logs selection change (can verify with React DevTools or console log)</verify>
  <done>Elements respond to click, Shift+click, and Ctrl/Cmd+click with correct selection behavior</done>
</task>

<task type="auto">
  <name>Task 2: Update BaseElement to accept onClick</name>
  <files>src/components/elements/BaseElement.tsx</files>
  <action>
Modify BaseElement to accept and forward click handler.

**Changes:**

1. Update interface to accept onClick:
```typescript
interface BaseElementProps {
  element: ElementConfig
  children: React.ReactNode
  onClick?: (e: React.MouseEvent) => void
}
```

2. Forward onClick to the wrapper div:
```typescript
<div
  data-element-id={element.id}
  style={style}
  onClick={onClick}
>
  {children}
</div>
```

3. Add `userSelect: 'none'` to the style object to prevent text selection during shift-click:
```typescript
const style = React.useMemo(
  () => ({
    // ... existing styles
    userSelect: 'none' as const,
  }),
  // ... existing deps
)
```

4. Add `cursor: 'pointer'` when element is not locked:
```typescript
cursor: element.locked ? 'default' : 'pointer',
```
  </action>
  <verify>BaseElement accepts onClick prop and renders with pointer cursor</verify>
  <done>BaseElement forwards click events and has pointer cursor for selectable elements</done>
</task>

<task type="auto">
  <name>Task 3: Add background click to clear selection</name>
  <files>src/components/Canvas/Canvas.tsx</files>
  <action>
Add click handler to canvas background to clear selection when clicking empty space.

**Changes:**

1. Get clearSelection action:
```typescript
const clearSelection = useStore((state) => state.clearSelection)
```

2. Create background click handler:
```typescript
const handleBackgroundClick = (e: React.MouseEvent) => {
  // Only clear if clicking directly on background (not bubbled from element)
  if (e.target === e.currentTarget) {
    clearSelection()
  }
}
```

3. Add onClick to the canvas-background div:
```typescript
<div
  className="canvas-background"
  style={{...}}
  onClick={handleBackgroundClick}
>
```

**Note:** The `e.target === e.currentTarget` check ensures we only clear selection when clicking the background itself, not when event bubbles from a child. However, elements already call `e.stopPropagation()`, so this is a safety measure.

**Alternative approach:** Just call clearSelection directly since elements stop propagation:
```typescript
onClick={clearSelection}
```

Use the simpler approach since elements stop propagation.
  </action>
  <verify>Clicking empty canvas area clears selection (verify selectedIds becomes empty)</verify>
  <done>Clicking canvas background clears all selected elements</done>
</task>

</tasks>

<verification>
1. `npm run build` completes without errors
2. Click element: that element becomes selected (blue border appears)
3. Shift+click another element: both elements selected
4. Ctrl/Cmd+click selected element: element deselects (toggles off)
5. Click canvas background: all elements deselect
6. No text selection occurs during shift+click
</verification>

<success_criteria>
- CANV-04: Click to select single element - works
- CANV-05: Shift+click for multi-select - works
- Ctrl/Cmd+click toggles selection
- Canvas background click clears selection
- No interference with pan/zoom interactions (spacebar+drag should still pan)
</success_criteria>

<output>
After completion, create `.planning/phases/03-selection-history/03-03-SUMMARY.md`
</output>
