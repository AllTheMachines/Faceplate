---
phase: 03-selection-history
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/store/elementsSlice.ts
  - src/utils/intersection.ts
  - package.json
autonomous: true

must_haves:
  truths:
    - "Selection state tracks which elements are selected"
    - "Selection actions modify selectedIds array"
    - "AABB intersection utility can detect overlapping rectangles"
  artifacts:
    - path: "src/store/elementsSlice.ts"
      provides: "Selection state and actions"
      exports: ["selectElement", "toggleSelection", "addToSelection", "clearSelection", "selectMultiple"]
    - path: "src/utils/intersection.ts"
      provides: "AABB collision detection"
      exports: ["intersectRect"]
  key_links:
    - from: "src/store/elementsSlice.ts"
      to: "zustand store"
      via: "StateCreator pattern"
      pattern: "selectedIds|lastSelectedId"
---

<objective>
Establish selection state foundation and install react-hotkeys-hook dependency.

Purpose: Selection is the prerequisite for all editing operations. Without knowing what's selected, delete/move/resize can't work. This plan creates the state infrastructure that all other plans in this phase depend on.

Output: Expanded selection slice with actions, AABB intersection utility, react-hotkeys-hook installed.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-selection-history/03-CONTEXT.md
@.planning/phases/03-selection-history/03-RESEARCH.md
@src/store/elementsSlice.ts
@src/store/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Expand selection state in elementsSlice</name>
  <files>src/store/elementsSlice.ts</files>
  <action>
Expand the existing ElementsSlice interface and implementation with selection state and actions:

**State to add:**
- `lastSelectedId: string | null` - tracks last selected element for shift-click range selection

**Actions to add:**
- `selectElement(id: string)` - replaces selection with single element, updates lastSelectedId
- `toggleSelection(id: string)` - adds/removes element from selection (for Ctrl+click)
- `addToSelection(id: string)` - adds element to selection without clearing (for shift+click)
- `clearSelection()` - empties selectedIds array
- `selectMultiple(ids: string[])` - replaces selection with multiple elements (for marquee)

**Implementation notes:**
- Keep existing `selectedIds: string[]` (already exists as empty array)
- `selectElement` should set `selectedIds = [id]` and `lastSelectedId = id`
- `toggleSelection` should add if not present, remove if present
- `addToSelection` should add to array if not already present, update lastSelectedId
- `clearSelection` should set `selectedIds = []` and `lastSelectedId = null`
- `selectMultiple` should set `selectedIds = ids` (replacing)
- Selection state IS included in undo history (not excluded in partialize)
  </action>
  <verify>TypeScript compiles without errors: `npm run build` succeeds</verify>
  <done>elementsSlice exports all 5 new selection actions plus lastSelectedId state</done>
</task>

<task type="auto">
  <name>Task 2: Create AABB intersection utility</name>
  <files>src/utils/intersection.ts</files>
  <action>
Create a new utility file for rectangle intersection detection using AABB (Axis-Aligned Bounding Box) algorithm.

**Export:**
```typescript
export interface Rect {
  left: number
  top: number
  right: number
  bottom: number
}

/**
 * Check if two rectangles intersect using AABB algorithm.
 * Returns true if rectangles overlap, false if separated.
 */
export function intersectRect(rect1: Rect, rect2: Rect): boolean
```

**Algorithm (from research):**
1. Check horizontal separation: if `rect1.right < rect2.left || rect2.right < rect1.left` return false
2. Check vertical separation: if `rect1.bottom < rect2.top || rect2.bottom < rect1.top` return false
3. No separation means intersection: return true

**Helper function (optional but useful):**
```typescript
/**
 * Convert DOMRect to Rect interface
 */
export function domRectToRect(domRect: DOMRect): Rect
```

This utility will be used by marquee selection to determine which elements intersect with the selection rectangle.
  </action>
  <verify>Create a simple test in the file comments showing expected behavior, TypeScript compiles</verify>
  <done>intersectRect function correctly identifies overlapping and non-overlapping rectangles</done>
</task>

<task type="auto">
  <name>Task 3: Install react-hotkeys-hook</name>
  <files>package.json</files>
  <action>
Install react-hotkeys-hook for declarative keyboard shortcut handling:

```bash
npm install react-hotkeys-hook
```

This library will be used in Plan 02 for Ctrl+Z, Ctrl+Y, Delete, and Escape shortcuts.

**Why this library (from research):**
- Declarative hook-based API (`useHotkeys`)
- Full TypeScript support
- Handles modifier keys (Ctrl, Shift, Meta)
- Built-in preventDefault option
- Automatic cleanup on unmount
  </action>
  <verify>`npm ls react-hotkeys-hook` shows version 5.x installed</verify>
  <done>react-hotkeys-hook appears in package.json dependencies</done>
</task>

</tasks>

<verification>
1. `npm run build` completes without TypeScript errors
2. `npm ls react-hotkeys-hook` shows installed version
3. elementsSlice.ts exports: selectElement, toggleSelection, addToSelection, clearSelection, selectMultiple, lastSelectedId
4. intersection.ts exports: intersectRect, Rect interface
</verification>

<success_criteria>
- Selection state foundation established with all required actions
- AABB intersection utility ready for marquee selection
- react-hotkeys-hook installed for keyboard shortcuts in next plan
- All code compiles and type-checks
</success_criteria>

<output>
After completion, create `.planning/phases/03-selection-history/03-01-SUMMARY.md`
</output>
