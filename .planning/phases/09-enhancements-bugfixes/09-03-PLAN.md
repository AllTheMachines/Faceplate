---
phase: 09-enhancements-bugfixes
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/store/canvasSlice.ts
  - src/store/index.ts
  - src/components/Properties/PropertyPanel.tsx
  - src/components/elements/Element.tsx
  - src/components/Layout/RightPanel.tsx
autonomous: true

must_haves:
  truths:
    - "User can lock individual elements to prevent selection/movement"
    - "User can enable lock all mode for UI testing without accidental edits"
  artifacts:
    - path: "src/store/canvasSlice.ts"
      provides: "lockAllMode state and toggle action"
      contains: "lockAllMode"
    - path: "src/components/Properties/PropertyPanel.tsx"
      provides: "Lock toggle checkbox for individual elements"
      contains: "element.locked"
  key_links:
    - from: "src/components/elements/Element.tsx"
      to: "src/store/canvasSlice.ts"
      via: "lockAllMode check"
      pattern: "lockAllMode.*locked"
---

<objective>
Implement element locking: individual lock toggle and global "lock all" mode for UI testing.

Purpose: IMP-02 and IMP-03 enable non-destructive UI testing - users can interact with controls without accidentally moving them.
Output: Lock checkbox in property panel, lock all toggle in toolbar, locked elements cannot be selected or moved.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/09-enhancements-bugfixes/09-RESEARCH.md

@src/store/canvasSlice.ts
@src/store/index.ts
@src/types/elements.ts
@src/components/elements/BaseElement.tsx
@src/components/elements/Element.tsx
@src/components/Properties/PropertyPanel.tsx
@src/components/Layout/RightPanel.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add lockAllMode to canvas slice</name>
  <files>src/store/canvasSlice.ts, src/store/index.ts</files>
  <action>
Add global lock mode to canvasSlice.ts:

In CanvasSlice interface, add:
```typescript
// Lock all mode (prevents selection/editing for UI testing)
lockAllMode: boolean
toggleLockAllMode: () => void
```

In createCanvasSlice, add:
```typescript
lockAllMode: false,
toggleLockAllMode: () => set((state) => ({ lockAllMode: !state.lockAllMode })),
```

In src/store/index.ts, add `lockAllMode` to the partialize exclusion list (same as isPanning, scale, etc.) so it doesn't pollute undo history:

```typescript
partialize: (state) => {
  const { scale, offsetX, offsetY, isPanning, dragStart, lockAllMode, ...rest } = state
  return rest
},
```

Why exclude from undo: Toggling lock mode is not a document change, it's a view/interaction mode like panning. Users shouldn't undo/redo lock toggles.
  </action>
  <verify>
Run `npm run build` - should compile without errors.
Check canvasSlice exports lockAllMode and toggleLockAllMode.
  </verify>
  <done>Canvas slice has lockAllMode state and toggle action, excluded from undo history.</done>
</task>

<task type="auto">
  <name>Task 2: Add individual lock toggle to PropertyPanel</name>
  <files>src/components/Properties/PropertyPanel.tsx</files>
  <action>
Add a lock toggle checkbox to the property panel for the selected element.

After the Identity section, add a new Lock section:

```typescript
{/* Lock */}
<PropertySection title="Lock">
  <label className="flex items-center gap-2 text-sm">
    <input
      type="checkbox"
      checked={element.locked}
      onChange={(e) => update({ locked: e.target.checked })}
      className="rounded border-gray-600 bg-gray-700 text-blue-500 focus:ring-blue-500"
    />
    <span className="text-gray-300">Lock element</span>
  </label>
  <p className="text-xs text-gray-500 mt-1">
    Locked elements cannot be selected or moved
  </p>
</PropertySection>
```

The element.locked property already exists in BaseElementConfig, and BaseElement.tsx already disables dragging when locked. We just need the UI toggle.
  </action>
  <verify>
Run `npm run build` - should compile without errors.
Check PropertyPanel has lock checkbox in correct location.
  </verify>
  <done>Property panel has lock toggle for individual elements.</done>
</task>

<task type="auto">
  <name>Task 3: Block selection when lockAllMode or element.locked</name>
  <files>src/components/elements/Element.tsx</files>
  <action>
Modify Element.tsx click handler to respect both individual lock and global lockAllMode.

Add lockAllMode to the store reads:
```typescript
const lockAllMode = useStore((state) => state.lockAllMode)
```

Modify the click handler:
```typescript
const handleClick = (e: React.MouseEvent) => {
  e.stopPropagation()

  // Don't allow selection in lock-all mode or for individually locked elements
  if (lockAllMode || element.locked) return

  // ... existing selection logic (Shift+click, Ctrl+click, etc.)
}
```

This prevents selecting locked elements. BaseElement.tsx already prevents dragging locked elements via the `disabled: element.locked` prop.

Also update the cursor style to indicate locked state:
```typescript
style={{
  cursor: lockAllMode || element.locked ? 'default' : (isSelected ? 'move' : 'pointer'),
  // ... other styles
}}
```
  </action>
  <verify>
Run `npm run build` - should compile without errors.
Check Element.tsx reads lockAllMode and blocks selection appropriately.
  </verify>
  <done>Element click handlers respect lockAllMode and individual lock state.</done>
</task>

<task type="auto">
  <name>Task 4: Add lock all toggle to RightPanel</name>
  <files>src/components/Layout/RightPanel.tsx</files>
  <action>
Add a lock all toggle button to the right panel header area.

At the top of RightPanel, add store access:
```typescript
const lockAllMode = useStore((state) => state.lockAllMode)
const toggleLockAllMode = useStore((state) => state.toggleLockAllMode)
```

Add the toggle button before the main content (after the section header):
```typescript
{/* Lock All Toggle */}
<div className="px-4 py-2 border-b border-gray-700">
  <button
    onClick={toggleLockAllMode}
    className={`flex items-center gap-2 px-3 py-1.5 rounded text-sm font-medium transition-colors w-full justify-center ${
      lockAllMode
        ? 'bg-amber-600 text-white hover:bg-amber-500'
        : 'bg-gray-700 text-gray-300 hover:bg-gray-600'
    }`}
  >
    <span>{lockAllMode ? 'ðŸ”’' : 'ðŸ”“'}</span>
    <span>{lockAllMode ? 'Unlock All' : 'Lock All'}</span>
  </button>
  {lockAllMode && (
    <p className="text-xs text-amber-400 mt-1 text-center">
      UI Test Mode: Elements cannot be selected
    </p>
  )}
</div>
```

Position this prominently so users know the mode is active.
  </action>
  <verify>
Run `npm run build` - should compile without errors.
Manual test: Click "Lock All" button - should toggle between locked/unlocked states.
  </verify>
  <done>Right panel has lock all toggle button with visual feedback.</done>
</task>

</tasks>

<verification>
1. `npm run build` completes successfully
2. Start app with `npm run dev`
3. Add multiple elements to canvas
4. Select an element, check "Lock element" in property panel
5. Try to click/drag the locked element - should NOT select or move
6. Click "Lock All" button in right panel
7. Try to click/drag any element - NONE should select or move
8. Click "Unlock All" - elements should be selectable again
9. Undo/redo - lock state changes should NOT appear in undo history
</verification>

<success_criteria>
- IMP-02: Individual element lock toggle works (locked elements can't be selected/moved)
- IMP-03: Lock all mode prevents any element selection/movement
- Lock state changes don't pollute undo/redo history
- Clear visual indication when lock all mode is active
</success_criteria>

<output>
After completion, create `.planning/phases/09-enhancements-bugfixes/09-03-SUMMARY.md`
</output>
