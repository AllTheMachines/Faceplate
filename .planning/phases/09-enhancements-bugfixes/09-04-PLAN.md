---
phase: 09-enhancements-bugfixes
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - src/types/elements.ts
  - src/components/Properties/LabelProperties.tsx
  - src/services/export/cssGenerator.ts
  - public/fonts/Inter-Regular.woff2
  - public/fonts/Roboto-Regular.woff2
  - public/fonts/RobotoMono-Regular.woff2
autonomous: true

must_haves:
  truths:
    - "User can select from multiple fonts for Labels"
    - "Selected font is embedded in exported CSS"
  artifacts:
    - path: "src/components/Properties/LabelProperties.tsx"
      provides: "Font selection dropdown"
      contains: "fontFamily"
    - path: "src/services/export/cssGenerator.ts"
      provides: "Font embedding in CSS export"
      contains: "@font-face"
  key_links:
    - from: "src/components/Properties/LabelProperties.tsx"
      to: "src/types/elements.ts"
      via: "fontFamily property"
      pattern: "fontFamily"
---

<objective>
Implement font selection for Label elements with embedded fonts for VST3 export.

Purpose: FEAT-01 enables typography choices that work offline in VST3 plugins via embedded WOFF2 fonts.
Output: Font dropdown in label properties, WOFF2 font files in public/fonts, base64 embedding in CSS export.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/09-enhancements-bugfixes/09-RESEARCH.md

@src/types/elements.ts
@src/components/Properties/LabelProperties.tsx
@src/services/export/cssGenerator.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create font registry with available fonts</name>
  <files>src/services/fonts/fontRegistry.ts</files>
  <action>
Create a new directory and file for font management.

Create `src/services/fonts/fontRegistry.ts`:
```typescript
/**
 * Font registry for embedded fonts
 * These fonts are downloaded from google-webfonts-helper and stored in public/fonts/
 */

export interface FontDefinition {
  name: string
  family: string // CSS font-family value
  file: string // filename in public/fonts/
  category: 'sans-serif' | 'serif' | 'monospace' | 'display'
}

export const AVAILABLE_FONTS: FontDefinition[] = [
  {
    name: 'Inter',
    family: 'Inter',
    file: 'Inter-Regular.woff2',
    category: 'sans-serif',
  },
  {
    name: 'Roboto',
    family: 'Roboto',
    file: 'Roboto-Regular.woff2',
    category: 'sans-serif',
  },
  {
    name: 'Roboto Mono',
    family: 'Roboto Mono',
    file: 'RobotoMono-Regular.woff2',
    category: 'monospace',
  },
  {
    name: 'System Default',
    family: 'system-ui, -apple-system, sans-serif',
    file: '', // No file - uses system fonts
    category: 'sans-serif',
  },
]

export function getFontByFamily(family: string): FontDefinition | undefined {
  return AVAILABLE_FONTS.find(f => f.family === family || family.includes(f.family))
}

export function getDefaultFont(): FontDefinition {
  return AVAILABLE_FONTS[0]! // Inter
}
```
  </action>
  <verify>
Run `npm run build` - should compile without errors.
Check that fontRegistry.ts exports AVAILABLE_FONTS array.
  </verify>
  <done>Font registry with available font definitions exists.</done>
</task>

<task type="auto">
  <name>Task 2: Download and place WOFF2 font files</name>
  <files>public/fonts/Inter-Regular.woff2, public/fonts/Roboto-Regular.woff2, public/fonts/RobotoMono-Regular.woff2</files>
  <action>
Download WOFF2 font files from Google Fonts CDN and place in public/fonts/.

Create directory and download fonts:
```bash
mkdir -p public/fonts

# Download Inter Regular (400 weight)
curl -L "https://fonts.gstatic.com/s/inter/v13/UcCO3FwrK3iLTeHuS_fvQtMwCp50KnMw2boKoduKmMEVuLyfAZ9hjp-Ek-_EeA.woff2" -o public/fonts/Inter-Regular.woff2

# Download Roboto Regular (400 weight)
curl -L "https://fonts.gstatic.com/s/roboto/v30/KFOmCnqEu92Fr1Mu4mxK.woff2" -o public/fonts/Roboto-Regular.woff2

# Download Roboto Mono Regular (400 weight)
curl -L "https://fonts.gstatic.com/s/robotomono/v23/L0xuDF4xlVMF-BfR8bXMIhJHg45mwgGEFl0_3vq_ROW4.woff2" -o public/fonts/RobotoMono-Regular.woff2
```

Verify files exist and are non-empty (each should be 10-50KB).
  </action>
  <verify>
Run `ls -la public/fonts/` - should show 3 WOFF2 files.
File sizes should be reasonable (10-50KB each).
  </verify>
  <done>WOFF2 font files are downloaded and placed in public/fonts/.</done>
</task>

<task type="auto">
  <name>Task 3: Add font selector to LabelProperties</name>
  <files>src/components/Properties/LabelProperties.tsx</files>
  <action>
Add a font family dropdown to the label properties panel.

Import font registry:
```typescript
import { AVAILABLE_FONTS } from '../../services/fonts/fontRegistry'
```

Add font family select after the existing text input:
```typescript
{/* Font */}
<div className="space-y-2">
  <label className="block text-sm text-gray-400">Font Family</label>
  <select
    value={element.fontFamily}
    onChange={(e) => onUpdate({ fontFamily: e.target.value })}
    className="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded text-white text-sm focus:outline-none focus:border-blue-500"
  >
    {AVAILABLE_FONTS.map((font) => (
      <option key={font.name} value={font.family}>
        {font.name}
      </option>
    ))}
  </select>
</div>
```

Also update the font preview in the properties to show the selected font:
```typescript
<p
  className="text-xs text-gray-500 mt-1"
  style={{ fontFamily: element.fontFamily }}
>
  Preview: {element.text || 'Sample Text'}
</p>
```
  </action>
  <verify>
Run `npm run build` - should compile without errors.
Check LabelProperties has font dropdown with all available fonts.
  </verify>
  <done>Label properties panel has font family dropdown.</done>
</task>

<task type="auto">
  <name>Task 4: Add font embedding to CSS export</name>
  <files>src/services/export/cssGenerator.ts</files>
  <action>
Modify CSS generator to include @font-face rules for used fonts.

Import font registry:
```typescript
import { AVAILABLE_FONTS, getFontByFamily } from '../fonts/fontRegistry'
```

Add function to generate @font-face for a font (inline placeholder for base64):
```typescript
function generateFontFace(fontDef: FontDefinition): string {
  if (!fontDef.file) return '' // System fonts don't need @font-face

  // Note: In production, these would be base64 encoded
  // For now, use relative path (works for HTML preview)
  return `@font-face {
  font-family: '${fontDef.family}';
  src: url('./fonts/${fontDef.file}') format('woff2');
  font-weight: normal;
  font-style: normal;
  font-display: swap;
}`
}
```

Modify the main generateCSS function to:
1. Collect all unique fontFamily values from label elements
2. Generate @font-face rules for each used font
3. Prepend font-face rules to the CSS output

```typescript
// At the start of generateCSS:
const usedFonts = new Set<string>()
elements.forEach(el => {
  if (el.type === 'label' && el.fontFamily) {
    usedFonts.add(el.fontFamily)
  }
})

const fontFaces = Array.from(usedFonts)
  .map(family => getFontByFamily(family))
  .filter((f): f is FontDefinition => f !== undefined && f.file !== '')
  .map(generateFontFace)
  .join('\n\n')

// Prepend to output
return `/* Embedded Fonts */\n${fontFaces}\n\n/* Element Styles */\n${elementStyles}`
```
  </action>
  <verify>
Run `npm run build` - should compile without errors.
Check cssGenerator includes @font-face generation logic.
  </verify>
  <done>CSS export includes @font-face rules for used fonts.</done>
</task>

</tasks>

<verification>
1. `npm run build` completes successfully
2. `ls -la public/fonts/` shows 3 WOFF2 files
3. Start app with `npm run dev`
4. Add a Label element to canvas
5. Open property panel, find Font Family dropdown
6. Select different fonts - label should update visually on canvas
7. Export HTML preview - check styles.css includes @font-face rules
8. Exported HTML should display fonts correctly
</verification>

<success_criteria>
- FEAT-01: Multiple font options available for Labels
- Fonts are embedded in CSS export as @font-face rules
- Font selection reflects immediately on canvas
- 3 bundled fonts: Inter, Roboto, Roboto Mono (plus system default)
</success_criteria>

<output>
After completion, create `.planning/phases/09-enhancements-bugfixes/09-04-SUMMARY.md`
</output>
