---
phase: 09-enhancements-bugfixes
plan: 06
type: execute
wave: 2
depends_on: []
files_modified:
  - src/services/import/svgParser.ts
  - src/services/import/svgLayerExtractor.ts
  - src/components/DesignMode/SVGDesignMode.tsx
  - src/components/DesignMode/LayerAssignment.tsx
  - src/components/Palette/CustomSVGUpload.tsx
  - src/types/svg.ts
autonomous: true

must_haves:
  truths:
    - "User can enter Design Mode to dissect custom SVGs"
    - "User can see extracted layers from SVG groups"
    - "User can assign SVG parts to element layers (indicator, track, thumb, etc.)"
  artifacts:
    - path: "src/services/import/svgLayerExtractor.ts"
      provides: "SVG layer extraction using svg-parser"
      contains: "extractSVGLayers"
    - path: "src/components/DesignMode/SVGDesignMode.tsx"
      provides: "Design mode UI for layer assignment"
      contains: "LayerAssignment"
  key_links:
    - from: "src/components/Palette/CustomSVGUpload.tsx"
      to: "src/components/DesignMode/SVGDesignMode.tsx"
      via: "onDesignMode callback"
      pattern: "onDesignMode"
---

<objective>
Implement SVG Design Mode for dissecting custom SVGs and assigning parts to element layers.

Purpose: FEAT-02 enables users to create custom control skins by mapping SVG groups to functional layers.
Output: Design mode dialog, SVG layer extraction, layer assignment UI, enhanced custom element creation.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/09-enhancements-bugfixes/09-RESEARCH.md

@src/components/Palette/CustomSVGUpload.tsx
@src/types/elements.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install svg-parser and create SVG types</name>
  <files>package.json, src/types/svg.ts</files>
  <action>
Install svg-parser npm package:
```bash
npm install svg-parser
```

Create `src/types/svg.ts` with layer types:
```typescript
/**
 * SVG layer types for Design Mode
 */

export type SVGLayerType =
  | 'indicator'  // Rotates with value (knobs)
  | 'track'      // Static background
  | 'thumb'      // Moves with value (sliders)
  | 'fill'       // Grows/shrinks with value
  | 'glow'       // Reactive highlight
  | 'background' // Static backdrop
  | 'unknown'    // Unassigned layer

export interface SVGLayer {
  id: string
  name: string
  svgContent: string
  suggestedType: SVGLayerType
  assignedType?: SVGLayerType
  bounds?: { x: number; y: number; width: number; height: number }
}

export interface SVGDesignResult {
  elementType: 'knob' | 'slider' | 'button' | 'custom'
  layers: Record<SVGLayerType, string | undefined> // layerType -> svgContent
  originalSvg: string
  width: number
  height: number
}
```
  </action>
  <verify>
Run `npm install` then `npm run build` - should compile without errors.
Check package.json includes svg-parser.
  </verify>
  <done>svg-parser installed and SVG types defined.</done>
</task>

<task type="auto">
  <name>Task 2: Create SVG layer extractor service</name>
  <files>src/services/import/svgLayerExtractor.ts</files>
  <action>
Create SVG layer extraction service using svg-parser.

Create directory and file `src/services/import/svgLayerExtractor.ts`:
```typescript
/**
 * Extract layers from SVG for Design Mode
 */

import { parse, RootNode, ElementNode } from 'svg-parser'
import { SVGLayer, SVGLayerType } from '../../types/svg'

/**
 * Infer layer type from group ID/name using naming conventions
 */
function inferLayerType(name: string): SVGLayerType {
  const lower = name.toLowerCase()

  if (lower.includes('indicator') || lower.includes('pointer') || lower.includes('needle')) {
    return 'indicator'
  }
  if (lower.includes('track') || lower.includes('bg') || lower.includes('base')) {
    return 'track'
  }
  if (lower.includes('thumb') || lower.includes('handle') || lower.includes('grip')) {
    return 'thumb'
  }
  if (lower.includes('fill') || lower.includes('progress') || lower.includes('value')) {
    return 'fill'
  }
  if (lower.includes('glow') || lower.includes('highlight') || lower.includes('hover')) {
    return 'glow'
  }
  if (lower.includes('background') || lower.includes('backdrop')) {
    return 'background'
  }

  return 'unknown'
}

/**
 * Serialize a node back to SVG string
 */
function nodeToSvgString(node: ElementNode): string {
  const { tagName, properties = {}, children = [] } = node

  const attrs = Object.entries(properties)
    .map(([key, value]) => `${key}="${value}"`)
    .join(' ')

  const childContent = children
    .filter((child): child is ElementNode => child.type === 'element')
    .map(nodeToSvgString)
    .join('')

  if (childContent) {
    return `<${tagName}${attrs ? ' ' + attrs : ''}>${childContent}</${tagName}>`
  }

  return `<${tagName}${attrs ? ' ' + attrs : ''}/>`
}

/**
 * Extract layers from SVG content
 * Looks for <g> elements with id attributes
 */
export function extractSVGLayers(svgContent: string): SVGLayer[] {
  const ast = parse(svgContent) as RootNode
  const layers: SVGLayer[] = []

  function traverse(node: ElementNode | RootNode) {
    if ('tagName' in node && node.tagName === 'g' && node.properties?.id) {
      const layerId = String(node.properties.id)
      const layerName = node.properties['inkscape:label']
        ? String(node.properties['inkscape:label'])
        : layerId

      layers.push({
        id: layerId,
        name: layerName,
        svgContent: nodeToSvgString(node as ElementNode),
        suggestedType: inferLayerType(layerId),
      })
    }

    if ('children' in node && node.children) {
      for (const child of node.children) {
        if (typeof child === 'object' && child.type === 'element') {
          traverse(child as ElementNode)
        }
      }
    }
  }

  traverse(ast)
  return layers
}

/**
 * Get SVG dimensions from viewBox or width/height attributes
 */
export function getSVGDimensions(svgContent: string): { width: number; height: number } {
  const ast = parse(svgContent) as RootNode
  const svgNode = ast.children.find(
    (c): c is ElementNode => c.type === 'element' && c.tagName === 'svg'
  )

  if (!svgNode) {
    return { width: 100, height: 100 }
  }

  // Try viewBox first
  const viewBox = svgNode.properties?.viewBox
  if (viewBox) {
    const parts = String(viewBox).split(/[\s,]+/)
    if (parts.length >= 4) {
      return {
        width: parseFloat(parts[2]) || 100,
        height: parseFloat(parts[3]) || 100,
      }
    }
  }

  // Fall back to width/height attributes
  return {
    width: parseFloat(String(svgNode.properties?.width || 100)),
    height: parseFloat(String(svgNode.properties?.height || 100)),
  }
}
```
  </action>
  <verify>
Run `npm run build` - should compile without errors.
Check svgLayerExtractor exports extractSVGLayers and getSVGDimensions.
  </verify>
  <done>SVG layer extraction service exists using svg-parser.</done>
</task>

<task type="auto">
  <name>Task 3: Create SVG Design Mode component</name>
  <files>src/components/DesignMode/SVGDesignMode.tsx, src/components/DesignMode/LayerAssignment.tsx</files>
  <action>
Create Design Mode UI components.

Create `src/components/DesignMode/LayerAssignment.tsx`:
```typescript
import { SVGLayer, SVGLayerType } from '../../types/svg'

interface LayerAssignmentProps {
  layer: SVGLayer
  onAssign: (layerId: string, type: SVGLayerType) => void
}

const LAYER_TYPE_OPTIONS: { value: SVGLayerType; label: string }[] = [
  { value: 'indicator', label: 'Indicator (rotates)' },
  { value: 'track', label: 'Track (static)' },
  { value: 'thumb', label: 'Thumb (moves)' },
  { value: 'fill', label: 'Fill (grows)' },
  { value: 'glow', label: 'Glow (highlight)' },
  { value: 'background', label: 'Background' },
  { value: 'unknown', label: 'Unused' },
]

export function LayerAssignment({ layer, onAssign }: LayerAssignmentProps) {
  return (
    <div className="flex items-center gap-3 p-2 bg-gray-800 rounded">
      <div
        className="w-12 h-12 bg-gray-700 rounded flex-shrink-0"
        dangerouslySetInnerHTML={{
          __html: `<svg viewBox="0 0 100 100" class="w-full h-full">${layer.svgContent}</svg>`,
        }}
      />
      <div className="flex-1 min-w-0">
        <p className="text-sm font-medium text-white truncate">{layer.name}</p>
        <p className="text-xs text-gray-400">ID: {layer.id}</p>
      </div>
      <select
        value={layer.assignedType || layer.suggestedType}
        onChange={(e) => onAssign(layer.id, e.target.value as SVGLayerType)}
        className="px-2 py-1 bg-gray-700 border border-gray-600 rounded text-sm text-white"
      >
        {LAYER_TYPE_OPTIONS.map((opt) => (
          <option key={opt.value} value={opt.value}>
            {opt.label}
          </option>
        ))}
      </select>
    </div>
  )
}
```

Create `src/components/DesignMode/SVGDesignMode.tsx`:
```typescript
import { useState, useCallback } from 'react'
import { SVGLayer, SVGLayerType, SVGDesignResult } from '../../types/svg'
import { extractSVGLayers, getSVGDimensions } from '../../services/import/svgLayerExtractor'
import { LayerAssignment } from './LayerAssignment'

interface SVGDesignModeProps {
  svgContent: string
  onComplete: (result: SVGDesignResult) => void
  onCancel: () => void
}

export function SVGDesignMode({ svgContent, onComplete, onCancel }: SVGDesignModeProps) {
  const [layers, setLayers] = useState<SVGLayer[]>(() => extractSVGLayers(svgContent))
  const [elementType, setElementType] = useState<'knob' | 'slider' | 'button' | 'custom'>('knob')
  const dimensions = getSVGDimensions(svgContent)

  const handleAssign = useCallback((layerId: string, type: SVGLayerType) => {
    setLayers((prev) =>
      prev.map((layer) =>
        layer.id === layerId ? { ...layer, assignedType: type } : layer
      )
    )
  }, [])

  const handleComplete = useCallback(() => {
    const layerMap: Record<SVGLayerType, string | undefined> = {
      indicator: undefined,
      track: undefined,
      thumb: undefined,
      fill: undefined,
      glow: undefined,
      background: undefined,
      unknown: undefined,
    }

    layers.forEach((layer) => {
      const type = layer.assignedType || layer.suggestedType
      if (type !== 'unknown') {
        layerMap[type] = layer.svgContent
      }
    })

    onComplete({
      elementType,
      layers: layerMap,
      originalSvg: svgContent,
      width: dimensions.width,
      height: dimensions.height,
    })
  }, [layers, elementType, svgContent, dimensions, onComplete])

  return (
    <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
      <div className="bg-gray-900 rounded-lg shadow-xl max-w-2xl w-full max-h-[80vh] overflow-hidden">
        <div className="p-4 border-b border-gray-700">
          <h2 className="text-lg font-semibold text-white">SVG Design Mode</h2>
          <p className="text-sm text-gray-400 mt-1">
            Assign SVG layers to element parts
          </p>
        </div>

        <div className="p-4 grid grid-cols-2 gap-4">
          {/* Preview */}
          <div className="bg-gray-800 rounded p-4">
            <h3 className="text-sm font-medium text-gray-300 mb-2">Preview</h3>
            <div
              className="bg-gray-700 rounded aspect-square flex items-center justify-center"
              dangerouslySetInnerHTML={{ __html: svgContent }}
            />
            <p className="text-xs text-gray-500 mt-2">
              {dimensions.width} x {dimensions.height}
            </p>
          </div>

          {/* Settings */}
          <div className="space-y-4">
            <div>
              <label className="block text-sm font-medium text-gray-300 mb-1">
                Element Type
              </label>
              <select
                value={elementType}
                onChange={(e) => setElementType(e.target.value as any)}
                className="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded text-white"
              >
                <option value="knob">Knob</option>
                <option value="slider">Slider</option>
                <option value="button">Button</option>
                <option value="custom">Custom</option>
              </select>
            </div>

            <div>
              <h3 className="text-sm font-medium text-gray-300 mb-2">
                Layers ({layers.length})
              </h3>
              {layers.length === 0 ? (
                <p className="text-sm text-gray-500">
                  No named groups found. SVG must use &lt;g id="..."&gt; for layers.
                </p>
              ) : (
                <div className="space-y-2 max-h-48 overflow-y-auto">
                  {layers.map((layer) => (
                    <LayerAssignment
                      key={layer.id}
                      layer={layer}
                      onAssign={handleAssign}
                    />
                  ))}
                </div>
              )}
            </div>
          </div>
        </div>

        <div className="p-4 border-t border-gray-700 flex justify-end gap-3">
          <button
            onClick={onCancel}
            className="px-4 py-2 text-sm text-gray-300 hover:text-white"
          >
            Cancel
          </button>
          <button
            onClick={handleComplete}
            className="px-4 py-2 bg-blue-600 text-white rounded text-sm hover:bg-blue-500"
          >
            Create Element
          </button>
        </div>
      </div>
    </div>
  )
}
```
  </action>
  <verify>
Run `npm run build` - should compile without errors.
Check SVGDesignMode and LayerAssignment components exist.
  </verify>
  <done>SVG Design Mode UI components created.</done>
</task>

<task type="auto">
  <name>Task 4: Integrate Design Mode into CustomSVGUpload</name>
  <files>src/components/Palette/CustomSVGUpload.tsx</files>
  <action>
Add Design Mode button to custom SVG upload flow.

Import the Design Mode component:
```typescript
import { useState } from 'react'
import { SVGDesignMode } from '../DesignMode/SVGDesignMode'
import { SVGDesignResult } from '../../types/svg'
```

Add state for design mode:
```typescript
const [designModeOpen, setDesignModeOpen] = useState(false)
const [pendingSvg, setPendingSvg] = useState<string | null>(null)
```

Modify the file drop handler to offer design mode:
After reading the SVG file, instead of immediately creating the element, store it and show options:
```typescript
// After successful SVG read:
setPendingSvg(svgContent)
// Show dialog with two buttons: "Add as Image" and "Design Mode"
```

Add Design Mode dialog:
```typescript
{designModeOpen && pendingSvg && (
  <SVGDesignMode
    svgContent={pendingSvg}
    onComplete={(result) => {
      // Create element from design result
      // This creates an element with layer information
      handleDesignModeResult(result)
      setDesignModeOpen(false)
      setPendingSvg(null)
    }}
    onCancel={() => {
      setDesignModeOpen(false)
      setPendingSvg(null)
    }}
  />
)}
```

Add UI to choose between simple import and design mode:
```typescript
{pendingSvg && !designModeOpen && (
  <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-40">
    <div className="bg-gray-800 rounded-lg p-4 max-w-sm">
      <h3 className="text-white font-medium mb-3">SVG Import Options</h3>
      <div className="flex gap-2">
        <button
          onClick={() => {
            // Simple import as image
            createImageElement(pendingSvg)
            setPendingSvg(null)
          }}
          className="flex-1 px-3 py-2 bg-gray-700 text-white rounded hover:bg-gray-600 text-sm"
        >
          Add as Image
        </button>
        <button
          onClick={() => setDesignModeOpen(true)}
          className="flex-1 px-3 py-2 bg-blue-600 text-white rounded hover:bg-blue-500 text-sm"
        >
          Design Mode
        </button>
      </div>
      <button
        onClick={() => setPendingSvg(null)}
        className="mt-2 w-full text-gray-400 text-sm hover:text-white"
      >
        Cancel
      </button>
    </div>
  </div>
)}
```
  </action>
  <verify>
Run `npm run build` - should compile without errors.
Check CustomSVGUpload has design mode integration.
  </verify>
  <done>Design Mode is accessible from custom SVG upload.</done>
</task>

</tasks>

<verification>
1. `npm run build` completes successfully
2. Start app with `npm run dev`
3. Drag an SVG file with named groups onto the upload area
4. See "SVG Import Options" dialog with "Add as Image" and "Design Mode" buttons
5. Click "Design Mode" - see layer extraction dialog
6. Layers should be listed with suggested types based on naming
7. Assign layers to different types using dropdown
8. Click "Create Element" - element should be created on canvas
</verification>

<success_criteria>
- FEAT-02: SVG Design Mode extracts and displays layers
- Users can assign layers to functional types (indicator, track, thumb, etc.)
- Works with SVGs that use named `<g id="...">` groups
- Clear messaging when SVG has no extractable layers
</success_criteria>

<output>
After completion, create `.planning/phases/09-enhancements-bugfixes/09-06-SUMMARY.md`
</output>
