---
phase: 09-enhancements-bugfixes
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/Canvas/hooks/useMarquee.ts
  - src/components/Canvas/MarqueeSelection.tsx
autonomous: true

must_haves:
  truths:
    - "Selection rectangle does not appear when dragging an existing element"
    - "Marquee selection persists after mouse release (elements remain selected)"
  artifacts:
    - path: "src/components/Canvas/hooks/useMarquee.ts"
      provides: "Marquee hook with isDragging detection"
      contains: "useDndContext"
  key_links:
    - from: "src/components/Canvas/hooks/useMarquee.ts"
      to: "@dnd-kit/core"
      via: "useDndContext hook"
      pattern: "useDndContext.*active"
---

<objective>
Fix marquee selection bugs: prevent marquee when dragging elements and persist selection after mouse release.

Purpose: BUG-01 and BUG-02 are critical UX issues that confuse users during normal editing workflows.
Output: Fixed useMarquee hook that checks @dnd-kit drag state and properly persists selection.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/09-enhancements-bugfixes/09-RESEARCH.md

@src/components/Canvas/hooks/useMarquee.ts
@src/components/elements/BaseElement.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Prevent marquee during element drag</name>
  <files>src/components/Canvas/hooks/useMarquee.ts</files>
  <action>
Import `useDndContext` from `@dnd-kit/core` at the top of the file.

Inside `useMarquee`, add:
```typescript
const { active } = useDndContext()
const isDraggingElement = active?.data.current?.sourceType === 'element'
```

Modify `handleMouseDown` to check `isDraggingElement`:
```typescript
if (e.button !== 0 || isPanning || isDraggingElement) return
```

Add `isDraggingElement` to the dependency array of `handleMouseDown`.

Why this works: BaseElement.tsx already sets `sourceType: 'element'` in the `useDraggable` data prop, so we can detect when any element is being dragged.
  </action>
  <verify>
Run `npm run build` - should compile without errors.
Review the code to confirm useDndContext is imported and isDraggingElement is checked.
  </verify>
  <done>Marquee selection does not start when user begins dragging an existing element.</done>
</task>

<task type="auto">
  <name>Task 2: Fix marquee selection persistence</name>
  <files>src/components/Canvas/hooks/useMarquee.ts</files>
  <action>
The bug is that `handleMouseUp` clears the marquee state but does NOT clear the selection. The selection is set during `handleMouseMove`, but when the mouse is released, the marquee disappears and the visual feedback suggests nothing is selected.

The actual issue is in the selection logic - on mouseUp, we should NOT call `clearSelection()` if elements were selected. The current behavior selects elements during drag but then selection appears to vanish because the marquee rect disappears.

Fix `handleMouseUp`:
```typescript
const handleMouseUp = useCallback(() => {
  // Selection has already been applied during mousemove
  // Just clear the visual marquee, keep the selection
  setMarquee(null)
}, [])
```

Also remove the `clearSelection()` call from the `handleMouseMove` when `intersecting.length === 0` - this is what's causing the issue. Instead, only update selection when there ARE intersecting elements:

```typescript
if (intersecting.length > 0) {
  selectMultiple(intersecting.map((el) => el.id))
}
// Remove the else { clearSelection() } - we only want to clear on background click, not during marquee
```

Wait - re-reading the code, the clearSelection during mousemove IS the problem. When the user finishes marquee but there are no elements under the final position, it clears. The fix is to track what was selected and only clear if the user clicks background without dragging.

Simpler fix: Remove the `else { clearSelection() }` block entirely from `handleMouseMove`. Selection clearing should happen on background click (which is handled elsewhere in CanvasStage), not during marquee drag.
  </action>
  <verify>
Run `npm run build` - should compile without errors.
Manual test: Draw marquee over elements, release mouse - elements should remain selected with blue highlight.
  </verify>
  <done>Elements selected via marquee remain selected after mouse release.</done>
</task>

</tasks>

<verification>
1. `npm run build` completes successfully
2. Start app with `npm run dev`
3. Add 3 elements to canvas
4. Drag one element - NO marquee rectangle should appear during drag
5. Draw marquee rectangle over 2 elements - both should highlight
6. Release mouse - both elements should STAY selected (blue selection handles visible)
</verification>

<success_criteria>
- BUG-01: No selection rectangle appears when dragging existing elements
- BUG-02: Marquee-selected elements remain selected after mouse release
- No TypeScript errors or runtime exceptions
</success_criteria>

<output>
After completion, create `.planning/phases/09-enhancements-bugfixes/09-01-SUMMARY.md`
</output>
