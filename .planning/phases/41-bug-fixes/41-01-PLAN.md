---
phase: 41-bug-fixes
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/services/export/codeGenerator.ts
autonomous: true

must_haves:
  truths:
    - "Single-window project exports files directly to selected folder (no subfolder)"
    - "Multi-window project continues to create subfolders per window"
    - "README.md is written to root of selected folder for single-window"
  artifacts:
    - path: "src/services/export/codeGenerator.ts"
      provides: "exportMultiWindowToFolder function with single-window special case"
      contains: "windowsToExport.length === 1"
  key_links:
    - from: "exportMultiWindowToFolder"
      to: "writeFileToDirectory"
      via: "single-window conditional"
      pattern: "windowsToExport\\.length === 1"
---

<objective>
Fix folder export to write files directly to selected folder for single-window projects

Purpose: GitHub Issue #2 - Users expect single-window exports to write directly to chosen folder, not create an unnecessary subfolder.
Output: Modified codeGenerator.ts with conditional logic for single-window vs multi-window folder export.
</objective>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@src/services/export/codeGenerator.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add single-window detection and direct file writing</name>
  <files>src/services/export/codeGenerator.ts</files>
  <action>
Modify the `exportMultiWindowToFolder` function to detect single-window projects and write files directly to the selected directory instead of creating a subfolder.

Current behavior (lines ~856-940):
- Always creates `windowDir = await dirHandle.getDirectoryHandle(folderName, { create: true })`
- Writes files to `windowDir`

New behavior:
1. After filtering windows to export (line ~799-808), check if `windowsToExport.length === 1`
2. If single window:
   - Write files directly to `dirHandle` (the user-selected folder)
   - Skip subfolder creation
   - Do NOT include window navigation mapping (no other windows to navigate to)
   - Write README.md to root folder
3. If multiple windows:
   - Keep existing behavior (create subfolders per window)

Implementation:
```typescript
// After windowsToExport filtering and validation...

// Check for single-window case - write directly to selected folder
const isSingleWindow = windowsToExport.length === 1

if (isSingleWindow) {
  const window = windowsToExport[0]

  // Generate files for single window
  const htmlContent = generateHTML(window.elements, {
    canvasWidth: window.width,
    canvasHeight: window.height,
    backgroundColor: window.backgroundColor,
    isPreviewMode: false,
  })

  // ... (similar file generation as existing code)

  // NO window mapping for single window (no navigation needed)
  const bindingsJS = generateBindingsJS(window.elements, {
    isPreviewMode: false,
    // No windowMapping - single window has nowhere to navigate
  })

  // Write directly to dirHandle (selected folder)
  await writeFileToDirectory(dirHandle, 'index.html', htmlContent)
  await writeFileToDirectory(dirHandle, 'style.css', cssContent)
  await writeFileToDirectory(dirHandle, 'components.js', componentsJS)
  await writeFileToDirectory(dirHandle, 'bindings.js', bindingsWithScaling)

  // Write simple README for single window
  const readme = generateSingleWindowREADME(window)
  await writeFileToDirectory(dirHandle, 'README.md', readme)

  // Handle image assets - write to dirHandle directly
  // ...

  return { success: true, folderName: dirHandle.name }
}

// Existing multi-window logic continues here...
```

Also add a `generateSingleWindowREADME` helper function:
```typescript
function generateSingleWindowREADME(window: WindowExportData): string {
  return `# VST3 WebView UI

Window: **${window.name}** (${window.width}x${window.height})

## Files

- \`index.html\` - Main HTML file to load in WebView
- \`style.css\` - Styles for all UI elements
- \`components.js\` - UI component implementations
- \`bindings.js\` - JUCE parameter bindings

## Integration

\`\`\`cpp
// In your JUCE editor component
File uiDir = File::getSpecialLocation(File::currentApplicationFile)
                 .getChildFile("Resources")
                 .getChildFile("ui");
webView->goToURL(uiDir.getChildFile("index.html").getFullPathName());
\`\`\`

## Generated by Faceplate

VST3 WebView UI Designer
`
}
```
  </action>
  <verify>
1. Build passes: `npm run build`
2. Manual test:
   - Create a single-window project
   - Export to folder
   - Verify files are written directly to selected folder (index.html, style.css, etc.)
   - No subfolder should be created
3. Manual test multi-window:
   - Create a two-window project
   - Export to folder
   - Verify subfolders are created for each window
  </verify>
  <done>
Single-window folder export writes index.html, style.css, components.js, bindings.js, README.md directly to selected folder without creating a subfolder. Multi-window export continues to create subfolders per window.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update buildInfo timestamp</name>
  <files>src/buildInfo.ts</files>
  <action>
Update the build timestamp to current time in CET format:
```typescript
export const lastUpdated = 'DD Mon HH:MM CET'
```
  </action>
  <verify>Check file contains current timestamp</verify>
  <done>buildInfo.ts has current timestamp</done>
</task>

</tasks>

<verification>
1. `npm run build` completes without errors
2. Single-window folder export writes files directly to selected folder
3. Multi-window folder export creates subfolders per window (regression check)
4. README.md is appropriate for single vs multi window case
</verification>

<success_criteria>
- Single-window project exports directly to selected folder (no subfolder)
- Multi-window project creates subfolders per window (existing behavior preserved)
- Build passes, no TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/41-bug-fixes/41-01-SUMMARY.md`
</output>
