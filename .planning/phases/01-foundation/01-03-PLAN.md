---
phase: 01-foundation
plan: 03
type: execute
wave: 3
depends_on: ["01-02"]
files_modified:
  - src/components/Canvas/CanvasStage.tsx
  - src/components/Canvas/hooks/usePan.ts
  - src/components/Canvas/hooks/useZoom.ts
  - src/components/Canvas/hooks/index.ts
  - src/store/viewportSlice.ts
autonomous: false

must_haves:
  truths:
    - "User can pan the canvas by holding spacebar and dragging"
    - "User can zoom the canvas using scroll wheel"
    - "User can zoom the canvas using trackpad pinch gesture"
    - "Canvas maintains correct coordinate transforms at all zoom levels (0.25x, 1x, 4x)"
    - "Cursor changes to grab hand when spacebar is held"
    - "Zoom centers on mouse pointer position, not canvas origin"
  artifacts:
    - path: "src/components/Canvas/hooks/usePan.ts"
      provides: "Spacebar+drag pan implementation"
      exports: ["usePan"]
    - path: "src/components/Canvas/hooks/useZoom.ts"
      provides: "Scroll/pinch zoom implementation"
      exports: ["useZoom"]
  key_links:
    - from: "src/components/Canvas/hooks/usePan.ts"
      to: "src/store/index.ts"
      via: "setViewport action"
      pattern: "setViewport|setPanning"
    - from: "src/components/Canvas/hooks/useZoom.ts"
      to: "src/store/index.ts"
      via: "setViewport action"
      pattern: "setViewport|setScale"
    - from: "src/components/Canvas/CanvasStage.tsx"
      to: "src/components/Canvas/hooks"
      via: "hook imports"
      pattern: "usePan|useZoom"
---

<objective>
Implement canvas pan and zoom interactions that follow industry-standard UX patterns (Figma, Photoshop). Users will be able to navigate the canvas freely using spacebar+drag for panning and scroll wheel/pinch for zooming.

Purpose: Pan and zoom are fundamental canvas interactions required before any element placement or manipulation. These interactions must work flawlessly as they're used constantly during design work.

Output: Fully interactive canvas with spacebar panning and scroll/pinch zooming, with correct coordinate transforms at all zoom levels.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation/01-RESEARCH.md
@.planning/phases/01-foundation/01-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement Spacebar + Drag Panning</name>
  <files>
    src/components/Canvas/hooks/usePan.ts
    src/components/Canvas/hooks/index.ts
    src/store/viewportSlice.ts
    src/components/Canvas/CanvasStage.tsx
  </files>
  <action>
    Create custom hook for pan functionality.

    Update viewportSlice.ts:
    - Add dragStart state: { x: number; y: number } | null (tracks mouse position at drag start)
    - Add setDragStart action

    Create src/components/Canvas/hooks/usePan.ts:
    - Import useStore and useEffect, useCallback from React
    - Track spacebar state with keyboard event listeners
    - On keydown Space: set isPanning true, prevent default (stops page scroll)
    - On keyup Space: set isPanning false, clear dragStart
    - Return object with:
      - isPanning: boolean
      - handlers: { onMouseDown, onMouseMove, onMouseUp } for Stage

    onMouseDown handler:
    - Only activate if isPanning is true
    - Get pointer position from Konva stage
    - Calculate dragStart: pointer position minus current offset
    - Store in dragStart state

    onMouseMove handler:
    - Only process if isPanning AND dragStart exists
    - Get current pointer position
    - Calculate new offset: pointer position minus dragStart
    - Call setViewport with current scale and new offset

    onMouseUp handler:
    - Clear dragStart (but keep isPanning true if spacebar still held)

    Create src/components/Canvas/hooks/index.ts:
    - Export usePan

    Update CanvasStage.tsx:
    - Import and call usePan hook
    - Spread pan handlers onto Stage: {...panHandlers}
    - Apply cursor style based on isPanning: 'grab' when panning, 'default' otherwise
    - When dragging (dragStart exists AND isPanning), cursor should be 'grabbing'

    CRITICAL: Add event listeners to window, not document, for consistent behavior.
    CRITICAL: Clean up event listeners in useEffect return.
  </action>
  <verify>
    Run `npm run dev`
    Hold spacebar - cursor should change to grab hand
    Hold spacebar and drag - canvas should pan (move around)
    Release spacebar while dragging - panning should stop
    Pan in all directions - canvas should follow mouse smoothly
    Check console for errors during rapid spacebar press/release
  </verify>
  <done>
    Spacebar activates pan mode with grab cursor, drag moves canvas, release stops panning, no event listener leaks
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement Scroll Wheel and Pinch Zoom</name>
  <files>
    src/components/Canvas/hooks/useZoom.ts
    src/components/Canvas/hooks/index.ts
    src/components/Canvas/CanvasStage.tsx
  </files>
  <action>
    Create custom hook for zoom functionality.

    Create src/components/Canvas/hooks/useZoom.ts:
    - Import useStore and useCallback from React
    - Define zoom constraints: MIN_SCALE = 0.1, MAX_SCALE = 10
    - Return object with:
      - handleWheel: Konva wheel event handler

    handleWheel implementation (following Konva zoom-to-pointer pattern from research):
    1. Prevent default browser scroll: e.evt.preventDefault()
    2. Get stage reference from event: e.target.getStage()
    3. Get pointer position: stage.getPointerPosition()
    4. Determine zoom direction:
       - For trackpad pinch (ctrlKey is true): use -deltaY
       - For scroll wheel: use deltaY
       - Positive = zoom out, negative = zoom in
    5. Calculate scale factor: 1.05 for zoom in, 0.95 for zoom out (5% per step)
    6. Calculate new scale: clamp(currentScale * scaleFactor, MIN_SCALE, MAX_SCALE)
    7. Calculate point under cursor BEFORE zoom: (pointer - offset) / currentScale
    8. Calculate new offset to keep point stationary: pointer - (point * newScale)
    9. Call setViewport with newScale and new offset

    Update hooks/index.ts:
    - Export useZoom

    Update CanvasStage.tsx:
    - Import and call useZoom hook
    - Add onWheel={handleWheel} to Stage

    CRITICAL: The two-step transform (steps 7-8) is essential. Without it, zoom centers on origin instead of cursor.
    CRITICAL: Handle both ctrlKey (trackpad pinch) and regular scroll (mouse wheel) - they have opposite deltaY signs.
  </action>
  <verify>
    Run `npm run dev`
    Scroll wheel up - canvas should zoom in (scale increases, indicator updates)
    Scroll wheel down - canvas should zoom out (scale decreases)
    Zoom should center on mouse cursor position (not jump to corner)
    Test at different cursor positions - zoom point should stay under cursor
    Zoom indicator should update (shows percentage)
    Test trackpad pinch if available - should also zoom
    Zoom to 0.25x (25%) and 4x (400%) - canvas should render correctly
  </verify>
  <done>
    Scroll wheel zooms in/out, pinch gesture zooms, zoom centers on cursor, scale clamped to 0.1-10 range, indicator updates
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete Phase 1 foundation: three-panel layout with canvas, pan with spacebar+drag, zoom with scroll/pinch, configurable canvas dimensions and background.
  </what-built>
  <how-to-verify>
    1. Open the app at http://localhost:5173 (or the port shown in terminal)
    2. Verify three-panel layout: left panel "Elements", center canvas, right panel "Properties"
    3. Verify dark theme: gray backgrounds, light text
    4. Verify canvas: visible 800x600 canvas with dark background and border

    5. Test PAN:
       - Hold spacebar - cursor should change to grab hand
       - While holding spacebar, click and drag - canvas should move
       - Release spacebar - panning should stop, cursor returns to default

    6. Test ZOOM:
       - Scroll wheel up/down - canvas should zoom in/out
       - Watch the zoom indicator (bottom-right) - should update percentage
       - Zoom while cursor is over different parts of canvas - zoom should center on cursor
       - If you have trackpad: pinch gesture should also zoom

    7. Test canvas configuration:
       - Change width/height inputs in right panel - canvas border should resize
       - Change background color - canvas should update immediately

    8. Test zoom levels:
       - Zoom out to ~25% - canvas should still render correctly, be small
       - Zoom in to ~400% - canvas should be large, no visual glitches
       - Pan while zoomed - should work smoothly

    9. Test coordinate correctness:
       - Zoom to 2x, pan canvas so it's offset
       - The canvas background and border should stay perfectly aligned
  </how-to-verify>
  <resume-signal>Type "approved" if all checks pass, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
After completing all tasks:
1. Spacebar + drag pans the canvas smoothly
2. Scroll wheel zooms in/out centered on cursor
3. Trackpad pinch also zooms (if hardware supports)
4. Zoom indicator shows current scale percentage
5. Canvas renders correctly at extreme zoom levels (0.25x to 4x)
6. Pan works correctly at all zoom levels
7. No console errors during interaction
8. Event listeners cleaned up properly (no memory leaks)
</verification>

<success_criteria>
- Spacebar hold shows grab cursor
- Spacebar + drag pans canvas in all directions
- Scroll wheel zooms centered on cursor position
- Trackpad pinch zooms (ctrlKey + deltaY handling)
- Zoom clamped between 0.1 (10%) and 10 (1000%)
- Zoom indicator updates in real-time
- Pan and zoom work together at all scale levels
- No coordinate drift at extreme zooms (0.25x, 4x)
- All Phase 1 success criteria from ROADMAP met:
  1. Empty canvas with configurable dimensions in three-panel layout
  2. Pan with spacebar+drag
  3. Zoom with scroll/pinch
  4. Configurable background
  5. Correct coordinate transforms at all zoom levels
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-03-SUMMARY.md`
</output>
