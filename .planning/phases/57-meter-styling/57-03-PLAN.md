---
phase: 57-meter-styling
plan: 03
type: execute
wave: 2
depends_on: ["57-01"]
files_modified:
  - src/components/Properties/meters/SharedMeterProperties.tsx
  - src/services/export/svgElementExport.ts
autonomous: true

must_haves:
  truths:
    - "PropertyPanel shows style dropdown for all professional meters"
    - "Color override controls appear when style is selected"
    - "Peak color override control is available"
    - "Peak hold duration control is available and configurable per-element"
    - "LAYER_CONVENTIONS includes meter zone fill layers"
  artifacts:
    - path: "src/components/Properties/meters/SharedMeterProperties.tsx"
      provides: "Style dropdown, color override controls, and peak hold duration for meters"
      contains: "peakHoldDuration"
    - path: "src/services/export/svgElementExport.ts"
      provides: "Meter zone fill layer naming conventions"
      contains: "meter-fill-green"
  key_links:
    - from: "src/components/Properties/meters/SharedMeterProperties.tsx"
      to: "src/store/slices/elementStylesSlice.ts"
      via: "getStylesByCategory selector"
      pattern: "getStylesByCategory"
---

<objective>
Add style dropdown, color override controls, and peak hold duration control to SharedMeterProperties, and update LAYER_CONVENTIONS with zone fill layer names.

Purpose: Enable users to select SVG styles for meters, override peak indicator color, and configure peak hold duration through the PropertyPanel (satisfying CONTEXT.md locked decision).
Output: Complete PropertyPanel integration and export layer naming support for meter styling.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/57-meter-styling/57-CONTEXT.md
@.planning/phases/57-meter-styling/57-RESEARCH.md
@.planning/phases/57-meter-styling/57-01-SUMMARY.md
@src/components/Properties/meters/SharedMeterProperties.tsx
@src/components/Properties/controls/KnobProperties.tsx
@src/services/export/svgElementExport.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add style dropdown, color overrides, and peak hold duration to SharedMeterProperties</name>
  <files>src/components/Properties/meters/SharedMeterProperties.tsx</files>
  <action>
Update SharedMeterProperties to include SVG style selection, color override controls, and peak hold duration, following the pattern from KnobProperties.tsx.

1. Add imports at top of file:
```typescript
import { useStore } from '../../../store'
import { ColorPicker } from '../ColorPicker'
```

2. Get styles from store:
```typescript
const getStylesByCategory = useStore((state) => state.getStylesByCategory)
const meterStyles = getStylesByCategory('meter')
```

3. Add Style section after Meter Type Label, before Orientation:
```typescript
{/* Style */}
<PropertySection title="Style">
  <div>
    <label className="block text-xs text-gray-400 mb-1">Meter Style</label>
    <select
      value={config.styleId || ''}
      onChange={(e) => update({ styleId: e.target.value || undefined })}
      className="w-full bg-gray-700 border border-gray-600 text-white rounded px-2 py-1.5 text-sm"
    >
      <option value="">Default (Segmented)</option>
      {meterStyles.map((style) => (
        <option key={style.id} value={style.id}>
          {style.name}
        </option>
      ))}
    </select>
  </div>
</PropertySection>
```

4. Add Peak Hold Duration control (always visible - applies to both default and styled renderers):
```typescript
{/* Peak Hold Duration */}
<PropertySection title="Peak Hold">
  <div>
    <label className="block text-xs text-gray-400 mb-1">
      Hold Duration (ms)
    </label>
    <input
      type="number"
      min={500}
      max={5000}
      step={100}
      value={config.peakHoldDuration ?? 1000}
      onChange={(e) => {
        const value = parseInt(e.target.value, 10)
        // Clamp to valid range
        const clamped = Math.max(500, Math.min(5000, value || 1000))
        update({ peakHoldDuration: clamped })
      }}
      className="w-full bg-gray-700 border border-gray-600 text-white rounded px-2 py-1.5 text-sm"
    />
    <div className="text-xs text-gray-500 mt-1">
      How long peak indicator holds before dropping (500-5000ms)
    </div>
  </div>
</PropertySection>
```

5. Add Color Overrides section (only shown when styleId is set):
```typescript
{/* Color Overrides (only when using SVG style) */}
{config.styleId && (
  <PropertySection title="Color Overrides">
    <div>
      <label className="block text-xs text-gray-400 mb-1">Peak Indicator</label>
      <ColorPicker
        color={config.colorOverrides?.peak || '#ef4444'}
        onChange={(color) => update({
          colorOverrides: { ...config.colorOverrides, peak: color }
        })}
      />
    </div>
    <div className="text-xs text-gray-500 mt-2">
      Override colors for specific SVG layers
    </div>
  </PropertySection>
)}
```

6. Update the interface to accept config with styleId and peakHoldDuration:
The SharedMeterPropertiesProps interface already accepts BaseProfessionalMeterConfig which now includes styleId, colorOverrides, and peakHoldDuration from Plan 01.

Key points:
- Style dropdown shows "Default (Segmented)" when no style is selected
- Peak hold duration is always visible (applies to both renderers)
- Peak hold duration defaults to 1000ms, range 500-5000ms (per CONTEXT.md)
- Peak color override uses #ef4444 (red) as default
- Color overrides section only appears when a style is selected
- Follow existing PropertySection patterns for consistency
- This satisfies CONTEXT.md locked decision: "Peak hold duration: configurable per-element via PropertyPanel property"
  </action>
  <verify>Run `npm run dev`, open any professional meter's properties, verify Style section and Peak Hold Duration control appear</verify>
  <done>SharedMeterProperties shows style dropdown with available meter styles; peak hold duration control with 500-5000ms range; color override controls appear when style is selected</done>
</task>

<task type="auto">
  <name>Task 2: Update LAYER_CONVENTIONS with meter zone fill layers</name>
  <files>src/services/export/svgElementExport.ts</files>
  <action>
Update LAYER_CONVENTIONS.meter to include zone fill layer names for multi-zone meter SVGs.

Update the meter array:
```typescript
meter: [
  'meter-body',
  'meter-fill',
  'meter-fill-green',
  'meter-fill-yellow',
  'meter-fill-red',
  'meter-scale',
  'meter-peak',
  'meter-segments'
],
```

Key points:
- 'meter-fill' is the single fill layer (fallback)
- 'meter-fill-green', 'meter-fill-yellow', 'meter-fill-red' are zone layers
- Keep 'meter-segments' for legacy compatibility
- Order matches typical stacking order (body first, peak/segments last)

This enables:
1. SVG export includes correct layer names
2. getLayerNamesForType('meter') returns complete list
3. Layer detection can find zone layers by convention
  </action>
  <verify>Run `npx tsc --noEmit`; grep LAYER_CONVENTIONS in file shows updated meter array</verify>
  <done>LAYER_CONVENTIONS.meter includes fill-green, fill-yellow, fill-red zone layer names</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. `npm run dev` starts without errors
3. Any professional meter's PropertyPanel shows "Style" section with dropdown
4. Any professional meter's PropertyPanel shows "Peak Hold" section with duration input (500-5000ms)
5. Selecting a style (if available) shows "Color Overrides" section with Peak Indicator color picker
6. LAYER_CONVENTIONS.meter includes 'meter-fill-green', 'meter-fill-yellow', 'meter-fill-red'
</verification>

<success_criteria>
- Style dropdown appears in PropertyPanel for all professional meters
- Dropdown shows "Default (Segmented)" option and any available meter styles
- Peak Hold Duration input appears with default 1000ms and range 500-5000ms
- Color Overrides section appears only when a style is selected
- Peak indicator color override is available
- LAYER_CONVENTIONS.meter includes zone fill layer names
- No TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/57-meter-styling/57-03-SUMMARY.md`
</output>
