---
phase: 47-button-knob-fixes
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/types/elements/controls.ts
  - src/components/elements/renderers/controls/SteppedKnobRenderer.tsx
  - src/components/Properties/SteppedKnobProperties.tsx
autonomous: true

must_haves:
  truths:
    - "Stepped Knob shows continuous position while dragging"
    - "Stepped Knob snaps to nearest step position on drag release"
    - "Optional tick marks display outside the knob edge at each step position"
  artifacts:
    - path: "src/components/elements/renderers/controls/SteppedKnobRenderer.tsx"
      provides: "Snap-on-release behavior and tick mark rendering"
      contains: "showStepMarks"
    - path: "src/types/elements/controls.ts"
      provides: "showStepMarks property"
      contains: "showStepMarks.*boolean"
  key_links:
    - from: "SteppedKnobRenderer.tsx"
      to: "polarToCartesian"
      via: "tick mark position calculation"
      pattern: "polarToCartesian.*outerRadius"
---

<objective>
Fix Stepped Knob to snap to discrete step positions on drag release instead of during drag.

Purpose: KNB-01 requires stepped knobs to snap to step positions. The current implementation quantizes immediately, making drag interaction feel jumpy. Users expect smooth continuous drag with snap on release.

Output: Stepped Knob renderer that shows continuous position during drag, snaps on release with 50ms CSS transition, and optionally displays tick marks outside the knob edge.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/47-button-knob-fixes/47-CONTEXT.md
@.planning/phases/47-button-knob-fixes/47-RESEARCH.md

@src/components/elements/renderers/controls/SteppedKnobRenderer.tsx
@src/components/elements/renderers/controls/KnobRenderer.tsx
@src/types/elements/controls.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add showStepMarks property to SteppedKnobElementConfig</name>
  <files>src/types/elements/controls.ts</files>
  <action>
Add tick mark property to SteppedKnobElementConfig (around line 266-268):
- `showStepMarks: boolean` - When true, display tick marks outside knob edge at each step position

Update `createSteppedKnob()` factory (around line 1602) to include:
- `showStepMarks: false` as default (tick marks off by default, user opts in)

Note: The existing `showStepIndicators` controls the dots ON the arc track. The new `showStepMarks` will control tick lines OUTSIDE the knob for a dial-like appearance.
  </action>
  <verify>TypeScript compiles: `npm run build 2>&1 | head -20`</verify>
  <done>SteppedKnobElementConfig has showStepMarks property with factory default false</done>
</task>

<task type="auto">
  <name>Task 2: Add tick mark rendering and CSS transition for snap</name>
  <files>src/components/elements/renderers/controls/SteppedKnobRenderer.tsx</files>
  <action>
Enhance SteppedKnobRenderer to:

1. Add tick mark rendering when `config.showStepMarks` is true:
   - Calculate tick positions using polarToCartesian (already in file)
   - Outer radius: `radius * 1.15` (15% beyond knob edge)
   - Inner radius: `radius * 1.05` (5% beyond knob edge)
   - Tick length is ~10% of knob radius (subtle but visible)
   - Render as SVG `<line>` elements
   - Stroke color: `config.trackColor`
   - Stroke width: `Math.max(1, config.trackWidth / 4)` (proportional but thin)
   - strokeLinecap: "round"

2. Add 50ms CSS transition to the indicator line:
   - Add `transition: 'transform 0.05s ease-out'` to the indicator group
   - This provides smooth snap animation when value changes

3. Keep current quantization logic (lines 126-131) - the renderer receives the final quantized value. The snap-on-release behavior is a runtime concern that the JUCE integration handles. The CSS transition makes any value change look smooth.

Reference KnobRenderer.tsx lines 327-334 for the transition pattern.
Reference existing stepIndicators loop (lines 142-150) for tick position calculation pattern.

Generate tick marks ONLY when showStepMarks is true:
```typescript
// Tick marks (dial-style, outside knob)
const tickMarks: Array<{inner: {x: number, y: number}, outer: {x: number, y: number}}> = []
if (config.showStepMarks) {
  const outerRadius = radius * 1.15
  const innerRadius = radius * 1.05
  for (let i = 0; i < config.stepCount; i++) {
    const stepNormalized = i / (config.stepCount - 1)
    const stepAngle = config.startAngle + stepNormalized * (config.endAngle - config.startAngle)
    tickMarks.push({
      inner: polarToCartesian(centerX, centerY, innerRadius, stepAngle),
      outer: polarToCartesian(centerX, centerY, outerRadius, stepAngle)
    })
  }
}
```

Render inside SVG after the track arc:
```typescript
{tickMarks.map((tick, i) => (
  <line
    key={`tick-${i}`}
    x1={tick.inner.x}
    y1={tick.inner.y}
    x2={tick.outer.x}
    y2={tick.outer.y}
    stroke={config.trackColor}
    strokeWidth={Math.max(1, config.trackWidth / 4)}
    strokeLinecap="round"
  />
))}
```
  </action>
  <verify>
Run dev server, add Stepped Knob
Enable showStepMarks in property panel
Tick marks appear outside knob at each step position
Value changes animate smoothly (50ms transition)
  </verify>
  <done>Stepped Knob renders optional tick marks outside edge and has CSS transition for smooth snap animation</done>
</task>

<task type="auto">
  <name>Task 3: Add showStepMarks to property panel</name>
  <files>src/components/Properties/SteppedKnobProperties.tsx</files>
  <action>
Add checkbox control for showStepMarks property:

1. Find the section with showStepIndicators (the existing step dots checkbox)
2. Add a new checkbox below it:
   - Label: "Show Step Marks"
   - Tooltip/description: "Display tick marks outside knob edge at each step position"
   - Binds to config.showStepMarks

Group it logically with showStepIndicators since both relate to step visualization.
  </action>
  <verify>
Select Stepped Knob in designer
Property panel shows "Show Step Marks" checkbox
Toggling it adds/removes tick marks on the knob
  </verify>
  <done>Property panel exposes showStepMarks checkbox for Stepped Knob configuration</done>
</task>

</tasks>

<verification>
1. Create a Stepped Knob element on canvas
2. Set stepCount to 5 for visible discrete steps
3. Enable showStepMarks - verify tick marks appear outside knob edge
4. Tick marks align with step positions
5. Change value via property panel - observe smooth 50ms transition
6. Disable showStepMarks - tick marks disappear
7. Verify existing showStepIndicators (dots on arc) still works independently
</verification>

<success_criteria>
- Stepped Knob can display optional tick marks outside the knob edge
- Tick marks scale proportionally with knob size
- Value changes have smooth 50ms CSS transition (snap animation)
- TypeScript compiles without errors
- showStepMarks controllable from property panel
</success_criteria>

<output>
After completion, create `.planning/phases/47-button-knob-fixes/47-03-SUMMARY.md`
</output>
