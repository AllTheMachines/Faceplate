---
phase: 54-knob-variants
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/types/elements/controls.ts
  - src/components/elements/renderers/controls/CenterDetentKnobRenderer.tsx
  - src/components/Properties/CenterDetentKnobProperties.tsx
autonomous: true

must_haves:
  truths:
    - "Center Detent Knob accepts styleId and renders with SVG layers"
    - "Arc layer hides when value is at center (within snap threshold)"
    - "Indicator rotates smoothly, snaps visually to center position"
    - "Style dropdown shows rotary styles from elementStyles"
    - "Color overrides allow per-instance layer color customization"
    - "Default CSS rendering unchanged when no styleId set"
  artifacts:
    - path: "src/types/elements/controls.ts"
      provides: "CenterDetentKnobElementConfig with styleId and colorOverrides"
      contains: "styleId?: string"
    - path: "src/components/elements/renderers/controls/CenterDetentKnobRenderer.tsx"
      provides: "StyledCenterDetentKnobRenderer function"
      contains: "StyledCenterDetentKnobRenderer"
    - path: "src/components/Properties/CenterDetentKnobProperties.tsx"
      provides: "Style dropdown and color overrides UI"
      contains: "getStylesByCategory"
  key_links:
    - from: "CenterDetentKnobRenderer.tsx"
      to: "elementStylesSlice"
      via: "useStore getElementStyle"
      pattern: "getElementStyle\\(config\\.styleId\\)"
    - from: "CenterDetentKnobProperties.tsx"
      to: "elementStylesSlice"
      via: "useStore getStylesByCategory"
      pattern: "getStylesByCategory\\('rotary'\\)"
---

<objective>
Add SVG styling support to Center Detent Knob using the elementStyles system from Phase 53.

Purpose: Enable users to apply custom SVG designs to Center Detent Knob elements with center snap behavior preserved.
Output: Center Detent Knob accepts styleId, renders with SVG layers, shows style dropdown in properties panel.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/54-knob-variants/54-CONTEXT.md
@.planning/phases/54-knob-variants/54-RESEARCH.md

# Key references
@src/components/elements/renderers/controls/KnobRenderer.tsx (exact pattern to follow)
@src/types/elementStyle.ts (RotaryLayers, ElementStyle, ColorOverrides)
@src/store/elementStylesSlice.ts (getStylesByCategory, getElementStyle)
@src/services/elementLayers.ts (extractElementLayer)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend CenterDetentKnobElementConfig with styleId and colorOverrides</name>
  <files>src/types/elements/controls.ts</files>
  <action>
Add styleId and colorOverrides properties to CenterDetentKnobElementConfig interface.

In CenterDetentKnobElementConfig interface (around line 302-348), add after the existing valueColor property:

```typescript
  // SVG Style (optional - if undefined, render default CSS knob)
  styleId?: string

  // Per-instance color overrides (only used when styleId is set)
  colorOverrides?: ColorOverrides
```

Note: ColorOverrides is already imported from knobStyle.ts for KnobElementConfig - reuse same import.
  </action>
  <verify>TypeScript compiles without errors: `npm run build 2>&1 | head -50`</verify>
  <done>CenterDetentKnobElementConfig has optional styleId and colorOverrides properties</done>
</task>

<task type="auto">
  <name>Task 2: Add StyledCenterDetentKnobRenderer with center snap behavior</name>
  <files>src/components/elements/renderers/controls/CenterDetentKnobRenderer.tsx</files>
  <action>
Add StyledCenterDetentKnobRenderer function alongside existing implementation.

1. Add imports at top:
```typescript
import { useMemo } from 'react'
import { useStore } from '../../../../store'
import { SafeSVG } from '../../../SafeSVG'
import { extractElementLayer } from '../../../../services/elementLayers'
import { applyAllColorOverrides } from '../../../../services/knobLayers'
```

2. Rename existing `CenterDetentKnobRenderer` to `DefaultCenterDetentKnobRenderer` (keep implementation unchanged)

3. Add new StyledCenterDetentKnobRenderer function:
```typescript
function StyledCenterDetentKnobRenderer({ config }: CenterDetentKnobRendererProps) {
  const getElementStyle = useStore((state) => state.getElementStyle)
  const style = config.styleId ? getElementStyle(config.styleId) : undefined

  // Category validation - must be rotary
  if (style && style.category !== 'rotary') {
    console.warn('CenterDetentKnob requires rotary category style')
    return null
  }

  // Calculate normalized value
  const normalizedValue = (config.value - config.min) / (config.max - config.min)

  // Check if at center (within snap threshold)
  const isAtCenter = Math.abs(normalizedValue - 0.5) < config.snapThreshold

  // Memoize SVG content with color overrides
  const svgContent = useMemo(() => {
    if (!style) return ''
    return applyAllColorOverrides(style.svgContent, style.layers, config.colorOverrides)
  }, [style, config.colorOverrides])

  // Calculate rotation angle (smooth, no quantization)
  const indicatorAngle = useMemo(() => {
    if (!style) return 0
    const rotationRange = style.maxAngle - style.minAngle
    return style.minAngle + normalizedValue * rotationRange
  }, [style, normalizedValue])

  // Extract layers
  const layers = useMemo(() => {
    if (!style || !svgContent) return null
    return {
      track: style.layers.track ? extractElementLayer(svgContent, style.layers.track) : null,
      shadow: style.layers.shadow ? extractElementLayer(svgContent, style.layers.shadow) : null,
      arc: style.layers.arc ? extractElementLayer(svgContent, style.layers.arc) : null,
      indicator: style.layers.indicator ? extractElementLayer(svgContent, style.layers.indicator) : null,
      glow: style.layers.glow ? extractElementLayer(svgContent, style.layers.glow) : null,
    }
  }, [style, svgContent])

  // Format value
  const formattedValue = formatValue(
    normalizedValue,
    config.min,
    config.max,
    config.valueFormat,
    config.valueSuffix,
    config.valueDecimalPlaces
  )

  // Style not found fallback
  if (!style) {
    return (
      <div style={{
        width: '100%', height: '100%',
        display: 'flex', alignItems: 'center', justifyContent: 'center',
        background: '#374151', borderRadius: '50%',
        color: '#9CA3AF', fontSize: '12px', textAlign: 'center', padding: '8px',
      }}>
        Style not found
      </div>
    )
  }

  return (
    <div style={{ position: 'relative', width: '100%', height: '100%' }}>
      {/* Track - static background */}
      {layers?.track && (
        <div style={{ position: 'absolute', inset: 0 }}>
          <SafeSVG content={layers.track} style={{ width: '100%', height: '100%' }} />
        </div>
      )}

      {/* Shadow - static */}
      {layers?.shadow && (
        <div style={{ position: 'absolute', inset: 0 }}>
          <SafeSVG content={layers.shadow} style={{ width: '100%', height: '100%' }} />
        </div>
      )}

      {/* Arc - HIDES when at center (position-only feedback per CONTEXT.md decision) */}
      {layers?.arc && !isAtCenter && (
        <div style={{
          position: 'absolute', inset: 0,
          opacity: Math.abs(normalizedValue - 0.5) * 2, // 0 at center, 1 at extremes
          transition: 'opacity 0.05s ease-out',
        }}>
          <SafeSVG content={layers.arc} style={{ width: '100%', height: '100%' }} />
        </div>
      )}

      {/* Indicator - rotates smoothly */}
      {layers?.indicator && (
        <div style={{
          position: 'absolute', inset: 0,
          transform: `rotate(${indicatorAngle}deg)`,
          transformOrigin: 'center center',
          transition: 'transform 0.05s ease-out',
        }}>
          <SafeSVG content={layers.indicator} style={{ width: '100%', height: '100%' }} />
        </div>
      )}

      {/* Glow - intensity based on distance from center */}
      {layers?.glow && (
        <div style={{
          position: 'absolute', inset: 0,
          opacity: Math.abs(normalizedValue - 0.5) * 2 * 0.7 + 0.3,
          transition: 'opacity 0.05s ease-out',
        }}>
          <SafeSVG content={layers.glow} style={{ width: '100%', height: '100%' }} />
        </div>
      )}

      {/* Label */}
      {config.showLabel && <span style={getLabelStyle(config)}>{config.labelText}</span>}

      {/* Value Display */}
      {config.showValue && <span style={getValueStyle(config)}>{formattedValue}</span>}
    </div>
  )
}
```

4. Add new main export function that delegates:
```typescript
export function CenterDetentKnobRenderer({ config }: CenterDetentKnobRendererProps) {
  if (!config.styleId) {
    return <DefaultCenterDetentKnobRenderer config={config} />
  }
  return <StyledCenterDetentKnobRenderer config={config} />
}
```
  </action>
  <verify>TypeScript compiles: `npm run build 2>&1 | head -50`</verify>
  <done>CenterDetentKnobRenderer delegates to Default or Styled based on styleId, arc hides at center</done>
</task>

<task type="auto">
  <name>Task 3: Add style dropdown and color overrides to CenterDetentKnobProperties</name>
  <files>src/components/Properties/CenterDetentKnobProperties.tsx</files>
  <action>
Add style selection dropdown and color override controls.

1. First read the current file to understand its structure, then add:

2. Add imports at top:
```typescript
import { useStore } from '../../store'
import { useLicense } from '../../hooks/useLicense'
import { RotaryLayers } from '../../types/elementStyle'
```

3. Add store selectors and license check inside component:
```typescript
const { isPro } = useLicense()
const getStylesByCategory = useStore((state) => state.getStylesByCategory)
const getElementStyle = useStore((state) => state.getElementStyle)
const rotaryStyles = getStylesByCategory('rotary')
```

4. Add Style Selection section at TOP of return (before Center Detent Behavior):
```typescript
{/* Knob Style - Pro feature */}
{isPro && (
  <PropertySection title="Knob Style">
    <div>
      <label className="block text-xs text-gray-400 mb-1">Style</label>
      <select
        value={element.styleId || ''}
        onChange={(e) => {
          const value = e.target.value
          onUpdate({
            styleId: value === '' ? undefined : value,
            colorOverrides: undefined, // Reset on style change
          })
        }}
        className="w-full bg-gray-700 border border-gray-600 text-white rounded px-2 py-1.5 text-sm"
      >
        <option value="">Default (CSS)</option>
        {rotaryStyles.map((style) => (
          <option key={style.id} value={style.id}>
            {style.name}
          </option>
        ))}
      </select>
    </div>
  </PropertySection>
)}

{/* Color Overrides - only when SVG style selected */}
{isPro && element.styleId && (() => {
  const style = getElementStyle(element.styleId)
  if (!style || style.category !== 'rotary') return null

  const layerNames: Array<keyof RotaryLayers> = ['indicator', 'track', 'arc', 'glow', 'shadow']
  const existingLayers = layerNames.filter((layerName) => style.layers[layerName])

  if (existingLayers.length === 0) return null

  return (
    <PropertySection title="Color Overrides">
      {existingLayers.map((layerName) => (
        <ColorInput
          key={layerName}
          label={layerName.charAt(0).toUpperCase() + layerName.slice(1)}
          value={element.colorOverrides?.[layerName] || ''}
          onChange={(color) => {
            const newOverrides = { ...element.colorOverrides }
            if (color) {
              newOverrides[layerName] = color
            } else {
              delete newOverrides[layerName]
            }
            onUpdate({ colorOverrides: newOverrides })
          }}
        />
      ))}
      <button
        onClick={() => onUpdate({ colorOverrides: undefined })}
        className="w-full text-left text-sm text-red-400 hover:text-red-300 mt-1"
      >
        Reset to Original Colors
      </button>
    </PropertySection>
  )
})()}
```
  </action>
  <verify>TypeScript compiles: `npm run build 2>&1 | head -50`</verify>
  <done>CenterDetentKnobProperties shows style dropdown and color overrides for Pro users</done>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors
2. Dev server starts: `npm run dev`
3. Center Detent Knob on canvas still renders with CSS (no styleId)
4. When rotary styles exist, dropdown shows them in properties panel
5. Arc layer should hide when value is at center (behavior test)
</verification>

<success_criteria>
- CenterDetentKnobElementConfig has styleId and colorOverrides properties
- CenterDetentKnobRenderer delegates to Default (CSS) or Styled (SVG) based on styleId
- StyledCenterDetentKnobRenderer hides arc layer when isAtCenter is true
- CenterDetentKnobProperties shows style dropdown (Pro users only)
- Color overrides section appears when style is selected
</success_criteria>

<output>
After completion, create `.planning/phases/54-knob-variants/54-02-SUMMARY.md`
</output>
