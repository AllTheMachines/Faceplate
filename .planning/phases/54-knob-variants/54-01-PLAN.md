---
phase: 54-knob-variants
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/types/elements/controls.ts
  - src/components/elements/renderers/controls/SteppedKnobRenderer.tsx
  - src/components/Properties/SteppedKnobProperties.tsx
autonomous: true

must_haves:
  truths:
    - "Stepped Knob accepts styleId and renders with SVG layers"
    - "Indicator rotates to discrete positions (stepped quantization)"
    - "Style dropdown shows rotary styles from elementStyles"
    - "Color overrides allow per-instance layer color customization"
    - "Default CSS rendering unchanged when no styleId set"
  artifacts:
    - path: "src/types/elements/controls.ts"
      provides: "SteppedKnobElementConfig with styleId and colorOverrides"
      contains: "styleId?: string"
    - path: "src/components/elements/renderers/controls/SteppedKnobRenderer.tsx"
      provides: "StyledSteppedKnobRenderer function"
      contains: "StyledSteppedKnobRenderer"
    - path: "src/components/Properties/SteppedKnobProperties.tsx"
      provides: "Style dropdown and color overrides UI"
      contains: "getStylesByCategory"
  key_links:
    - from: "SteppedKnobRenderer.tsx"
      to: "elementStylesSlice"
      via: "useStore getElementStyle"
      pattern: "getElementStyle\\(config\\.styleId\\)"
    - from: "SteppedKnobProperties.tsx"
      to: "elementStylesSlice"
      via: "useStore getStylesByCategory"
      pattern: "getStylesByCategory\\('rotary'\\)"
---

<objective>
Add SVG styling support to Stepped Knob using the elementStyles system from Phase 53.

Purpose: Enable users to apply custom SVG designs to Stepped Knob elements with stepped rotation behavior preserved.
Output: Stepped Knob accepts styleId, renders with SVG layers, shows style dropdown in properties panel.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/54-knob-variants/54-CONTEXT.md
@.planning/phases/54-knob-variants/54-RESEARCH.md

# Key references
@src/components/elements/renderers/controls/KnobRenderer.tsx (exact pattern to follow)
@src/types/elementStyle.ts (RotaryLayers, ElementStyle, ColorOverrides)
@src/store/elementStylesSlice.ts (getStylesByCategory, getElementStyle)
@src/services/elementLayers.ts (extractElementLayer)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend SteppedKnobElementConfig with styleId and colorOverrides</name>
  <files>src/types/elements/controls.ts</files>
  <action>
Add styleId and colorOverrides properties to SteppedKnobElementConfig interface.

1. Add import for ColorOverrides from elementStyle.ts (it's already imported from knobStyle.ts, keep that for KnobElementConfig, add second import from elementStyle.ts or use the same ColorOverrides type since they're identical)

2. In SteppedKnobElementConfig interface (around line 250-300), add after the existing properties:
```typescript
  // SVG Style (optional - if undefined, render default CSS knob)
  styleId?: string

  // Per-instance color overrides (only used when styleId is set)
  colorOverrides?: ColorOverrides
```

Note: The ColorOverrides type from knobStyle.ts and elementStyle.ts are identical (both are `{ [layerRole: string]: string }`), so you can use the existing import.
  </action>
  <verify>TypeScript compiles without errors: `npm run build 2>&1 | head -50`</verify>
  <done>SteppedKnobElementConfig has optional styleId and colorOverrides properties</done>
</task>

<task type="auto">
  <name>Task 2: Add StyledSteppedKnobRenderer with stepped rotation</name>
  <files>src/components/elements/renderers/controls/SteppedKnobRenderer.tsx</files>
  <action>
Add StyledSteppedKnobRenderer function alongside existing DefaultSteppedKnobRenderer (which stays unchanged).

1. Add imports at top:
```typescript
import { useMemo } from 'react'
import { useStore } from '../../../../store'
import { SafeSVG } from '../../../SafeSVG'
import { extractElementLayer } from '../../../../services/elementLayers'
import { applyAllColorOverrides } from '../../../../services/knobLayers'
```

2. Rename existing `SteppedKnobRenderer` to `DefaultSteppedKnobRenderer` (keep implementation unchanged)

3. Add new StyledSteppedKnobRenderer function (follow KnobRenderer.tsx pattern exactly):
```typescript
function StyledSteppedKnobRenderer({ config }: SteppedKnobRendererProps) {
  const getElementStyle = useStore((state) => state.getElementStyle)
  const style = config.styleId ? getElementStyle(config.styleId) : undefined

  // Category validation - must be rotary
  if (style && style.category !== 'rotary') {
    console.warn('SteppedKnob requires rotary category style')
    return null
  }

  // Calculate stepped value (quantize BEFORE rotation)
  const normalizedValue = (config.value - config.min) / (config.max - config.min)
  const stepSize = 1 / (config.stepCount - 1)
  const steppedValue = Math.round(normalizedValue / stepSize) * stepSize

  // Memoize SVG content with color overrides
  const svgContent = useMemo(() => {
    if (!style) return ''
    return applyAllColorOverrides(style.svgContent, style.layers, config.colorOverrides)
  }, [style, config.colorOverrides])

  // Calculate rotation angle with stepped value
  const indicatorAngle = useMemo(() => {
    if (!style) return 0
    const rotationRange = style.maxAngle - style.minAngle
    return style.minAngle + steppedValue * rotationRange
  }, [style, steppedValue])

  // Extract layers
  const layers = useMemo(() => {
    if (!style || !svgContent) return null
    return {
      track: style.layers.track ? extractElementLayer(svgContent, style.layers.track) : null,
      shadow: style.layers.shadow ? extractElementLayer(svgContent, style.layers.shadow) : null,
      arc: style.layers.arc ? extractElementLayer(svgContent, style.layers.arc) : null,
      indicator: style.layers.indicator ? extractElementLayer(svgContent, style.layers.indicator) : null,
      glow: style.layers.glow ? extractElementLayer(svgContent, style.layers.glow) : null,
    }
  }, [style, svgContent])

  // Format value
  const formattedValue = formatValue(
    steppedValue,
    config.min,
    config.max,
    config.valueFormat,
    config.valueSuffix,
    config.valueDecimalPlaces
  )

  // Style not found fallback
  if (!style) {
    return (
      <div style={{
        width: '100%', height: '100%',
        display: 'flex', alignItems: 'center', justifyContent: 'center',
        background: '#374151', borderRadius: '50%',
        color: '#9CA3AF', fontSize: '12px', textAlign: 'center', padding: '8px',
      }}>
        Style not found
      </div>
    )
  }

  return (
    <div style={{ position: 'relative', width: '100%', height: '100%' }}>
      {/* Track - static background */}
      {layers?.track && (
        <div style={{ position: 'absolute', inset: 0 }}>
          <SafeSVG content={layers.track} style={{ width: '100%', height: '100%' }} />
        </div>
      )}

      {/* Shadow - static */}
      {layers?.shadow && (
        <div style={{ position: 'absolute', inset: 0 }}>
          <SafeSVG content={layers.shadow} style={{ width: '100%', height: '100%' }} />
        </div>
      )}

      {/* Arc - animated by value */}
      {layers?.arc && (
        <div style={{
          position: 'absolute', inset: 0,
          opacity: steppedValue,
          transition: 'opacity 0.05s ease-out',
        }}>
          <SafeSVG content={layers.arc} style={{ width: '100%', height: '100%' }} />
        </div>
      )}

      {/* Indicator - rotates with snap transition */}
      {layers?.indicator && (
        <div style={{
          position: 'absolute', inset: 0,
          transform: `rotate(${indicatorAngle}deg)`,
          transformOrigin: 'center center',
          transition: 'transform 0.05s ease-out',
        }}>
          <SafeSVG content={layers.indicator} style={{ width: '100%', height: '100%' }} />
        </div>
      )}

      {/* Glow - intensity by value */}
      {layers?.glow && (
        <div style={{
          position: 'absolute', inset: 0,
          opacity: steppedValue * 0.7 + 0.3,
          transition: 'opacity 0.05s ease-out',
        }}>
          <SafeSVG content={layers.glow} style={{ width: '100%', height: '100%' }} />
        </div>
      )}

      {/* Label */}
      {config.showLabel && <span style={getLabelStyle(config)}>{config.labelText}</span>}

      {/* Value Display */}
      {config.showValue && <span style={getValueStyle(config)}>{formattedValue}</span>}
    </div>
  )
}
```

4. Add new main export function that delegates:
```typescript
export function SteppedKnobRenderer({ config }: SteppedKnobRendererProps) {
  if (!config.styleId) {
    return <DefaultSteppedKnobRenderer config={config} />
  }
  return <StyledSteppedKnobRenderer config={config} />
}
```
  </action>
  <verify>TypeScript compiles: `npm run build 2>&1 | head -50`</verify>
  <done>SteppedKnobRenderer delegates to Default or Styled based on styleId presence</done>
</task>

<task type="auto">
  <name>Task 3: Add style dropdown and color overrides to SteppedKnobProperties</name>
  <files>src/components/Properties/SteppedKnobProperties.tsx</files>
  <action>
Add style selection dropdown and color override controls to SteppedKnobProperties.

1. Add imports at top:
```typescript
import { useStore } from '../../store'
import { useLicense } from '../../hooks/useLicense'
import { RotaryLayers } from '../../types/elementStyle'
```

2. Add store selectors and license check inside component:
```typescript
const { isPro } = useLicense()
const getStylesByCategory = useStore((state) => state.getStylesByCategory)
const getElementStyle = useStore((state) => state.getElementStyle)
const rotaryStyles = getStylesByCategory('rotary')
```

3. Add Style Selection section at TOP of return (before Step Configuration):
```typescript
{/* Knob Style - Pro feature */}
{isPro && (
  <PropertySection title="Knob Style">
    <div>
      <label className="block text-xs text-gray-400 mb-1">Style</label>
      <select
        value={element.styleId || ''}
        onChange={(e) => {
          const value = e.target.value
          onUpdate({
            styleId: value === '' ? undefined : value,
            colorOverrides: undefined, // Reset on style change
          })
        }}
        className="w-full bg-gray-700 border border-gray-600 text-white rounded px-2 py-1.5 text-sm"
      >
        <option value="">Default (CSS)</option>
        {rotaryStyles.map((style) => (
          <option key={style.id} value={style.id}>
            {style.name}
          </option>
        ))}
      </select>
    </div>
  </PropertySection>
)}

{/* Color Overrides - only when SVG style selected */}
{isPro && element.styleId && (() => {
  const style = getElementStyle(element.styleId)
  if (!style || style.category !== 'rotary') return null

  const layerNames: Array<keyof RotaryLayers> = ['indicator', 'track', 'arc', 'glow', 'shadow']
  const existingLayers = layerNames.filter((layerName) => style.layers[layerName])

  if (existingLayers.length === 0) return null

  return (
    <PropertySection title="Color Overrides">
      {existingLayers.map((layerName) => (
        <ColorInput
          key={layerName}
          label={layerName.charAt(0).toUpperCase() + layerName.slice(1)}
          value={element.colorOverrides?.[layerName] || ''}
          onChange={(color) => {
            const newOverrides = { ...element.colorOverrides }
            if (color) {
              newOverrides[layerName] = color
            } else {
              delete newOverrides[layerName]
            }
            onUpdate({ colorOverrides: newOverrides })
          }}
        />
      ))}
      <button
        onClick={() => onUpdate({ colorOverrides: undefined })}
        className="w-full text-left text-sm text-red-400 hover:text-red-300 mt-1"
      >
        Reset to Original Colors
      </button>
    </PropertySection>
  )
})()}
```
  </action>
  <verify>TypeScript compiles: `npm run build 2>&1 | head -50`</verify>
  <done>SteppedKnobProperties shows style dropdown and color overrides for Pro users</done>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors
2. Dev server starts: `npm run dev`
3. Stepped Knob on canvas still renders with CSS (no styleId)
4. When rotary styles exist, dropdown shows them in properties panel
</verification>

<success_criteria>
- SteppedKnobElementConfig has styleId and colorOverrides properties
- SteppedKnobRenderer delegates to Default (CSS) or Styled (SVG) based on styleId
- StyledSteppedKnobRenderer quantizes value to steps before calculating rotation
- SteppedKnobProperties shows style dropdown (Pro users only)
- Color overrides section appears when style is selected
</success_criteria>

<output>
After completion, create `.planning/phases/54-knob-variants/54-01-SUMMARY.md`
</output>
