---
phase: 15-asset-library-storage-ui
plan: 05
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/elements/renderers/ImageRenderer.tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "ImageRenderer renders SVG content when assetId is present"
    - "ImageRenderer falls back to src when assetId is not set"
    - "Existing image elements with src continue to work (backward compatibility)"
  artifacts:
    - path: "src/components/elements/renderers/ImageRenderer.tsx"
      provides: "Asset-aware image rendering with SafeSVG"
      contains: "getAsset"
      min_lines: 60
  key_links:
    - from: "src/components/elements/renderers/ImageRenderer.tsx"
      to: "src/store/index.ts"
      via: "useStore hook"
      pattern: "useStore.*getAsset"
    - from: "src/components/elements/renderers/ImageRenderer.tsx"
      to: "src/components/SafeSVG.tsx"
      via: "SafeSVG import"
      pattern: "import.*SafeSVG"
---

<objective>
Wire ImageRenderer to render asset-based SVG content via SafeSVG component.

Purpose: Close the gap preventing drag-to-canvas from displaying imported SVG assets. Currently, dragging an asset to canvas creates an ImageElement with assetId but no src, causing ImageRenderer to display "No image" placeholder. After this fix, ImageRenderer will look up the asset by assetId and render its SVG content.

Output: Updated ImageRenderer.tsx that supports both assetId-based assets (SVG via SafeSVG) and src-based images (external URLs via img tag).
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/15-asset-library-storage-ui/15-VERIFICATION.md

# Source files needed
@src/components/elements/renderers/ImageRenderer.tsx
@src/store/assetsSlice.ts
@src/components/SafeSVG.tsx
@src/types/elements.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire ImageRenderer to render asset SVG content</name>
  <files>src/components/elements/renderers/ImageRenderer.tsx</files>
  <action>
Update ImageRenderer to support assetId-based rendering:

1. Add imports at top:
   - `import { useStore } from '../../../store'`
   - `import { SafeSVG } from '../../SafeSVG'`

2. Inside the component, get the getAsset selector:
   ```typescript
   const getAsset = useStore((state) => state.getAsset)
   ```

3. Add assetId check BEFORE the existing src check:
   ```typescript
   // Check for assetId first (asset library SVG)
   if (config.assetId) {
     const asset = getAsset(config.assetId)
     if (asset) {
       return (
         <SafeSVG
           content={asset.svgContent}
           style={{
             width: '100%',
             height: '100%',
           }}
         />
       )
     }
     // Asset not found - fall through to "No image" placeholder
   }
   ```

4. Keep existing src-based rendering logic for backward compatibility:
   - If assetId is not set but src is set, use the img tag (existing behavior)
   - If neither assetId nor src is set, show "No image" placeholder (existing behavior)

Key constraints:
- assetId check MUST come before src check (assetId takes precedence)
- SafeSVG handles all sanitization internally (do NOT call sanitizeSVG manually)
- objectFit is not applicable to SVG (SafeSVG fills container at 100%)
- Keep the hasError state for src-based images only (SVG from assets doesn't use onError)
  </action>
  <verify>
1. TypeScript compiles: `npx tsc --noEmit`
2. Dev server starts: `npm run dev`
3. Manual test in browser:
   - Import an SVG asset via the Asset Library panel
   - Drag the asset from library to canvas
   - Verify SVG renders on canvas (not "No image" placeholder)
   - Verify existing image elements with src URLs still render correctly
  </verify>
  <done>
- ImageRenderer checks config.assetId and calls getAsset if present
- SafeSVG renders asset.svgContent when assetId is found
- Fallback to src-based img rendering when assetId is not set
- TypeScript compiles without errors
- Drag-to-canvas displays SVG content on canvas
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>ImageRenderer now renders SVG content from asset library when assetId is present</what-built>
  <how-to-verify>
1. Start dev server: `npm run dev`
2. Open browser to http://localhost:5173
3. Click "Assets" tab in left panel
4. Click "Import Asset" button
5. Upload any SVG file (or use an existing one if available)
6. Give it a name and select a category, click "Add to Library"
7. Drag the newly added asset thumbnail to the canvas
8. Verify: The SVG renders on canvas (you should see the SVG content, not "No image")
9. Verify: You can select, move, and resize the element normally
10. (Optional) Verify backward compatibility: If you have any existing image elements with external URLs, they should still work
  </how-to-verify>
  <resume-signal>Type "approved" if SVG renders correctly on canvas, or describe any issues</resume-signal>
</task>

</tasks>

<verification>
- [ ] `npx tsc --noEmit` passes (no TypeScript errors)
- [ ] `npm run dev` starts without errors
- [ ] ImageRenderer imports useStore and SafeSVG
- [ ] ImageRenderer calls getAsset when config.assetId is present
- [ ] SVG content renders via SafeSVG component
- [ ] Drag asset from library to canvas shows SVG (not placeholder)
- [ ] Existing src-based images still render correctly
</verification>

<success_criteria>
1. ASSET-08 requirement satisfied: User can drag asset from library directly to canvas
2. All 6/6 must-haves from Phase 15 verified (was 5/6 with partial)
3. Full end-to-end flow works: Import SVG -> Browse in library -> Drag to canvas -> See SVG on canvas
</success_criteria>

<output>
After completion, create `.planning/phases/15-asset-library-storage-ui/15-05-SUMMARY.md`
</output>
