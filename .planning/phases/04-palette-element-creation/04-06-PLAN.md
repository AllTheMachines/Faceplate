---
phase: 04-palette-element-creation
plan: 06
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/Palette/CustomSVGUpload.tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "User can add foreground/overlay images to the canvas at a reasonable position"
    - "Imported SVG appears centered in the current viewport"
  artifacts:
    - path: "src/components/Palette/CustomSVGUpload.tsx"
      provides: "SVG placement at viewport center"
      contains: "offsetX"
  key_links:
    - from: "src/components/Palette/CustomSVGUpload.tsx"
      to: "src/store (viewport state)"
      via: "useStore to get scale, offsetX, offsetY"
      pattern: "useStore.*offset"
---

<objective>
Fix hardcoded SVG position by centering imported SVGs in the current viewport.

Purpose: Enable user to import SVGs and have them appear in the visible canvas area regardless of zoom/pan state, instead of always appearing at fixed (100, 100).

Output: CustomSVGUpload calculates canvas center position from viewport state and places imported SVG there.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/04-palette-element-creation/04-VERIFICATION.md

Key files:
@src/components/Palette/CustomSVGUpload.tsx
@src/store/viewportSlice.ts (reference for viewport state structure)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Calculate viewport center for SVG placement</name>
  <files>src/components/Palette/CustomSVGUpload.tsx</files>
  <action>
Update CustomSVGUpload to place imported SVGs at the center of the current viewport instead of hardcoded (100, 100).

1. Add imports to get viewport state from store:
```typescript
import { useStore } from '../../store';
```

2. Inside the CustomSVGUpload component, get viewport state (add to existing useStore call or add new ones):
```typescript
const scale = useStore((state) => state.scale);
const offsetX = useStore((state) => state.offsetX);
const offsetY = useStore((state) => state.offsetY);
```

3. Update handleAddToCanvas to calculate viewport center in canvas coordinates:

The viewport center calculation:
- Get the canvas viewport element dimensions (it's the `.canvas-viewport` element)
- The center of the viewport in screen space is (viewportWidth / 2, viewportHeight / 2)
- Convert to canvas space: (screenCenter - offset) / scale
- Center the SVG by subtracting half its dimensions

```typescript
const handleAddToCanvas = () => {
  if (!parsedSVG) return;

  // Get the canvas viewport element dimensions
  const canvasViewport = document.querySelector('.canvas-viewport');
  const viewportWidth = canvasViewport?.clientWidth || 800;
  const viewportHeight = canvasViewport?.clientHeight || 600;

  // Calculate center of viewport in canvas coordinates
  // Screen center: (viewportWidth / 2, viewportHeight / 2)
  // Canvas coords: (screenX - offsetX) / scale
  const centerCanvasX = (viewportWidth / 2 - offsetX) / scale;
  const centerCanvasY = (viewportHeight / 2 - offsetY) / scale;

  // Center the SVG on this point (subtract half its dimensions)
  const svgX = centerCanvasX - parsedSVG.width / 2;
  const svgY = centerCanvasY - parsedSVG.height / 2;

  // Create image element with SVG as data URL
  const dataUrl = svgToDataUrl(parsedSVG.svgString);
  const element = createImage({
    x: svgX,
    y: svgY,
    width: parsedSVG.width,
    height: parsedSVG.height,
    src: dataUrl,
    name: 'Custom SVG',
  });

  addElement(element);
  setParsedSVG(null);
  setIsOpen(false);
};
```

This ensures:
- At 100% zoom with no pan: SVG appears at canvas center
- When panned: SVG appears at center of current view
- When zoomed: SVG appears at center of current view in canvas coordinates
  </action>
  <verify>
1. TypeScript compiles: `npm run build`
2. Start dev server: `npm run dev`
3. Test import at default view (100% zoom, no pan) - SVG should appear centered
4. Pan canvas, then import another SVG - should appear centered in new view
5. Zoom out to 50%, then import - SVG should appear centered in visible area
  </verify>
  <done>Imported SVGs appear at the center of the current viewport regardless of zoom/pan state</done>
</task>

</tasks>

<verification>
After completing the task:

1. **Build check:** `npm run build` passes without errors
2. **Center placement test at default view:**
   - Run `npm run dev`
   - Import an SVG file using the "+ Import Custom SVG" button
   - Verify SVG appears centered on canvas (roughly around canvas center)
3. **Center placement test with pan:**
   - Pan the canvas to a different area
   - Import another SVG
   - Verify SVG appears centered in the CURRENT viewport view
4. **Center placement test with zoom:**
   - Zoom out to 50%
   - Import another SVG
   - Verify SVG appears centered in the zoomed-out view (not at absolute position)
</verification>

<success_criteria>
- No hardcoded (100, 100) position in CustomSVGUpload
- Imported SVGs appear at viewport center accounting for scale/offset
- SVG placement works correctly at all zoom levels (0.5x, 1x, 2x)
- SVG placement works correctly when canvas is panned
- No TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/04-palette-element-creation/04-06-SUMMARY.md`
</output>
