---
phase: 04-palette-element-creation
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/store/elementsSlice.ts
  - src/store/index.ts
  - src/components/Canvas/hooks/useKeyboardShortcuts.ts
  - src/components/Canvas/ZOrderPanel.tsx
  - src/components/Layout/RightPanel.tsx
autonomous: true

must_haves:
  truths:
    - "User can reorder elements using keyboard shortcuts (mod+]/[, mod+shift+]/[)"
    - "User can see z-order controls in the right panel when element is selected"
    - "Z-order changes are reflected immediately on canvas"
  artifacts:
    - path: "src/store/elementsSlice.ts"
      provides: "Z-order actions: moveToFront, moveToBack, moveForward, moveBackward"
      exports: ["moveToFront", "moveToBack", "moveForward", "moveBackward"]
    - path: "src/components/Canvas/hooks/useKeyboardShortcuts.ts"
      provides: "Z-order keyboard shortcuts"
      contains: "mod+shift+]"
    - path: "src/components/Canvas/ZOrderPanel.tsx"
      provides: "Z-order control buttons"
      exports: ["ZOrderPanel"]
  key_links:
    - from: "src/components/Canvas/hooks/useKeyboardShortcuts.ts"
      to: "src/store/elementsSlice.ts"
      via: "z-order actions"
      pattern: "move(ToFront|ToBack|Forward|Backward)"
---

<objective>
Implement z-order management with keyboard shortcuts and UI controls

Purpose: Allow users to control visual stacking of elements using standard design-tool shortcuts
Output: Z-order actions in store, keyboard shortcuts, control panel in right sidebar
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@src/store/elementsSlice.ts
@src/components/Canvas/hooks/useKeyboardShortcuts.ts
@src/components/Layout/RightPanel.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add z-order actions to elementsSlice</name>
  <files>src/store/elementsSlice.ts</files>
  <action>
Add z-order management actions to ElementsSlice:

1. Add to ElementsSlice interface:
```typescript
// Z-order actions
moveToFront: (id: string) => void;
moveToBack: (id: string) => void;
moveForward: (id: string) => void;
moveBackward: (id: string) => void;
```

2. Implement the actions (array position = z-order, last = front):

```typescript
moveToFront: (id) =>
  set((state) => {
    const element = state.elements.find((el) => el.id === id);
    if (!element) return state;
    return {
      elements: [
        ...state.elements.filter((el) => el.id !== id),
        element,
      ],
    };
  }),

moveToBack: (id) =>
  set((state) => {
    const element = state.elements.find((el) => el.id === id);
    if (!element) return state;
    return {
      elements: [
        element,
        ...state.elements.filter((el) => el.id !== id),
      ],
    };
  }),

moveForward: (id) =>
  set((state) => {
    const index = state.elements.findIndex((el) => el.id === id);
    if (index === -1 || index === state.elements.length - 1) return state;
    const newElements = [...state.elements];
    [newElements[index], newElements[index + 1]] = [newElements[index + 1], newElements[index]];
    return { elements: newElements };
  }),

moveBackward: (id) =>
  set((state) => {
    const index = state.elements.findIndex((el) => el.id === id);
    if (index <= 0) return state;
    const newElements = [...state.elements];
    [newElements[index], newElements[index - 1]] = [newElements[index - 1], newElements[index]];
    return { elements: newElements };
  }),
```

Note: This approach uses array position as implicit z-order. The elements array order determines rendering order - last element renders on top. This is simpler than explicit zIndex values (no conflicts, no gaps).
  </action>
  <verify>Run `npm run build` - no TypeScript errors</verify>
  <done>
ElementsSlice has moveToFront, moveToBack, moveForward, moveBackward actions.
Actions manipulate array position, not zIndex property.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add z-order keyboard shortcuts</name>
  <files>src/components/Canvas/hooks/useKeyboardShortcuts.ts</files>
  <action>
Add z-order keyboard shortcuts to useKeyboardShortcuts hook:

1. Get z-order actions from store:
```typescript
const moveToFront = useStore((state) => state.moveToFront);
const moveToBack = useStore((state) => state.moveToBack);
const moveForward = useStore((state) => state.moveForward);
const moveBackward = useStore((state) => state.moveBackward);
```

2. Add keyboard shortcuts using useHotkeys:

```typescript
// Bring to Front: Ctrl/Cmd + Shift + ]
useHotkeys('mod+shift+]', (e) => {
  e.preventDefault();
  if (selectedIds.length === 1) {
    moveToFront(selectedIds[0]);
  }
}, { enableOnFormTags: false });

// Send to Back: Ctrl/Cmd + Shift + [
useHotkeys('mod+shift+[', (e) => {
  e.preventDefault();
  if (selectedIds.length === 1) {
    moveToBack(selectedIds[0]);
  }
}, { enableOnFormTags: false });

// Bring Forward: Ctrl/Cmd + ]
useHotkeys('mod+]', (e) => {
  e.preventDefault();
  if (selectedIds.length === 1) {
    moveForward(selectedIds[0]);
  }
}, { enableOnFormTags: false });

// Send Backward: Ctrl/Cmd + [
useHotkeys('mod+[', (e) => {
  e.preventDefault();
  if (selectedIds.length === 1) {
    moveBackward(selectedIds[0]);
  }
}, { enableOnFormTags: false });
```

Note: These match industry-standard shortcuts (Figma, Sketch, Adobe). Only work with single selection - multi-select z-order is more complex and deferred.
  </action>
  <verify>
Run `npm run dev`:
1. Select an element
2. Press Cmd+] (Mac) or Ctrl+] (Windows) - element moves forward
3. Press Cmd+[ - element moves backward
4. Press Cmd+Shift+] - element moves to front
5. Press Cmd+Shift+[ - element moves to back
  </verify>
  <done>
Z-order keyboard shortcuts work: mod+], mod+[, mod+shift+], mod+shift+[.
Shortcuts only activate with single selection.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create ZOrderPanel component</name>
  <files>
    src/components/Canvas/ZOrderPanel.tsx
    src/components/Layout/RightPanel.tsx
  </files>
  <action>
Create ZOrderPanel for the right panel:

**src/components/Canvas/ZOrderPanel.tsx:**
```typescript
import { useStore } from '../../store';

export function ZOrderPanel() {
  const selectedIds = useStore((state) => state.selectedIds);
  const moveToFront = useStore((state) => state.moveToFront);
  const moveToBack = useStore((state) => state.moveToBack);
  const moveForward = useStore((state) => state.moveForward);
  const moveBackward = useStore((state) => state.moveBackward);

  // Only show when single element selected
  if (selectedIds.length !== 1) {
    return null;
  }

  const elementId = selectedIds[0];

  const buttons = [
    { label: 'Bring to Front', shortcut: 'Ctrl+Shift+]', action: () => moveToFront(elementId) },
    { label: 'Bring Forward', shortcut: 'Ctrl+]', action: () => moveForward(elementId) },
    { label: 'Send Backward', shortcut: 'Ctrl+[', action: () => moveBackward(elementId) },
    { label: 'Send to Back', shortcut: 'Ctrl+Shift+[', action: () => moveToBack(elementId) },
  ];

  return (
    <div className="p-4 border-t border-gray-700">
      <h3 className="text-sm font-medium text-gray-300 mb-3">Layer Order</h3>
      <div className="space-y-1">
        {buttons.map((btn) => (
          <button
            key={btn.label}
            onClick={btn.action}
            className="w-full flex justify-between items-center px-3 py-2 text-sm text-gray-300 hover:bg-gray-700 rounded transition-colors"
          >
            <span>{btn.label}</span>
            <span className="text-xs text-gray-500">{btn.shortcut}</span>
          </button>
        ))}
      </div>
    </div>
  );
}
```

**Update src/components/Layout/RightPanel.tsx:**
- Import ZOrderPanel
- Add ZOrderPanel at the bottom of the right panel content
- Keep existing placeholder content above it

```typescript
import { ZOrderPanel } from '../Canvas/ZOrderPanel';

export function RightPanel() {
  return (
    <div className="bg-gray-800 border-l border-gray-700 overflow-y-auto flex flex-col">
      <div className="p-4 flex-1">
        <h2 className="text-lg font-semibold text-gray-100 mb-4">Properties</h2>
        <p className="text-sm text-gray-400">Property panel (Phase 5)</p>
      </div>
      <ZOrderPanel />
    </div>
  );
}
```
  </action>
  <verify>
Run `npm run dev`:
1. Select an element on canvas
2. Right panel shows "Layer Order" section with 4 buttons
3. Click "Bring to Front" - element moves to front
4. Click "Send to Back" - element moves to back
5. Deselect element - Layer Order section disappears
  </verify>
  <done>
ZOrderPanel shows 4 z-order buttons when element is selected.
Buttons have matching keyboard shortcut hints.
RightPanel includes ZOrderPanel at bottom.
  </done>
</task>

</tasks>

<verification>
After completing all tasks:
1. Run `npm run build` - passes without errors
2. Run `npm run dev` - app loads
3. Add 3+ elements to canvas (overlapping)
4. Select back element, press Cmd+Shift+] - element now on top
5. Select front element, press Cmd+Shift+[ - element now on bottom
6. Select middle element, press Cmd+] - element moves forward one
7. Select element, click "Send to Back" button - element moves to back
</verification>

<success_criteria>
- elementsSlice has moveToFront, moveToBack, moveForward, moveBackward
- Z-order uses array position (last = front), not explicit zIndex
- Keyboard shortcuts work: mod+], mod+[, mod+shift+], mod+shift+[
- ZOrderPanel shows buttons when element selected
- Visual stacking updates immediately on canvas
</success_criteria>

<output>
After completion, create `.planning/phases/04-palette-element-creation/04-03-SUMMARY.md`
</output>
