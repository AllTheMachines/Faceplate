---
phase: 16-static-svg-graphics
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/Properties/SvgGraphicProperties.tsx
  - src/services/svg/getSVGNaturalSize.ts
autonomous: true

must_haves:
  truths:
    - "User can select asset from dropdown in property panel"
    - "User can toggle flip horizontal and flip vertical"
    - "User can adjust opacity from 0-100%"
    - "User can reset element to asset's natural size"
    - "Natural size is extracted from SVG viewBox attribute"
  artifacts:
    - path: "src/components/Properties/SvgGraphicProperties.tsx"
      provides: "Property panel for SVG Graphic elements"
      exports: ["SvgGraphicProperties"]
    - path: "src/services/svg/getSVGNaturalSize.ts"
      provides: "Extract width/height from SVG viewBox"
      exports: ["getSVGNaturalSize"]
  key_links:
    - from: "SvgGraphicProperties"
      to: "AssetsSlice"
      via: "useStore for assets list and getAsset"
      pattern: "useStore.*assets"
    - from: "getSVGNaturalSize"
      to: "DOMParser"
      via: "parse SVG and read viewBox"
      pattern: "DOMParser.*parseFromString"
---

<objective>
Create the property panel component for SVG Graphic elements and the utility function for extracting SVG natural dimensions.

Purpose: Enable users to configure SVG Graphic properties including asset selection, transforms, and size reset.
Output: SvgGraphicProperties component and getSVGNaturalSize utility function.
</objective>

<execution_context>
@./.claude/agents/gsd-executor.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-static-svg-graphics/16-CONTEXT.md
@.planning/phases/16-static-svg-graphics/16-RESEARCH.md
@src/components/Properties/ImageProperties.tsx
@src/components/Properties/index.ts
@src/types/asset.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create getSVGNaturalSize utility function</name>
  <files>src/services/svg/getSVGNaturalSize.ts</files>
  <action>
Create getSVGNaturalSize.ts that extracts natural dimensions from SVG content using DOMParser.

The function should:
1. Parse SVG content with DOMParser
2. Try to read viewBox attribute first (most reliable)
3. Fall back to width/height attributes
4. Return default 100x100 if parsing fails

Implementation from RESEARCH.md:
```typescript
/**
 * Extract natural dimensions from SVG content
 * @param svgContent - Raw SVG string
 * @returns { width, height } or null if extraction fails
 */
export function getSVGNaturalSize(svgContent: string): { width: number; height: number } | null {
  try {
    const parser = new DOMParser()
    const doc = parser.parseFromString(svgContent, 'image/svg+xml')

    // Check for parsing errors
    const parserError = doc.querySelector('parsererror')
    if (parserError) {
      console.warn('SVG parsing failed')
      return { width: 100, height: 100 }
    }

    const svgEl = doc.querySelector('svg')
    if (!svgEl) {
      return { width: 100, height: 100 }
    }

    // Try viewBox first (most reliable)
    const viewBox = svgEl.getAttribute('viewBox')
    if (viewBox) {
      const parts = viewBox.trim().split(/\s+/)
      if (parts.length === 4) {
        const [, , width, height] = parts.map(Number)
        if (!isNaN(width) && !isNaN(height) && width > 0 && height > 0) {
          return { width, height }
        }
      }
    }

    // Fallback to width/height attributes
    const widthAttr = svgEl.getAttribute('width')
    const heightAttr = svgEl.getAttribute('height')

    if (widthAttr && heightAttr) {
      // Parse numeric value, stripping units like "px"
      const width = parseFloat(widthAttr)
      const height = parseFloat(heightAttr)

      if (!isNaN(width) && !isNaN(height) && width > 0 && height > 0) {
        return { width, height }
      }
    }

    // Final fallback
    return { width: 100, height: 100 }
  } catch (err) {
    console.error('SVG dimension extraction failed:', err)
    return { width: 100, height: 100 }
  }
}
```

Also create/update src/services/svg/index.ts to export the function:
```typescript
export { getSVGNaturalSize } from './getSVGNaturalSize'
```
  </action>
  <verify>
Run `npx tsc --noEmit` to verify no type errors.
Check file exists: `ls src/services/svg/getSVGNaturalSize.ts`
  </verify>
  <done>getSVGNaturalSize function exists and correctly parses viewBox and dimension attributes.</done>
</task>

<task type="auto">
  <name>Task 2: Create SvgGraphicProperties component</name>
  <files>src/components/Properties/SvgGraphicProperties.tsx</files>
  <action>
Create SvgGraphicProperties.tsx with sections for:

1. **Asset Selection Section**
   - Dropdown of available assets (from useStore assets)
   - "None (placeholder)" option at top
   - When asset is selected, update assetId and optionally resize to natural size
   - "Reset to Natural Size" button (visible when asset is assigned)

2. **Transform Section**
   - Flip Horizontal checkbox
   - Flip Vertical checkbox
   - Opacity slider (0-100%, stored as 0-1)

Follow ImageProperties pattern for styling.

```typescript
import { SvgGraphicElementConfig, ElementConfig } from '../../types/elements'
import { PropertySection, NumberInput } from './'
import { useStore } from '../../store'
import { getSVGNaturalSize } from '../../services/svg'

interface SvgGraphicPropertiesProps {
  element: SvgGraphicElementConfig
  onUpdate: (updates: Partial<ElementConfig>) => void
}

export function SvgGraphicProperties({ element, onUpdate }: SvgGraphicPropertiesProps) {
  const assets = useStore((state) => state.assets)
  const getAsset = useStore((state) => state.getAsset)

  const handleAssetChange = (newAssetId: string | undefined) => {
    if (newAssetId) {
      const asset = getAsset(newAssetId)
      if (asset) {
        // Get natural size and apply it
        const naturalSize = getSVGNaturalSize(asset.svgContent)
        if (naturalSize) {
          onUpdate({
            assetId: newAssetId,
            width: naturalSize.width,
            height: naturalSize.height,
          })
          return
        }
      }
    }
    onUpdate({ assetId: newAssetId })
  }

  const handleResetToNaturalSize = () => {
    if (!element.assetId) return
    const asset = getAsset(element.assetId)
    if (!asset) return

    const naturalSize = getSVGNaturalSize(asset.svgContent)
    if (naturalSize) {
      onUpdate({
        width: naturalSize.width,
        height: naturalSize.height,
      })
    }
  }

  return (
    <>
      {/* Asset Selection */}
      <PropertySection title="Asset">
        <div>
          <label className="block text-xs text-gray-400 mb-1">SVG Asset</label>
          <select
            value={element.assetId || ''}
            onChange={(e) => handleAssetChange(e.target.value || undefined)}
            className="w-full bg-gray-700 border border-gray-600 text-white rounded px-2 py-1.5 text-sm"
          >
            <option value="">None (placeholder)</option>
            {assets.map((asset) => (
              <option key={asset.id} value={asset.id}>
                {asset.name}
              </option>
            ))}
          </select>
        </div>

        {element.assetId && (
          <button
            onClick={handleResetToNaturalSize}
            className="w-full mt-2 bg-gray-700 hover:bg-gray-600 text-white rounded px-3 py-2 text-sm transition-colors"
          >
            Reset to Natural Size
          </button>
        )}
      </PropertySection>

      {/* Transform */}
      <PropertySection title="Transform">
        <div className="flex gap-4 mb-3">
          <label className="flex items-center gap-2 text-sm">
            <input
              type="checkbox"
              checked={element.flipH}
              onChange={(e) => onUpdate({ flipH: e.target.checked })}
              className="rounded border-gray-600 bg-gray-700 text-blue-500"
            />
            <span className="text-gray-300">Flip H</span>
          </label>

          <label className="flex items-center gap-2 text-sm">
            <input
              type="checkbox"
              checked={element.flipV}
              onChange={(e) => onUpdate({ flipV: e.target.checked })}
              className="rounded border-gray-600 bg-gray-700 text-blue-500"
            />
            <span className="text-gray-300">Flip V</span>
          </label>
        </div>

        <NumberInput
          label="Opacity"
          value={Math.round(element.opacity * 100)}
          onChange={(val) => onUpdate({ opacity: val / 100 })}
          min={0}
          max={100}
          step={5}
          suffix="%"
        />
      </PropertySection>
    </>
  )
}
```

Also update src/components/Properties/index.ts to export SvgGraphicProperties.
  </action>
  <verify>
Run `npx tsc --noEmit` to verify no type errors.
Check file exists: `ls src/components/Properties/SvgGraphicProperties.tsx`
  </verify>
  <done>SvgGraphicProperties component exists with asset dropdown, flip toggles, opacity slider, and reset button.</done>
</task>

</tasks>

<verification>
After completing all tasks:
1. `npx tsc --noEmit` passes with no errors
2. getSVGNaturalSize.ts exists in src/services/svg/
3. SvgGraphicProperties.tsx exists in src/components/Properties/
4. Both are properly exported from their respective index files
</verification>

<success_criteria>
- TypeScript compilation succeeds
- getSVGNaturalSize correctly extracts dimensions from viewBox or width/height attributes
- SvgGraphicProperties shows asset dropdown with all available assets
- Flip H/V toggles work correctly
- Opacity slider allows 0-100% adjustment
- Reset to Natural Size button appears when asset is assigned
</success_criteria>

<output>
After completion, create `.planning/phases/16-static-svg-graphics/16-02-SUMMARY.md`
</output>
