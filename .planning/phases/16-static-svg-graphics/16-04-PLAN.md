---
phase: 16-static-svg-graphics
plan: 04
type: execute
wave: 2
depends_on: ["16-01"]
files_modified:
  - src/services/export/htmlGenerator.ts
  - src/services/export/cssGenerator.ts
autonomous: true

must_haves:
  truths:
    - "SVG Graphic exports as inline sanitized SVG in HTML"
    - "Transforms (flip, opacity) are applied in exported HTML"
    - "Missing asset exports as empty div with comment"
    - "CSS includes SVG containment styles"
  artifacts:
    - path: "src/services/export/htmlGenerator.ts"
      provides: "generateSvgGraphicHTML function"
      contains: "case 'svggraphic'"
    - path: "src/services/export/cssGenerator.ts"
      provides: "SVG Graphic CSS styles"
      contains: "svggraphic-element"
  key_links:
    - from: "htmlGenerator.ts"
      to: "sanitizeSVG"
      via: "import and call"
      pattern: "sanitizeSVG"
    - from: "htmlGenerator.ts"
      to: "useStore.getState"
      via: "getAsset lookup"
      pattern: "getState.*getAsset"
---

<objective>
Add SVG Graphic element export support to the HTML and CSS generators.

Purpose: Ensure SVG Graphic elements are correctly exported for JUCE WebView with sanitized SVG and proper transforms.
Output: Exported HTML includes inline SVG with transforms; CSS includes containment styles.
</objective>

<execution_context>
@./.claude/agents/gsd-executor.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-static-svg-graphics/16-CONTEXT.md
@.planning/phases/16-static-svg-graphics/16-RESEARCH.md
@.planning/phases/16-static-svg-graphics/16-01-SUMMARY.md
@src/services/export/htmlGenerator.ts
@src/services/export/cssGenerator.ts
@src/services/svg/sanitizer.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add SVG Graphic HTML export</name>
  <files>src/services/export/htmlGenerator.ts</files>
  <action>
1. Add import for SvgGraphicElementConfig type:
```typescript
import type {
  // ... existing imports ...
  SvgGraphicElementConfig
} from '../../types/elements'
```

2. Add import for useStore and sanitizeSVG:
```typescript
import { useStore } from '../../store'
import { sanitizeSVG } from '../svg/sanitizer'
```

3. Add case in generateElementHTML switch statement:
```typescript
case 'svggraphic':
  return generateSvgGraphicHTML(id, baseClass, positionStyle, element)
```

4. Add the generateSvgGraphicHTML helper function:
```typescript
function generateSvgGraphicHTML(
  id: string,
  baseClass: string,
  positionStyle: string,
  element: SvgGraphicElementConfig
): string {
  const getAsset = useStore.getState().getAsset
  const asset = element.assetId ? getAsset(element.assetId) : null

  // Build transform with flip (rotation is in positionStyle already)
  const transformParts: string[] = []
  if (element.flipH) transformParts.push('scaleX(-1)')
  if (element.flipV) transformParts.push('scaleY(-1)')
  const flipTransform = transformParts.length > 0 ? transformParts.join(' ') : ''

  // Combine position style with flip transform and opacity
  // Note: rotation is already in positionStyle from generateElementHTML
  let combinedStyle = positionStyle
  if (flipTransform) {
    // Append flip to existing transform
    combinedStyle = combinedStyle.replace(
      /transform: rotate\(([^)]+)\);/,
      `transform: rotate($1) ${flipTransform}; transform-origin: center center;`
    )
  }
  if (element.opacity !== 1) {
    combinedStyle += ` opacity: ${element.opacity};`
  }

  if (!asset) {
    // Placeholder or missing asset - export as empty div with comment
    return `<div id="${id}" class="${baseClass} svggraphic-element" data-type="svggraphic" style="${combinedStyle}">
  <!-- SVG Graphic: Asset not assigned or missing -->
</div>`
  }

  // Export with re-sanitized SVG content inline (SEC-04: sanitize before export)
  const sanitizedSVG = sanitizeSVG(asset.svgContent)

  return `<div id="${id}" class="${baseClass} svggraphic-element" data-type="svggraphic" style="${combinedStyle}">
  ${sanitizedSVG}
</div>`
}
```

Note: The sanitizeSVG call ensures SEC-04 compliance (re-sanitize before export).
  </action>
  <verify>
Run `npx tsc --noEmit` to verify no type errors.
Grep for svggraphic in htmlGenerator.ts: `grep -n "svggraphic" src/services/export/htmlGenerator.ts`
  </verify>
  <done>SVG Graphic elements export as inline sanitized SVG with transforms and opacity applied.</done>
</task>

<task type="auto">
  <name>Task 2: Add SVG Graphic CSS export</name>
  <files>src/services/export/cssGenerator.ts</files>
  <action>
1. Add case in generateElementCSS switch statement for 'svggraphic':
```typescript
case 'svggraphic':
  return generateSvgGraphicCSS(id)
```

2. Add the generateSvgGraphicCSS helper function:
```typescript
function generateSvgGraphicCSS(id: string): string {
  return `/* SVG Graphic: ${id} */
#${id} {
  overflow: hidden;
  display: flex;
  align-items: center;
  justify-content: center;
}

#${id} svg {
  max-width: 100%;
  max-height: 100%;
  width: 100%;
  height: 100%;
  object-fit: contain;
}`
}
```

This CSS ensures:
- Container is flex for centering
- Overflow hidden prevents bleed
- SVG scales with object-fit: contain (per CONTEXT.md)
- SVG fills container while maintaining aspect ratio
  </action>
  <verify>
Run `npx tsc --noEmit` to verify no type errors.
Grep for svggraphic in cssGenerator.ts: `grep -n "svggraphic" src/services/export/cssGenerator.ts`
  </verify>
  <done>CSS generator produces proper SVG containment styles for SVG Graphic elements.</done>
</task>

</tasks>

<verification>
After completing all tasks:
1. `npx tsc --noEmit` passes with no errors
2. htmlGenerator.ts contains generateSvgGraphicHTML function
3. cssGenerator.ts contains generateSvgGraphicCSS function
4. Both handle the 'svggraphic' case in their switch statements
</verification>

<success_criteria>
- TypeScript compilation succeeds
- SVG Graphic with assigned asset exports as inline sanitized SVG
- SVG Graphic without asset exports as empty div with comment
- Flip transforms and opacity are included in export
- CSS includes proper containment and scaling styles
- Exported SVG is re-sanitized (SEC-04 compliance)
</success_criteria>

<output>
After completion, create `.planning/phases/16-static-svg-graphics/16-04-SUMMARY.md`
</output>
