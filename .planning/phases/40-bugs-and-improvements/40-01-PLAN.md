---
phase: 40-bugs-and-improvements
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/services/serialization.ts
  - src/schemas/project.ts
  - src/store/windowsSlice.ts
  - src/components/Canvas/hooks/useCopyPaste.ts
autonomous: true

must_haves:
  truths:
    - "Opening a v1.x project shows migration message, not error"
    - "Project version is saved in JSON and restored on load"
    - "Duplicating multi-selected elements only affects current window"
    - "Deleting element and recreating with same name works without error"
  artifacts:
    - path: "src/services/serialization.ts"
      provides: "Graceful version handling for missing version field"
      contains: "version handling"
    - path: "src/store/windowsSlice.ts"
      provides: "Duplicate name validation scoped to current window"
      exports: ["isNameUnique"]
  key_links:
    - from: "src/services/serialization.ts"
      to: "migrateProject"
      via: "Missing version treated as v1.0.0"
      pattern: "!.*version.*1\\.0\\.0"
---

<objective>
Fix critical state synchronization bugs: version handling, name validation, and multi-window duplicate scoping.

Purpose: These three bugs cause data loss or user frustration - version errors prevent opening old projects, duplicate name validation blocks valid names, and multi-window duplicate affects wrong elements.

Output: Robust serialization with version migration, window-scoped name validation, and properly filtered duplicate operation.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/40-bugs-and-improvements/40-RESEARCH.md
@src/services/serialization.ts
@src/store/windowsSlice.ts
@src/components/Canvas/hooks/useCopyPaste.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix version handling in serialization</name>
  <files>src/services/serialization.ts</files>
  <action>
    Update `migrateProject()` to handle missing version field gracefully:

    1. At the start of migrateProject(), check if data is an object with no version AND no canvas property (malformed v2)
    2. If version is missing but has windows array, treat as v2.0.0 (add version field)
    3. If version is missing and no windows AND no canvas, return error: "Invalid project file: missing version information"
    4. Update console.log messages to be more informative: "[Serialization] Migrating project from v{X} to v{Y}"

    The key fix: Don't fail on missing version - infer from structure.
  </action>
  <verify>
    Create a test JSON file without version field but with windows array. Verify deserializeProject() succeeds and returns data with version: '2.0.0'.

    ```typescript
    // Test case
    const noVersionJson = JSON.stringify({
      windows: [{ id: 'w1', name: 'Main', type: 'release', width: 800, height: 600, backgroundColor: '#333', backgroundType: 'color', elementIds: [], createdAt: Date.now() }],
      elements: [],
      selectedIds: []
    })
    const result = deserializeProject(noVersionJson)
    console.log(result.success) // should be true
    ```
  </verify>
  <done>Projects without explicit version field load successfully by inferring version from structure</done>
</task>

<task type="auto">
  <name>Task 2: Fix duplicate name validation scope</name>
  <files>src/store/windowsSlice.ts</files>
  <action>
    Add a helper function `isNameUniqueInWindow(name: string, windowId: string, excludeElementId?: string)` to windowsSlice:

    1. Get the window by ID
    2. Get all elements in that window via elementIds
    3. Filter out the element being renamed (excludeElementId) if provided
    4. Check if any remaining element has the same name
    5. Return true if name is unique, false otherwise

    Export this function and update any component that validates names to use it with the correct scope.

    Key insight: The bug occurs because validation checks ALL elements instead of just elements in the current window, and doesn't exclude the element's own ID when renaming.
  </action>
  <verify>
    1. Create element named "Button1" in Window A
    2. Delete "Button1"
    3. Create new element, name it "Button1" - should succeed (no error)
    4. Try to rename another element to "Button1" - should fail (duplicate)
  </verify>
  <done>Element names are validated only within the current window, and renaming an element to its own name doesn't trigger duplicate error</done>
</task>

<task type="auto">
  <name>Task 3: Fix multi-window duplicate operation</name>
  <files>src/components/Canvas/hooks/useCopyPaste.ts</files>
  <action>
    The `duplicateSelected()` function already has filtering by activeWindowId (lines 147-155), but verify it's working correctly:

    1. Review the filtering logic - it should filter selectedIds by activeWindowId BEFORE duplicating
    2. Verify that `getWindowForElement` is correctly returning the window for each element
    3. Add console.log to trace: "Duplicating {N} elements in window {activeWindowId}, skipping {M} from other windows"
    4. If filtering isn't happening, the bug is that selectedIds includes elements from all windows

    The fix may be in the selection system, not duplicate. Check if clearSelection() is called when switching windows.

    Also check: When switching windows, does the selection persist? It shouldn't - selections should be window-scoped.
  </action>
  <verify>
    1. Window A: Create 2 elements, select both
    2. Window B: Create 2 elements, select both
    3. Switch to Window A
    4. Press Ctrl+D to duplicate
    5. Verify: Window A should have 4 elements (2 original + 2 duplicates)
    6. Verify: Window B should still have only 2 elements
  </verify>
  <done>Duplicating elements only creates copies in the active window, regardless of what was selected in other windows</done>
</task>

</tasks>

<verification>
Run the following verification sequence:

1. **Version migration test:**
   - Save a project, manually edit JSON to remove "version" field
   - Open the edited JSON - should load without error

2. **Name uniqueness test:**
   - Create element, delete it, create new one with same name - should work

3. **Multi-window duplicate test:**
   - Select in Window A, switch to Window B, select there, switch to A, duplicate
   - Only Window A elements should duplicate

All tests should pass without console errors.
</verification>

<success_criteria>
1. Projects without version field load successfully (BUG-40-07)
2. Deleted element names can be reused immediately (BUG-40-03)
3. Duplicate operation only affects active window elements (BUG-40-06)
4. No regressions in save/load cycle
5. No regressions in copy/paste functionality
</success_criteria>

<output>
After completion, create `.planning/phases/40-bugs-and-improvements/40-01-SUMMARY.md`
</output>
