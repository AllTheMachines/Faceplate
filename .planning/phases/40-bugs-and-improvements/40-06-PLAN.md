---
phase: 40-bugs-and-improvements
plan: 06
type: execute
wave: 2
depends_on: []
files_modified:
  - src/components/ContainerEditor/ContainerEditor.tsx
  - src/components/ContainerEditor/hooks/useContainerCopyPaste.ts
autonomous: true

must_haves:
  truths:
    - "User can copy/paste elements within container editor"
    - "User can duplicate elements in container editor with Ctrl+D"
    - "Pasted elements are offset from originals"
  artifacts:
    - path: "src/components/ContainerEditor/hooks/useContainerCopyPaste.ts"
      provides: "Copy/paste/duplicate for container editor context"
      exports: ["useContainerCopyPaste"]
  key_links:
    - from: "src/components/ContainerEditor/ContainerEditor.tsx"
      to: "useContainerCopyPaste"
      via: "Keyboard shortcut handlers"
      pattern: "copyToClipboard|pasteFromClipboard|duplicate"
---

<objective>
Add copy/paste and duplicate support to the container editor.

Purpose: The main canvas supports Ctrl+C/V/D for copy/paste/duplicate, but the container editor lacks these shortcuts (FEAT-40-03). This makes working with child elements tedious.

Output: Container editor with full copy/paste/duplicate support matching main canvas behavior.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/40-bugs-and-improvements/40-RESEARCH.md
@src/components/Canvas/hooks/useCopyPaste.ts
@src/store/containerEditorSlice.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useContainerCopyPaste hook</name>
  <files>src/components/ContainerEditor/hooks/useContainerCopyPaste.ts</files>
  <action>
    Create a copy/paste hook adapted for container context:

    ```typescript
    import { useRef, useCallback } from 'react'
    import { useStore } from '../../../store'
    import { ElementConfig } from '../../../types/elements'

    const PASTE_OFFSET = 20

    export function useContainerCopyPaste(containerId: string) {
      const clipboardRef = useRef<ElementConfig[]>([])

      const selectedIds = useStore((state) => state.selectedIds)
      const getElement = useStore((state) => state.getElement)
      const addChildToContainer = useStore((state) => state.addChildToContainer)
      const getContainerChildren = useStore((state) => state.getContainerChildren)
      const clearSelection = useStore((state) => state.clearSelection)
      const selectMultiple = useStore((state) => state.selectMultiple)

      const copyToClipboard = useCallback(() => {
        // Get selected elements that are children of this container
        const children = getContainerChildren(containerId)
        const childIds = new Set(children.map(c => c.id))

        const elements = selectedIds
          .filter(id => childIds.has(id))
          .map(id => getElement(id))
          .filter((el): el is ElementConfig => el !== undefined)

        if (elements.length === 0) return

        clipboardRef.current = elements
      }, [selectedIds, getElement, containerId, getContainerChildren])

      const pasteFromClipboard = useCallback(() => {
        if (clipboardRef.current.length === 0) return

        const pastedIds: string[] = []

        for (const original of clipboardRef.current) {
          // Clone with new ID and offset
          const cloned = {
            ...structuredClone(original),
            id: crypto.randomUUID(),
            x: original.x + PASTE_OFFSET,
            y: original.y + PASTE_OFFSET,
            name: `${original.name} copy`,
          }

          // Add to container
          addChildToContainer(containerId, cloned)
          pastedIds.push(cloned.id)
        }

        // Select pasted elements
        clearSelection()
        selectMultiple(pastedIds)
      }, [containerId, addChildToContainer, clearSelection, selectMultiple])

      const duplicateSelected = useCallback(() => {
        // Get selected elements that are children of this container
        const children = getContainerChildren(containerId)
        const childIds = new Set(children.map(c => c.id))

        const elements = selectedIds
          .filter(id => childIds.has(id))
          .map(id => getElement(id))
          .filter((el): el is ElementConfig => el !== undefined)

        if (elements.length === 0) return

        const duplicatedIds: string[] = []

        for (const original of elements) {
          const cloned = {
            ...structuredClone(original),
            id: crypto.randomUUID(),
            x: original.x + PASTE_OFFSET,
            y: original.y + PASTE_OFFSET,
            name: `${original.name} copy`,
          }

          addChildToContainer(containerId, cloned)
          duplicatedIds.push(cloned.id)
        }

        clearSelection()
        selectMultiple(duplicatedIds)
      }, [selectedIds, getElement, containerId, getContainerChildren, addChildToContainer, clearSelection, selectMultiple])

      return { copyToClipboard, pasteFromClipboard, duplicateSelected }
    }
    ```
  </action>
  <verify>
    TypeScript compiles without errors.
  </verify>
  <done>useContainerCopyPaste hook provides copy/paste/duplicate for container context</done>
</task>

<task type="auto">
  <name>Task 2: Wire keyboard shortcuts in container editor</name>
  <files>src/components/ContainerEditor/ContainerEditor.tsx</files>
  <action>
    Add keyboard event handlers for copy/paste/duplicate:

    1. Import and use the hook:
       ```typescript
       const { copyToClipboard, pasteFromClipboard, duplicateSelected } =
         useContainerCopyPaste(editingContainerId!)
       ```

    2. Add keyboard event handler to the container editor div:
       ```typescript
       useEffect(() => {
         const handleKeyDown = (e: KeyboardEvent) => {
           // Only handle if container editor is active
           if (!editingContainerId) return

           // Don't intercept if typing in an input
           if (e.target instanceof HTMLInputElement ||
               e.target instanceof HTMLTextAreaElement) return

           const isMod = e.metaKey || e.ctrlKey

           if (isMod && e.key === 'c') {
             e.preventDefault()
             copyToClipboard()
           } else if (isMod && e.key === 'v') {
             e.preventDefault()
             pasteFromClipboard()
           } else if (isMod && e.key === 'd') {
             e.preventDefault()
             duplicateSelected()
           }
         }

         document.addEventListener('keydown', handleKeyDown)
         return () => document.removeEventListener('keydown', handleKeyDown)
       }, [editingContainerId, copyToClipboard, pasteFromClipboard, duplicateSelected])
       ```

    3. If the container editor is a modal/overlay, make sure it has focus so keyboard events work.
  </action>
  <verify>
    1. Open container editor (Edit Contents on a Panel)
    2. Add two Button elements to the container
    3. Select one Button
    4. Press Ctrl+C (copy)
    5. Press Ctrl+V (paste) - verify new Button appears offset by 20px
    6. Select both Buttons
    7. Press Ctrl+D (duplicate) - verify two new Buttons appear
  </verify>
  <done>Keyboard shortcuts Ctrl+C/V/D work in container editor</done>
</task>

<task type="auto">
  <name>Task 3: Add context menu support</name>
  <files>src/components/ContainerEditor/ContainerEditor.tsx</files>
  <action>
    Add right-click context menu with copy/paste/duplicate options:

    1. Add state for context menu:
       ```typescript
       const [contextMenu, setContextMenu] = useState<{ x: number; y: number } | null>(null)
       ```

    2. Add context menu handler:
       ```typescript
       const handleContextMenu = (e: React.MouseEvent) => {
         e.preventDefault()
         setContextMenu({ x: e.clientX, y: e.clientY })
       }
       ```

    3. Render context menu:
       ```tsx
       {contextMenu && (
         <div
           className="fixed bg-gray-800 border border-gray-700 rounded shadow-lg py-1 z-50"
           style={{ left: contextMenu.x, top: contextMenu.y }}
         >
           <button
             className="w-full px-4 py-1 text-left text-sm hover:bg-gray-700"
             onClick={() => { copyToClipboard(); setContextMenu(null) }}
           >
             Copy <span className="text-gray-500 ml-4">Ctrl+C</span>
           </button>
           <button
             className="w-full px-4 py-1 text-left text-sm hover:bg-gray-700"
             onClick={() => { pasteFromClipboard(); setContextMenu(null) }}
           >
             Paste <span className="text-gray-500 ml-4">Ctrl+V</span>
           </button>
           <button
             className="w-full px-4 py-1 text-left text-sm hover:bg-gray-700"
             onClick={() => { duplicateSelected(); setContextMenu(null) }}
           >
             Duplicate <span className="text-gray-500 ml-4">Ctrl+D</span>
           </button>
         </div>
       )}
       ```

    4. Close menu on click outside:
       ```typescript
       useEffect(() => {
         if (!contextMenu) return
         const handleClick = () => setContextMenu(null)
         document.addEventListener('click', handleClick)
         return () => document.removeEventListener('click', handleClick)
       }, [contextMenu])
       ```
  </action>
  <verify>
    1. Open container editor
    2. Right-click on an element
    3. Verify context menu appears with Copy, Paste, Duplicate options
    4. Click Duplicate - verify element is duplicated
    5. Click outside menu - verify it closes
  </verify>
  <done>Context menu provides copy/paste/duplicate in container editor</done>
</task>

</tasks>

<verification>
Full copy/paste workflow:
1. Open container editor for Panel A
2. Add 3 elements, position them
3. Select all 3 (Ctrl+A or click each with Shift)
4. Ctrl+C to copy
5. Ctrl+V to paste - verify 3 new elements appear offset
6. Ctrl+D to duplicate the pasted ones - verify 3 more appear
7. Close container editor
8. Open container editor for Panel B
9. Ctrl+V - verify paste works in different container
</verification>

<success_criteria>
1. Ctrl+C copies selected elements in container editor
2. Ctrl+V pastes with 20px offset
3. Ctrl+D duplicates selected elements
4. Right-click context menu provides same options
5. Operations only affect elements in current container
6. Pasted elements have unique names (append "copy")
</success_criteria>

<output>
After completion, create `.planning/phases/40-bugs-and-improvements/40-06-SUMMARY.md`
</output>
