---
phase: 40-bugs-and-improvements
plan: 08
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/Properties/shared/FontWeightSelect.tsx
  - src/services/fonts/fontRegistry.ts
  - src/components/export/PreviewPanel.tsx
autonomous: true

must_haves:
  truths:
    - "Font weight dropdown shows actual font subfamily names when available"
    - "Browser preview renders fonts with correct weight"
    - "Canvas and preview match in font rendering"
  artifacts:
    - path: "src/components/Properties/shared/FontWeightSelect.tsx"
      provides: "Weight selector showing font-specific names"
      contains: "subfamilyName|actualName"
    - path: "src/services/fonts/fontRegistry.ts"
      provides: "Font weight metadata extraction"
      contains: "fontSubfamily"
  key_links:
    - from: "src/components/Properties/shared/FontWeightSelect.tsx"
      to: "src/services/fonts/fontRegistry.ts"
      via: "Get font subfamily names"
      pattern: "getWeightName|fontSubfamily"
---

<objective>
Fix font weight display to show actual font subfamily names and ensure preview rendering matches canvas.

Purpose: Font weight selector shows generic names (Light, Medium) but fonts have their own weight names like "Inter Light" (BUG-40-01). This causes confusion and potential mismatch between canvas and preview.

Output: Font weight selector with accurate subfamily names, consistent rendering in canvas and preview.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/40-bugs-and-improvements/40-RESEARCH.md
@src/components/Properties/shared/FontWeightSelect.tsx
@src/services/fonts/fontRegistry.ts
@src/store/fontsSlice.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extract and store font subfamily names</name>
  <files>src/services/fonts/fontRegistry.ts, src/store/fontsSlice.ts</files>
  <action>
    When loading fonts with opentype.js, extract the subfamily name (not just weight number):

    1. In fontRegistry.ts or fontsSlice.ts where fonts are loaded, extract metadata:
       ```typescript
       import * as opentype from 'opentype.js'

       interface FontWeight {
         value: number          // 300, 400, 500, etc.
         genericName: string    // "Light", "Regular", "Medium"
         actualName?: string    // "Inter Light", "Roboto Medium" (from font metadata)
       }

       async function extractFontWeights(fontUrl: string): Promise<FontWeight[]> {
         const font = await opentype.load(fontUrl)
         const subfamily = font.names.fontSubfamily?.en || ''
         const weight = getWeightFromSubfamily(subfamily)

         return [{
           value: weight,
           genericName: getGenericWeightName(weight),
           actualName: subfamily,
         }]
       }

       function getWeightFromSubfamily(subfamily: string): number {
         const map: Record<string, number> = {
           'Thin': 100,
           'ExtraLight': 200, 'Extra Light': 200, 'UltraLight': 200,
           'Light': 300,
           'Regular': 400, 'Normal': 400, 'Book': 400,
           'Medium': 500,
           'SemiBold': 600, 'Semi Bold': 600, 'DemiBold': 600,
           'Bold': 700,
           'ExtraBold': 800, 'Extra Bold': 800, 'UltraBold': 800,
           'Black': 900, 'Heavy': 900,
         }
         return map[subfamily] || 400
       }
       ```

    2. Store the extracted weight info in fontsSlice for each loaded font family.
  </action>
  <verify>
    Load a font file and log the extracted subfamily name. Verify "Inter-Light.woff2" shows actualName: "Light" or "Inter Light".
  </verify>
  <done>Font weight metadata (subfamily names) extracted and stored when fonts are loaded</done>
</task>

<task type="auto">
  <name>Task 2: Update FontWeightSelect to show actual names</name>
  <files>src/components/Properties/shared/FontWeightSelect.tsx</files>
  <action>
    Update the dropdown to show font-specific weight names when available:

    1. Accept optional font family prop to look up actual weight names:
       ```typescript
       interface FontWeightSelectProps {
         value: number | string
         onChange: (value: number | string) => void
         label?: string
         variant?: 'full' | 'compact'
         valueType?: 'number' | 'string'
         fontFamily?: string  // NEW: To look up actual weight names
       }
       ```

    2. Look up weight names for the current font:
       ```typescript
       const customFonts = useStore((state) => state.customFonts)
       const fontInfo = customFonts.find(f => f.family === fontFamily)

       const weights = variant === 'full' ? FONT_WEIGHTS_FULL : FONT_WEIGHTS_COMPACT
       const displayWeights = weights.map(w => ({
         ...w,
         label: fontInfo?.weights?.find(fw => fw.value === w.value)?.actualName
           || w.label  // Fall back to generic name
       }))
       ```

    3. Show both actual and generic names if different:
       ```tsx
       <option key={optValue} value={optValue}>
         {displayWeight.actualName !== displayWeight.label
           ? `${displayWeight.actualName} (${displayWeight.label})`
           : displayWeight.label}
       </option>
       // Example: "Inter Light (300)" or just "Light (300)" for generic
       ```
  </action>
  <verify>
    1. Load custom font "Inter" with Light, Regular, Medium weights
    2. Open font weight dropdown
    3. Verify it shows "Inter Light (300)", "Inter Regular (400)", "Inter Medium (500)"
    4. For built-in fonts without metadata, verify generic names still work
  </verify>
  <done>FontWeightSelect shows actual font subfamily names when available</done>
</task>

<task type="auto">
  <name>Task 3: Ensure preview matches canvas font rendering</name>
  <files>src/components/export/PreviewPanel.tsx, src/services/export/cssGenerator.ts</files>
  <action>
    Verify and fix font rendering consistency between canvas and preview:

    1. Check that preview embeds fonts the same way canvas does:
       - Canvas: Uses @font-face from loaded fonts
       - Preview: Should use same @font-face declarations

    2. In cssGenerator.ts, verify font-weight CSS uses the numeric value:
       ```css
       font-weight: 300;  /* Not "Light" - browsers need numbers */
       ```

    3. In PreviewPanel, ensure fonts are loaded before rendering:
       ```typescript
       // Wait for fonts to load in iframe
       iframe.contentDocument.fonts.ready.then(() => {
         // Fonts are loaded, content should render correctly
       })
       ```

    4. If custom fonts use variable font-weight ranges, ensure the exact weight is specified.
  </action>
  <verify>
    1. Create element with custom font at weight 300 (Light)
    2. Verify canvas shows Light weight
    3. Open Browser Preview
    4. Verify preview shows same Light weight
    5. Compare side-by-side - should be identical
  </verify>
  <done>Font rendering matches between canvas and browser preview</done>
</task>

</tasks>

<verification>
Full font workflow test:
1. Load custom font family with multiple weights (e.g., Inter)
2. Create a Label element
3. Set font to Inter, weight to 300
4. Verify dropdown shows "Inter Light (300)" or similar
5. Verify canvas renders in Light weight
6. Open Browser Preview
7. Verify preview renders identically to canvas
8. Save project, reload
9. Verify font weight persists correctly
</verification>

<success_criteria>
1. Font weight dropdown shows actual font names when available (BUG-40-01)
2. Generic names used as fallback for fonts without metadata
3. Canvas and preview render fonts identically
4. Font weight values correctly saved and restored
5. Export generates correct font-weight CSS values
</success_criteria>

<output>
After completion, create `.planning/phases/40-bugs-and-improvements/40-08-SUMMARY.md`
</output>
