---
phase: 40-bugs-and-improvements
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/Properties/ColorInput.tsx
  - src/components/Properties/shared/LabelDisplaySection.tsx
  - src/components/Properties/shared/ValueDisplaySection.tsx
autonomous: true

must_haves:
  truths:
    - "Color picker swatch matches hex input value"
    - "Switching between elements updates color picker correctly"
    - "Label/value distance is editable for elements that support it"
  artifacts:
    - path: "src/components/Properties/ColorInput.tsx"
      provides: "Controlled color picker with key-based remount"
      contains: "key="
  key_links:
    - from: "src/components/Properties/ColorInput.tsx"
      to: "HexColorPicker"
      via: "value prop directly passed"
      pattern: "color=\\{value\\}"
---

<objective>
Fix color picker state desynchronization and verify label/value distance editing.

Purpose: Color picker swatch shows wrong color while hex field shows correct value (BUG-40-04). Also verify that label/value distance editing works since the components already have the fields (BUG-40-05).

Output: Reliable color picker that always shows the correct color, and confirmed working distance controls.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/40-bugs-and-improvements/40-RESEARCH.md
@src/components/Properties/ColorInput.tsx
@src/components/Properties/shared/LabelDisplaySection.tsx
@src/components/Properties/shared/ValueDisplaySection.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix ColorInput controlled component pattern</name>
  <files>src/components/Properties/ColorInput.tsx</files>
  <action>
    The ColorInput component needs to ensure the HexColorPicker always reflects the current value. Add key prop to force remount when element changes:

    1. Add a `key` prop to the ColorInput interface:
       ```typescript
       interface ColorInputProps {
         key?: string  // Optional key to force remount
         label: string
         value: string
         onChange: (value: string) => void
       }
       ```

    2. Ensure the HexColorPicker color prop uses `value` directly (it already does, but verify):
       ```tsx
       <HexColorPicker color={value} onChange={onChange} />
       ```

    3. The issue may be stale closure in the picker popup. Close the picker when value changes from outside:
       Add useEffect to close picker when value changes:
       ```typescript
       useEffect(() => {
         // Close picker when value changes from outside (element selection changed)
         if (showPicker) {
           // Don't close - let user continue editing
         }
       }, [value])
       ```

    4. Actually, the real fix: Ensure the swatch button background uses value directly and not any cached state:
       ```tsx
       style={{ backgroundColor: value }}
       ```
       This is already correct in the code, so the issue may be in parent components not passing updated values.

    5. Add console.log debugging to trace value flow:
       ```typescript
       useEffect(() => {
         console.log('[ColorInput] value changed:', value)
       }, [value])
       ```
  </action>
  <verify>
    1. Add two elements (Knob and Slider)
    2. Set Knob fill color to #FF0000 (red)
    3. Set Slider fill color to #00FF00 (green)
    4. Click Knob, verify color picker shows red
    5. Click Slider, verify color picker shows green
    6. Click Knob again, verify it shows red (not stale green)
  </verify>
  <done>Color picker swatch always matches the hex value in the text field</done>
</task>

<task type="auto">
  <name>Task 2: Wire label/value distance to all knob variants</name>
  <files>src/components/Properties/KnobProperties.tsx, src/components/Properties/SteppedKnobProperties.tsx, src/components/Properties/CenterDetentKnobProperties.tsx, src/components/Properties/DotIndicatorKnobProperties.tsx</files>
  <action>
    The LabelDisplaySection and ValueDisplaySection already support distance props. Verify they are wired up in all knob property panels:

    1. Check KnobProperties.tsx - should have:
       ```tsx
       <LabelDisplaySection
         labelDistance={element.labelDistance}
         onLabelDistanceChange={(labelDistance) => onUpdate({ labelDistance })}
         // ... other props
       />
       <ValueDisplaySection
         valueDistance={element.valueDistance}
         onValueDistanceChange={(valueDistance) => onUpdate({ valueDistance })}
         // ... other props
       />
       ```

    2. Check the knob type defaults in src/types/elements/controls.ts - should have:
       ```typescript
       labelDistance: 4,   // pixels from element to label
       valueDistance: 4,   // pixels from element to value
       ```

    3. If these aren't wired up, add the props. If they are wired but not showing, check if the parent component is passing the callbacks.
  </action>
  <verify>
    1. Add a Knob to canvas
    2. Enable "Show Label" in properties
    3. Verify "Distance" field appears next to "Font Size"
    4. Change distance from 4 to 20
    5. Verify label moves further from knob on canvas
    6. Do same for "Show Value" section
  </verify>
  <done>Label and Value distance fields are visible and functional for knob elements</done>
</task>

<task type="auto">
  <name>Task 3: Wire label/value distance to slider elements</name>
  <files>src/components/Properties/SliderProperties.tsx</files>
  <action>
    Same as Task 2 but for sliders. Check SliderProperties.tsx and ensure distance props are wired:

    1. Verify LabelDisplaySection has labelDistance and onLabelDistanceChange props
    2. Verify ValueDisplaySection has valueDistance and onValueDistanceChange props
    3. If missing, add them following the same pattern as knobs

    Also check that the slider renderer respects labelDistance and valueDistance in positioning.
  </action>
  <verify>
    1. Add a Slider to canvas
    2. Enable "Show Label" in properties
    3. Verify "Distance" field appears
    4. Change distance and verify label position updates on canvas
  </verify>
  <done>Label and Value distance fields work for slider elements</done>
</task>

</tasks>

<verification>
Color picker test:
1. Create 3 elements with different colors
2. Rapidly switch between them
3. Verify color picker always shows correct color

Distance test:
1. Create Knob with label at top, distance 4
2. Create Knob with label at top, distance 20
3. Verify visual difference in label positioning
4. Save, reload, verify distances preserved
</verification>

<success_criteria>
1. Color picker swatch always matches hex value (BUG-40-04)
2. Switching elements updates color picker immediately
3. Label distance editable and affects canvas rendering (BUG-40-05)
4. Value distance editable and affects canvas rendering (BUG-40-05)
5. Distance values persist across save/load
</success_criteria>

<output>
After completion, create `.planning/phases/40-bugs-and-improvements/40-03-SUMMARY.md`
</output>
