---
phase: 40-bugs-and-improvements
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - src/services/export/codeGenerator.ts
  - src/components/export/ExportDialog.tsx
autonomous: true

must_haves:
  truths:
    - "User can choose between ZIP export and folder export"
    - "Folder export writes files directly to selected directory"
    - "ZIP export works as before"
  artifacts:
    - path: "src/services/export/codeGenerator.ts"
      provides: "exportToFolder function using File System Access API"
      exports: ["exportToFolder"]
    - path: "src/components/export/ExportDialog.tsx"
      provides: "Export mode selector (ZIP vs Folder)"
      contains: "exportMode"
  key_links:
    - from: "src/components/export/ExportDialog.tsx"
      to: "src/services/export/codeGenerator.ts"
      via: "exportToFolder() call"
      pattern: "exportToFolder"
---

<objective>
Add direct folder export option alongside existing ZIP export.

Purpose: Users want to export directly to their project's UI folder without unzipping (FEAT-40-01). This speeds up the workflow significantly.

Output: Export dialog with mode selector (ZIP/Folder), folder export using File System Access API.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/40-bugs-and-improvements/40-RESEARCH.md
@src/services/export/codeGenerator.ts
@src/components/export/ExportDialog.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add exportToFolder function</name>
  <files>src/services/export/codeGenerator.ts</files>
  <action>
    Add a new export function that writes directly to a folder using File System Access API:

    ```typescript
    /**
     * Export project to a folder (no ZIP)
     * Uses File System Access API to write directly to selected directory
     */
    export async function exportMultiWindowToFolder(
      options: MultiWindowExportOptions
    ): Promise<{ success: boolean; folderName?: string; error?: string }> {
      // 1. Show directory picker
      let dirHandle: FileSystemDirectoryHandle
      try {
        dirHandle = await window.showDirectoryPicker({
          mode: 'readwrite',
          startIn: 'documents'
        })
      } catch (e) {
        if (e instanceof Error && e.name === 'AbortError') {
          return { success: false, error: 'Export cancelled' }
        }
        throw e
      }

      // 2. Get windows data (same as ZIP export)
      const store = useStore.getState()
      const windows = options.includeDeveloperWindows
        ? store.windows
        : store.windows.filter(w => w.type === 'release')

      // 3. For each window, create subfolder and write files
      for (const window of windows) {
        const windowDir = await dirHandle.getDirectoryHandle(
          sanitizeFilename(window.name),
          { create: true }
        )

        // Generate files (same as ZIP)
        const elements = window.elementIds.map(id => store.getElement(id)).filter(Boolean)
        const html = generateHTML({ ... })
        const css = generateCSS({ ... })
        const js = generateBindingsJS({ ... })

        // Write files
        await writeFile(windowDir, 'index.html', html)
        await writeFile(windowDir, 'styles.css', css)
        await writeFile(windowDir, 'bindings.js', js)
        // ... fonts, images, etc.
      }

      return { success: true, folderName: dirHandle.name }
    }

    async function writeFile(dir: FileSystemDirectoryHandle, name: string, content: string) {
      const file = await dir.getFileHandle(name, { create: true })
      const writable = await file.createWritable()
      await writable.write(content)
      await writable.close()
    }
    ```

    Key considerations:
    - Use same generation logic as ZIP export
    - Handle permission errors gracefully
    - Support subdirectories for multi-window
    - Show progress for large exports
  </action>
  <verify>
    Run in browser console:
    ```javascript
    // Trigger folder export
    const { exportMultiWindowToFolder } = await import('./services/export/codeGenerator')
    await exportMultiWindowToFolder({ projectName: 'test' })
    ```
    Verify folder picker appears and files are written.
  </verify>
  <done>exportMultiWindowToFolder function writes project files directly to selected folder</done>
</task>

<task type="auto">
  <name>Task 2: Add export mode selector to UI</name>
  <files>src/components/export/ExportDialog.tsx</files>
  <action>
    Update the export dialog to offer ZIP vs Folder choice:

    1. Add state for export mode:
       ```typescript
       const [exportMode, setExportMode] = useState<'zip' | 'folder'>('zip')
       ```

    2. Add radio buttons or segmented control in dialog:
       ```tsx
       <div className="flex gap-4 mb-4">
         <label className="flex items-center gap-2 cursor-pointer">
           <input
             type="radio"
             checked={exportMode === 'zip'}
             onChange={() => setExportMode('zip')}
           />
           <span>ZIP Archive</span>
         </label>
         <label className="flex items-center gap-2 cursor-pointer">
           <input
             type="radio"
             checked={exportMode === 'folder'}
             onChange={() => setExportMode('folder')}
           />
           <span>Export to Folder</span>
         </label>
       </div>
       ```

    3. Update export button handler:
       ```typescript
       const handleExport = async () => {
         if (exportMode === 'folder') {
           const result = await exportMultiWindowToFolder(options)
           if (result.success) {
             toast.success(`Exported to ${result.folderName}/`)
           } else if (result.error) {
             toast.error(result.error)
           }
         } else {
           // Existing ZIP export
           await exportMultiWindowBundle(options)
         }
       }
       ```

    4. Show helpful hint below folder option:
       "Exports directly to a folder. Choose your project's UI folder to skip unzipping."
  </action>
  <verify>
    1. Open Export dialog (Ctrl+E or menu)
    2. Verify radio buttons for ZIP and Folder
    3. Select Folder mode
    4. Click Export
    5. Verify folder picker appears
    6. Select folder, verify files written
    7. Verify success toast shows folder name
  </verify>
  <done>Export dialog offers ZIP and Folder export modes with clear UI</done>
</task>

<task type="auto">
  <name>Task 3: Handle browser compatibility</name>
  <files>src/services/export/codeGenerator.ts, src/components/export/ExportDialog.tsx</files>
  <action>
    File System Access API is not supported in all browsers. Add graceful fallback:

    1. Check for API support:
       ```typescript
       const isFolderExportSupported = 'showDirectoryPicker' in window
       ```

    2. In ExportDialog, disable folder option if not supported:
       ```tsx
       <label className={`... ${!isFolderExportSupported ? 'opacity-50 cursor-not-allowed' : ''}`}>
         <input
           type="radio"
           disabled={!isFolderExportSupported}
           ...
         />
         <span>Export to Folder</span>
         {!isFolderExportSupported && (
           <span className="text-xs text-gray-500 ml-2">
             (Not supported in this browser)
           </span>
         )}
       </label>
       ```

    3. In exportToFolder, throw clear error if called without support:
       ```typescript
       if (!('showDirectoryPicker' in window)) {
         return { success: false, error: 'Folder export requires Chrome, Edge, or Opera' }
       }
       ```
  </action>
  <verify>
    Test in Chrome - folder export should work.
    If testing in Firefox/Safari - folder option should be disabled with message.
  </verify>
  <done>Folder export gracefully handles unsupported browsers with clear messaging</done>
</task>

</tasks>

<verification>
Full export test:
1. Create project with 2 windows (Main, Settings)
2. Add elements to both windows
3. Export as ZIP - verify works as before
4. Export to Folder - verify folder picker, files written
5. Open exported folder, verify structure:
   ```
   selected-folder/
     Main/
       index.html
       styles.css
       bindings.js
       fonts/
     Settings/
       index.html
       ...
   ```
</verification>

<success_criteria>
1. Export dialog shows ZIP/Folder mode selector
2. Folder export uses File System Access API
3. Files written directly to selected folder
4. Multi-window exports create subfolders
5. Unsupported browsers show disabled option with message
6. ZIP export still works unchanged
</success_criteria>

<output>
After completion, create `.planning/phases/40-bugs-and-improvements/40-04-SUMMARY.md`
</output>
