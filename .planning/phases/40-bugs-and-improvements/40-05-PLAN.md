---
phase: 40-bugs-and-improvements
plan: 05
type: execute
wave: 2
depends_on: []
files_modified:
  - src/components/ContainerEditor/ContainerEditor.tsx
  - src/components/ContainerEditor/hooks/useContainerGrid.ts
autonomous: true

must_haves:
  truths:
    - "Container editor shows grid matching main canvas grid"
    - "Elements snap to grid when moved in container editor"
    - "Grid visibility can be toggled in container editor"
  artifacts:
    - path: "src/components/ContainerEditor/hooks/useContainerGrid.ts"
      provides: "Snap-to-grid logic for container editor"
      exports: ["useContainerGrid"]
    - path: "src/components/ContainerEditor/ContainerEditor.tsx"
      provides: "Grid rendering in container editor canvas"
      contains: "gridSize"
  key_links:
    - from: "src/components/ContainerEditor/ContainerEditor.tsx"
      to: "src/store/canvasSlice.ts"
      via: "Grid settings subscription"
      pattern: "snapToGrid|gridSize"
---

<objective>
Add snap-to-grid support to the container editor.

Purpose: The main canvas has snap-to-grid (Phase 33), but the container editor lacks this feature (FEAT-40-02). This makes precise positioning of child elements difficult.

Output: Container editor with grid display and snapping behavior matching main canvas.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/40-bugs-and-improvements/40-RESEARCH.md
@src/store/containerEditorSlice.ts
@src/components/Canvas/Canvas.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useContainerGrid hook</name>
  <files>src/components/ContainerEditor/hooks/useContainerGrid.ts</files>
  <action>
    Create a hook that provides grid functionality for the container editor:

    ```typescript
    import { useStore } from '../../../store'

    export function useContainerGrid() {
      // Subscribe to canvas grid settings
      const snapToGrid = useStore((state) => state.snapToGrid)
      const gridSize = useStore((state) => state.gridSize)
      const showGrid = useStore((state) => state.showGrid)
      const gridColor = useStore((state) => state.gridColor)

      /**
       * Snap a position to the grid
       */
      const snapPosition = (x: number, y: number): { x: number; y: number } => {
        if (!snapToGrid) return { x, y }
        return {
          x: Math.round(x / gridSize) * gridSize,
          y: Math.round(y / gridSize) * gridSize,
        }
      }

      /**
       * Snap a size to the grid
       */
      const snapSize = (width: number, height: number): { width: number; height: number } => {
        if (!snapToGrid) return { width, height }
        return {
          width: Math.max(gridSize, Math.round(width / gridSize) * gridSize),
          height: Math.max(gridSize, Math.round(height / gridSize) * gridSize),
        }
      }

      return {
        snapToGrid,
        gridSize,
        showGrid,
        gridColor,
        snapPosition,
        snapSize,
      }
    }
    ```

    Create the hooks directory if it doesn't exist: `src/components/ContainerEditor/hooks/`
  </action>
  <verify>
    Import and call `useContainerGrid()` in ContainerEditor.tsx to verify it compiles and returns expected values.
  </verify>
  <done>useContainerGrid hook provides grid settings and snap functions for container editor</done>
</task>

<task type="auto">
  <name>Task 2: Add grid rendering to container editor</name>
  <files>src/components/ContainerEditor/ContainerEditor.tsx</files>
  <action>
    Add grid background to the container editor canvas area:

    1. Import useContainerGrid hook
    2. Get grid settings: `const { showGrid, gridSize, gridColor } = useContainerGrid()`
    3. Add grid background to the editing area (similar to main Canvas.tsx):

    ```tsx
    // In the container editing area div:
    <div
      className="relative"
      style={{
        width: containerWidth,
        height: containerHeight,
        // Grid background when showGrid is true
        backgroundImage: showGrid
          ? `linear-gradient(to right, ${gridColor}22 1px, transparent 1px),
             linear-gradient(to bottom, ${gridColor}22 1px, transparent 1px)`
          : undefined,
        backgroundSize: showGrid ? `${gridSize}px ${gridSize}px` : undefined,
      }}
    >
      {/* Child elements */}
    </div>
    ```

    4. The grid should use the same settings as the main canvas (via Zustand store subscription).
  </action>
  <verify>
    1. Open container editor (click "Edit Contents" on a Panel)
    2. Toggle grid visibility (Ctrl+G or toolbar button)
    3. Verify grid appears/disappears in container editor
    4. Verify grid size matches main canvas grid size
  </verify>
  <done>Container editor displays grid matching main canvas grid settings</done>
</task>

<task type="auto">
  <name>Task 3: Wire snap-to-grid to element dragging</name>
  <files>src/components/ContainerEditor/ContainerEditor.tsx</files>
  <action>
    Integrate snapping into the drag handlers in container editor:

    1. Get snap function: `const { snapPosition } = useContainerGrid()`

    2. Find the drag end handler (likely onDragEnd from @dnd-kit). Update to snap:
    ```typescript
    const handleDragEnd = (event: DragEndEvent) => {
      const { active, delta } = event
      const element = getElement(active.id)
      if (!element) return

      // Calculate new position
      let newX = element.x + delta.x
      let newY = element.y + delta.y

      // Snap to grid
      const snapped = snapPosition(newX, newY)

      // Update element
      updateElement(element.id, { x: snapped.x, y: snapped.y })
    }
    ```

    3. Also snap when resizing elements (if resize is supported in container editor):
    ```typescript
    const handleResize = (id: string, newWidth: number, newHeight: number) => {
      const snapped = snapSize(newWidth, newHeight)
      updateElement(id, { width: snapped.width, height: snapped.height })
    }
    ```
  </action>
  <verify>
    1. Enable snap-to-grid (Ctrl+G if off)
    2. Open container editor
    3. Add a child element
    4. Drag the element - verify it snaps to grid lines
    5. Disable snap-to-grid (Ctrl+G)
    6. Drag element - verify it moves freely without snapping
  </verify>
  <done>Elements in container editor snap to grid when snapToGrid is enabled</done>
</task>

</tasks>

<verification>
Full grid test in container editor:
1. Set grid size to 20px in main canvas settings
2. Open container editor for a Panel
3. Add a Button child element
4. Verify grid lines are visible and spaced at 20px
5. Drag the Button - verify it snaps to 20px increments
6. Change grid size to 10px
7. Verify container editor grid updates to 10px
8. Drag Button - verify it now snaps to 10px increments
</verification>

<success_criteria>
1. Container editor shows grid when grid is enabled
2. Grid size and color match main canvas settings
3. Elements snap to grid when dragged (if snap enabled)
4. Toggling grid (Ctrl+G) affects container editor
5. No regressions in main canvas grid behavior
</success_criteria>

<output>
After completion, create `.planning/phases/40-bugs-and-improvements/40-05-SUMMARY.md`
</output>
