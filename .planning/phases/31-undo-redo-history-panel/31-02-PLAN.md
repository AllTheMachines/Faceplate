---
phase: 31-undo-redo-history-panel
plan: 02
type: execute
wave: 2
depends_on: ["31-01"]
files_modified:
  - src/hooks/useHistoryPanel.ts
  - src/components/History/HistoryPanel.tsx
  - src/components/History/HistoryEntry.tsx
  - src/components/History/historyUtils.ts
  - src/App.tsx
autonomous: true

must_haves:
  truths:
    - "User can toggle history panel with Ctrl+Shift+H (Cmd+Shift+H on Mac)"
    - "Each history entry shows timestamp, action type, and affected element names"
    - "Clicking a history entry jumps to that state (time travel)"
  artifacts:
    - path: "src/components/History/historyUtils.ts"
      provides: "Action inference from state diffs"
      exports: ["inferAction", "getAffectedElements"]
    - path: "src/hooks/useHistoryPanel.ts"
      provides: "Panel visibility with keyboard shortcut"
      exports: ["useHistoryPanel"]
  key_links:
    - from: "src/components/History/HistoryEntry.tsx"
      to: "temporal.undo/redo"
      via: "onClick handler with step count"
      pattern: "undo\\(|redo\\("
    - from: "src/hooks/useHistoryPanel.ts"
      to: "useHotkeys"
      via: "react-hotkeys-hook integration"
      pattern: "useHotkeys"
    - from: "src/components/History/HistoryPanel.tsx"
      to: "useAppStore.temporal"
      via: "useStore from zustand with temporal selector"
      pattern: "useStore\\(useAppStore\\.temporal"
---

<objective>
Add keyboard shortcut toggle, action inference, and time-travel navigation to complete the History Panel.

Purpose: Enable users to quickly toggle the history panel visibility and navigate to any previous state by clicking entries. Action type and affected elements provide meaningful context for each state change.

Output: Fully functional history panel with Ctrl+Shift+H toggle, descriptive entries (action type, affected elements, timestamp), and click-to-jump time-travel.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/31-undo-redo-history-panel/31-RESEARCH.md
@.planning/phases/31-undo-redo-history-panel/31-01-SUMMARY.md (will exist after Plan 01)

Key existing files:
@src/components/Canvas/hooks/useKeyboardShortcuts.ts - Pattern for useHotkeys usage
@src/store/index.ts - Temporal API with undo(n)/redo(n) for multi-step time travel
@src/components/Layout/LeftPanel.tsx - Shows temporal access pattern (lines 13-15): useStore(useAppStore.temporal, selector)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create action inference utilities</name>
  <files>
    src/components/History/historyUtils.ts
  </files>
  <action>
1. Create src/components/History/historyUtils.ts with:

   ```typescript
   // Types
   export type HistoryAction = 'add' | 'delete' | 'move' | 'resize' | 'update' | 'canvas' | 'initial'

   // Action color mapping for UI
   export const ACTION_COLORS: Record<HistoryAction, string> = {
     add: 'text-green-400',
     delete: 'text-red-400',
     move: 'text-yellow-400',
     resize: 'text-purple-400',
     update: 'text-blue-400',
     canvas: 'text-cyan-400',
     initial: 'text-gray-400',
   }
   ```

2. Implement inferAction function:
   - Compare before and after states
   - Check for element count changes (add/delete)
   - Check for position changes (move: x or y changed)
   - Check for size changes (resize: width or height changed)
   - Check for canvas property changes (canvasWidth, canvasHeight, backgroundColor)
   - Default to 'update' if elements changed but not position/size

3. Implement getAffectedElements function:
   - Compare element arrays between states
   - Return array of element names that were added, removed, or modified
   - For added elements: find elements in after that aren't in before
   - For removed elements: find elements in before that aren't in after
   - For modified elements: find elements with same id but different properties

4. Implement formatTimestamp function:
   - Accept optional timestamp (number)
   - Return relative time string: "just now", "Xs ago", "Xm ago", "Xh ago"
   - Simple implementation, no external library needed
  </action>
  <verify>
    TypeScript compiles without errors
    Functions can be imported from historyUtils
  </verify>
  <done>
    inferAction correctly identifies add/delete/move/resize/update/canvas actions
    getAffectedElements returns meaningful element names
    formatTimestamp provides human-readable relative times
  </done>
</task>

<task type="auto">
  <name>Task 2: Add keyboard shortcut and wire time-travel</name>
  <files>
    src/hooks/useHistoryPanel.ts
    src/components/History/HistoryPanel.tsx
    src/components/History/HistoryEntry.tsx
    src/App.tsx
  </files>
  <action>
1. Update src/hooks/useHistoryPanel.ts:
   - Import useHotkeys from 'react-hotkeys-hook'
   - Add keyboard shortcut: 'ctrl+shift+h, meta+shift+h'
   - Options: { preventDefault: true, enableOnFormTags: true, enableOnContentEditable: true }
   - Toggle isPanelVisible on shortcut

2. Update HistoryEntry.tsx:
   - Import inferAction, getAffectedElements, ACTION_COLORS, formatTimestamp from historyUtils
   - Add props: beforeState, afterState, onJump (callback)
   - Display inferred action with color from ACTION_COLORS
   - Display affected element names (first 2-3 names, then "+ X more" if more)
   - Display timestamp (relative time)
   - onClick calls onJump(index)

3. Update HistoryPanel.tsx:
   - Use the EXISTING codebase pattern for temporal access (from LeftPanel.tsx lines 13-15):
     ```typescript
     import { useStore } from 'zustand'
     import { useStore as useAppStore } from '../../store'

     // Subscribe to pastStates and futureStates reactively
     const pastStates = useStore(useAppStore.temporal, (state) => state.pastStates)
     const futureStates = useStore(useAppStore.temporal, (state) => state.futureStates)
     ```
   - Do NOT use a custom useTemporalStore hook - use the standard zustand pattern above
   - Create jumpToHistoryIndex function:
     ```typescript
     const jumpToHistoryIndex = (targetIndex: number) => {
       const { pastStates, undo, redo } = useAppStore.temporal.getState()
       const currentIndex = pastStates.length

       if (targetIndex < currentIndex) {
         undo(currentIndex - targetIndex)
       } else if (targetIndex > currentIndex) {
         redo(targetIndex - currentIndex)
       }
     }
     ```
   - Pass beforeState (previous entry or null) and afterState to each HistoryEntry
   - Pass onJump={jumpToHistoryIndex} to each entry
   - Track creation timestamp for entries (store in useRef on mount)

4. Update App.tsx:
   - Import useHistoryPanel hook
   - Use isPanelVisible to control bottom Panel visibility
   - When isPanelVisible is false, set Panel defaultSize={0} and collapsedSize={0}
   - Or use conditional rendering to hide the entire bottom section
  </action>
  <verify>
    Press Ctrl+Shift+H to toggle panel visibility
    Panel shows/hides correctly
    Each entry displays action type (ADD, DELETE, MOVE, etc.) with appropriate color
    Each entry shows affected element names
    Clicking an entry jumps to that state in history
    After clicking, the current state indicator moves to the clicked entry
  </verify>
  <done>
    Ctrl+Shift+H (Cmd+Shift+H on Mac) toggles panel visibility
    Entries show action type, affected elements, and relative timestamp
    Time-travel works - clicking an entry restores that state
  </done>
</task>

<task type="auto">
  <name>Task 3: Polish and verify success criteria</name>
  <files>
    src/components/History/HistoryPanel.tsx
    src/components/History/HistoryEntry.tsx
  </files>
  <action>
1. Visual polish for HistoryPanel:
   - Header with "History" title and toggle collapse button
   - Show count: "X past | Y future"
   - Scrollable list with smooth scrolling to current entry
   - Empty state when no history

2. Visual polish for HistoryEntry:
   - Compact layout: [Index] [Action Badge] [Elements] [Time]
   - Past entries: gray background, full opacity
   - Current entry: blue-900 background, highlighted border
   - Future entries: slightly faded (opacity-70), blue-tinted

3. Ensure all success criteria from ROADMAP are met:
   - Bottom panel with scrollable list showing all state changes
   - Each entry shows: timestamp, action type, affected element(s), before/after summary
   - Clicking an entry jumps to that state (time travel debugging)
   - Keyboard shortcut to toggle panel visibility (Ctrl+Shift+H)
   - Panel is collapsible/resizable
   - Clear visual distinction between undo-able and redo-able entries

4. Update buildInfo.ts with current timestamp
  </action>
  <verify>
    All 6 success criteria from ROADMAP Phase 31 are verified:
    1. Bottom panel visible with scrollable list
    2. Entries show timestamp, action type, affected elements
    3. Click-to-jump works for time travel
    4. Ctrl+Shift+H toggles panel
    5. Panel is collapsible and resizable
    6. Past (undoable) and future (redoable) entries are visually distinct
  </verify>
  <done>
    History panel fully functional with all Phase 31 success criteria met
    Visual design matches dark theme of the application
    Build timestamp updated
  </done>
</task>

</tasks>

<verification>
1. Ctrl+Shift+H toggles the history panel visibility
2. Panel shows past states as gray entries, current as highlighted blue, future as faded blue
3. Each entry displays:
   - Action type badge (ADD, DELETE, MOVE, RESIZE, UPDATE) with color coding
   - Affected element names (truncated if many)
   - Relative timestamp ("just now", "Xs ago", etc.)
4. Clicking any entry performs time-travel to that state
5. After time-travel, canvas shows the historical state
6. Panel is resizable by dragging the divider
7. Panel can be collapsed and re-expanded
</verification>

<success_criteria>
Phase 31 Success Criteria (all met):
1. Bottom panel with scrollable list showing all state changes
2. Each entry shows: timestamp, action type, affected element(s), before/after summary
3. Clicking an entry jumps to that state (time travel debugging)
4. Keyboard shortcut to toggle panel visibility (Ctrl+Shift+H)
5. Panel is collapsible/resizable
6. Clear visual distinction between undo-able and redo-able entries
</success_criteria>

<output>
After completion, create `.planning/phases/31-undo-redo-history-panel/31-02-SUMMARY.md`
</output>
