---
phase: 08-code-export
plan: 04
type: execute
wave: 3
depends_on: ["08-02", "08-03"]
files_modified:
  - src/services/export/codeGenerator.ts
  - src/services/export/index.ts
autonomous: true

must_haves:
  truths:
    - "Export orchestrator validates design before generating code"
    - "JUCE export produces 5-file ZIP bundle"
    - "HTML preview export produces 4-file ZIP without C++"
    - "Export fails gracefully with user-friendly errors"
  artifacts:
    - path: "src/services/export/codeGenerator.ts"
      provides: "Export orchestration and ZIP bundle creation"
      exports: ["exportJUCEBundle", "exportHTMLPreview", "ExportOptions", "ExportResult"]
    - path: "src/services/export/index.ts"
      provides: "Barrel export for export service"
      exports: ["exportJUCEBundle", "exportHTMLPreview", "validateForExport"]
  key_links:
    - from: "src/services/export/codeGenerator.ts"
      to: "src/services/export/htmlGenerator.ts"
      via: "Calls generateHTML"
      pattern: "import.*generateHTML.*from"
    - from: "src/services/export/codeGenerator.ts"
      to: "jszip"
      via: "Creates ZIP bundle"
      pattern: "import JSZip from 'jszip'"
---

<objective>
Create the main code generator orchestrator that combines all generators and produces ZIP bundles.

Purpose: Coordinate all generators (HTML, CSS, JS, C++) into a complete export workflow with validation and ZIP packaging.
Output: codeGenerator.ts with exportJUCEBundle and exportHTMLPreview functions, index.ts barrel export.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-code-export/08-CONTEXT.md
@.planning/phases/08-code-export/08-RESEARCH.md
@src/services/export/validators.ts (from Plan 01)
@src/services/export/htmlGenerator.ts (from Plan 02)
@src/services/export/cssGenerator.ts (from Plan 02)
@src/services/export/jsGenerator.ts (from Plan 03)
@src/services/export/cppGenerator.ts (from Plan 03)
@src/services/fileSystem.ts (existing)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create code generator orchestrator</name>
  <files>src/services/export/codeGenerator.ts</files>
  <action>
Create `src/services/export/codeGenerator.ts` with main export orchestration:

1. **Types**
```typescript
import type { ElementConfig } from '../../types/elements'

export interface ExportOptions {
  elements: ElementConfig[]
  canvasWidth: number
  canvasHeight: number
  backgroundColor: string
  projectName?: string  // Used for ZIP filename
}

export type ExportResult =
  | { success: true }
  | { success: false; error: string }
```

2. **exportJUCEBundle(options: ExportOptions): Promise<ExportResult>**
   Main export function for JUCE WebView2 bundle:

   a. **Validate** - Call validateForExport(elements)
      - If invalid, return { success: false, error: formatted errors }

   b. **Generate all files:**
      - HTML: generateHTML(elements, { ...options, isPreviewMode: false })
      - CSS: generateCSS(elements, options)
      - Components JS: generateComponentsJS(elements)
      - Bindings JS: generateBindingsJS(elements, { isPreviewMode: false })
      - C++: generateCPP(elements)

   c. **Create ZIP:**
      - Use JSZip to create archive
      - Add all 5 files:
        - index.html
        - styles.css
        - components.js
        - bindings.js
        - bindings.cpp

   d. **Trigger download:**
      - Generate blob from ZIP
      - Use browser-fs-access fileSave for download
      - Filename: `${projectName || 'webview-ui'}-juce.zip`

   e. **Return result:**
      - { success: true } on success
      - { success: false, error: message } on failure

3. **exportHTMLPreview(options: ExportOptions): Promise<ExportResult>**
   Export for standalone HTML preview (no JUCE required):

   a. **Validate** - Same as JUCE export

   b. **Generate files (4 files, no C++):**
      - HTML: generateHTML(elements, { ...options, isPreviewMode: true })
      - CSS: generateCSS(elements, options)
      - Components JS: generateComponentsJS(elements)
      - Bindings JS: generateMockJUCE() + '\n\n' + generateBindingsJS(elements, { isPreviewMode: true })

   c. **Create ZIP:**
      - 4 files (no bindings.cpp)
      - Filename: `${projectName || 'webview-ui'}-preview.zip`

   d. **Return result**

4. **Error handling:**
   - Wrap in try/catch
   - User cancelled save dialog: return { success: true } (not an error)
   - AbortError from fileSave is not a failure
   - Other errors: return { success: false, error: message }

5. **Imports:**
```typescript
import JSZip from 'jszip'
import { fileSave } from 'browser-fs-access'
import { validateForExport } from './validators'
import { generateHTML } from './htmlGenerator'
import { generateCSS } from './cssGenerator'
import { generateBindingsJS, generateComponentsJS, generateMockJUCE } from './jsGenerator'
import { generateCPP } from './cppGenerator'
```
  </action>
  <verify>
Test orchestrator logic:
- Empty elements array should validate and generate minimal output
- Invalid elements should return validation errors
- All imports resolve correctly
- TypeScript compilation passes: `npx tsc --noEmit`
  </verify>
  <done>Code generator orchestrator coordinates all generators and produces ZIP bundles</done>
</task>

<task type="auto">
  <name>Task 2: Create barrel export and wire up service</name>
  <files>src/services/export/index.ts</files>
  <action>
Create `src/services/export/index.ts` as barrel export:

```typescript
/**
 * Export service for code generation
 * Produces JUCE WebView2 bundles and HTML preview packages
 */

// Main export functions
export { exportJUCEBundle, exportHTMLPreview } from './codeGenerator'
export type { ExportOptions, ExportResult } from './codeGenerator'

// Validation
export { validateForExport } from './validators'
export type { ExportValidationResult, ExportError } from './validators'

// Utilities (exposed for potential future use)
export { toKebabCase, toCamelCase, escapeHTML } from './utils'
```

This provides a clean public API for the export service:
- `import { exportJUCEBundle, exportHTMLPreview, validateForExport } from '../services/export'`
  </action>
  <verify>
Import from barrel works:
- `import { exportJUCEBundle } from './services/export'` should resolve
- TypeScript compilation passes: `npx tsc --noEmit`
  </verify>
  <done>Barrel export provides clean public API for export service</done>
</task>

</tasks>

<verification>
1. `src/services/export/codeGenerator.ts` exports exportJUCEBundle and exportHTMLPreview
2. `src/services/export/index.ts` re-exports all public API
3. JUCE export produces 5-file ZIP (html, css, components.js, bindings.js, bindings.cpp)
4. HTML preview produces 4-file ZIP (no C++) with mock JUCE
5. Validation errors prevent export with user-friendly messages
6. `npm run build` completes without errors
</verification>

<success_criteria>
- Export validates design before code generation
- JUCE bundle contains all 5 required files
- HTML preview includes mock JUCE backend for standalone testing
- Export uses browser-fs-access for progressive file save
- Errors are caught and returned as user-friendly messages
- Barrel export provides clean import path for consumers
</success_criteria>

<output>
After completion, create `.planning/phases/08-code-export/08-04-SUMMARY.md`
</output>
