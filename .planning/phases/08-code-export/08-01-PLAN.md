---
phase: 08-code-export
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - src/services/export/validators.ts
  - src/services/export/utils.ts
autonomous: true

must_haves:
  truths:
    - "Export validation catches interactive elements without names"
    - "Case conversion produces correct kebab-case and camelCase"
    - "HTML special characters are properly escaped"
  artifacts:
    - path: "src/services/export/validators.ts"
      provides: "Pre-export validation with Zod"
      exports: ["validateForExport", "ExportValidationResult"]
    - path: "src/services/export/utils.ts"
      provides: "Case conversion and HTML escaping utilities"
      exports: ["toKebabCase", "toCamelCase", "escapeHTML"]
  key_links:
    - from: "src/services/export/validators.ts"
      to: "src/schemas/project.ts"
      via: "Reuses existing element schemas"
      pattern: "import.*from.*schemas/project"
---

<objective>
Install JSZip and create export validation and utility functions.

Purpose: Establish the foundation for code generation with proper validation (prevent broken exports) and case conversion (element names to IDs).
Output: JSZip installed, validators.ts with export validation, utils.ts with toKebabCase/toCamelCase/escapeHTML utilities.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-code-export/08-CONTEXT.md
@.planning/phases/08-code-export/08-RESEARCH.md
@src/schemas/project.ts
@src/types/elements.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install JSZip for ZIP bundle creation</name>
  <files>package.json</files>
  <action>
Install JSZip for browser-based ZIP file generation:

```bash
npm install jszip
```

JSZip is the de facto standard for client-side ZIP creation. Version 3.10.1+ recommended.

Do NOT install change-case or sonner - we'll hand-roll the simple case converters and use existing error display patterns from SaveLoadPanel.
  </action>
  <verify>
Run `npm list jszip` - should show jszip@3.10.1 or higher installed.
Run `npm run build` - should complete without errors.
  </verify>
  <done>JSZip installed and available for import</done>
</task>

<task type="auto">
  <name>Task 2: Create export utilities (case conversion, HTML escaping)</name>
  <files>src/services/export/utils.ts</files>
  <action>
Create `src/services/export/utils.ts` with utility functions:

1. **toKebabCase(str: string): string**
   - Convert element names to HTML/JS IDs
   - "Gain Knob" -> "gain-knob"
   - "OSC2 Level" -> "osc2-level"
   - Handle: camelCase, spaces, underscores, multiple spaces
   - Pattern: `str.replace(/([a-z])([A-Z])/g, '$1-$2').replace(/[\s_]+/g, '-').toLowerCase()`

2. **toCamelCase(str: string): string**
   - Convert element names to C++ variable names
   - "Gain Knob" -> "gainKnob"
   - "OSC2 Level" -> "osc2Level"
   - Pattern: `str.toLowerCase().replace(/[^a-zA-Z0-9]+(.)/g, (_, chr) => chr.toUpperCase())`

3. **escapeHTML(str: string): string**
   - Escape special HTML characters in user content
   - Replace: & -> &amp;, < -> &lt;, > -> &gt;, " -> &quot;, ' -> &#039;
   - Prevents XSS and broken HTML in generated code

4. **toRelayVariableName(name: string, type: string): string**
   - Generate C++ relay variable name with type suffix
   - "Gain Knob" (knob) -> "gainKnobRelay"
   - "Master Volume" (slider) -> "masterVolumeRelay"
   - Pattern: `${toCamelCase(name)}Relay`

Add comprehensive JSDoc comments explaining each function's purpose and examples.
  </action>
  <verify>
Create a temporary test in the file or use console to verify:
- toKebabCase("Gain Knob") === "gain-knob"
- toKebabCase("OSC2Level") === "osc2-level"
- toCamelCase("Gain Knob") === "gainKnob"
- escapeHTML("<script>") === "&lt;script&gt;"
  </verify>
  <done>All utility functions exported and working correctly</done>
</task>

<task type="auto">
  <name>Task 3: Create export validators</name>
  <files>src/services/export/validators.ts</files>
  <action>
Create `src/services/export/validators.ts` with pre-export validation:

1. **ExportValidationResult type**
```typescript
export type ExportValidationResult =
  | { valid: true }
  | { valid: false; errors: ExportError[] }

export interface ExportError {
  elementId: string
  elementName: string
  field: string
  message: string
}
```

2. **validateForExport(elements: ElementConfig[]): ExportValidationResult**
   - Validate all elements before code generation
   - Check rules:
     a. All elements MUST have non-empty names (required for ID generation)
     b. Interactive elements (knob, slider, button) SHOULD have parameterId set (warn if missing, use TODO in output)
     c. No duplicate names (would create duplicate IDs)
   - Return structured errors with element context

3. **Validation rules:**
   - Empty name: "Element name is required for ID generation"
   - Duplicate name: "Duplicate element name '{name}' - IDs must be unique"
   - Interactive without parameterId: (warning only, not blocking) - generate TODO comment in C++

4. **isInteractiveElement(element: ElementConfig): boolean**
   - Helper to identify elements needing JUCE bindings
   - Returns true for: 'knob', 'slider', 'button'
   - Returns false for: 'label', 'meter', 'image' (static or output-only)

Import ElementConfig from '@/types/elements'. Use the existing type system.
  </action>
  <verify>
The file should compile without TypeScript errors: `npx tsc --noEmit`

Test cases to verify mentally:
- Empty array returns { valid: true }
- Element with empty name returns error
- Two elements with same name returns duplicate error
- Knob without parameterId still passes (warning generates TODO in later plans)
  </verify>
  <done>Validators catch missing names and duplicate IDs before export</done>
</task>

</tasks>

<verification>
1. `npm list jszip` shows installed
2. `src/services/export/utils.ts` exists with 4 exported functions
3. `src/services/export/validators.ts` exists with validateForExport and ExportError
4. `npm run build` completes without errors
5. TypeScript compilation passes: `npx tsc --noEmit`
</verification>

<success_criteria>
- JSZip installed for ZIP bundle creation
- Case conversion utilities handle element name variants correctly
- HTML escaping prevents XSS in generated code
- Export validation catches missing names and duplicates before code generation
- All files compile without TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/08-code-export/08-01-SUMMARY.md`
</output>
