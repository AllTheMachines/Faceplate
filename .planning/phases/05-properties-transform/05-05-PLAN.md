---
phase: 05-properties-transform
plan: 05
type: execute
wave: 2
depends_on: ["05-02", "05-03"]
files_modified:
  - src/components/Canvas/hooks/useElementNudge.ts
  - src/components/Canvas/hooks/useKeyboardShortcuts.ts
  - src/components/Canvas/hooks/index.ts
  - src/store/canvasSlice.ts
  - src/store/index.ts
  - src/App.tsx
  - src/components/Canvas/hooks/useResize.ts
  - src/components/Layout/RightPanel.tsx
autonomous: true

must_haves:
  truths:
    - "Arrow keys nudge selected elements 1px"
    - "Shift+Arrow keys nudge selected elements 10px"
    - "Nudge does not fire when typing in inputs"
    - "Snap-to-grid can be toggled on/off"
    - "Drag end snaps to grid when enabled"
    - "Resize end snaps to grid when enabled"
  artifacts:
    - path: "src/components/Canvas/hooks/useElementNudge.ts"
      provides: "Arrow key nudge hook"
      min_lines: 40
    - path: "src/store/canvasSlice.ts"
      provides: "snapToGrid state and toggle"
      contains: "snapToGrid"
  key_links:
    - from: "src/components/Canvas/hooks/useElementNudge.ts"
      to: "react-hotkeys-hook"
      via: "useHotkeys"
      pattern: "useHotkeys.*Arrow"
    - from: "src/App.tsx"
      to: "src/store/canvasSlice.ts"
      via: "snapToGrid state"
      pattern: "snapToGrid"
---

<objective>
Implement keyboard nudge for fine-tuned positioning and snap-to-grid functionality for drag/resize operations.

Purpose: Users need precise control over element positioning (MANP-03) and consistent alignment via snap-to-grid (MANP-04).

Output: useElementNudge hook for arrow key movement, snapToGrid state in store, snap toggle in UI, and snap application in drag/resize finalization.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-properties-transform/05-CONTEXT.md
@.planning/phases/05-properties-transform/05-RESEARCH.md

# Existing keyboard shortcuts
@src/components/Canvas/hooks/useKeyboardShortcuts.ts

# Store
@src/store/canvasSlice.ts
@src/store/index.ts

# Drag and resize (modified by 05-02 and 05-03)
@src/App.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useElementNudge hook</name>
  <files>
    - src/components/Canvas/hooks/useElementNudge.ts
    - src/components/Canvas/hooks/index.ts
  </files>
  <action>
1. Create src/components/Canvas/hooks/useElementNudge.ts:

```typescript
import { useHotkeys } from 'react-hotkeys-hook'
import { useStore } from '../../../store'

/**
 * Check if user is currently typing in an input field
 * Prevents arrow key nudge from firing while editing properties
 */
function isTypingInInput(): boolean {
  const active = document.activeElement
  if (!active) return false
  const tagName = active.tagName.toLowerCase()
  return tagName === 'input' || tagName === 'textarea' || active.getAttribute('contenteditable') === 'true'
}

export function useElementNudge() {
  const selectedIds = useStore((state) => state.selectedIds)
  const getElement = useStore((state) => state.getElement)
  const updateElement = useStore((state) => state.updateElement)

  const nudge = (dx: number, dy: number) => {
    if (isTypingInInput()) return
    if (selectedIds.length === 0) return

    selectedIds.forEach((id) => {
      const element = getElement(id)
      if (!element || element.locked) return

      updateElement(id, {
        x: element.x + dx,
        y: element.y + dy,
      })
    })
  }

  // 1px nudge with arrow keys
  useHotkeys('ArrowUp', (e) => {
    e.preventDefault()
    nudge(0, -1)
  }, { enableOnFormTags: false })

  useHotkeys('ArrowDown', (e) => {
    e.preventDefault()
    nudge(0, 1)
  }, { enableOnFormTags: false })

  useHotkeys('ArrowLeft', (e) => {
    e.preventDefault()
    nudge(-1, 0)
  }, { enableOnFormTags: false })

  useHotkeys('ArrowRight', (e) => {
    e.preventDefault()
    nudge(1, 0)
  }, { enableOnFormTags: false })

  // 10px nudge with Shift+Arrow
  useHotkeys('shift+ArrowUp', (e) => {
    e.preventDefault()
    nudge(0, -10)
  }, { enableOnFormTags: false })

  useHotkeys('shift+ArrowDown', (e) => {
    e.preventDefault()
    nudge(0, 10)
  }, { enableOnFormTags: false })

  useHotkeys('shift+ArrowLeft', (e) => {
    e.preventDefault()
    nudge(-10, 0)
  }, { enableOnFormTags: false })

  useHotkeys('shift+ArrowRight', (e) => {
    e.preventDefault()
    nudge(10, 0)
  }, { enableOnFormTags: false })
}
```

2. Export from index.ts: Add `export { useElementNudge } from './useElementNudge'`

3. Call useElementNudge() in useKeyboardShortcuts.ts or in a component that's always mounted (like Canvas)
  </action>
  <verify>
    - npm run build passes
    - grep "useElementNudge" src/components/Canvas/hooks/index.ts confirms export
    - grep "shift.ArrowUp" src/components/Canvas/hooks/useElementNudge.ts confirms 10px nudge
  </verify>
  <done>
    - useElementNudge hook created
    - 1px nudge on ArrowUp/Down/Left/Right
    - 10px nudge on Shift+Arrow
    - Input focus detection prevents nudge while typing
    - Hook exported and usable
  </done>
</task>

<task type="auto">
  <name>Task 2: Add snap-to-grid state and apply to drag/resize</name>
  <files>
    - src/store/canvasSlice.ts
    - src/store/index.ts
    - src/App.tsx
    - src/components/Canvas/hooks/useResize.ts
    - src/components/Layout/RightPanel.tsx
  </files>
  <action>
1. Update src/store/canvasSlice.ts:
   - Add state: `snapToGrid: boolean` (default false)
   - Add state: `gridSize: number` (default 10)
   - Add action: `setSnapToGrid: (enabled: boolean) => void`
   - Add action: `setGridSize: (size: number) => void`

2. Update src/store/index.ts:
   - Include new state and actions in the combined store type

3. Create snap utility function (can be in canvasSlice or utils):
   ```typescript
   export function snapValue(value: number, gridSize: number): number {
     return Math.round(value / gridSize) * gridSize
   }
   ```

4. Update src/App.tsx handleDragEnd:
   - Get snapToGrid and gridSize from store
   - After calculating newX, newY for element move:
     ```typescript
     const finalX = snapToGrid ? snapValue(newX, gridSize) : newX
     const finalY = snapToGrid ? snapValue(newY, gridSize) : newY
     updateElement(element.id, { x: finalX, y: finalY })
     ```

5. Update src/components/Canvas/hooks/useResize.ts:
   - Get snapToGrid and gridSize from store
   - In handleMouseUp (or when setting final values):
     - If snapToGrid enabled, snap the final x, y, width, height to grid
   - Note: Only snap on finalize (mouseup), not during drag for smooth movement

6. Add snap toggle UI in RightPanel.tsx:
   - Add a checkbox in the Canvas Settings section:
     ```tsx
     <div className="flex items-center gap-2 mt-3">
       <input
         type="checkbox"
         id="snap-toggle"
         checked={snapToGrid}
         onChange={(e) => setSnapToGrid(e.target.checked)}
         className="rounded border-gray-600 bg-gray-700"
       />
       <label htmlFor="snap-toggle" className="text-sm text-gray-300">
         Snap to grid ({gridSize}px)
       </label>
     </div>
     ```
  </action>
  <verify>
    - npm run build passes
    - grep "snapToGrid" src/store/canvasSlice.ts confirms state
    - grep "snapToGrid" src/App.tsx confirms drag snap
    - grep "snapToGrid" src/components/Canvas/hooks/useResize.ts confirms resize snap
    - grep "snap-toggle" src/components/Layout/RightPanel.tsx confirms UI
  </verify>
  <done>
    - snapToGrid state added to canvasSlice
    - Snap toggle checkbox in RightPanel
    - Drag finalize applies snap when enabled
    - Resize finalize applies snap when enabled
    - Snap is 10px granularity
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate useElementNudge into Canvas</name>
  <files>
    - src/components/Canvas/Canvas.tsx
  </files>
  <action>
1. Import useElementNudge from hooks
2. Call useElementNudge() in Canvas component alongside existing useKeyboardShortcuts()

Alternatively, add the nudge hotkeys directly to useKeyboardShortcuts.ts to keep all shortcuts in one place. Either approach is acceptable.
  </action>
  <verify>
    - npm run build passes
    - grep "useElementNudge" src/components/Canvas/Canvas.tsx OR grep "ArrowUp" src/components/Canvas/hooks/useKeyboardShortcuts.ts confirms integration
  </verify>
  <done>
    - Nudge functionality integrated and active
    - Arrow keys move selected elements
    - Shift+Arrow moves 10px
  </done>
</task>

</tasks>

<verification>
- `npm run build` completes without errors
- Arrow keys nudge selected elements (1px and 10px with Shift)
- Nudge does not fire when focused on input fields
- Snap toggle checkbox visible in RightPanel
- Dragging with snap enabled snaps to 10px grid on release
- Resizing with snap enabled snaps to 10px grid on release
</verification>

<success_criteria>
- [ ] Arrow keys move selected elements 1px
- [ ] Shift+Arrow moves selected elements 10px
- [ ] Nudge disabled when typing in property inputs
- [ ] Snap-to-grid checkbox visible in canvas settings
- [ ] Toggling snap on causes drag to snap to grid
- [ ] Toggling snap on causes resize to snap to grid
- [ ] Smooth movement during drag (snap only on release)
</success_criteria>

<output>
After completion, create `.planning/phases/05-properties-transform/05-05-SUMMARY.md`
</output>
